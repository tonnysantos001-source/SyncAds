-- =====================================================
-- MIGRATION: Adicionar Campos de Onboarding do Checkout
-- APLICAR DIRETAMENTE NO SUPABASE DASHBOARD
-- =====================================================

-- 1. ADICIONAR CAMPOS DE BILLING/STRIPE NA ORGANIZATION
ALTER TABLE "Organization" 
  ADD COLUMN IF NOT EXISTS "stripeCustomerId" TEXT,
  ADD COLUMN IF NOT EXISTS "subscriptionId" TEXT,
  ADD COLUMN IF NOT EXISTS "subscriptionStatus" TEXT CHECK ("subscriptionStatus" IN ('ACTIVE', 'CANCELED', 'PAST_DUE', 'TRIALING', 'INCOMPLETE')),
  ADD COLUMN IF NOT EXISTS "currentPeriodEnd" TIMESTAMP,
  ADD COLUMN IF NOT EXISTS "cancelAtPeriodEnd" BOOLEAN DEFAULT false;

-- 2. ADICIONAR CAMPOS DE DOMAIN NA ORGANIZATION
ALTER TABLE "Organization" 
  ADD COLUMN IF NOT EXISTS "domain" TEXT,
  ADD COLUMN IF NOT EXISTS "domainVerified" BOOLEAN DEFAULT false,
  ADD COLUMN IF NOT EXISTS "domainVerificationToken" TEXT,
  ADD COLUMN IF NOT EXISTS "domainVerificationMethod" TEXT CHECK ("domainVerificationMethod" IN ('DNS', 'FILE', 'META_TAG'));

-- 3. ADICIONAR CAMPOS DE SHIPPING NA ORGANIZATION (opcional)
ALTER TABLE "Organization"
  ADD COLUMN IF NOT EXISTS "shippingConfigured" BOOLEAN DEFAULT false;

-- 4. CRIAR TABELA SHIPPINGMETHOD
CREATE TABLE IF NOT EXISTS "ShippingMethod" (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  "organizationId" UUID NOT NULL REFERENCES "Organization"(id) ON DELETE CASCADE,
  
  -- Identificação
  name TEXT NOT NULL,
  description TEXT,
  
  -- Tipo de entrega
  type TEXT NOT NULL CHECK (type IN ('FIXED', 'WEIGHT_BASED', 'PRICE_BASED', 'LOCAL_PICKUP')),
  
  -- Configuração de preço
  "basePrice" DECIMAL(10,2) NOT NULL DEFAULT 0,
  "pricePerUnit" DECIMAL(10,2) DEFAULT 0,
  "freeShippingThreshold" DECIMAL(10,2),
  "maxWeight" DECIMAL(10,2),
  "minWeight" DECIMAL(10,2),
  
  -- Configuração de região
  "regions" TEXT[],
  "postalCodes" TEXT[],
  "excludedPostalCodes" TEXT[],
  
  -- Configuração de prazo
  "estimatedDays" INTEGER NOT NULL DEFAULT 5,
  "estimatedDaysMin" INTEGER,
  "estimatedDaysMax" INTEGER,
  
  -- Configuração de status
  "isActive" BOOLEAN DEFAULT true,
  "isDefault" BOOLEAN DEFAULT false,
  
  -- Configuração avançada
  "appliesTo" TEXT[] DEFAULT ARRAY['ALL'],
  "appliesToIds" UUID[],
  
  -- Ordem de exibição
  position INTEGER DEFAULT 0,
  
  -- Metadata
  metadata JSONB,
  "createdAt" TIMESTAMP DEFAULT NOW(),
  "updatedAt" TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_shipping_org ON "ShippingMethod"("organizationId");
CREATE INDEX idx_shipping_active ON "ShippingMethod"("isActive");
CREATE INDEX idx_shipping_type ON "ShippingMethod"(type);

-- 5. ENABLE RLS EM SHIPPINGMETHOD
ALTER TABLE "ShippingMethod" ENABLE ROW LEVEL SECURITY;

-- 6. RLS POLICIES PARA SHIPPINGMETHOD
CREATE POLICY "Users can view their own shipping methods" ON "ShippingMethod"
  FOR SELECT USING (
    "organizationId" IN (
      SELECT "organizationId" FROM "User" WHERE id = (SELECT auth.uid())::text
    )
  );

CREATE POLICY "Users can insert their own shipping methods" ON "ShippingMethod"
  FOR INSERT WITH CHECK (
    "organizationId" IN (
      SELECT "organizationId" FROM "User" WHERE id = (SELECT auth.uid())::text
    )
  );

CREATE POLICY "Users can update their own shipping methods" ON "ShippingMethod"
  FOR UPDATE USING (
    "organizationId" IN (
      SELECT "organizationId" FROM "User" WHERE id = (SELECT auth.uid())::text
    )
  );

CREATE POLICY "Users can delete their own shipping methods" ON "ShippingMethod"
  FOR DELETE USING (
    "organizationId" IN (
      SELECT "organizationId" FROM "User" WHERE id = (SELECT auth.uid())::text
    )
  );

-- 7. ATUALIZAR SHIPPINGCONFIGURED QUANDO MÉTODO FOR CRIADO
CREATE OR REPLACE FUNCTION update_shipping_configured()
RETURNS TRIGGER AS $$
BEGIN
  UPDATE "Organization"
  SET "shippingConfigured" = true
  WHERE id = NEW."organizationId";
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_shipping_configured_trigger
  AFTER INSERT OR UPDATE OF "isActive" ON "ShippingMethod"
  FOR EACH ROW
  WHEN (NEW."isActive" = true)
  EXECUTE FUNCTION update_shipping_configured();


# ü§ñ Sistema de Controle de IA no SaaS

## Conceito Chave

**Super Admin adiciona IA ‚Üí Organiza√ß√µes usam IA ‚Üí Usu√°rios interagem**

---

## üèóÔ∏è Arquitetura

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   SUPER ADMIN PANEL                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                          ‚îÇ
‚îÇ  ü§ñ Global AI Connections                               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îÇ
‚îÇ  ‚îÇ [+] Adicionar Nova IA                      ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ                                            ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ ‚úÖ OpenAI GPT-4                           ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ    API Key: sk-proj-****                  ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ    Atribu√≠da a: 5 organiza√ß√µes           ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ    [Editar] [Atribuir] [Remover]        ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ                                            ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ ‚úÖ Anthropic Claude                       ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ    API Key: sk-ant-****                   ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ    Atribu√≠da a: 2 organiza√ß√µes           ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ    [Editar] [Atribuir] [Remover]        ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ                                            ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ ‚úÖ Google Gemini                          ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ    API Key: AIza****                      ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ    Atribu√≠da a: 1 organiza√ß√£o            ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ    [Editar] [Atribuir] [Remover]        ‚îÇ         ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ
‚îÇ                                                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚Üì
                         ‚Üì Atribui
                         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              ORGANIZATION ADMIN PANEL                    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                          ‚îÇ
‚îÇ  ü§ñ IA Dispon√≠vel (Somente Leitura)                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îÇ
‚îÇ  ‚îÇ ‚úÖ OpenAI GPT-4 (Padr√£o)                  ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ    Status: Ativa                          ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ    Modelo: gpt-4-turbo                    ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ    Uso este m√™s: 1,250 mensagens         ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ                                            ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ üí¨ Configurar Prompt Padr√£o               ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ [‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ]        ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ Voc√™ √© um assistente especializado        ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ em marketing digital...                   ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ [‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ]        ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ    [Salvar]                               ‚îÇ         ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ
‚îÇ                                                          ‚îÇ
‚îÇ  ‚ùå USU√ÅRIOS N√ÉO PODEM:                                 ‚îÇ
‚îÇ     ‚Ä¢ Adicionar novas IAs                              ‚îÇ
‚îÇ     ‚Ä¢ Ver ou editar API keys                           ‚îÇ
‚îÇ     ‚Ä¢ Remover IAs                                      ‚îÇ
‚îÇ                                                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚Üì
                         ‚Üì Usa
                         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    USER PANEL                           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                          ‚îÇ
‚îÇ  üí¨ Chat com IA                                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îÇ
‚îÇ  ‚îÇ ü§ñ Usando: OpenAI GPT-4                   ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ                                            ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ [‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ]        ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ Digite sua mensagem...                    ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ [‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ]        ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ                                            ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ ‚úÖ Apenas interage com a IA               ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ ‚ùå N√£o v√™ API keys                        ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ ‚ùå N√£o configura IA                       ‚îÇ         ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ
‚îÇ                                                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìä Modelo de Dados

```sql
-- IA GLOBAL (gerenciada pelo Super Admin)
CREATE TABLE GlobalAiConnection (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL, -- "OpenAI GPT-4"
  provider TEXT NOT NULL, -- OPENAI, ANTHROPIC, GOOGLE, COHERE
  apiKey TEXT NOT NULL, -- Encriptado
  baseUrl TEXT, -- URL customizada se necess√°rio
  model TEXT, -- gpt-4-turbo, claude-3-opus, etc
  maxTokens INTEGER DEFAULT 4096,
  temperature DECIMAL(3,2) DEFAULT 0.7,
  isActive BOOLEAN DEFAULT true,
  createdAt TIMESTAMP DEFAULT NOW(),
  updatedAt TIMESTAMP DEFAULT NOW()
);

-- ATRIBUI√á√ÉO DE IA PARA ORGANIZA√á√ïES
CREATE TABLE OrganizationAiConnection (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organizationId UUID REFERENCES Organization(id) ON DELETE CASCADE,
  globalAiConnectionId UUID REFERENCES GlobalAiConnection(id) ON DELETE CASCADE,
  isDefault BOOLEAN DEFAULT false, -- IA padr√£o da org
  customSystemPrompt TEXT, -- Prompt customizado pela org
  createdAt TIMESTAMP DEFAULT NOW(),
  UNIQUE(organizationId, globalAiConnectionId)
);

-- USO DE IA (tracking e limites)
CREATE TABLE AiUsage (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organizationId UUID REFERENCES Organization(id) ON DELETE CASCADE,
  userId UUID REFERENCES User(id),
  globalAiConnectionId UUID REFERENCES GlobalAiConnection(id),
  messageCount INTEGER DEFAULT 1,
  tokensUsed INTEGER DEFAULT 0,
  cost DECIMAL(10,4) DEFAULT 0, -- custo estimado
  month TEXT NOT NULL, -- '2025-10'
  createdAt TIMESTAMP DEFAULT NOW(),
  UNIQUE(organizationId, userId, globalAiConnectionId, month)
);
```

---

## üîê RLS Policies

```sql
-- Super Admin v√™ todas as IAs globais
CREATE POLICY "SuperAdmin can see all global AI"
ON GlobalAiConnection FOR SELECT
USING (
  auth.jwt() ->> 'is_super_admin' = 'true'
);

-- Organiza√ß√µes veem apenas IAs atribu√≠das a elas
CREATE POLICY "Orgs see only assigned AI"
ON OrganizationAiConnection FOR SELECT
USING (
  organizationId = current_setting('app.current_organization_id')::uuid
);

-- Usu√°rios N√ÉO veem API keys (nunca!)
CREATE POLICY "Users never see API keys"
ON GlobalAiConnection FOR SELECT
USING (false); -- Bloqueado para users normais

-- Apenas Super Admin pode modificar
CREATE POLICY "Only SuperAdmin can modify global AI"
ON GlobalAiConnection FOR ALL
USING (
  auth.jwt() ->> 'is_super_admin' = 'true'
);
```

---

## üéØ Implementa√ß√£o Frontend

### **1. Super Admin - Adicionar IA:**

```typescript
// src/pages/super-admin/GlobalAiPage.tsx

const addGlobalAi = async (data: AiFormData) => {
  const { error } = await supabase
    .from('GlobalAiConnection')
    .insert({
      name: data.name,
      provider: data.provider,
      apiKey: encryptApiKey(data.apiKey), // Encrypt!
      model: data.model,
      baseUrl: data.baseUrl,
      isActive: true
    });

  if (!error) {
    toast.success('IA adicionada com sucesso!');
  }
};

const assignAiToOrg = async (aiId: string, orgId: string) => {
  const { error } = await supabase
    .from('OrganizationAiConnection')
    .insert({
      organizationId: orgId,
      globalAiConnectionId: aiId,
      isDefault: false
    });
};
```

### **2. Organization Admin - Visualizar IA:**

```typescript
// src/pages/app/AiConnectionsPage.tsx

const loadAvailableAi = async () => {
  const orgId = currentOrganization.id;
  
  // Buscar IAs atribu√≠das √† organiza√ß√£o
  const { data, error } = await supabase
    .from('OrganizationAiConnection')
    .select(`
      id,
      isDefault,
      customSystemPrompt,
      globalAiConnection:GlobalAiConnection (
        id,
        name,
        provider,
        model
        -- N√ÉO incluir apiKey!
      )
    `)
    .eq('organizationId', orgId);

  setAvailableAi(data);
};

// Usu√°rios S√ì podem configurar prompt
const updateCustomPrompt = async (prompt: string) => {
  const { error } = await supabase
    .from('OrganizationAiConnection')
    .update({ customSystemPrompt: prompt })
    .eq('organizationId', currentOrganization.id)
    .eq('isDefault', true);
};
```

### **3. User - Usar IA no Chat:**

```typescript
// src/pages/app/ChatPage.tsx

const sendMessage = async (message: string) => {
  // 1. Buscar IA padr√£o da organiza√ß√£o
  const { data: orgAi } = await supabase
    .from('OrganizationAiConnection')
    .select('globalAiConnection:GlobalAiConnection(*), customSystemPrompt')
    .eq('organizationId', currentOrganization.id)
    .eq('isDefault', true)
    .single();

  if (!orgAi) {
    toast.error('Nenhuma IA configurada. Contate o admin.');
    return;
  }

  // 2. Chamar API usando dados da IA global
  // NOTA: API Key NUNCA vem para o frontend!
  // Chamada passa pelo backend/edge function
  const response = await fetch('/api/chat', {
    method: 'POST',
    body: JSON.stringify({
      message,
      aiConnectionId: orgAi.globalAiConnection.id,
      systemPrompt: orgAi.customSystemPrompt
    })
  });

  // 3. Registrar uso
  await trackAiUsage(orgAi.globalAiConnection.id, tokensUsed);
};
```

---

## üîí Backend/Edge Function (Seguran√ßa)

```typescript
// supabase/functions/chat/index.ts

Deno.serve(async (req) => {
  const { message, aiConnectionId, systemPrompt } = await req.json();
  
  // 1. Verificar se organiza√ß√£o tem acesso a essa IA
  const { data: access } = await supabase
    .from('OrganizationAiConnection')
    .select('*')
    .eq('organizationId', userOrganizationId)
    .eq('globalAiConnectionId', aiConnectionId)
    .single();

  if (!access) {
    return new Response('Unauthorized', { status: 403 });
  }

  // 2. Buscar API Key (SOMENTE no backend!)
  const { data: aiConnection } = await supabase
    .from('GlobalAiConnection')
    .select('apiKey, provider, model')
    .eq('id', aiConnectionId)
    .single();

  const apiKey = decryptApiKey(aiConnection.apiKey);

  // 3. Chamar IA
  const response = await callAiProvider(
    aiConnection.provider,
    apiKey,
    message,
    systemPrompt
  );

  // 4. Registrar uso
  await trackUsage(userOrganizationId, aiConnectionId, response.tokensUsed);

  return new Response(JSON.stringify(response));
});
```

---

## üì± UI Components

### **Super Admin - Form de IA:**

```tsx
<Dialog>
  <DialogTrigger>
    <Button>+ Adicionar IA</Button>
  </DialogTrigger>
  <DialogContent>
    <DialogHeader>
      <DialogTitle>Nova Conex√£o de IA Global</DialogTitle>
    </DialogHeader>
    
    <Form>
      <FormField>
        <Label>Nome</Label>
        <Input placeholder="OpenAI GPT-4" />
      </FormField>

      <FormField>
        <Label>Provider</Label>
        <Select>
          <SelectOption value="OPENAI">OpenAI</SelectOption>
          <SelectOption value="ANTHROPIC">Anthropic</SelectOption>
          <SelectOption value="GOOGLE">Google</SelectOption>
        </Select>
      </FormField>

      <FormField>
        <Label>API Key</Label>
        <Input type="password" placeholder="sk-proj-..." />
      </FormField>

      <FormField>
        <Label>Modelo</Label>
        <Input placeholder="gpt-4-turbo" />
      </FormField>

      <Button type="submit">Adicionar</Button>
    </Form>
  </DialogContent>
</Dialog>
```

### **Organization Admin - View Only:**

```tsx
<Card>
  <CardHeader>
    <CardTitle>ü§ñ IA Dispon√≠vel</CardTitle>
    <CardDescription>
      Configurada pelo administrador do sistema
    </CardDescription>
  </CardHeader>
  <CardContent>
    {availableAi.map(ai => (
      <div key={ai.id} className="border rounded-lg p-4 mb-4">
        <div className="flex items-center justify-between">
          <div>
            <h3 className="font-bold">{ai.globalAiConnection.name}</h3>
            <p className="text-sm text-gray-500">
              {ai.globalAiConnection.provider} ‚Ä¢ {ai.globalAiConnection.model}
            </p>
            {ai.isDefault && (
              <Badge variant="success">Padr√£o</Badge>
            )}
          </div>
          <Badge variant="outline">Ativa</Badge>
        </div>

        <Separator className="my-4" />

        <Label>Prompt Customizado (Opcional)</Label>
        <Textarea
          value={ai.customSystemPrompt}
          onChange={(e) => updatePrompt(ai.id, e.target.value)}
          placeholder="Personalize o comportamento da IA..."
        />
        <Button size="sm" onClick={savePrompt}>Salvar</Button>

        <Alert className="mt-4">
          <Info className="h-4 w-4" />
          <AlertDescription>
            Voc√™ n√£o pode adicionar ou remover conex√µes de IA.
            Contate o suporte para solicitar novas IAs.
          </AlertDescription>
        </Alert>
      </div>
    ))}
  </CardContent>
</Card>
```

---

## üéØ Fluxo Completo

```
1. SUPER ADMIN ADICIONA IA
   ‚Üì
2. SUPER ADMIN ATRIBUI IA √Ä ORGANIZA√á√ÉO
   ‚Üì
3. ORGANIZATION ADMIN V√ä IA DISPON√çVEL
   ‚Üì
4. ORGANIZATION ADMIN CONFIGURA PROMPT (OPCIONAL)
   ‚Üì
5. USU√ÅRIOS USAM IA NO CHAT
   ‚Üì
6. SISTEMA REGISTRA USO
   ‚Üì
7. SUPER ADMIN MONITORA USO GLOBAL
```

---

## ‚úÖ Vantagens desta Arquitetura

1. **Seguran√ßa:** API keys NUNCA expostas
2. **Controle:** Admin controla custos e acesso
3. **Simplicidade:** Usu√°rios s√≥ usam, n√£o configuram
4. **Escalabilidade:** F√°cil adicionar novos providers
5. **Monetiza√ß√£o:** Pode cobrar por IA premium

---

## üí° Features Futuras

- [ ] Limites de uso por organiza√ß√£o
- [ ] IA dedicada para planos Enterprise
- [ ] Escolha de IA por usu√°rio (se org tiver m√∫ltiplas)
- [ ] Analytics de uso de IA
- [ ] Auto-scaling baseado em demanda
- [ ] Fallback se IA principal falhar

---

**Status:** Pronto para implementa√ß√£o

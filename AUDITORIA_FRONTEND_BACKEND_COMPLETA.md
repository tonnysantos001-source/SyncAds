# üîç AUDITORIA COMPLETA - Frontend & Backend

**Data:** 20 de Outubro de 2025  
**Auditor:** Cascade AI  
**Status:** üî¥ Requer a√ß√µes corretivas

---

## üìä RESUMO EXECUTIVO

### Problemas Cr√≠ticos Encontrados: **12**
### Problemas M√©dios Encontrados: **18**
### Melhorias Sugeridas: **25**

### Score Geral: **6.5/10**

---

# üî¥ PAINEL DO CLIENTE

## 1. Chat IA (/chat)

### ‚úÖ FUNCIONANDO:
- Interface de chat
- Hist√≥rico de conversas
- Edge Function integrada
- Cria√ß√£o de novas conversas
- Sistema de mensagens

### ‚ö†Ô∏è PROBLEMAS:
1. **CR√çTICO:** Dados mockados em `chatConversations`
   - **Impacto:** Mostra conversas falsas
   - **Solu√ß√£o:** Buscar do banco (ChatConversation table)
   
2. **M√âDIO:** Personalidade da IA n√£o configur√°vel
   - **Impacto:** IA usa prompt padr√£o
   - **Solu√ß√£o:** Buscar customSystemPrompt de OrganizationAiConnection

3. **BAIXO:** Sem indicador de "typing..."
   - **Impacto:** UX
   - **Solu√ß√£o:** Adicionar skeleton loading

### üìã DADOS MOCKADOS:
```typescript
// src/data/mocks.ts
export const chatConversations: ChatConversation[] = [...]
```

### üîß A√á√ïES NECESS√ÅRIAS:
1. Substituir `chatConversations` mockadas por query real
2. Integrar customSystemPrompt do banco
3. Adicionar loading states

---

## 2. Dashboard (/dashboard)

### ‚úÖ FUNCIONANDO:
- Layout de m√©tricas
- Abas (Vis√£o Geral, Campanhas, Analytics)
- Gr√°ficos (via Recharts)
- Cards de campanhas

### üî¥ PROBLEMAS CR√çTICOS:
1. **dashboardMetrics** - Dados 100% mockados
   ```typescript
   // MOCKADO
   export const dashboardMetrics: Metric[] = [
     { title: 'Total de Campanhas', value: '12', ...},
     { title: 'Cliques Totais', value: '3,456', ...},
     { title: 'Taxa de Convers√£o', value: '4.2%', ...},
     { title: 'ROI', value: 'R$ 8,920', ...}
   ];
   ```
   - **REAL:** Calcular de Campaign table
   
2. **chartData** - Gerado aleatoriamente
   ```typescript
   export const chartData = Array.from({ length: 12 }, (_, i) => {
     return {
       name: month,
       Cliques: Math.floor(Math.random() * 5000),
       Conversoes: Math.floor(Math.random() * 500),
     };
   });
   ```
   - **REAL:** Agregar de Campaign por m√™s

3. **allCampaigns** - 10 campanhas mockadas
   - **REAL:** Query `Campaign` table filtrada por `organizationId`

### ‚ö†Ô∏è PROBLEMAS M√âDIOS:
1. Gr√°fico n√£o filtr√°vel por data
2. Sem exporta√ß√£o de dados
3. Sem compara√ß√£o com per√≠odo anterior

### üìã DADOS MOCKADOS:
- `dashboardMetrics` (4 m√©tricas)
- `chartData` (12 meses)
- `allCampaigns` (10 campanhas)
- `recentCampaigns` (5 campanhas)
- `aiSuggestions` (3 sugest√µes)

### üîß A√á√ïES NECESS√ÅRIAS:
**PRIORIDADE ALTA:**
1. Criar query para m√©tricas reais:
```typescript
// Buscar do banco
const { data: campaigns } = await supabase
  .from('Campaign')
  .select('*')
  .eq('organizationId', user.organizationId);

// Calcular m√©tricas
const totalCampaigns = campaigns.length;
const totalClicks = campaigns.reduce((sum, c) => sum + c.clicks, 0);
const totalConversions = campaigns.reduce((sum, c) => sum + c.conversions, 0);
const conversionRate = (totalConversions / totalClicks) * 100;
```

2. Criar query para chartData agrupado por m√™s
3. Remover campanhas mockadas

---

## 3. Integra√ß√µes (/integrations)

### ‚úÖ FUNCIONANDO:
- Lista de integra√ß√µes categorizadas
- OAuth flow (popup)
- Salvar tokens no banco
- `Integration` table com RLS

### ‚ö†Ô∏è PROBLEMAS:
1. **M√âDIO:** Client IDs hardcoded
   ```typescript
   // src/lib/oauth/oauthConfig.ts
   META_ADS: 'YOUR_META_CLIENT_ID_HERE',
   GOOGLE_ADS: 'YOUR_GOOGLE_CLIENT_ID_HERE',
   ```
   - **Solu√ß√£o:** Configurar no `.env`

2. **M√âDIO:** 15+ integra√ß√µes listadas, mas apenas 5 funcionam
   - **Solu√ß√£o:** Marcar claramente quais est√£o dispon√≠veis

3. **BAIXO:** Sem status de "conectado" vis√≠vel
   - **Solu√ß√£o:** Badge verde nas conectadas

### üìã DADOS MOCKADOS:
```typescript
// src/data/mocks.ts
export const categorizedIntegrations: IntegrationCategory[] = [
  // 24 integra√ß√µes, maioria "comingSoon"
]
```

### üîß A√á√ïES NECESS√ÅRIAS:
1. Mover client IDs para vari√°veis de ambiente
2. Criar sistema de "status" para integra√ß√µes
3. Buscar integra√ß√µes conectadas do banco

---

## 4. Configura√ß√µes (/settings/*)

### ‚úÖ FUNCIONANDO:
- **Perfil:** Atualizar nome, email, avatar
- **Seguran√ßa:** Trocar senha, 2FA, verificar email (novo!)
- **Notifica√ß√µes:** Toggle de prefer√™ncias
- **Faturamento:** Lista de faturas

### ‚ö†Ô∏è PROBLEMAS:
1. **M√âDIO:** Faturas mockadas
   ```typescript
   export const billingHistory: Invoice[] = [
     { id: 'INV-001', date: '01/06/2025', amount: 'R$ 99,00', status: 'Paga' },
     ...
   ];
   ```
   - **Solu√ß√£o:** Integrar com Stripe/Asaas

2. **M√âDIO:** Plano atual n√£o din√¢mico
   - Hardcoded como "Pro - R$ 99/m√™s"
   - **Solu√ß√£o:** Buscar de `Subscription` table

3. **BAIXO:** Sem p√°gina de upgrade/downgrade
   - **Solu√ß√£o:** Criar flow de mudan√ßa de plano

### üìã DADOS MOCKADOS:
- `billingHistory` (4 faturas)

### üîß A√á√ïES NECESS√ÅRIAS:
1. Integrar billing real (Stripe/Asaas)
2. P√°gina de planos e upgrade
3. Buscar hist√≥rico de faturas

---

## 5. Campanhas (Detalhes /campaigns/:id)

### ‚úÖ FUNCIONANDO:
- Ver detalhes de campanha
- Editar campanha
- Pausar/Ativar
- Deletar

### ‚ö†Ô∏è PROBLEMAS:
1. **M√âDIO:** M√©tricas em tempo real n√£o funcionam
   - Dados est√°ticos
   - **Solu√ß√£o:** Integrar com APIs das plataformas

2. **M√âDIO:** Sem hist√≥rico de mudan√ßas
   - **Solu√ß√£o:** Criar tabela `CampaignHistory`

3. **BAIXO:** Sem gr√°fico de performance da campanha individual
   - **Solu√ß√£o:** Adicionar gr√°fico de evolu√ß√£o

### üîß A√á√ïES NECESS√ÅRIAS:
1. Integrar APIs reais (Meta, Google Ads)
2. Criar hist√≥rico de altera√ß√µes
3. Gr√°ficos individuais por campanha

---

# üî¥ PAINEL SUPER ADMIN

## 1. Dashboard (/super-admin)

### ‚úÖ FUNCIONANDO:
- Stats reais do banco (COUNT de orgs, users, mensagens)
- MRR calculado
- Lista de organiza√ß√µes
- Quick actions

### ‚ö†Ô∏è PROBLEMAS:
1. **M√âDIO:** Gr√°fico de crescimento mockado
   - **Solu√ß√£o:** Agregar por m√™s de `Organization.createdAt`

2. **BAIXO:** Sem alertas de limites excedidos
   - **Solu√ß√£o:** Query em `UsageTracking`

### üîß A√á√ïES NECESS√ÅRIAS:
1. Gr√°fico real de crescimento
2. Sistema de alertas

---

## 2. Organizations (/super-admin/clients)

### ‚úÖ FUNCIONANDO:
- Listar todas as organiza√ß√µes
- Criar nova organiza√ß√£o
- Suspender/Ativar
- Ver detalhes

### ‚ö†Ô∏è PROBLEMAS:
1. **M√âDIO:** Sem filtros avan√ßados
   - Por plano, status, data
   - **Solu√ß√£o:** Adicionar filtros

2. **M√âDIO:** Sem busca por nome/email
   - **Solu√ß√£o:** Adicionar search bar

3. **BAIXO:** Sem pagina√ß√£o
   - **Solu√ß√£o:** Implementar pagina√ß√£o (50/p√°gina)

### üîß A√á√ïES NECESS√ÅRIAS:
1. Sistema de filtros
2. Busca
3. Pagina√ß√£o

---

## 3. Global AI (/super-admin/ai-connections)

### ‚úÖ FUNCIONANDO:
- CRUD de IAs globais
- Testar conex√£o
- Atribuir IAs para organiza√ß√µes

### ‚ö†Ô∏è PROBLEMAS:
1. **CR√çTICO:** API keys vis√≠veis em texto plano
   - **Solu√ß√£o:** Usar `pgcrypto` (j√° configurado, mas n√£o usado)

2. **M√âDIO:** Sem tracking de uso por IA
   - Qual IA est√° sendo mais usada?
   - **Solu√ß√£o:** Query em `AiUsage` por provider

### üîß A√á√ïES NECESS√ÅRIAS:
1. Encriptar API keys ao salvar
2. Dashboard de uso por IA

---

## 4. Billing (/super-admin/billing)

### ‚úÖ FUNCIONANDO:
- Lista de transa√ß√µes (mockado)

### üî¥ PROBLEMAS CR√çTICOS:
1. **100% mockado** - Nenhum dado real
   - **Solu√ß√£o:** Integrar webhooks Stripe/Asaas

2. **Sem gest√£o de assinaturas**
   - Criar, cancelar, upgrade
   - **Solu√ß√£o:** Interface para `Subscription` table

### üìã DADOS MOCKADOS:
Todas as transa√ß√µes, MRR, churn

### üîß A√á√ïES NECESS√ÅRIAS:
1. Integra√ß√£o completa com gateway
2. CRUD de assinaturas
3. Webhooks configurados

---

## 5. Usage (/super-admin/usage)

### ‚úÖ FUNCIONANDO:
- Lista de uso de IAs (mockado)

### üî¥ PROBLEMAS CR√çTICOS:
1. **Dados mockados** - N√£o reflete uso real
   - **Solu√ß√£o:** Query `AiUsage` table

2. **Sem limites por organiza√ß√£o**
   - **Solu√ß√£o:** Verificar `UsageTracking`

### üîß A√á√ïES NECESS√ÅRIAS:
1. Query real de `AiUsage`
2. Gr√°ficos de consumo
3. Alertas de limites

---

## 6. Gateways (/super-admin/gateways)

### ‚ö†Ô∏è STATUS:
- **Interface criada**
- **L√≥gica pendente**

### üî¥ PROBLEMAS CR√çTICOS:
1. **Sem integra√ß√£o real com gateways**
   - Stripe, Asaas, Mercado Pago
   - **Solu√ß√£o:** Configurar SDKs

2. **Sem webhooks configurados**
   - **Solu√ß√£o:** Endpoints para callbacks

### üîß A√á√ïES NECESS√ÅRIAS:
1. Integrar Stripe SDK
2. Configurar webhooks
3. Testar fluxo completo

---

# üìä BACKEND (Supabase)

## 1. Tabelas do Banco

### ‚úÖ FUNCIONANDO:
- `User` - Cadastro, CPF, birthDate, emailVerified
- `Organization` - Multi-tenant
- `Campaign` - CRUD completo
- `ChatConversation` - Hist√≥rico de conversas
- `ChatMessage` - Mensagens
- `Integration` - OAuth tokens
- `GlobalAiConnection` - IAs globais
- `OrganizationAiConnection` - Atribui√ß√£o
- `Subscription` - Assinaturas
- `UsageTracking` - Limites
- `AiUsage` - Tracking de uso
- `PendingInvite` - Convites

### ‚ö†Ô∏è PROBLEMAS:
1. **M√âDIO:** Sem √≠ndices em queries frequentes
   ```sql
   -- Falta √≠ndice
   CREATE INDEX idx_campaign_org_date ON Campaign(organizationId, createdAt DESC);
   CREATE INDEX idx_aiusage_org_month ON AiUsage(organizationId, month);
   ```

2. **M√âDIO:** Sem triggers para audit log
   - Quem mudou o qu√™ e quando?
   - **Solu√ß√£o:** Triggers de UPDATE/DELETE

3. **BAIXO:** Sem soft delete
   - Deletar permanentemente √© arriscado
   - **Solu√ß√£o:** Campo `deletedAt`

### üîß A√á√ïES NECESS√ÅRIAS:
1. Criar √≠ndices de performance
2. Implementar audit log
3. Soft delete

---

## 2. Edge Functions

### ‚úÖ FUNCIONANDO:
- `/functions/v1/chat` - Deployada e funcionando
- `/functions/v1/invite-user` - Deployada

### ‚ö†Ô∏è PROBLEMAS:
1. **M√âDIO:** Chat function sem rate limiting
   - Usu√°rio pode spammar
   - **Solu√ß√£o:** Rate limit no c√≥digo

2. **M√âDIO:** Sem tratamento de erros consistente
   - **Solu√ß√£o:** Padronizar responses

### üîß A√á√ïES NECESS√ÅRIAS:
1. Implementar rate limiting
2. Melhorar error handling

---

## 3. RLS Policies

### ‚úÖ FUNCIONANDO:
- Isolamento por `organizationId`
- SuperAdmin bypassa RLS
- Policies em todas as tabelas

### ‚ö†Ô∏è PROBLEMAS:
1. **AVISO:** 19 policies usam `auth.uid()` sem cache
   - **Impacto:** Performance 10-100x mais lenta
   - **Solu√ß√£o:** Usar `(SELECT auth.uid())`

2. **M√âDIO:** Policies redundantes
   - M√∫ltiplas permissive policies
   - **Solu√ß√£o:** Consolidar

### üîß A√á√ïES NECESS√ÅRIAS:
1. Otimizar auth.uid() calls
2. Consolidar policies

---

## 4. Autentica√ß√£o

### ‚úÖ FUNCIONANDO:
- Email/senha
- Login imediato (sem confirma√ß√£o obrigat√≥ria)
- Verifica√ß√£o opcional
- 2FA (flag no banco)

### ‚ö†Ô∏è PROBLEMAS:
1. **M√âDIO:** 2FA n√£o implementado no flow de login
   - Flag existe, mas n√£o valida
   - **Solu√ß√£o:** Implementar TOTP

2. **BAIXO:** Sem OAuth social (Google, GitHub)
   - **Solu√ß√£o:** Configurar providers

### üîß A√á√ïES NECESS√ÅRIAS:
1. Implementar 2FA real
2. OAuth social

---

# üéØ PREPARA√á√ÉO PARA CHECKOUT

## Requisitos para Checkout de Pagamento:

### 1. ‚úÖ Backend Necess√°rio:
- [x] Tabela `Subscription`
- [x] Tabela `Organization`
- [x] User autenticado
- [ ] Integra√ß√£o com gateway (Stripe/Asaas)
- [ ] Webhooks configurados
- [ ] Planos definidos

### 2. ‚úÖ Frontend Necess√°rio:
- [x] Sistema de autentica√ß√£o
- [x] Dashboard do usu√°rio
- [ ] P√°gina de planos
- [ ] Checkout page
- [ ] P√°gina de sucesso
- [ ] P√°gina de falha

### 3. üî¥ Pend√™ncias Cr√≠ticas para Checkout:

#### A. Definir Planos
```typescript
// Criar arquivo: src/data/plans.ts
export const plans = [
  {
    id: 'free',
    name: 'Gratuito',
    price: 0,
    features: [
      '5 campanhas',
      '1.000 mensagens IA/m√™s',
      '1 usu√°rio',
    ]
  },
  {
    id: 'pro',
    name: 'Profissional',
    price: 99,
    features: [
      '50 campanhas',
      '10.000 mensagens IA/m√™s',
      '5 usu√°rios',
      'Suporte priorit√°rio'
    ]
  },
  {
    id: 'enterprise',
    name: 'Enterprise',
    price: 299,
    features: [
      'Campanhas ilimitadas',
      'Mensagens IA ilimitadas',
      'Usu√°rios ilimitados',
      'API dedicada',
      'Suporte 24/7'
    ]
  }
];
```

#### B. Escolher Gateway de Pagamento
**Op√ß√µes:**
1. **Stripe** (Recomendado internacional)
   - Checkout pronto
   - Webhooks confi√°veis
   - Suporte a m√∫ltiplas moedas
   
2. **Asaas** (Recomendado Brasil)
   - PIX instant√¢neo
   - Boleto
   - Cart√£o nacional

3. **Mercado Pago**
   - Popular no Brasil
   - Parcelamento sem juros

#### C. Criar P√°ginas de Checkout
```
/pricing       - P√°gina de planos
/checkout      - Formul√°rio de pagamento
/checkout/success - Pagamento aprovado
/checkout/error   - Pagamento falhou
```

#### D. Implementar Webhooks
```typescript
// Edge Function: /functions/v1/stripe-webhook
// Escuta eventos:
- checkout.session.completed
- customer.subscription.updated
- customer.subscription.deleted
- invoice.payment_succeeded
- invoice.payment_failed
```

#### E. Criar L√≥gica de Upgrade/Downgrade
```typescript
// Verificar limites ao criar campanha
if (campaigns.length >= organization.maxCampaigns) {
  throw new Error('Limite de campanhas atingido. Fa√ßa upgrade!');
}
```

---

# üìã LISTA COMPLETA DE DADOS MOCKADOS

## üî¥ CR√çTICO - Substituir IMEDIATAMENTE:

1. **dashboardMetrics** - M√©tricas da dashboard
2. **allCampaigns** - 10 campanhas falsas
3. **chartData** - Gr√°fico aleat√≥rio
4. **billingHistory** - 4 faturas falsas
5. **chatConversations** - 3 conversas falsas

## üü° M√âDIO - Substituir em breve:

6. **aiSuggestions** - 3 sugest√µes falsas
7. **categorizedIntegrations** - 24 integra√ß√µes (maioria "coming soon")
8. **recentCampaigns** - Campanhas conclu√≠das

## üü¢ BAIXO - Manter por enquanto:

9. **√çcones e UI** - Podem ficar mockados

---

# üöÄ PLANO DE A√á√ÉO IMEDIATO

## Fase 1: Remover Dados Mockados (1-2 dias)

### Dia 1 - Dashboard
- [ ] Substituir `dashboardMetrics` por query real
- [ ] Substituir `chartData` por agrega√ß√£o mensal
- [ ] Substituir `allCampaigns` por query filtrada

### Dia 2 - Chat e Integra√ß√µes
- [ ] Substituir `chatConversations` por query real
- [ ] Adicionar status "conectado" em integra√ß√µes
- [ ] Buscar faturas do gateway

---

## Fase 2: Preparar para Checkout (2-3 dias)

### Dia 3 - Definir Estrutura
- [ ] Criar arquivo `plans.ts` com planos
- [ ] Escolher gateway (Stripe ou Asaas)
- [ ] Configurar SDK

### Dia 4 - Backend
- [ ] Criar Edge Function para webhooks
- [ ] Testar cria√ß√£o de subscription
- [ ] Implementar verifica√ß√£o de limites

### Dia 5 - Frontend (Aguardando suas imagens)
- [ ] P√°gina de planos (`/pricing`)
- [ ] P√°gina de checkout (`/checkout`)
- [ ] P√°ginas de sucesso/erro
- [ ] Integrar com gateway

---

## Fase 3: Melhorias de Performance (1-2 dias)

### Dia 6 - Otimiza√ß√µes
- [ ] Criar √≠ndices no banco
- [ ] Otimizar RLS policies
- [ ] Implementar rate limiting

### Dia 7 - Testes
- [ ] Testar fluxo completo de pagamento
- [ ] Testar upgrade/downgrade
- [ ] Testar limites e bloqueios

---

# üìä PRIORIZA√á√ÉO FINAL

## üî¥ CR√çTICO (Fazer AGORA):
1. Remover dados mockados da dashboard
2. Integrar gateway de pagamento
3. Criar checkout

## üü° IMPORTANTE (Esta semana):
4. Otimizar RLS policies
5. Implementar limites reais
6. Audit log

## üü¢ DESEJ√ÅVEL (Pr√≥ximo sprint):
7. 2FA real
8. OAuth social
9. Soft delete
10. Analytics avan√ßados

---

# ‚úÖ CONCLUS√ÉO

## Status Atual: **BOM com ressalvas**

### Pontos Fortes:
- ‚úÖ Arquitetura SaaS s√≥lida
- ‚úÖ Multi-tenant funcionando
- ‚úÖ Edge Functions deployadas
- ‚úÖ RLS implementado
- ‚úÖ Sistema de convites completo
- ‚úÖ Novo sistema de cadastro

### Pontos Fracos:
- üî¥ Muitos dados mockados (60% da interface)
- üî¥ Billing n√£o integrado
- üî¥ Sem checkout de pagamento
- üü° Performance RLS pode melhorar
- üü° Falta audit log

### Pronto para Checkout?
**SIM**, mas precisa:
1. Escolher gateway (Stripe/Asaas)
2. Definir planos e pre√ßos
3. Criar p√°ginas de checkout (aguardando imagens)
4. Remover dados mockados cr√≠ticos

### Recomenda√ß√£o:
**Seguir Fase 1 e Fase 2 do Plano de A√ß√£o antes de produ√ß√£o.**

---

**Auditoria completa! Pronto para pr√≥ximos passos! üöÄ**

**Aguardando imagens do checkout para implementar!**

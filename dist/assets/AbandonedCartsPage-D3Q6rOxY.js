import{s as n,r as x,f as A,u as T,j as e,g as f,h as j,i as p,D as N,l as g,S as q,I as E,n as R,B}from"./index-DQQKXQmv.js";import{T as D,a as O,b as S,c as u,d as k,e as h}from"./table-BQnPOjhr.js";import{S as v}from"./skeleton-DOhPQ-ow.js";import{C as L}from"./clock-Cr-6OxDQ.js";import{M as I}from"./mail-KjfGuuhJ.js";const P={async getById(s){const{data:a,error:t}=await n.from("Cart").select(`
        *,
        items:CartItem(*)
      `).eq("id",s).single();if(t)throw t;return a},async getBySession(s){const{data:a,error:t}=await n.from("Cart").select(`
        *,
        items:CartItem(*)
      `).eq("sessionId",s).order("createdAt",{ascending:!1}).limit(1).single();if(t){if(t.code==="PGRST116")return null;throw t}return a},async getByCustomer(s){const{data:a,error:t}=await n.from("Cart").select(`
        *,
        items:CartItem(*)
      `).eq("customerId",s).order("createdAt",{ascending:!1}).limit(1).single();if(t){if(t.code==="PGRST116")return null;throw t}return a},async create(s){const{data:a,error:t}=await n.from("Cart").insert(s).select().single();if(t)throw t;return a},async update(s,a){const{data:t,error:o}=await n.from("Cart").update({...a,updatedAt:new Date().toISOString()}).eq("id",s).select().single();if(o)throw o;return t},async applyCoupon(s,a,t){const{data:o,error:i}=await n.from("Cart").update({couponCode:a,discount:t,updatedAt:new Date().toISOString()}).eq("id",s).select().single();if(i)throw i;return o},async removeCoupon(s){const{data:a,error:t}=await n.from("Cart").update({couponCode:null,discount:0,updatedAt:new Date().toISOString()}).eq("id",s).select().single();if(t)throw t;return a},async clear(s){const{error:a}=await n.from("CartItem").delete().eq("cartId",s);if(a)throw a;const{data:t,error:o}=await n.from("Cart").update({subtotal:0,discount:0,shipping:0,tax:0,total:0,updatedAt:new Date().toISOString()}).eq("id",s).select().single();if(o)throw o;return t},async delete(s){const{error:a}=await n.from("Cart").delete().eq("id",s);if(a)throw a},async recalculate(s){const{data:a,error:t}=await n.from("Cart").select(`
        *,
        items:CartItem(*)
      `).eq("id",s).single();if(t)throw t;const i=(a.items||[]).reduce((y,r)=>y+r.price*r.quantity,0),w=a.discount||0,c=a.shipping||0,d=a.tax||0,C=i-w+c+d,{data:b,error:m}=await n.from("Cart").update({subtotal:i,total:C,updatedAt:new Date().toISOString()}).eq("id",s).select().single();if(m)throw m;return b}},M=()=>{const[s,a]=x.useState([]),[t,o]=x.useState(!0),[i,w]=x.useState(""),{toast:c}=A(),d=T(r=>r.user);x.useEffect(()=>{C()},[]);const C=async()=>{try{if(!(d!=null&&d.organizationId))return;const r=await P.abandoned.list(d.organizationId);a(r)}catch(r){c({title:"Erro ao carregar",description:r.message,variant:"destructive"})}finally{o(!1)}},b=async r=>{try{c({title:"Email de recuperação enviado!"})}catch(l){c({title:"Erro",description:l.message,variant:"destructive"})}},m=s.filter(r=>{var l;return(l=r.customerEmail)==null?void 0:l.toLowerCase().includes(i.toLowerCase())}),y=s.reduce((r,l)=>r+l.total,0);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Carrinhos Abandonados"}),e.jsx("p",{className:"text-muted-foreground",children:"Recupere vendas de carrinhos abandonados"})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsxs(f,{children:[e.jsxs(j,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(p,{className:"text-sm font-medium",children:"Total Abandonados"}),e.jsx(N,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(g,{children:e.jsx("div",{className:"text-2xl font-bold",children:s.length})})]}),e.jsxs(f,{children:[e.jsxs(j,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(p,{className:"text-sm font-medium",children:"Valor Total"}),e.jsx(L,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(g,{children:e.jsxs("div",{className:"text-2xl font-bold",children:["R$ ",y.toFixed(2)]})})]}),e.jsxs(f,{children:[e.jsxs(j,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(p,{className:"text-sm font-medium",children:"Taxa Recuperação"}),e.jsx(I,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(g,{children:e.jsx("div",{className:"text-2xl font-bold",children:"-"})})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(E,{placeholder:"Buscar por email...",value:i,onChange:r=>w(r.target.value),className:"pl-9"})]}),e.jsxs(f,{children:[e.jsx(j,{children:e.jsx(p,{children:"Lista de Carrinhos"})}),e.jsx(g,{children:t?e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{className:"h-12 w-full"}),e.jsx(v,{className:"h-12 w-full"})]}):m.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(N,{className:"h-12 w-12 text-muted-foreground mb-4 mx-auto"}),e.jsx("h3",{className:"text-lg font-semibold",children:"Nenhum carrinho abandonado"})]}):e.jsxs(D,{children:[e.jsx(O,{children:e.jsxs(S,{children:[e.jsx(u,{children:"Email"}),e.jsx(u,{children:"Produtos"}),e.jsx(u,{children:"Valor"}),e.jsx(u,{children:"Abandonado há"}),e.jsx(u,{children:"Ações"})]})}),e.jsx(k,{children:m.map(r=>e.jsxs(S,{children:[e.jsx(h,{children:r.customerEmail}),e.jsxs(h,{children:[r.itemCount," items"]}),e.jsxs(h,{children:["R$ ",r.total.toFixed(2)]}),e.jsx(h,{children:e.jsxs(R,{variant:"outline",children:[r.abandonedDays,"d"]})}),e.jsx(h,{children:e.jsxs(B,{size:"sm",onClick:()=>b(r.id),children:[e.jsx(I,{className:"h-4 w-4 mr-2"}),"Recuperar"]})})]},r.id))})]})})]})]})};export{M as default};

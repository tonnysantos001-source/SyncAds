import{c as Y,s as D,r as C,b as ee,u as te,j as e,M as S,B as A,a6 as q,I as b,S as ae,d as $,e as G,f as O,h as H,n as se}from"./index-BG2-EjYz.js";import{S as re}from"./switch-CF1Z95KB.js";import{T as ie,a as oe,b as ne,c as N,d as le,e as w}from"./table-DbNfEFq1.js";import{D as ce,a as de,b as ue,c as me,d as pe,f as ge}from"./dialog-BneTg7BA.js";import{L as v}from"./label-BaplfQ40.js";import{S as he,a as xe,b as fe,c as ye,d as T}from"./select-C_W93U7I.js";import{m as L}from"./marketingApi-pe6NZ27B.js";import{a as ve}from"./shopifySync-DQF64yT5.js";import{S as je}from"./skeleton-BYk31VVR.js";import{P as B}from"./plus-LJP0SZvt.js";import{T as Ce}from"./trending-up-BSolS8YE.js";import{U as be}from"./users-CJOeUxVr.js";import{P as V}from"./percent-B3IWdqle.js";import{D as Ae}from"./dollar-sign-Cl8V-y3w.js";import{S as Ne}from"./square-pen-CALbgAcF.js";import{T as we}from"./trash-2-Bi201oHe.js";import{f as Se,p as De}from"./pt-BR-BQ5kKd2v.js";import"./index-l7U3HNJg.js";import"./x-B9bG8ALD.js";import"./constructFrom-rJN6zrQ_.js";/**
 * @license lucide-react v0.417.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const R=Y("Ticket",[["path",{d:"M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z",key:"qn84l0"}],["path",{d:"M13 5v2",key:"dyzc3o"}],["path",{d:"M13 17v2",key:"1ont0d"}],["path",{d:"M13 11v2",key:"1wjjxi"}]]),ke={async listFromShopify(i,r){try{let a=D.from("ShopifyDiscountCode").select(`
          *,
          priceRule:ShopifyPriceRule!ShopifyDiscountCode_priceRuleId_fkey(*)
        `).eq("userId",i).order("updatedAt",{ascending:!1});r!=null&&r.search&&(a=a.ilike("code",`%${r.search}%`));const{data:c,error:s}=await a;if(s)throw s;let d=(c||[]).map(l=>{const o=l.priceRule,u=new Date,p=o.startsAt?new Date(o.startsAt):null,f=o.endsAt?new Date(o.endsAt):null;let g="active",x=!0;return p&&u<p?(g="scheduled",x=!1):f&&u>f?(g="expired",x=!1):o.usageLimit&&l.usageCount>=o.usageLimit&&(g="exhausted",x=!1),{id:String(l.id),code:l.code,title:o.title,type:o.targetType==="shipping_line"?"free_shipping":o.valueType==="percentage"?"percentage":"fixed_amount",value:parseFloat(o.value),usageCount:l.usageCount||0,usageLimit:o.usageLimit||void 0,startsAt:o.startsAt||void 0,endsAt:o.endsAt||void 0,status:g,isValid:x,metadata:{shopifyId:l.id,priceRuleId:o.id,shopifyData:l.shopifyData,priceRuleData:o.shopifyData,targetType:o.targetType,targetSelection:o.targetSelection,allocationMethod:o.allocationMethod,oncePerCustomer:o.oncePerCustomer},createdAt:l.createdAt,updatedAt:l.updatedAt}});return r!=null&&r.status&&(d=d.filter(l=>l.status===r.status)),d}catch(a){throw console.error("Error listing Shopify discounts:",a),a}},async getByCode(i,r){try{const{data:a,error:c}=await D.from("ShopifyDiscountCode").select(`
          *,
          priceRule:ShopifyPriceRule!ShopifyDiscountCode_priceRuleId_fkey(*)
        `).eq("userId",i).ilike("code",r).single();if(c)return console.error("Error getting discount by code:",c),null;if(!a)return null;const s=a.priceRule,d=new Date,l=s.startsAt?new Date(s.startsAt):null,o=s.endsAt?new Date(s.endsAt):null;let u="active",p=!0;return l&&d<l?(u="scheduled",p=!1):o&&d>o?(u="expired",p=!1):s.usageLimit&&a.usageCount>=s.usageLimit&&(u="exhausted",p=!1),{id:String(a.id),code:a.code,title:s.title,type:s.targetType==="shipping_line"?"free_shipping":s.valueType==="percentage"?"percentage":"fixed_amount",value:parseFloat(s.value),usageCount:a.usageCount||0,usageLimit:s.usageLimit||void 0,startsAt:s.startsAt||void 0,endsAt:s.endsAt||void 0,status:u,isValid:p,metadata:{shopifyId:a.id,priceRuleId:s.id,shopifyData:a.shopifyData,priceRuleData:s.shopifyData,targetType:s.targetType,targetSelection:s.targetSelection,allocationMethod:s.allocationMethod,oncePerCustomer:s.oncePerCustomer},createdAt:a.createdAt,updatedAt:a.updatedAt}}catch(a){return console.error("Error getting discount by code:",a),null}},async validateCode(i,r){try{const a=await this.getByCode(i,r);if(!a)return{valid:!1,reason:"Código não encontrado"};if(!a.isValid){if(a.status==="scheduled")return{valid:!1,reason:"Código ainda não está ativo"};if(a.status==="expired")return{valid:!1,reason:"Código expirado"};if(a.status==="exhausted")return{valid:!1,reason:"Código atingiu limite de uso"}}return{valid:!0,discount:a}}catch(a){return console.error("Error validating discount code:",a),{valid:!1,reason:"Erro ao validar código"}}},calculateDiscount(i,r,a=0){if(!i.isValid)return 0;const c=i.metadata||{};if(i.type==="free_shipping")return a;const s=c.targetType==="shipping_line"?a:r;if(i.type==="percentage"){const d=s*i.value/100;return Math.min(d,s)}else return Math.min(i.value,s)},async getStats(i){try{const{data:r,error:a}=await D.from("ShopifyDiscountCode").select(`
          usageCount,
          priceRule:ShopifyPriceRule!ShopifyDiscountCode_priceRuleId_fkey(usageLimit, startsAt, endsAt)
        `).eq("userId",i);if(a)throw a;const c=new Date;let s=0,d=0,l=0,o=0,u=0;return(r||[]).forEach(p=>{const f=p.priceRule,g=f.startsAt?new Date(f.startsAt):null,x=f.endsAt?new Date(f.endsAt):null;u+=p.usageCount||0,g&&c<g?d++:x&&c>x?l++:f.usageLimit&&p.usageCount>=f.usageLimit?o++:s++}),{total:(r==null?void 0:r.length)||0,active:s,scheduled:d,expired:l,exhausted:o,totalUsage:u}}catch(r){return console.error("Error getting discount stats:",r),{total:0,active:0,scheduled:0,expired:0,exhausted:0,totalUsage:0}}},async count(i){try{const{count:r,error:a}=await D.from("ShopifyDiscountCode").select("*",{count:"exact",head:!0}).eq("userId",i);if(a)throw a;return r||0}catch(r){return console.error("Error counting Shopify discounts:",r),0}},async incrementUsage(i,r){try{const a=await this.getByCode(i,r);if(!a||!a.isValid)return!1;const{error:c}=await D.from("ShopifyDiscountCode").update({usageCount:(a.usageCount||0)+1,updatedAt:new Date().toISOString()}).eq("id",a.id);if(c)throw c;return!0}catch(a){return console.error("Error incrementing discount usage:",a),!1}}},E=({title:i,value:r,icon:a,color:c,delay:s=0,subtitle:d})=>e.jsx(S.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:s},children:e.jsxs($,{className:"relative overflow-hidden border-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl shadow-lg hover:shadow-xl transition-all duration-300",children:[e.jsx("div",{className:`absolute top-0 right-0 w-32 h-32 ${c} opacity-10 rounded-full blur-3xl`}),e.jsxs(G,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(O,{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:i}),e.jsx("div",{className:`p-2 rounded-lg ${c} bg-opacity-10`,children:e.jsx(a,{className:`h-5 w-5 ${c.replace("bg-","text-")}`})})]}),e.jsxs(H,{children:[e.jsx("div",{className:"text-3xl font-bold bg-gradient-to-br from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent",children:r}),d&&e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:d})]})]})}),Je=()=>{const[i,r]=C.useState([]),[a,c]=C.useState([]),[s,d]=C.useState(!0),[l,o]=C.useState(!1),[u,p]=C.useState(""),[f,g]=C.useState(!1),[x,I]=C.useState(null),{toast:y}=ee(),m=te(t=>t.user),[n,h]=C.useState({code:"",name:"",type:"PERCENTAGE",value:0,minPurchaseAmount:0,maxDiscountAmount:0,usageLimit:0,perCustomerLimit:1,startsAt:"",expiresAt:"",isActive:!0});C.useEffect(()=>{m!=null&&m.id&&k()},[m==null?void 0:m.id]),C.useEffect(()=>{X()},[u,i]);const k=async()=>{if(!(m!=null&&m.id)){d(!1);return}try{d(!0);const t=await ke.listFromShopify(m.id);r(t),c(t)}catch(t){console.error("Erro ao carregar cupons:",t),y({title:"Erro ao carregar cupons",description:t.message,variant:"destructive"})}finally{d(!1)}},P=async()=>{if(!(m!=null&&m.id)){y({title:"Erro",description:"Faça login para sincronizar",variant:"destructive"});return}try{o(!0),y({title:"Sincronizando...",description:"Buscando descontos da Shopify"});const t=await ve.syncDiscounts(m.id);t.success?(y({title:"Sincronização concluída!",description:t.message}),await k()):y({title:"Erro na sincronização",description:t.message,variant:"destructive"})}catch{y({title:"Erro ao sincronizar",description:"Configure a integração Shopify em Integrações",variant:"destructive"})}finally{o(!1)}},X=()=>{if(!u){c(i);return}const t=i.filter(j=>{var _,U;return((_=j.code)==null?void 0:_.toLowerCase().includes(u.toLowerCase()))||((U=j.name)==null?void 0:U.toLowerCase().includes(u.toLowerCase()))});c(t)},Z=async t=>{t.preventDefault();try{if(!(m!=null&&m.organizationId))return;x?(await L.coupons.update(x.id,n),y({title:"Cupom atualizado!",description:"As alterações foram salvas."})):(await L.coupons.create({...n,organizationId:m.organizationId,usageCount:0}),y({title:"Cupom criado!",description:"O cupom está pronto para uso."})),g(!1),z(),k()}catch(j){y({title:"Erro",description:j.message,variant:"destructive"})}},J=async t=>{if(confirm("Tem certeza que deseja deletar este cupom?"))try{await L.coupons.delete(t),y({title:"Cupom deletado"}),k()}catch(j){y({title:"Erro ao deletar",description:j.message,variant:"destructive"})}},K=t=>{I(t),h({code:t.code,name:t.name,type:t.type,value:t.value,minPurchaseAmount:t.minPurchaseAmount||0,maxDiscountAmount:t.maxDiscountAmount||0,usageLimit:t.usageLimit||0,perCustomerLimit:t.perCustomerLimit||1,startsAt:t.startsAt||"",expiresAt:t.expiresAt||"",isActive:t.isActive}),g(!0)},z=()=>{I(null),h({code:"",name:"",type:"PERCENTAGE",value:0,minPurchaseAmount:0,maxDiscountAmount:0,usageLimit:0,perCustomerLimit:1,startsAt:"",expiresAt:"",isActive:!0})},Q=t=>new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(t),W=t=>t.type==="PERCENTAGE"?`${t.value}%`:t.type==="FIXED_AMOUNT"?Q(t.value):"Frete Grátis",F=i.reduce((t,j)=>t+(j.usageCount||0),0),M=i.filter(t=>t.isActive).length;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(S.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-5xl font-black bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 dark:from-blue-400 dark:via-purple-400 dark:to-pink-400 bg-clip-text text-transparent mb-2",children:"Cupons de Desconto"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-300 font-medium text-lg",children:"Gerencie cupons sincronizados com Shopify"})]}),e.jsxs(S.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},transition:{duration:.5,delay:.2},className:"flex gap-3",children:[e.jsxs(A,{onClick:P,disabled:l,variant:"outline",size:"lg",className:"border-2 hover:border-purple-500",children:[e.jsx(q,{className:`mr-2 h-5 w-5 ${l?"animate-spin":""}`}),l?"Sincronizando...":"Sincronizar Shopify"]}),e.jsxs(ce,{open:f,onOpenChange:g,children:[e.jsx(de,{asChild:!0,children:e.jsxs(A,{onClick:z,size:"lg",className:"bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700",children:[e.jsx(B,{className:"mr-2 h-5 w-5"}),"Criar Cupom"]})}),e.jsxs(ue,{className:"max-w-2xl bg-white/95 dark:bg-gray-900/95 backdrop-blur-xl",children:[e.jsx(me,{children:e.jsx(pe,{className:"text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent",children:x?"Editar Cupom":"Novo Cupom"})}),e.jsxs("form",{onSubmit:Z,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(v,{children:"Código *"}),e.jsx(b,{value:n.code,onChange:t=>h({...n,code:t.target.value.toUpperCase()}),placeholder:"DESCONTO20",className:"mt-1.5",required:!0})]}),e.jsxs("div",{children:[e.jsx(v,{children:"Nome *"}),e.jsx(b,{value:n.name,onChange:t=>h({...n,name:t.target.value}),placeholder:"Nome do cupom",className:"mt-1.5",required:!0})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(v,{children:"Tipo de Desconto"}),e.jsxs(he,{value:n.type,onValueChange:t=>h({...n,type:t}),children:[e.jsx(xe,{className:"mt-1.5",children:e.jsx(fe,{})}),e.jsxs(ye,{children:[e.jsx(T,{value:"PERCENTAGE",children:"Percentual (%)"}),e.jsx(T,{value:"FIXED_AMOUNT",children:"Valor Fixo (R$)"}),e.jsx(T,{value:"FREE_SHIPPING",children:"Frete Grátis"})]})]})]}),e.jsxs("div",{children:[e.jsx(v,{children:"Valor"}),e.jsx(b,{type:"number",step:"0.01",value:n.value,onChange:t=>h({...n,value:parseFloat(t.target.value)}),placeholder:"0.00",className:"mt-1.5",required:!0})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(v,{children:"Compra Mínima (R$)"}),e.jsx(b,{type:"number",step:"0.01",value:n.minPurchaseAmount,onChange:t=>h({...n,minPurchaseAmount:parseFloat(t.target.value)}),className:"mt-1.5"})]}),e.jsxs("div",{children:[e.jsx(v,{children:"Desconto Máximo (R$)"}),e.jsx(b,{type:"number",step:"0.01",value:n.maxDiscountAmount,onChange:t=>h({...n,maxDiscountAmount:parseFloat(t.target.value)}),className:"mt-1.5"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(v,{children:"Limite Total de Uso"}),e.jsx(b,{type:"number",value:n.usageLimit,onChange:t=>h({...n,usageLimit:parseInt(t.target.value)}),placeholder:"0 = ilimitado",className:"mt-1.5"})]}),e.jsxs("div",{children:[e.jsx(v,{children:"Limite por Cliente"}),e.jsx(b,{type:"number",value:n.perCustomerLimit,onChange:t=>h({...n,perCustomerLimit:parseInt(t.target.value)}),className:"mt-1.5"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(v,{children:"Data de Início"}),e.jsx(b,{type:"datetime-local",value:n.startsAt,onChange:t=>h({...n,startsAt:t.target.value}),className:"mt-1.5"})]}),e.jsxs("div",{children:[e.jsx(v,{children:"Data de Expiração"}),e.jsx(b,{type:"datetime-local",value:n.expiresAt,onChange:t=>h({...n,expiresAt:t.target.value}),className:"mt-1.5"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(re,{checked:n.isActive,onCheckedChange:t=>h({...n,isActive:t})}),e.jsx(v,{children:"Cupom Ativo"})]}),e.jsxs(ge,{className:"mt-6",children:[e.jsx(A,{type:"button",variant:"outline",onClick:()=>g(!1),children:"Cancelar"}),e.jsxs(A,{type:"submit",className:"bg-gradient-to-r from-blue-600 to-purple-600",children:[x?"Atualizar":"Criar"," Cupom"]})]})]})]})]})]})]}),e.jsxs("div",{className:"grid gap-6 md:grid-cols-2 lg:grid-cols-4",children:[e.jsx(E,{title:"Total de Cupons",value:i.length,icon:R,color:"bg-blue-500",delay:.1}),e.jsx(E,{title:"Cupons Ativos",value:M,icon:Ce,color:"bg-green-500",delay:.2,subtitle:`${(M/i.length*100||0).toFixed(0)}% do total`}),e.jsx(E,{title:"Usos Totais",value:F,icon:be,color:"bg-purple-500",delay:.3}),e.jsx(E,{title:"Média de Uso",value:(F/i.length||0).toFixed(1),icon:V,color:"bg-pink-500",delay:.4,subtitle:"por cupom"})]}),e.jsxs(S.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.5},className:"relative",children:[e.jsx(ae,{className:"absolute left-4 top-1/2 h-5 w-5 -translate-y-1/2 text-gray-400"}),e.jsx(b,{placeholder:"Buscar por código ou nome...",value:u,onChange:t=>p(t.target.value),className:"pl-12 h-12 border-0 bg-white/80 dark:bg-gray-800/80 backdrop-blur-xl shadow-lg"})]}),e.jsx(S.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.6},children:e.jsxs($,{className:"border-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl shadow-lg",children:[e.jsx(G,{children:e.jsx(O,{className:"text-2xl font-bold bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent",children:"Lista de Cupons"})}),e.jsx(H,{children:s?e.jsx("div",{className:"space-y-3",children:[1,2,3,4,5].map(t=>e.jsx(je,{className:"h-16 w-full"},t))}):a.length===0?e.jsxs(S.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"flex flex-col items-center justify-center py-16",children:[e.jsxs("div",{className:"relative mb-6",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 opacity-20 blur-3xl rounded-full"}),e.jsx(R,{className:"relative h-20 w-20 text-gray-400"})]}),e.jsx("h3",{className:"text-2xl font-bold mb-2",children:"Nenhum cupom encontrado"}),e.jsx("p",{className:"text-gray-500 mb-6",children:u?"Tente ajustar os filtros":"Sincronize com Shopify ou crie um cupom"}),!u&&e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(A,{onClick:P,disabled:l,variant:"outline",size:"lg",children:[e.jsx(q,{className:`mr-2 h-5 w-5 ${l?"animate-spin":""}`}),"Sincronizar Shopify"]}),e.jsxs(A,{onClick:()=>g(!0),size:"lg",className:"bg-gradient-to-r from-blue-600 to-purple-600",children:[e.jsx(B,{className:"mr-2 h-5 w-5"}),"Criar Cupom"]})]})]}):e.jsxs(ie,{children:[e.jsx(oe,{children:e.jsxs(ne,{children:[e.jsx(N,{children:"Código"}),e.jsx(N,{children:"Nome"}),e.jsx(N,{children:"Desconto"}),e.jsx(N,{children:"Usos"}),e.jsx(N,{children:"Validade"}),e.jsx(N,{children:"Status"}),e.jsx(N,{className:"text-right",children:"Ações"})]})}),e.jsx(le,{children:a.map((t,j)=>e.jsxs(S.tr,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:j*.05},className:"hover:bg-gray-50 dark:hover:bg-gray-800/50",children:[e.jsx(w,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center",children:e.jsx(R,{className:"h-5 w-5 text-white"})}),e.jsx("span",{className:"font-mono font-semibold",children:t.code})]})}),e.jsx(w,{className:"font-medium",children:t.name}),e.jsx(w,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[t.type==="PERCENTAGE"?e.jsx(V,{className:"h-4 w-4 text-green-500"}):e.jsx(Ae,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{className:"font-semibold",children:W(t)})]})}),e.jsxs(w,{children:[t.usageCount||0,t.usageLimit?` / ${t.usageLimit}`:""]}),e.jsx(w,{className:"text-sm",children:t.expiresAt?Se(new Date(t.expiresAt),"dd/MM/yyyy",{locale:De}):"Sem expiração"}),e.jsx(w,{children:e.jsx(se,{className:t.isActive?"bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400":"bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-400",children:t.isActive?"Ativo":"Inativo"})}),e.jsx(w,{className:"text-right",children:e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(A,{variant:"ghost",size:"icon",onClick:()=>K(t),className:"hover:bg-blue-100 dark:hover:bg-blue-900/30",children:e.jsx(Ne,{className:"h-4 w-4"})}),e.jsx(A,{variant:"ghost",size:"icon",onClick:()=>J(t.id),className:"hover:bg-red-100 dark:hover:bg-red-900/30",children:e.jsx(we,{className:"h-4 w-4"})})]})})]},t.id))})]})})]})})]})};export{Je as default};

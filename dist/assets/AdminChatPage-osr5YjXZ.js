import{j as e}from"./vendor-ui-D3JNL6pE.js";import{r as t}from"./vendor-react-X41Bjl18.js";import{g as a,B as s,L as r,M as o,w as i,N as n,O as c,P as l,e as d,y as m,C as u,c as h,Q as p,R as x,s as g}from"./index-CSfOwV7D.js";import{T as f}from"./textarea-DNMw6Fcn.js";import{S as v}from"./SuperAdminLayout-BSQSa0m5.js";import{A as w}from"./AiThinkingIndicator-B6kghmFZ.js";import"./vendor-supabase-HUq0BeMy.js";import"./vendor-utils-Dl0_yMKq.js";import"./vendor-animation-DtB50Lbk.js";import"./vendor-query-DqG_mm-v.js";import"./vendor-icons-DiMyZvwG.js";function j(){const{toast:j}=a(),[b,N]=t.useState([]),[y,I]=t.useState(""),[C,A]=t.useState(!1),[S,k]=t.useState(null),[E,T]=t.useState([]),[z,J]=t.useState(!0),U=t.useRef(null),[q,D]=t.useState(null),[O,M]=t.useState(""),[R,L]=t.useState([]),Z=async()=>{try{const{data:{user:e}}=await g.auth.getUser();if(!e)return;const{data:t,error:a}=await g.from("ChatConversation").select("id, title, createdAt, updatedAt").eq("userId",e.id).order("updatedAt",{ascending:!1}).limit(20);if(a)throw a;T(t||[])}catch(e){}},$=async e=>{try{const{data:t,error:a}=await g.from("ChatMessage").select("id, role, content, createdAt").eq("conversationId",e).order("createdAt",{ascending:!0});if(a)throw a;const s=(t||[]).map(e=>({id:e.id,role:e.role,content:e.content,timestamp:new Date(e.createdAt)}));N(s),k(e)}catch(t){j({title:"Erro",description:"N√£o foi poss√≠vel carregar mensagens.",variant:"destructive"})}};t.useEffect(()=>{(async()=>{try{const{data:{user:e},error:t}=await g.auth.getUser();if(t||!e)return j({title:"Erro de autentica√ß√£o",description:"Voc√™ precisa fazer login novamente.",variant:"destructive"}),void(window.location.href="/login");await Z();const{data:a,error:s}=await g.from("ChatConversation").select("id, title, createdAt, updatedAt").eq("userId",e.id).order("updatedAt",{ascending:!1}).limit(1).single();a&&(k(a.id),await $(a.id))}catch(e){}})()},[]),t.useEffect(()=>{U.current?.scrollIntoView({behavior:"smooth"})},[b]);const _=async()=>{if(!y.trim()||C||!S)return;const e=y.trim();I(""),A(!0);try{if(!S)throw new Error("Conversa n√£o inicializada");const t=S,a={id:`temp-${Date.now()}`,role:"USER",content:e,timestamp:new Date};N(e=>[...e,a]);const s=function(e){const t=e.toLowerCase();return t.includes("conecte facebook")||t.includes("conecte o facebook")||t.includes("facebook ads")?"facebook":t.includes("conecte google")||t.includes("google ads")?"google":t.includes("conecte linkedin")?"linkedin":t.includes("conecte tiktok")?"tiktok":null}(e),r=await(async(e,t)=>{try{const a=e.toLowerCase();let s=null,r="";if(a.includes("pesquis")||a.includes("busca")||a.includes("google")||a.includes("internet")){s="web_search";let t=e;if(a.includes("pesquis")){const a=e.match(/pesquis[ae]\s+(.+)/i);t=a?a[1]:e}r=`Pesquisando na web sobre: "${t}"`,D("web_search"),M(r),L(["Google Search","Exa AI","Tavily"])}else if(a.includes("baix")||a.includes("rasp")||a.includes("scrape")){s="web_scraping";const t=e.match(/https?:\/\/[^\s]+/i),a=t?t[0]:"URL n√£o especificada";r=`Raspando dados de: ${a}`,D("web_scraping"),M(r),L([a])}else a.includes("python")||a.includes("calcule")||a.includes("execute c√≥digo")?(s="python_exec",r="Executando c√≥digo Python para processar dados...",D("python_exec"),M(r)):(D(null),M("Processando sua solicita√ß√£o..."),L([]));const{data:{session:o}}=await g.auth.getSession();if(!o)throw new Error("N√£o autenticado");const i="https://ovskepqggmxlfckxqgbr.supabase.co/functions/v1/chat-enhanced",n=b.map(e=>({role:e.role.toLowerCase(),content:e.content})),c=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o.access_token}`,apikey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92c2tlcHFnZ214bGZja3hxZ2JyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MjQ4NTUsImV4cCI6MjA3NjQwMDg1NX0.UdNgqpTN38An6FuoJPZlj_zLkmAqfJQXb6i1DdTQO_E"},body:JSON.stringify({message:e,conversationId:t,conversationHistory:n,systemPrompt:void 0})});if(!c.ok){const e=await c.json();throw new Error(e.error||"Erro ao processar mensagem")}const l=await c.json();return l.error?`‚ö†Ô∏è ${l.response||l.error}`:l.response&&"Sem resposta da IA"!==l.response?(D(null),M(""),L([]),l.response):"‚ö†Ô∏è IA n√£o configurada ou sem resposta. Configure uma IA em Configura√ß√µes > IA Global."}catch(a){return D(null),M(""),L([]),`‚ùå Erro: ${a.message}`}})(e,t),o={id:`temp-${Date.now()+1}`,role:"ASSISTANT",content:r,timestamp:new Date,metadata:s?{oauthAction:{platform:s,action:"connect"}}:void 0};N(e=>[...e,o])}catch(t){const e={id:`error-${Date.now()}`,role:"ASSISTANT",content:`‚ùå ERRO DETALHADO:\n\n${t.message}\n\n${t.stack||"Sem stack trace"}\n\n${JSON.stringify(t,null,2)}`,timestamp:new Date};N(t=>[...t,e]),j({title:"Erro ao processar",description:t.message,variant:"destructive"})}finally{A(!1)}};return e.jsx(v,{children:e.jsxs("div",{className:"h-[calc(100vh-80px)] flex",children:[e.jsxs("div",{className:(z?"w-72":"w-0")+" transition-all duration-300 bg-gray-900/50 border-r border-gray-700/50 flex flex-col overflow-hidden",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-sm font-semibold text-gray-300",children:"Conversas"}),e.jsx(s,{onClick:()=>J(!1),variant:"ghost",size:"sm",className:"h-7 w-7 p-0",children:e.jsx(r,{className:"h-4 w-4"})})]}),e.jsxs(s,{onClick:async()=>{try{const{data:{user:e}}=await g.auth.getUser();if(!e)return;const t=crypto.randomUUID(),a=(new Date).toISOString(),{error:s}=await g.from("ChatConversation").insert({id:t,userId:e.id,title:"üÜï Nova Conversa",createdAt:a,updatedAt:a});if(s)throw s;N([]),k(t),await Z(),j({title:"‚úÖ Nova conversa criada!",description:"Comece um novo chat do zero."})}catch(e){j({title:"Erro",description:e.message||"N√£o foi poss√≠vel criar nova conversa.",variant:"destructive"})}},className:"w-full gap-2",size:"sm",children:[e.jsx(o,{className:"h-4 w-4"}),"Nova Conversa"]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-2 space-y-1",children:E.map(t=>e.jsxs("div",{className:"group relative flex items-center gap-2 p-3 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors "+(S===t.id?"bg-blue-50 border border-blue-200":"bg-white"),onClick:()=>$(t.id),children:[e.jsx(i,{className:"h-4 w-4 text-gray-400 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:t.title}),e.jsx("p",{className:"text-xs text-gray-400",children:new Date(t.updatedAt).toLocaleDateString("pt-BR")})]}),e.jsx(s,{onClick:e=>{e.stopPropagation(),(async e=>{try{await g.from("ChatMessage").delete().eq("conversationId",e),await g.from("ChatConversation").delete().eq("id",e),S===e&&(N([]),k(null)),await Z(),j({title:"‚úÖ Conversa deletada!",description:"Conversa removida com sucesso."})}catch(t){j({title:"Erro",description:"N√£o foi poss√≠vel deletar conversa.",variant:"destructive"})}})(t.id)},variant:"ghost",size:"sm",className:"h-7 w-7 p-0 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx(n,{className:"h-3.5 w-3.5 text-red-500"})})]},t.id))})]}),e.jsxs("div",{className:"flex-1 flex flex-col",children:[e.jsx("div",{className:"border-b border-gray-700/50 bg-gray-900/50 backdrop-blur-xl p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[!z&&e.jsx(s,{onClick:()=>J(!0),variant:"ghost",size:"sm",className:"h-9 w-9 p-0",children:e.jsx(c,{className:"h-5 w-5"})}),e.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-r from-blue-500 to-purple-500",children:e.jsx(l,{className:"h-6 w-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold text-gray-900",children:"Chat Administrativo"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Chat com IA"})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(s,{onClick:async()=>{if(S)try{await g.from("ChatMessage").delete().eq("conversationId",S),N([]),j({title:"‚úÖ Mensagens limpas!",description:"Chat limpo com sucesso."})}catch(e){j({title:"Erro",description:"N√£o foi poss√≠vel limpar mensagens.",variant:"destructive"})}},variant:"outline",size:"sm",className:"gap-2 hover:bg-red-50 hover:border-red-300",children:[e.jsx(n,{className:"h-4 w-4 text-red-500"}),"Limpar Chat"]}),e.jsxs(d,{className:"bg-gradient-to-r from-green-500 to-emerald-500",children:[e.jsx(m,{className:"h-3 w-3 mr-1"}),"Online"]})]})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[b.map(t=>e.jsx("div",{className:"flex "+("USER"===t.role?"justify-end":"justify-start"),children:e.jsx(u,{className:"max-w-[80%] "+("USER"===t.role?"bg-gradient-to-r from-blue-500 to-purple-500 text-white":"SYSTEM"===t.role?"bg-gradient-to-r from-amber-50 to-orange-50 border-amber-200":"bg-white"),children:e.jsxs(h,{className:"p-4",children:[e.jsxs("div",{className:"flex items-start gap-2",children:["ASSISTANT"===t.role&&e.jsx(l,{className:"h-5 w-5 text-blue-600 mt-1 flex-shrink-0"}),"SYSTEM"===t.role&&e.jsx(m,{className:"h-5 w-5 text-amber-600 mt-1 flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"whitespace-pre-wrap break-words text-sm "+("USER"===t.role?"text-white":"text-gray-900"),children:t.content}),t.metadata?.oauthAction&&e.jsxs(s,{onClick:()=>(async e=>{try{const{data:{user:t}}=await g.auth.getUser();if(!t)throw new Error("Usu√°rio n√£o autenticado");const a="https://ovskepqggmxlfckxqgbr.supabase.co/functions/v1/oauth-init",{data:{session:s}}=await g.auth.getSession();if(!s)throw new Error("N√£o autenticado");const r=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s.access_token}`,apikey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92c2tlcHFnZ214bGZja3hxZ2JyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MjQ4NTUsImV4cCI6MjA3NjQwMDg1NX0.UdNgqpTN38An6FuoJPZlj_zLkmAqfJQXb6i1DdTQO_E"},body:JSON.stringify({platform:e,redirectUrl:`${window.location.origin}/integrations/callback`})});if(!r.ok)throw new Error("Erro ao iniciar OAuth");const{authUrl:o}=await r.json();window.open(o,"_blank"),j({title:"üîó Autoriza√ß√£o Necess√°ria",description:`Abra a nova aba para autorizar ${e}`})}catch(t){j({title:"Erro ao conectar",description:t.message,variant:"destructive"})}})(t.metadata.oauthAction.platform),className:"mt-3 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600",size:"sm",children:["Conectar ",t.metadata.oauthAction.platform]})]})]}),e.jsx("div",{className:"text-xs mt-2 "+("USER"===t.role?"text-white/70":"text-gray-400"),children:t.timestamp.toLocaleTimeString("pt-BR")})]})})},t.id)),C&&e.jsx(w,{isThinking:C,currentTool:q,reasoning:O,sources:R}),C&&e.jsx("div",{className:"flex justify-start",children:e.jsx(u,{className:"bg-gray-800/50 border-gray-700",children:e.jsx(h,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(p,{className:"h-4 w-4 animate-spin text-blue-600"}),e.jsx("span",{className:"text-sm text-gray-400",children:"Processando..."})]})})})}),e.jsx("div",{ref:U})]}),e.jsx("div",{className:"border-t border-gray-700/50 p-4 bg-gray-900/50 backdrop-blur-xl",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(f,{value:y,onChange:e=>I(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),_())},placeholder:"Digite seu comando... (Ex: '/help', 'quantos usu√°rios temos?', '/stats')",className:"min-h-[60px] resize-none",disabled:C}),e.jsx(s,{onClick:_,disabled:!y.trim()||C||!S,className:"bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600",size:"lg",children:C?e.jsx(p,{className:"h-5 w-5 animate-spin"}):e.jsx(x,{className:"h-5 w-5"})})]})})]})]})})}export{j as default};

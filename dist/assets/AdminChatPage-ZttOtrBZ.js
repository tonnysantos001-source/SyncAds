import{c as q,f as J,r as d,j as e,B as u,X as L,M as P,n as B,g as S,l as I,v as E,s as i}from"./index-BSGnXIvk.js";import{T as Z}from"./textarea-Sq-tbSkV.js";import{S as Q}from"./SuperAdminLayout-BcwuNsz7.js";import{M as X}from"./message-square-BwCSfRom.js";import{T as A}from"./trash-2-Dt7q_6l8.js";import{S as k}from"./Logo-B_Z5f_z5.js";import{S as M}from"./sparkles-BCrCQ6Rq.js";import{S as F}from"./send-BIMxQl-_.js";import"./dollar-sign-CMaZjbqz.js";/**
 * @license lucide-react v0.417.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const V=q("CirclePlus",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]);function ae(){const{toast:c}=J(),[v,m]=d.useState([]),[h,f]=d.useState(""),[p,w]=d.useState(!1),[l,x]=d.useState(null),[T,z]=d.useState([]),[N,j]=d.useState(!0),y=d.useRef(null),g=async()=>{try{const{data:{user:r}}=await i.auth.getUser();if(!r)return;const{data:s,error:a}=await i.from("ChatConversation").select("id, title, createdAt, updatedAt").eq("userId",r.id).order("updatedAt",{ascending:!1}).limit(20);if(a)throw a;z(s||[])}catch(r){console.error("Erro ao carregar conversas:",r)}},b=async r=>{try{const{data:s,error:a}=await i.from("ChatMessage").select("id, role, content, createdAt").eq("conversationId",r).order("createdAt",{ascending:!0});if(a)throw a;const t=(s||[]).map(o=>({id:o.id,role:o.role,content:o.content,timestamp:new Date(o.createdAt)}));m(t),x(r),console.log(`‚úÖ ${t.length} mensagens carregadas da conversa ${r}`)}catch(s){console.error("Erro ao carregar mensagens:",s),c({title:"Erro",description:"N√£o foi poss√≠vel carregar mensagens.",variant:"destructive"})}},U=async r=>{try{await i.from("ChatMessage").delete().eq("conversationId",r),await i.from("ChatConversation").delete().eq("id",r),l===r&&(m([]),x(null)),await g(),c({title:"‚úÖ Conversa deletada!",description:"Conversa removida com sucesso."})}catch(s){console.error("Erro ao deletar conversa:",s),c({title:"Erro",description:"N√£o foi poss√≠vel deletar conversa.",variant:"destructive"})}};d.useEffect(()=>{(async()=>{try{const{data:{user:s},error:a}=await i.auth.getUser();if(a||!s){console.error("Usu√°rio n√£o autenticado:",a),c({title:"Erro de autentica√ß√£o",description:"Voc√™ precisa fazer login novamente.",variant:"destructive"}),window.location.href="/login";return}await g();const{data:t,error:o}=await i.from("ChatConversation").select("id, title, createdAt, updatedAt").eq("userId",s.id).order("updatedAt",{ascending:!1}).limit(1).single();t?(console.log("‚úÖ Carregando conversa existente:",t.id),x(t.id),await b(t.id)):console.log('üìã Nenhuma conversa existente. Use "Nova Conversa" para come√ßar.')}catch(s){console.error("Erro ao inicializar conversa:",s)}})()},[]),d.useEffect(()=>{var r;(r=y.current)==null||r.scrollIntoView({behavior:"smooth"})},[v]);const D=async(r,s)=>{try{const{data:{session:a}}=await i.auth.getSession();if(!a)throw new Error("N√£o autenticado");const t="https://ovskepqggmxlfckxqgbr.supabase.co/functions/v1/chat-enhanced";console.log("üåê Calling chat-stream (Admin):",t);const o=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a.access_token}`,apikey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92c2tlcHFnZ214bGZja3hxZ2JyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MjQ4NTUsImV4cCI6MjA3NjQwMDg1NX0.UdNgqpTN38An6FuoJPZlj_zLkmAqfJQXb6i1DdTQO_E"},body:JSON.stringify({message:r,conversationId:s,conversationHistory:[],systemPrompt:void 0})});if(!o.ok){const R=await o.json();throw new Error(R.error||"Erro ao processar mensagem")}const n=await o.json();return console.log("üì¶ Response data:",n),n.error?(console.error("‚ùå Erro na resposta:",n.error),`‚ö†Ô∏è ${n.response||n.error}`):!n.response||n.response==="Sem resposta da IA"?(console.error("‚ùå IA n√£o retornou resposta v√°lida"),"‚ö†Ô∏è IA n√£o configurada ou sem resposta. Configure uma IA em Configura√ß√µes > IA Global."):n.response}catch(a){return console.error("Admin chat error:",a),`‚ùå Erro: ${a.message}`}},$=async()=>{if(l)try{await i.from("ChatMessage").delete().eq("conversationId",l),m([]),c({title:"‚úÖ Mensagens limpas!",description:"Chat limpo com sucesso."})}catch(r){console.error("Erro ao limpar mensagens:",r),c({title:"Erro",description:"N√£o foi poss√≠vel limpar mensagens.",variant:"destructive"})}},O=async()=>{try{const{data:{user:r}}=await i.auth.getUser();if(!r)return;const{data:s}=await i.from("User").select("organizationId").eq("id",r.id).single();if(!(s!=null&&s.organizationId))throw new Error("Usu√°rio sem organiza√ß√£o");const a=crypto.randomUUID(),t=new Date().toISOString(),{error:o}=await i.from("ChatConversation").insert({id:a,userId:r.id,organizationId:s.organizationId,title:"üÜï Nova Conversa",createdAt:t,updatedAt:t});if(o)throw o;m([]),x(a),await g(),c({title:"‚úÖ Nova conversa criada!",description:"Comece um novo chat do zero."})}catch(r){console.error("Erro ao criar nova conversa:",r),c({title:"Erro",description:r.message||"N√£o foi poss√≠vel criar nova conversa.",variant:"destructive"})}},C=async()=>{if(!h.trim()||p||!l){console.log("Bot√£o desabilitado:",{inputTrim:!h.trim(),isLoading:p,conversationId:!!l});return}console.log("Enviando mensagem:",h.trim());const r=h.trim();f(""),w(!0);try{if(!l)throw new Error("Conversa n√£o inicializada");const s=l;console.log("Active conversation ID:",s);const a={id:`temp-${Date.now()}`,role:"USER",content:r,timestamp:new Date};m(n=>[...n,a]);const t=await D(r,s),o={id:`temp-${Date.now()+1}`,role:"ASSISTANT",content:t,timestamp:new Date};m(n=>[...n,o])}catch(s){console.error("ERRO COMPLETO:",s);const a={id:`error-${Date.now()}`,role:"ASSISTANT",content:`‚ùå ERRO DETALHADO:

${s.message}

${s.stack||"Sem stack trace"}

${JSON.stringify(s,null,2)}`,timestamp:new Date};m(t=>[...t,a]),c({title:"Erro ao processar",description:s.message,variant:"destructive"})}finally{w(!1)}};return e.jsx(Q,{children:e.jsxs("div",{className:"h-[calc(100vh-80px)] flex",children:[e.jsxs("div",{className:`${N?"w-72":"w-0"} transition-all duration-300 bg-gray-50 border-r border-gray-200 flex flex-col overflow-hidden`,children:[e.jsxs("div",{className:"p-4 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-sm font-semibold text-gray-700",children:"Conversas"}),e.jsx(u,{onClick:()=>j(!1),variant:"ghost",size:"sm",className:"h-7 w-7 p-0",children:e.jsx(L,{className:"h-4 w-4"})})]}),e.jsxs(u,{onClick:O,className:"w-full gap-2",size:"sm",children:[e.jsx(V,{className:"h-4 w-4"}),"Nova Conversa"]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-2 space-y-1",children:T.map(r=>e.jsxs("div",{className:`group relative flex items-center gap-2 p-3 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors ${l===r.id?"bg-blue-50 border border-blue-200":"bg-white"}`,onClick:()=>b(r.id),children:[e.jsx(X,{className:"h-4 w-4 text-gray-500 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:r.title}),e.jsx("p",{className:"text-xs text-gray-500",children:new Date(r.updatedAt).toLocaleDateString("pt-BR")})]}),e.jsx(u,{onClick:s=>{s.stopPropagation(),U(r.id)},variant:"ghost",size:"sm",className:"h-7 w-7 p-0 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx(A,{className:"h-3.5 w-3.5 text-red-500"})})]},r.id))})]}),e.jsxs("div",{className:"flex-1 flex flex-col",children:[e.jsx("div",{className:"border-b border-gray-200 bg-white/80 backdrop-blur-xl p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[!N&&e.jsx(u,{onClick:()=>j(!0),variant:"ghost",size:"sm",className:"h-9 w-9 p-0",children:e.jsx(P,{className:"h-5 w-5"})}),e.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-r from-blue-500 to-purple-500",children:e.jsx(k,{className:"h-6 w-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold text-gray-900",children:"Chat Administrativo"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Chat com IA"})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(u,{onClick:$,variant:"outline",size:"sm",className:"gap-2 hover:bg-red-50 hover:border-red-300",children:[e.jsx(A,{className:"h-4 w-4 text-red-500"}),"Limpar Chat"]}),e.jsxs(B,{className:"bg-gradient-to-r from-green-500 to-emerald-500",children:[e.jsx(M,{className:"h-3 w-3 mr-1"}),"Online"]})]})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[v.map(r=>e.jsx("div",{className:`flex ${r.role==="USER"?"justify-end":"justify-start"}`,children:e.jsx(S,{className:`max-w-[80%] ${r.role==="USER"?"bg-gradient-to-r from-blue-500 to-purple-500 text-white":r.role==="SYSTEM"?"bg-gradient-to-r from-amber-50 to-orange-50 border-amber-200":"bg-white"}`,children:e.jsxs(I,{className:"p-4",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[r.role==="ASSISTANT"&&e.jsx(k,{className:"h-5 w-5 text-blue-600 mt-1 flex-shrink-0"}),r.role==="SYSTEM"&&e.jsx(M,{className:"h-5 w-5 text-amber-600 mt-1 flex-shrink-0"}),e.jsx("div",{className:`flex-1 whitespace-pre-wrap break-words text-sm ${r.role==="USER"?"text-white":"text-gray-900"}`,children:r.content})]}),e.jsx("div",{className:`text-xs mt-2 ${r.role==="USER"?"text-white/70":"text-gray-500"}`,children:r.timestamp.toLocaleTimeString("pt-BR")})]})})},r.id)),p&&e.jsx("div",{className:"flex justify-start",children:e.jsx(S,{className:"bg-white",children:e.jsx(I,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(E,{className:"h-4 w-4 animate-spin text-blue-600"}),e.jsx("span",{className:"text-sm text-gray-500",children:"Processando..."})]})})})}),e.jsx("div",{ref:y})]}),e.jsx("div",{className:"border-t border-gray-200 p-4 bg-white/80 backdrop-blur-xl",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(Z,{value:h,onChange:r=>f(r.target.value),onKeyDown:r=>{r.key==="Enter"&&!r.shiftKey&&(r.preventDefault(),C())},placeholder:"Digite seu comando... (Ex: '/help', 'quantos usu√°rios temos?', '/stats')",className:"min-h-[60px] resize-none",disabled:p}),e.jsx(u,{onClick:C,disabled:!h.trim()||p||!l,className:"bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600",size:"lg",children:p?e.jsx(E,{className:"h-5 w-5 animate-spin"}):e.jsx(F,{className:"h-5 w-5"})})]})})]})]})})}export{ae as default};

import{j as e}from"./vendor-ui-D8qh2McD.js";import{l as t,f as o,r as a}from"./vendor-react-X41Bjl18.js";import{s}from"./index-i3b3sNGH.js";import{L as n,C as r,F as i}from"./vendor-icons-CouwLySB.js";import"./vendor-supabase-ChjAI-9u.js";import"./vendor-utils-Dl0_yMKq.js";import"./vendor-animation-APnkykC6.js";import"./vendor-query-CYpOgAEj.js";var c={};const d={google_ads:{slug:"google_ads",name:"Google Ads",authType:"oauth",icon:"ðŸ”",description:"Gerencie suas campanhas do Google Ads",scopes:["https://www.googleapis.com/auth/adwords"],clientId:c.VITE_GOOGLE_CLIENT_ID,authUrl:"https://accounts.google.com/o/oauth2/v2/auth",tokenUrl:"https://oauth2.googleapis.com/token"},meta_ads:{slug:"meta_ads",name:"Meta Ads",authType:"oauth",icon:"ðŸ“˜",description:"Conecte suas campanhas do Facebook e Instagram",scopes:["ads_management","ads_read","business_management"],clientId:c.VITE_META_CLIENT_ID,authUrl:"https://www.facebook.com/v18.0/dialog/oauth",tokenUrl:"https://graph.facebook.com/v18.0/oauth/access_token"},facebook_ads:{slug:"facebook_ads",name:"Facebook Ads",authType:"oauth",icon:"ðŸ‘¥",description:"Gerencie anÃºncios do Facebook",scopes:["ads_management","ads_read"],clientId:c.VITE_META_CLIENT_ID,authUrl:"https://www.facebook.com/v18.0/dialog/oauth",tokenUrl:"https://graph.facebook.com/v18.0/oauth/access_token"},linkedin_ads:{slug:"linkedin_ads",name:"LinkedIn Ads",authType:"oauth",icon:"ðŸ’¼",description:"Conecte suas campanhas do LinkedIn",scopes:["r_ads","rw_ads","r_organization_social"],clientId:c.VITE_LINKEDIN_CLIENT_ID,authUrl:"https://www.linkedin.com/oauth/v2/authorization",tokenUrl:"https://www.linkedin.com/oauth/v2/accessToken"},google_analytics:{slug:"google_analytics",name:"Google Analytics",authType:"oauth",icon:"ðŸ“Š",description:"Analise dados do Google Analytics",scopes:["https://www.googleapis.com/auth/analytics.readonly"],clientId:c.VITE_GOOGLE_CLIENT_ID,authUrl:"https://accounts.google.com/o/oauth2/v2/auth",tokenUrl:"https://oauth2.googleapis.com/token"},twitter_ads:{slug:"twitter_ads",name:"Twitter Ads",authType:"oauth",icon:"ðŸ¦",description:"Gerencie campanhas do Twitter/X",scopes:["tweet.read","users.read","offline.access"],clientId:c.VITE_TWITTER_CLIENT_ID,authUrl:"https://twitter.com/i/oauth2/authorize",tokenUrl:"https://api.twitter.com/2/oauth2/token"},tiktok_ads:{slug:"tiktok_ads",name:"TikTok Ads",authType:"oauth",icon:"ðŸŽµ",description:"Conecte suas campanhas do TikTok",scopes:["user.info.basic","video.list"],clientId:c.VITE_TIKTOK_CLIENT_ID,authUrl:"https://www.tiktok.com/auth/authorize/",tokenUrl:"https://open-api.tiktok.com/oauth/access_token/"}};const l=new class{REDIRECT_URI=`${window.location.origin}/integrations/callback`;async listIntegrations(e){const{data:t,error:o}=await s.from("Integration").select("*").eq("userId",e);if(o)throw o;return t||[]}async getIntegrationStatus(e,t){const{data:o,error:a}=await s.from("Integration").select("*").eq("userId",e).eq("platform",t.toUpperCase()).single();if(a&&"PGRST116"!==a.code)throw a;return o}async generateOAuthUrl(e,t){const o=d[e];if(!o||"oauth"!==o.authType)throw new Error("IntegraÃ§Ã£o nÃ£o suporta OAuth");if(!o.clientId||"your-google-client-id"===o.clientId||"your-meta-client-id"===o.clientId||"your-linkedin-client-id"===o.clientId||"your-twitter-client-id"===o.clientId||"your-tiktok-client-id"===o.clientId)throw new Error(`âŒ Client ID nÃ£o configurado para ${o.name}\n\nðŸ“ Para conectar esta integraÃ§Ã£o, vocÃª precisa:\n1. Criar uma aplicaÃ§Ã£o OAuth no ${o.name}\n2. Adicionar o Client ID no arquivo .env\n3. Reiniciar o servidor de desenvolvimento\n\nðŸ“– Consulte OAUTH_SETUP.md para instruÃ§Ãµes detalhadas.`);const a=btoa(JSON.stringify({userId:t,slug:e,timestamp:Date.now(),random:Math.random().toString(36).substring(7)})),n=new Date(Date.now()+6e5).toISOString(),{error:r}=await s.from("OAuthState").insert({id:crypto.randomUUID(),state:a,userId:t,integrationSlug:e,expiresAt:n,createdAt:(new Date).toISOString()});if(r)throw new Error(`Erro ao armazenar state OAuth: ${r.message}`);const i=new URLSearchParams({client_id:o.clientId,redirect_uri:this.REDIRECT_URI,response_type:"code",scope:o.scopes?.join(" ")||"",state:a,access_type:"offline",prompt:"consent"});return{authUrl:`${o.authUrl}?${i.toString()}`,state:a}}async handleOAuthCallback(e,t){const{data:o,error:a}=await s.from("OAuthState").select("*").eq("state",t).single();if(a||!o)throw new Error("State invÃ¡lido ou expirado");const{userId:n,integrationSlug:r}=JSON.parse(atob(t)),i=d[r];if(!i)throw new Error("IntegraÃ§Ã£o nÃ£o encontrada");const c=await fetch(i.tokenUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({client_id:i.clientId,client_secret:"8b80da29081d73fd7d1037f3cae72d55",code:e,redirect_uri:this.REDIRECT_URI,grant_type:"authorization_code"})});if(!c.ok)throw new Error("Falha ao obter tokens");const l=await c.json();l.expires_in&&new Date(Date.now()+1e3*l.expires_in).toISOString();const{data:h}=await s.from("Integration").select("id").eq("userId",n).eq("platform",r.toUpperCase()).single();if(h)await s.from("Integration").update({credentials:{access_token:l.access_token,refresh_token:l.refresh_token},isConnected:!0,lastSyncAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()}).eq("id",h.id);else{const{error:e}=await s.from("Integration").insert({id:crypto.randomUUID(),userId:n,platform:r.toUpperCase(),credentials:{access_token:l.access_token,refresh_token:l.refresh_token},isConnected:!0,lastSyncAt:(new Date).toISOString(),createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()});if(e)throw e}return await s.from("OAuthState").delete().eq("state",t),{success:!0,slug:r}}async connectDirect(e,t,o){throw new Error("AutenticaÃ§Ã£o direta requer implementaÃ§Ã£o no backend")}async disconnect(e,t){const{error:o}=await s.from("Integration").delete().eq("userId",e).eq("platform",t.toUpperCase());if(o)throw o}async refreshToken(e){}};function h(){const[c]=t(),h=o(),[u,m]=a.useState("loading"),[g,p]=a.useState("Processing your connection...");return a.useEffect(()=>{(async()=>{try{const t=c.get("shop"),o=c.get("code"),a=c.get("hmac");if(t&&o&&a){m("loading"),p("Conectando com Shopify...");try{const e=await s.auth.getSession(),n=await fetch(`https://your-project.supabase.co/functions/v1/shopify-oauth?action=callback&shop=${t}&code=${o}&hmac=${a}`,{headers:{Authorization:`Bearer ${e.data.session?.access_token}`}}),r=await n.json();if(r.success)return m("success"),p("Shopify conectada! Sincronizando dados..."),void setTimeout(()=>h("/integrations"),2e3);throw new Error(r.error||"Erro ao conectar Shopify")}catch(e){return m("error"),p(`Erro ao conectar Shopify: ${e.message}`),void setTimeout(()=>h("/integrations"),3e3)}}const n=c.get("state"),r=c.get("error");if(r)throw new Error(r);if(!o||!n)throw new Error("Missing code or state parameter");const i=await l.handleOAuthCallback(o,n),u=d[i.slug];m("success"),p(`${u.name} connected successfully!`);const g=JSON.parse(atob(n));localStorage.setItem(`oauth_success_${g.platform}_${g.userId}`,"true"),setTimeout(()=>{window.opener?window.close():h("/chat")},2e3)}catch(t){m("error"),p(t.message||"Failed to connect integration"),setTimeout(()=>{window.opener?window.close():h("/chat")},3e3)}})()},[c,h]),e.jsx("div",{className:"flex items-center justify-center min-h-screen bg-gray-50 dark:bg-gray-900",children:e.jsxs("div",{className:"text-center p-8 bg-white dark:bg-gray-800 rounded-lg shadow-lg max-w-md",children:["loading"===u&&e.jsxs(e.Fragment,{children:[e.jsx(n,{className:"h-16 w-16 animate-spin text-blue-600 mx-auto mb-4"}),e.jsx("h1",{className:"text-2xl font-bold mb-2",children:"Processing..."}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:g})]}),"success"===u&&e.jsxs(e.Fragment,{children:[e.jsx(r,{className:"h-16 w-16 text-green-600 mx-auto mb-4"}),e.jsx("h1",{className:"text-2xl font-bold mb-2 text-green-600",children:"Success!"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:g}),e.jsx("p",{className:"text-sm text-gray-500 mt-2",children:"Closing this window..."})]}),"error"===u&&e.jsxs(e.Fragment,{children:[e.jsx(i,{className:"h-16 w-16 text-red-600 mx-auto mb-4"}),e.jsx("h1",{className:"text-2xl font-bold mb-2 text-red-600",children:"Error"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:g}),e.jsx("p",{className:"text-sm text-gray-500 mt-2",children:"Redirecting..."})]})]})})}export{h as IntegrationCallbackPage};

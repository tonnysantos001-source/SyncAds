import{j as e}from"./vendor-ui-DkUuACDy.js";import{r as t,f as a}from"./vendor-react-X41Bjl18.js";import{s,g as n,f as r,i as o}from"./index-bMFOlucA.js";import{I as i,a as c,b as d}from"./IconSend-Bab7lU40.js";import"./vendor-supabase-BQxDPPjR.js";import"./vendor-utils-Dl0_yMKq.js";import"./vendor-animation-DQ3cvw6m.js";import"./vendor-query-Bf3pI66S.js";import"./vendor-icons-DTdRnryx.js";function l({status:t="thinking"}){return e.jsxs("div",{className:"flex items-center gap-2 p-4 bg-gray-800 rounded-lg max-w-[70%]",children:[e.jsxs("div",{className:"flex gap-1",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-bounce [animation-delay:-0.3s]"}),e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-bounce [animation-delay:-0.15s]"}),e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-bounce"})]}),e.jsx("span",{className:"text-sm text-gray-400",children:{thinking:"Pensando...",searching:"Pesquisando...",navigating:"Navegando...",processing:"Processando..."}[t]})]})}function m(){const m=a(),{toast:u}=n(),g=r(e=>e.user),x=r(e=>e.isAuthenticated),[f,h]=t.useState([]),[p,v]=t.useState(null),[b,y]=t.useState(""),[j,w]=t.useState(!1),[N,E]=t.useState(!1),[S,C]=t.useState(null),[A,I]=t.useState(!0),[T,D]=t.useState({connected:!1,deviceId:null,lastCheck:0}),[k,$]=t.useState([]),O=t.useRef(null);!function({userId:e,onCommandUpdate:a,onCommandCompleted:n,onCommandFailed:r,enabled:o=!0}){const[i,c]=t.useState(null),[d,l]=t.useState(!1),[m,u]=t.useState(null),[g,x]=t.useState(null),f=t.useCallback(e=>{const t=e.new;u(t),a&&a(t),"completed"===t.status&&n&&n(t),"failed"===t.status&&r&&r(t)},[a,n,r]),h=t.useCallback(()=>{if(e&&o&&!i)try{const t=s.channel(`extension-commands-${e}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"extension_commands",filter:`user_id=eq.${e}`},f).subscribe(e=>{"SUBSCRIBED"===e?(l(!0),x(null)):"CHANNEL_ERROR"===e?(l(!1),x("Failed to subscribe to realtime channel")):"TIMED_OUT"===e&&(l(!1),x("Realtime subscription timed out"))});c(t)}catch(t){x(t instanceof Error?t.message:"Unknown error"),l(!1)}},[e,o,i,f]),p=t.useCallback(()=>{i&&s.removeChannel(i).then(()=>{c(null),l(!1)})},[i]);t.useEffect(()=>(o&&e&&h(),()=>{i&&p()}),[o,e])}({userId:g?.id,enabled:!!g?.id,onCommandCompleted:async e=>{const t=k.find(t=>t.id===e.id);t&&(await P(e,t.messageId),$(t=>t.filter(t=>t.id!==e.id)))},onCommandFailed:async e=>{$(t=>t.filter(t=>t.id!==e.id)),u({title:"Comando falhou",description:e.error||"Erro ao executar comando na extensão",variant:"destructive"})}}),t.useEffect(()=>{x&&g||m("/login-v2",{replace:!0})},[x,g,m]),t.useEffect(()=>{if(!g)return;(async()=>{w(!0);try{const{data:e,error:t}=await s.from("ChatConversation").select("id, title, createdAt").eq("userId",g.id).order("createdAt",{ascending:!1});if(t)throw t;if(!e||0===e.length){const e={id:crypto.randomUUID(),userId:g.id,title:`Conversa ${(new Date).toLocaleDateString()}`,createdAt:(new Date).toISOString()},{error:t}=await s.from("ChatConversation").insert(e);return void(t||(h([{id:e.id,title:e.title,messages:[]}]),v(e.id)))}const a=await Promise.all(e.map(async e=>{const{data:t}=await s.from("ChatMessage").select("id, role, content, createdAt").eq("conversationId",e.id).order("createdAt",{ascending:!0});return{id:e.id,title:e.title,messages:(t||[]).map(e=>({id:e.id,role:e.role.toLowerCase(),content:e.content,createdAt:e.createdAt}))}}));h(a),!p&&a.length>0&&v(a[0].id)}catch(e){u({title:"Erro",description:"Não foi possível carregar as conversas",variant:"destructive"})}finally{w(!1)}})()},[g]),t.useEffect(()=>{if(!g)return;let e=0;const t=async()=>{try{const{data:t,error:a}=await s.from("extension_devices").select("id, device_id, status, last_seen").eq("user_id",g.id).eq("status","online").order("last_seen",{ascending:!1}).limit(1).maybeSingle();if(a)return e++,void(e>=3&&D({connected:!1,deviceId:null,lastCheck:Date.now()}));const n=Date.now(),r=t?new Date(t.last_seen).getTime():0;D({connected:!!t&&n-r<3e4,deviceId:t?.device_id||null,lastCheck:n}),a||(e=0)}catch(t){e++}};t();const a=setInterval(t,5e3);return()=>clearInterval(a)},[g]),t.useEffect(()=>{O.current?.scrollIntoView({behavior:"smooth"})},[f,p]);const P=async(e,t)=>{if(g&&p)try{const{data:{session:t}}=await s.auth.getSession();if(!t)return;let a="";if("COMPLETED"===e.status&&e.result){const t=e.result.result||e.result;switch(e.command){case"LIST_TABS":const s=t.tabs||[];a=`RESULTADO: Encontrei ${s.length} abas abertas:\n\n${s.map((e,t)=>`${t+1}. ${e.title}\n   URL: ${e.url}`).join("\n\n")}\n\nPor favor, apresente esta lista de forma organizada e amigável para o usuário.`;break;case"GET_PAGE_INFO":a=`RESULTADO: Informações da página:\n- Título: ${t.title}\n- URL: ${t.url}\n- Domínio: ${t.domain}\n\nResumo do conteúdo:\n${t.bodyText?.substring(0,500)||"Sem conteúdo"}\n\nPor favor, apresente essas informações de forma clara para o usuário.`;break;case"NAVIGATE":a=`RESULTADO: Nova aba aberta com sucesso em: ${t.navigated}\n\nConfirme ao usuário que a ação foi concluída.`;break;case"CLICK_ELEMENT":a=`RESULTADO: Clique executado com sucesso no elemento: ${t.clicked}\n\nConfirme ao usuário que a ação foi concluída.`;break;case"TYPE_TEXT":a=`RESULTADO: Texto digitado com sucesso: "${t.value}"\n\nConfirme ao usuário que a ação foi concluída.`;break;case"READ_TEXT":a=`RESULTADO: Texto lido do elemento:\n\n${t.text}\n\nPor favor, apresente este conteúdo de forma clara para o usuário.`;break;default:a=`RESULTADO da ação ${e.command}:\n\n${JSON.stringify(t,null,2)}\n\nPor favor, apresente este resultado de forma clara para o usuário.`}}else"FAILED"===e.status&&(a=`ERRO: A ação ${e.command} falhou com o seguinte erro: ${e.error}\n\nPor favor, explique o problema ao usuário de forma amigável e sugira uma solução.`);const n=await fetch("https://your-project.supabase.co/functions/v1/chat-enhanced",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.access_token}`},body:JSON.stringify({message:a,conversationId:p,extensionConnected:T.connected})});if(!n.ok)throw new Error(`Erro HTTP: ${n.status}`);const r=await n.json(),o={id:crypto.randomUUID(),role:"assistant",content:r.response,createdAt:(new Date).toISOString()};h(e=>e.map(e=>e.id===p?{...e,messages:[...e.messages,o]}:e))}catch(a){}},U=async()=>{if(!b.trim()||!p||!g||N)return;const e=b.trim(),t=`temp-user-${Date.now()}`,a=`temp-ai-${Date.now()}`;y(""),E(!0);const n=e.toLowerCase();n.includes("pesquis")||n.includes("busca")||n.includes("procur")?C("searching"):n.includes("abr")||n.includes("naveg")||n.includes("acess")?C("navigating"):C("thinking");try{h(a=>a.map(a=>a.id===p?{...a,messages:[...a.messages,{id:t,role:"user",content:e,createdAt:(new Date).toISOString()}]}:a));const{data:{session:n}}=await s.auth.getSession();if(!n)throw new Error("Sem sessão");const r=await fetch("https://your-project.supabase.co/functions/v1/chat-enhanced",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n.access_token}`},body:JSON.stringify({message:e,conversationId:p,extensionConnected:T.connected})});if(!r.ok)throw new Error(`Erro HTTP: ${r.status}`);const o=await r.json();if(o.error)throw new Error(o.error);let i=o.response||"";i=i.replace(/```json\s*[\s\S]*?\s*```/g,""),i=i.replace(/\{[\s\S]*?"type"[\s\S]*?\}/g,""),i=i.replace(/\n{3,}/g,"\n\n").trim(),i||(i="Executando ação..."),h(s=>s.map(s=>s.id===p?{...s,messages:[...s.messages.filter(e=>!e.id.startsWith("temp-")),{id:o.userMessageId||t,role:"user",content:e,createdAt:(new Date).toISOString()},{id:o.aiMessageId||a,role:"assistant",content:i,createdAt:(new Date).toISOString()}]}:s))}catch(r){h(e=>e.map(e=>e.id===p?{...e,messages:e.messages.filter(e=>!e.id.startsWith("temp-"))}:e)),u({title:"Erro ao enviar mensagem",description:r.message||"Tente novamente",variant:"destructive"})}finally{E(!1),C(null)}},L=f.find(e=>e.id===p);return e.jsxs("div",{className:"flex h-screen bg-gray-950 text-white",children:[e.jsx("div",{className:(A?"w-80":"w-0")+" transition-all duration-300 border-r border-gray-800 flex flex-col",children:A&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"p-4 border-b border-gray-800",children:e.jsxs("button",{onClick:async()=>{if(g)try{const e=(new Date).toISOString(),t={id:crypto.randomUUID(),userId:g.id,title:`Conversa ${(new Date).toLocaleDateString()}`,createdAt:e,updatedAt:e},{data:a,error:n}=await s.from("ChatConversation").insert(t).select().single();if(n)throw n;const r={id:t.id,title:t.title,messages:[]};h([r,...f]),v(t.id),setMessages([]),setIsLoadingMessages(!1),setTimeout(()=>{const e=document.querySelector(".overflow-y-auto");e&&(e.scrollTop=0)},100),u({title:"Nova conversa criada!"})}catch(e){u({title:"Erro",description:e?.message||"Não foi possível criar nova conversa",variant:"destructive"})}else u({title:"Erro",description:"Usuário não autenticado",variant:"destructive"})},className:"w-full flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg transition-colors",children:[e.jsx(i,{className:"w-5 h-5"}),"Nova Conversa"]})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-2",children:j?e.jsx("div",{className:"text-center text-gray-500 py-4",children:"Carregando..."}):f.map(t=>e.jsxs("div",{onClick:()=>v(t.id),className:"p-3 mb-2 rounded-lg cursor-pointer transition-colors "+(p===t.id?"bg-gray-800 border border-blue-600":"bg-gray-900 hover:bg-gray-800"),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm truncate",children:t.title}),e.jsx("button",{onClick:e=>{e.stopPropagation(),(async e=>{try{const{error:t}=await s.from("ChatConversation").delete().eq("id",e);if(t)throw t;h(t=>t.filter(t=>t.id!==e)),p===e&&v(f[0]?.id||null),u({title:"Conversa deletada"})}catch(t){u({title:"Erro ao deletar",variant:"destructive"})}})(t.id)},className:"text-gray-500 hover:text-red-500",children:e.jsx(o,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[t.messages.length," mensagens"]})]},t.id))})]})}),e.jsxs("div",{className:"flex-1 flex flex-col",children:[e.jsxs("div",{className:"h-16 border-b border-gray-800 flex items-center px-4 justify-between",children:[e.jsx("button",{onClick:()=>I(!A),className:"p-2 hover:bg-gray-800 rounded-lg",children:e.jsx(c,{className:"w-6 h-6"})}),e.jsx("h1",{className:"text-lg font-semibold",children:L?.title||"Chat"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-medium "+(T.connected?"bg-green-600/20 text-green-400 border border-green-600/30":"bg-gray-800 text-gray-400 border border-gray-700"),children:[e.jsx("div",{className:"w-2 h-2 rounded-full "+(T.connected?"bg-green-400":"bg-gray-500")}),e.jsx("span",{children:T.connected?"Extensão Ativa":"Extensão Offline"})]})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:L?0===L.messages.length?e.jsx("div",{className:"flex items-center justify-center h-full text-gray-500",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xl mb-2",children:"Nova conversa"}),e.jsx("p",{className:"text-sm",children:"Envie uma mensagem para começar"}),T.connected&&e.jsxs("div",{className:"mt-8 p-4 bg-green-600/10 border border-green-600/30 rounded-lg max-w-md mx-auto",children:[e.jsx("p",{className:"text-green-400 text-sm mb-2 font-medium",children:"✨ Extensão conectada!"}),e.jsx("p",{className:"text-gray-400 text-xs",children:'Agora posso controlar seu navegador. Experimente: "Abra o Facebook Ads"'})]})]})}):e.jsxs(e.Fragment,{children:[L.messages.map(t=>e.jsx("div",{className:"flex "+("user"===t.role?"justify-end":"justify-start"),children:e.jsx("div",{className:"max-w-[70%] rounded-lg p-4 "+("user"===t.role?"bg-blue-600":"bg-gray-800"),children:e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:t.content})})},t.id)),S&&e.jsx(l,{status:S}),e.jsx("div",{ref:O})]}):e.jsx("div",{className:"flex items-center justify-center h-full text-gray-500",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xl mb-2",children:"Nenhuma conversa selecionada"}),e.jsx("p",{className:"text-sm",children:"Crie uma nova conversa para começar"}),!T.connected&&e.jsxs("div",{className:"mt-8 p-4 bg-yellow-600/10 border border-yellow-600/30 rounded-lg max-w-md mx-auto",children:[e.jsx("p",{className:"text-yellow-400 text-sm mb-2 font-medium",children:"⚠️ Extensão do navegador offline"}),e.jsx("p",{className:"text-gray-400 text-xs",children:"Para usar automação de navegador, instale e ative a extensão SyncAds AI"})]})]})})}),e.jsx("div",{className:"border-t border-gray-800 p-4",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:b,onChange:e=>y(e.target.value),onKeyPress:e=>"Enter"===e.key&&!e.shiftKey&&U(),onPaste:e=>{e.stopPropagation();const t=e.clipboardData.getData("text");t&&y(b+t)},placeholder:"Digite sua mensagem...",disabled:N||!p,className:"flex-1 bg-gray-900 border border-gray-800 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-600 disabled:opacity-50"}),e.jsx("button",{onClick:U,disabled:!b.trim()||N||!p,className:"bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-white px-6 py-3 rounded-lg transition-colors flex items-center gap-2",children:N?e.jsx("span",{children:"Enviando..."}):e.jsxs(e.Fragment,{children:[e.jsx(d,{className:"w-5 h-5"}),"Enviar"]})})]})})]})]})}export{m as default};

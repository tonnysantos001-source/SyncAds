import{s as x,r as b,f as X,u as Y,j as e,B as Z,ad as ee,g as p,h as N,i as y,U as te,l as w,Q as re,I as se,b as ae,k as U,o as F}from"./index-D53W62E_.js";import{T as L,a as H,b as q,c as m,d as z,e as u}from"./table-DBrC_OMi.js";import{S as ne,a as ce,b as oe,c as ie,d as G}from"./select-C398AF6E.js";import{T as le,a as de,b as B,c as D}from"./tabs-CnMOltTz.js";import{S as k}from"./skeleton-DM4jPz1B.js";import{t as me,c as ue}from"./constructFrom-rJN6zrQ_.js";import{T as _}from"./target-BeO7NYMK.js";import{D as he}from"./dollar-sign-BEZMla3r.js";import{T as $}from"./trending-up-DL7EZm4p.js";import{E as xe}from"./external-link-BVt0KlkH.js";import"./index-CPk5xn2D.js";const C={async track(s){try{const{data:t,error:r}=await x.from("UTMTracking").insert({...s,converted:!1}).select().single();if(r)throw r;return t}catch(t){throw console.error("Error tracking UTM:",t),t}},async getById(s){try{const{data:t,error:r}=await x.from("UTMTracking").select("*").eq("id",s).single();if(r)throw r;return t}catch(t){throw console.error("Error getting UTM:",t),t}},async getBySession(s){try{const{data:t,error:r}=await x.from("UTMTracking").select("*").eq("sessionId",s).order("createdAt",{ascending:!1}).limit(1).single();if(r){if(r.code==="PGRST116")return null;throw r}return t}catch(t){throw console.error("Error getting UTM by session:",t),t}},async getByUser(s,t){try{let r=x.from("UTMTracking").select("*").eq("userId",s).order("createdAt",{ascending:!1});t!=null&&t.source&&(r=r.eq("utmSource",t.source)),t!=null&&t.medium&&(r=r.eq("utmMedium",t.medium)),t!=null&&t.campaign&&(r=r.eq("utmCampaign",t.campaign)),(t==null?void 0:t.converted)!==void 0&&(r=r.eq("converted",t.converted)),t!=null&&t.dateFrom&&(r=r.gte("createdAt",t.dateFrom)),t!=null&&t.dateTo&&(r=r.lte("createdAt",t.dateTo)),t!=null&&t.limit&&(r=r.limit(t.limit)),t!=null&&t.offset&&(r=r.range(t.offset,t.offset+(t.limit||50)-1));const{data:c,error:l}=await r;if(l)throw l;return c}catch(r){throw console.error("Error listing UTMs:",r),r}},async markAsConverted(s,t,r){try{const{data:c,error:l}=await x.from("UTMTracking").update({converted:!0,convertedAt:new Date().toISOString(),orderId:t,orderValue:r,updatedAt:new Date().toISOString()}).eq("id",s).select().single();if(l)throw l;return c}catch(c){throw console.error("Error marking UTM as converted:",c),c}},async markSessionConverted(s,t,r){try{const c=await C.getBySession(s);return c?await C.markAsConverted(c.id,t,r):null}catch(c){throw console.error("Error marking session as converted:",c),c}},async update(s,t){try{const{data:r,error:c}=await x.from("UTMTracking").update({...t,updatedAt:new Date().toISOString()}).eq("id",s).select().single();if(c)throw c;return r}catch(r){throw console.error("Error updating UTM:",r),r}},async delete(s){try{const{error:t}=await x.from("UTMTracking").delete().eq("id",s);if(t)throw t}catch(t){throw console.error("Error deleting UTM:",t),t}},async getAnalytics(s,t){try{let r=x.from("UTMAnalytics").select("*").eq("userId",s);t&&(r=r.gte("createdAt",t.from).lte("createdAt",t.to));const{data:c,error:l}=await r;if(l)throw l;return c}catch(r){throw console.error("Error getting analytics:",r),r}},async getStats(s,t){try{let r=x.from("UTMTracking").select("*").eq("userId",s);t&&(r=r.gte("createdAt",t.from).lte("createdAt",t.to));const{data:c,error:l}=await r;if(l)throw l;const h=c,v=h.length,f=h.filter(o=>o.converted).length,T=h.filter(o=>o.converted&&o.orderValue).reduce((o,i)=>o+(i.orderValue||0),0),V=v>0?f/v*100:0,P=f>0?T/f:0,M={};[...new Set(h.map(o=>o.utmSource).filter(Boolean))].forEach(o=>{const i=h.filter(n=>n.utmSource===o),d=i.filter(n=>n.converted),a=d.reduce((n,S)=>n+(S.orderValue||0),0);M[o]={utmSource:o,totalVisits:i.length,totalConversions:d.length,conversionRate:d.length/i.length*100,totalRevenue:a,averageOrderValue:d.length>0?a/d.length:0}});const E={};[...new Set(h.map(o=>o.utmMedium).filter(Boolean))].forEach(o=>{const i=h.filter(n=>n.utmMedium===o),d=i.filter(n=>n.converted),a=d.reduce((n,S)=>n+(S.orderValue||0),0);E[o]={utmMedium:o,totalVisits:i.length,totalConversions:d.length,conversionRate:d.length/i.length*100,totalRevenue:a,averageOrderValue:d.length>0?a/d.length:0}});const A={};[...new Set(h.map(o=>o.utmCampaign).filter(Boolean))].forEach(o=>{const i=h.filter(n=>n.utmCampaign===o),d=i.filter(n=>n.converted),a=d.reduce((n,S)=>n+(S.orderValue||0),0);A[o]={utmCampaign:o,totalVisits:i.length,totalConversions:d.length,conversionRate:d.length/i.length*100,totalRevenue:a,averageOrderValue:d.length>0?a/d.length:0}});const g=Object.entries(M).map(([o,i])=>({name:o,conversions:i.totalConversions,revenue:i.totalRevenue})).sort((o,i)=>i.revenue-o.revenue).slice(0,10),I=Object.entries(E).map(([o,i])=>({name:o,conversions:i.totalConversions,revenue:i.totalRevenue})).sort((o,i)=>i.revenue-o.revenue).slice(0,10),j=Object.entries(A).map(([o,i])=>({name:o,conversions:i.totalConversions,revenue:i.totalRevenue})).sort((o,i)=>i.revenue-o.revenue).slice(0,10);return{totalSessions:v,totalConversions:f,totalRevenue:T,conversionRate:V,averageOrderValue:P,bySource:M,byMedium:E,byCampaign:A,topPerformers:{sources:g,mediums:I,campaigns:j}}}catch(r){throw console.error("Error getting UTM stats:",r),r}},async getConversionRate(s,t){try{let r=x.from("UTMTracking").select("converted").eq("userId",s);t&&(r=r.gte("createdAt",t.from).lte("createdAt",t.to));const{data:c,error:l}=await r;if(l)throw l;const h=c,v=h.length,f=h.filter(T=>T.converted).length;return v>0?f/v*100:0}catch(r){throw console.error("Error getting conversion rate:",r),r}},async getBySource(s,t){try{const{data:r,error:c}=await x.from("UTMTracking").select("*").eq("userId",s).eq("utmSource",t).order("createdAt",{ascending:!1});if(c)throw c;return r}catch(r){throw console.error("Error getting UTMs by source:",r),r}},async getByMedium(s,t){try{const{data:r,error:c}=await x.from("UTMTracking").select("*").eq("userId",s).eq("utmMedium",t).order("createdAt",{ascending:!1});if(c)throw c;return r}catch(r){throw console.error("Error getting UTMs by medium:",r),r}},async getByCampaign(s,t){try{const{data:r,error:c}=await x.from("UTMTracking").select("*").eq("userId",s).eq("utmCampaign",t).order("createdAt",{ascending:!1});if(c)throw c;return r}catch(r){throw console.error("Error getting UTMs by campaign:",r),r}},async getUniqueSources(s){try{const{data:t,error:r}=await x.from("UTMTracking").select("utmSource").eq("userId",s).not("utmSource","is",null);if(r)throw r;return[...new Set(t.map(l=>l.utmSource).filter(Boolean))]}catch(t){throw console.error("Error getting unique sources:",t),t}},async getUniqueMediums(s){try{const{data:t,error:r}=await x.from("UTMTracking").select("utmMedium").eq("userId",s).not("utmMedium","is",null);if(r)throw r;return[...new Set(t.map(l=>l.utmMedium).filter(Boolean))]}catch(t){throw console.error("Error getting unique mediums:",t),t}},async getUniqueCampaigns(s){try{const{data:t,error:r}=await x.from("UTMTracking").select("utmCampaign").eq("userId",s).not("utmCampaign","is",null);if(r)throw r;return[...new Set(t.map(l=>l.utmCampaign).filter(Boolean))]}catch(t){throw console.error("Error getting unique campaigns:",t),t}},async getCampaignROI(s,t,r){try{const c=await C.getByCampaign(s,t),l=c.filter(T=>T.converted),h=l.reduce((T,V)=>T+(V.orderValue||0),0),v=r>0?(h-r)/r*100:0,f=c.length>0?l.length/c.length*100:0;return{campaign:t,adSpend:r,revenue:h,roi:v,conversions:l.length,conversionRate:f}}catch(c){throw console.error("Error calculating campaign ROI:",c),c}}};function ge(s,t){const r=me(s);return isNaN(t)?ue(s,NaN):(t&&r.setDate(r.getDate()+t),r)}function je(s,t){return ge(s,-t)}const Re=()=>{const[s,t]=b.useState(null),[r,c]=b.useState([]),[l,h]=b.useState([]),[v,f]=b.useState([]),[T,V]=b.useState({}),[P,M]=b.useState(!0),[O,E]=b.useState(""),[R,A]=b.useState("30d"),{toast:Q}=X(),g=Y(a=>a.user);b.useEffect(()=>{g!=null&&g.id&&I()},[g==null?void 0:g.id,R]);const I=async()=>{try{if(!(g!=null&&g.id))return;M(!0);const n={from:je(new Date,R==="7d"?7:R==="30d"?30:90).toISOString(),to:new Date().toISOString()},[S,J,K,W]=await Promise.all([C.getStats(g.id,n),C.getUniqueSources(g.id),C.getUniqueMediums(g.id),C.getUniqueCampaigns(g.id)]);t(S),c(J),h(K),f(W)}catch(a){console.error("Erro ao carregar dados:",a),Q({title:"Erro ao carregar dados",description:a.message,variant:"destructive"})}finally{M(!1)}},j=a=>new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(a),o=a=>`${a.toFixed(1)}%`,i=a=>O?a.filter(([n])=>n.toLowerCase().includes(O.toLowerCase())):a,d=()=>{switch(R){case"7d":return"Últimos 7 dias";case"30d":return"Últimos 30 dias";case"90d":return"Últimos 90 dias";default:return"Período"}};return P?e.jsxs("div",{className:"space-y-6",children:[e.jsx(k,{className:"h-20 w-full"}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-4",children:[e.jsx(k,{className:"h-32 w-full"}),e.jsx(k,{className:"h-32 w-full"}),e.jsx(k,{className:"h-32 w-full"}),e.jsx(k,{className:"h-32 w-full"})]}),e.jsx(k,{className:"h-96 w-full"})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Rastreamento UTM"}),e.jsx("p",{className:"text-muted-foreground",children:"Analise o desempenho de suas campanhas de marketing"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(ne,{value:R,onValueChange:a=>A(a),children:[e.jsx(ce,{className:"w-[180px]",children:e.jsx(oe,{})}),e.jsxs(ie,{children:[e.jsx(G,{value:"7d",children:"Últimos 7 dias"}),e.jsx(G,{value:"30d",children:"Últimos 30 dias"}),e.jsx(G,{value:"90d",children:"Últimos 90 dias"})]})]}),e.jsxs(Z,{variant:"outline",onClick:I,children:[e.jsx(ee,{className:"h-4 w-4 mr-2"}),"Atualizar"]})]})]}),s&&e.jsxs("div",{className:"grid gap-4 md:grid-cols-4",children:[e.jsxs(p,{children:[e.jsxs(N,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"Total de Sessões"}),e.jsx(te,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(w,{children:[e.jsx("div",{className:"text-2xl font-bold",children:s.totalSessions}),e.jsx("p",{className:"text-xs text-muted-foreground",children:d()})]})]}),e.jsxs(p,{children:[e.jsxs(N,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"Conversões"}),e.jsx(_,{className:"h-4 w-4 text-green-600"})]}),e.jsxs(w,{children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:s.totalConversions}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Taxa: ",o(s.conversionRate)]})]})]}),e.jsxs(p,{children:[e.jsxs(N,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"Receita Total"}),e.jsx(he,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(w,{children:[e.jsx("div",{className:"text-2xl font-bold",children:j(s.totalRevenue)}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Ticket médio: ",j(s.averageOrderValue)]})]})]}),e.jsxs(p,{children:[e.jsxs(N,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"Taxa de Conversão"}),e.jsx($,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(w,{children:[e.jsx("div",{className:"text-2xl font-bold",children:o(s.conversionRate)}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s.totalSessions," sessões"]})]})]})]}),e.jsx("div",{className:"flex items-center gap-4",children:e.jsxs("div",{className:"relative flex-1",children:[e.jsx(re,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(se,{placeholder:"Buscar por fonte, meio ou campanha...",value:O,onChange:a=>E(a.target.value),className:"pl-9"})]})}),e.jsxs(le,{defaultValue:"sources",className:"space-y-4",children:[e.jsxs(de,{children:[e.jsxs(B,{value:"sources",children:[e.jsx(ae,{className:"h-4 w-4 mr-2"}),"Fontes (",r.length,")"]}),e.jsxs(B,{value:"mediums",children:[e.jsx(xe,{className:"h-4 w-4 mr-2"}),"Meios (",l.length,")"]}),e.jsxs(B,{value:"campaigns",children:[e.jsx(_,{className:"h-4 w-4 mr-2"}),"Campanhas (",v.length,")"]}),e.jsxs(B,{value:"top",children:[e.jsx($,{className:"h-4 w-4 mr-2"}),"Top Performers"]})]}),e.jsx(D,{value:"sources",children:e.jsxs(p,{children:[e.jsxs(N,{children:[e.jsx(y,{children:"Performance por Fonte"}),e.jsx(U,{children:"Análise de tráfego por fonte de origem"})]}),e.jsx(w,{children:s&&Object.keys(s.bySource).length===0?e.jsx("div",{className:"text-center py-12 text-muted-foreground",children:"Nenhuma fonte rastreada ainda"}):e.jsxs(L,{children:[e.jsx(H,{children:e.jsxs(q,{children:[e.jsx(m,{children:"Fonte"}),e.jsx(m,{className:"text-right",children:"Visitas"}),e.jsx(m,{className:"text-right",children:"Conversões"}),e.jsx(m,{className:"text-right",children:"Taxa"}),e.jsx(m,{className:"text-right",children:"Receita"}),e.jsx(m,{className:"text-right",children:"Ticket Médio"})]})}),e.jsx(z,{children:s&&i(Object.entries(s.bySource)).sort(([,a],[,n])=>n.totalRevenue-a.totalRevenue).map(([a,n])=>e.jsxs(q,{children:[e.jsx(u,{children:e.jsx("div",{className:"font-medium",children:a})}),e.jsx(u,{className:"text-right",children:n.totalVisits}),e.jsx(u,{className:"text-right",children:e.jsx("span",{className:"font-medium text-green-600",children:n.totalConversions})}),e.jsx(u,{className:"text-right",children:e.jsx(F,{variant:"outline",children:o(n.conversionRate)})}),e.jsx(u,{className:"text-right font-medium",children:j(n.totalRevenue)}),e.jsx(u,{className:"text-right text-muted-foreground",children:j(n.averageOrderValue)})]},a))})]})})]})}),e.jsx(D,{value:"mediums",children:e.jsxs(p,{children:[e.jsxs(N,{children:[e.jsx(y,{children:"Performance por Meio"}),e.jsx(U,{children:"Análise de tráfego por meio de aquisição"})]}),e.jsx(w,{children:s&&Object.keys(s.byMedium).length===0?e.jsx("div",{className:"text-center py-12 text-muted-foreground",children:"Nenhum meio rastreado ainda"}):e.jsxs(L,{children:[e.jsx(H,{children:e.jsxs(q,{children:[e.jsx(m,{children:"Meio"}),e.jsx(m,{className:"text-right",children:"Visitas"}),e.jsx(m,{className:"text-right",children:"Conversões"}),e.jsx(m,{className:"text-right",children:"Taxa"}),e.jsx(m,{className:"text-right",children:"Receita"}),e.jsx(m,{className:"text-right",children:"Ticket Médio"})]})}),e.jsx(z,{children:s&&i(Object.entries(s.byMedium)).sort(([,a],[,n])=>n.totalRevenue-a.totalRevenue).map(([a,n])=>e.jsxs(q,{children:[e.jsx(u,{children:e.jsx("div",{className:"font-medium",children:a})}),e.jsx(u,{className:"text-right",children:n.totalVisits}),e.jsx(u,{className:"text-right",children:e.jsx("span",{className:"font-medium text-green-600",children:n.totalConversions})}),e.jsx(u,{className:"text-right",children:e.jsx(F,{variant:"outline",children:o(n.conversionRate)})}),e.jsx(u,{className:"text-right font-medium",children:j(n.totalRevenue)}),e.jsx(u,{className:"text-right text-muted-foreground",children:j(n.averageOrderValue)})]},a))})]})})]})}),e.jsx(D,{value:"campaigns",children:e.jsxs(p,{children:[e.jsxs(N,{children:[e.jsx(y,{children:"Performance por Campanha"}),e.jsx(U,{children:"Análise detalhada de cada campanha"})]}),e.jsx(w,{children:s&&Object.keys(s.byCampaign).length===0?e.jsx("div",{className:"text-center py-12 text-muted-foreground",children:"Nenhuma campanha rastreada ainda"}):e.jsxs(L,{children:[e.jsx(H,{children:e.jsxs(q,{children:[e.jsx(m,{children:"Campanha"}),e.jsx(m,{className:"text-right",children:"Visitas"}),e.jsx(m,{className:"text-right",children:"Conversões"}),e.jsx(m,{className:"text-right",children:"Taxa"}),e.jsx(m,{className:"text-right",children:"Receita"}),e.jsx(m,{className:"text-right",children:"Ticket Médio"})]})}),e.jsx(z,{children:s&&i(Object.entries(s.byCampaign)).sort(([,a],[,n])=>n.totalRevenue-a.totalRevenue).map(([a,n])=>e.jsxs(q,{children:[e.jsx(u,{children:e.jsx("div",{className:"font-medium",children:a})}),e.jsx(u,{className:"text-right",children:n.totalVisits}),e.jsx(u,{className:"text-right",children:e.jsx("span",{className:"font-medium text-green-600",children:n.totalConversions})}),e.jsx(u,{className:"text-right",children:e.jsx(F,{variant:"outline",children:o(n.conversionRate)})}),e.jsx(u,{className:"text-right font-medium",children:j(n.totalRevenue)}),e.jsx(u,{className:"text-right text-muted-foreground",children:j(n.averageOrderValue)})]},a))})]})})]})}),e.jsx(D,{value:"top",children:e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsxs(p,{children:[e.jsxs(N,{children:[e.jsx(y,{className:"text-base",children:"Top Fontes"}),e.jsx(U,{children:"Por receita gerada"})]}),e.jsx(w,{children:e.jsx("div",{className:"space-y-3",children:s==null?void 0:s.topPerformers.sources.slice(0,5).map((a,n)=>e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex h-8 w-8 items-center justify-center rounded-full bg-primary/10 text-sm font-bold",children:n+1}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium truncate",children:a.name}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[a.conversions," conversões"]})]}),e.jsx("div",{className:"text-right",children:e.jsx("div",{className:"font-medium text-sm",children:j(a.revenue)})})]},a.name))})})]}),e.jsxs(p,{children:[e.jsxs(N,{children:[e.jsx(y,{className:"text-base",children:"Top Meios"}),e.jsx(U,{children:"Por receita gerada"})]}),e.jsx(w,{children:e.jsx("div",{className:"space-y-3",children:s==null?void 0:s.topPerformers.mediums.slice(0,5).map((a,n)=>e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex h-8 w-8 items-center justify-center rounded-full bg-primary/10 text-sm font-bold",children:n+1}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium truncate",children:a.name}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[a.conversions," conversões"]})]}),e.jsx("div",{className:"text-right",children:e.jsx("div",{className:"font-medium text-sm",children:j(a.revenue)})})]},a.name))})})]}),e.jsxs(p,{children:[e.jsxs(N,{children:[e.jsx(y,{className:"text-base",children:"Top Campanhas"}),e.jsx(U,{children:"Por receita gerada"})]}),e.jsx(w,{children:e.jsx("div",{className:"space-y-3",children:s==null?void 0:s.topPerformers.campaigns.slice(0,5).map((a,n)=>e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex h-8 w-8 items-center justify-center rounded-full bg-primary/10 text-sm font-bold",children:n+1}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium truncate",children:a.name}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[a.conversions," conversões"]})]}),e.jsx("div",{className:"text-right",children:e.jsx("div",{className:"font-medium text-sm",children:j(a.revenue)})})]},a.name))})})]})]})})]})]})};export{Re as default};

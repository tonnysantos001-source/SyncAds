var F=Object.defineProperty;var z=(t,s,a)=>s in t?F(t,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[s]=a;var x=(t,s,a)=>z(t,typeof s!="symbol"?s+"":s,a);import{a6 as V,a7 as W,a8 as U,f as B,u as H,r as g,s as A,j as e,B as y,I as S,g as f,h as v,i as N,C as R,l as j,d as T,a9 as D,k as q,n as $,X}from"./index-DVJSl2Ld.js";import{L as C}from"./label-D4Gc-So-.js";import{D as Y,f as J,a as Z,b as Q,c as ee,d as se,e as ae}from"./dialog-DwnGSz2w.js";import{S as te,a as re,b as ie,c as ne,d as le}from"./select-DqXQ0fFQ.js";import{S as K}from"./SuperAdminLayout-BXGXFdZr.js";import{g as ce}from"./gatewaysApi-BoivFBnK.js";import{P}from"./plus-1Vai_N8k.js";import"./index-BuTvEyzT.js";import"./Logo-BEca72SF.js";import"./message-square-7JtsOD7H.js";import"./dollar-sign-DoGHfp-d.js";class oe extends Error{constructor(a){super(a.message);x(this,"type");x(this,"userMessage");x(this,"details");x(this,"code");x(this,"statusCode");x(this,"retryable");this.name="CustomError",this.type=a.type,this.userMessage=a.userMessage,this.details=a.details,this.code=a.code,this.statusCode=a.statusCode||500,this.retryable=a.retryable||!1}}function k(t){var s,a,n;return t!=null&&t.code?de(t):t!=null&&t.response?ue(t):(s=t==null?void 0:t.message)!=null&&s.includes("fetch")||(a=t==null?void 0:t.message)!=null&&a.includes("network")?{type:"NETWORK_ERROR",message:t.message,userMessage:"Erro de conexÃ£o. Verifique sua internet.",retryable:!0}:(n=t==null?void 0:t.message)!=null&&n.includes("timeout")?{type:"TIMEOUT",message:t.message,userMessage:"A operaÃ§Ã£o demorou muito. Tente novamente.",retryable:!0}:t instanceof oe?{type:t.type,message:t.message,userMessage:t.userMessage,details:t.details,code:t.code,statusCode:t.statusCode,retryable:t.retryable}:{type:"UNKNOWN_ERROR",message:(t==null?void 0:t.message)||"Erro desconhecido",userMessage:"Algo deu errado. Tente novamente.",details:t,retryable:!1}}function de(t){const s=t.code,a=t.message||"";return s==="PGRST301"||a.includes("JWT")?{type:"SESSION_EXPIRED",message:a,userMessage:"Sua sessÃ£o expirou. FaÃ§a login novamente.",code:s,statusCode:401,retryable:!1}:s==="PGRST116"||a.includes("not found")?{type:"NOT_FOUND",message:a,userMessage:"Registro nÃ£o encontrado.",code:s,statusCode:404,retryable:!1}:s==="23505"||a.includes("duplicate")||a.includes("already exists")?{type:"DUPLICATE_ENTRY",message:a,userMessage:"Este registro jÃ¡ existe.",code:s,statusCode:409,retryable:!1}:a.includes("permission denied")||a.includes("RLS")?{type:"FORBIDDEN",message:a,userMessage:"VocÃª nÃ£o tem permissÃ£o para esta aÃ§Ã£o.",code:s,statusCode:403,retryable:!1}:{type:"DATABASE_ERROR",message:a,userMessage:"Erro ao acessar o banco de dados.",code:s,statusCode:500,retryable:!0}}function ue(t){var m,d;const s=(m=t.response)==null?void 0:m.status,a=(d=t.response)==null?void 0:d.data,n=(a==null?void 0:a.message)||(a==null?void 0:a.error)||t.message;switch(s){case 400:return{type:"VALIDATION_ERROR",message:n,userMessage:"Dados invÃ¡lidos. Verifique os campos.",statusCode:400,details:a,retryable:!1};case 401:return{type:"UNAUTHORIZED",message:n,userMessage:"VocÃª precisa fazer login.",statusCode:401,retryable:!1};case 403:return{type:"FORBIDDEN",message:n,userMessage:"VocÃª nÃ£o tem permissÃ£o para esta aÃ§Ã£o.",statusCode:403,retryable:!1};case 404:return{type:"NOT_FOUND",message:n,userMessage:"Recurso nÃ£o encontrado.",statusCode:404,retryable:!1};case 409:return{type:"DUPLICATE_ENTRY",message:n,userMessage:"Este registro jÃ¡ existe.",statusCode:409,retryable:!1};case 429:return{type:"RATE_LIMIT_EXCEEDED",message:n,userMessage:"Muitas requisiÃ§Ãµes. Aguarde um momento.",statusCode:429,retryable:!0};case 500:case 502:case 503:case 504:return{type:"API_ERROR",message:n,userMessage:"Erro no servidor. Tente novamente em alguns instantes.",statusCode:s,retryable:!0};default:return{type:"API_ERROR",message:n,userMessage:"Erro na comunicaÃ§Ã£o com o servidor.",statusCode:s,details:a,retryable:!0}}}class me{constructor(){x(this,"logs",[]);x(this,"maxLogs",100)}log(s,a){const n={timestamp:new Date().toISOString(),type:s.type,message:s.message,userMessage:s.userMessage,details:s.details,code:s.code,statusCode:s.statusCode,userId:a==null?void 0:a.userId,organizationId:a==null?void 0:a.organizationId,url:window.location.href,userAgent:navigator.userAgent};this.logs.unshift(n),this.logs.length>this.maxLogs&&(this.logs=this.logs.slice(0,this.maxLogs)),this.sendToSentry(n)}getLogs(s=20){return this.logs.slice(0,s)}clear(){this.logs=[]}sendToSentry(s){V("error_details",{type:s.type,code:s.code,statusCode:s.statusCode,url:s.url}),W(s.userMessage,"error",{type:s.type,code:s.code,statusCode:s.statusCode});const a=new Error(s.message);a.name=s.type,U(a,{type:s.type,code:s.code,statusCode:s.statusCode,userMessage:s.userMessage,details:s.details,userId:s.userId,organizationId:s.organizationId,url:s.url})}}const ge=new me;function pe(t,s){const a=k(t);return ge.log(a,s),a}async function xe(t,s={}){const{maxRetries:a=3,delayMs:n=1e3,backoff:m=!0}=s;let d;for(let p=0;p<=a;p++)try{return await t()}catch(h){if(d=h,!k(h).retryable)throw h;if(p===a)break;const l=m?n*Math.pow(2,p):n;await new Promise(u=>setTimeout(u,l)),console.log(`ðŸ”„ Retry attempt ${p+1}/${a}`)}throw d}function he(){const{toast:t}=B(),{user:s,organization:a}=H(),n=g.useCallback((i,l)=>{const u=pe(i,{userId:s==null?void 0:s.id,organizationId:a==null?void 0:a.id});return t({title:"Erro",description:l||u.userMessage,variant:"destructive"}),u},[t,s,a]),m=g.useCallback(i=>{t({title:"Sucesso",description:i})},[t]),d=g.useCallback(i=>{t({title:"AtenÃ§Ã£o",description:i,variant:"default"})},[t]),p=g.useCallback(i=>{t({title:"InformaÃ§Ã£o",description:i})},[t]),h=g.useCallback(async(i,l)=>{try{const w=await(l!=null&&l.retry?()=>xe(i,l.retry):i)();return l!=null&&l.successMessage&&m(l.successMessage),w}catch(u){return n(u,l==null?void 0:l.errorMessage),null}},[n,m]);return{showError:n,showSuccess:m,showWarning:d,showInfo:p,executeWithErrorHandling:h}}const O=[{value:"stripe",label:"Stripe",icon:"ðŸ’³"},{value:"mercadopago",label:"Mercado Pago",icon:"ðŸ‡§ðŸ‡·"},{value:"pagseguro",label:"PagSeguro",icon:"ðŸ”’"},{value:"paypal",label:"PayPal",icon:"ðŸ…¿ï¸"},{value:"asaas",label:"Asaas",icon:"ðŸ’°"}];function Re(){const{showError:t,executeWithErrorHandling:s}=he(),[a,n]=g.useState([]),[m,d]=g.useState(!1),[p,h]=g.useState(!0),[i,l]=g.useState({name:"",provider:"",publicKey:"",secretKey:""});g.useEffect(()=>{u()},[]);const u=async()=>{h(!0);const r=await s(async()=>{const o=await ce.list();return await Promise.all(o.map(async c=>{var M,I;try{const{count:L}=await A.from("Transaction").select("*",{count:"exact",head:!0}).eq("gatewayId",c.id);return{id:c.id,name:c.name,provider:c.type,publicKey:((M=c.apiKey)==null?void 0:M.slice(0,20))+"***"||"N/A",isActive:c.isActive,createdAt:c.createdAt,transactionsCount:L||0}}catch{return{id:c.id,name:c.name,provider:c.type,publicKey:((I=c.apiKey)==null?void 0:I.slice(0,20))+"***"||"N/A",isActive:c.isActive,createdAt:c.createdAt,transactionsCount:0}}}))},{errorMessage:"NÃ£o foi possÃ­vel carregar os gateways"});r&&n(r),h(!1)},w=async()=>{if(!i.name||!i.provider||!i.publicKey||!i.secretKey){t(new Error("Campos obrigatÃ³rios"),"Preencha todos os campos");return}await s(async()=>{const{data:o,error:b}=await A.from("Gateway").insert({name:i.name,type:i.provider,apiKey:i.publicKey,secretKey:i.secretKey,isActive:!0,createdAt:new Date().toISOString()}).select().single();if(b)throw b;return o},{successMessage:`${i.name} foi configurado com sucesso.`,errorMessage:"NÃ£o foi possÃ­vel adicionar o gateway"})&&(d(!1),l({name:"",provider:"",publicKey:"",secretKey:""}),u())},G=async(r,o)=>{await s(async()=>{const{error:c}=await A.from("Gateway").update({isActive:o,updatedAt:new Date().toISOString()}).eq("id",r);if(c)throw c;return!0},{successMessage:o?"Gateway ativado":"Gateway desativado",errorMessage:"NÃ£o foi possÃ­vel atualizar o status"})&&u()},_=r=>O.find(o=>o.value===r)||{label:r,icon:"ðŸ’³"},E={total:a.length,active:a.filter(r=>r.isActive).length,totalTransactions:a.reduce((r,o)=>r+(o.transactionsCount||0),0)};return p?e.jsx(K,{children:e.jsx("div",{className:"flex items-center justify-center min-h-[50vh]",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})})}):e.jsx(K,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white",children:"Gateways de Pagamento"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"Gerencie os meios de recebimento dos clientes"})]}),e.jsxs(Y,{open:m,onOpenChange:d,children:[e.jsx(J,{asChild:!0,children:e.jsxs(y,{className:"bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600",children:[e.jsx(P,{className:"h-4 w-4 mr-2"}),"Adicionar Gateway"]})}),e.jsxs(Z,{className:"sm:max-w-[500px]",children:[e.jsxs(Q,{children:[e.jsx(ee,{children:"Adicionar Gateway de Pagamento"}),e.jsx(se,{children:"Configure um novo meio de recebimento"})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(C,{htmlFor:"name",children:"Nome do Gateway"}),e.jsx(S,{id:"name",placeholder:"Ex: Stripe Principal",value:i.name,onChange:r=>l({...i,name:r.target.value})})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(C,{htmlFor:"provider",children:"Provider"}),e.jsxs(te,{value:i.provider,onValueChange:r=>l({...i,provider:r}),children:[e.jsx(re,{children:e.jsx(ie,{placeholder:"Selecione um provider"})}),e.jsx(ne,{children:O.map(r=>e.jsx(le,{value:r.value,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:r.icon}),e.jsx("span",{children:r.label})]})},r.value))})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(C,{htmlFor:"publicKey",children:"Public Key"}),e.jsx(S,{id:"publicKey",placeholder:"pk_test_...",value:i.publicKey,onChange:r=>l({...i,publicKey:r.target.value})})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(C,{htmlFor:"secretKey",children:"Secret Key"}),e.jsx(S,{id:"secretKey",type:"password",placeholder:"sk_test_...",value:i.secretKey,onChange:r=>l({...i,secretKey:r.target.value})}),e.jsx("p",{className:"text-xs text-gray-500",children:"Esta chave serÃ¡ armazenada de forma segura e criptografada"})]})]}),e.jsxs(ae,{children:[e.jsx(y,{variant:"outline",onClick:()=>d(!1),children:"Cancelar"}),e.jsx(y,{className:"bg-gradient-to-r from-blue-500 to-purple-500",onClick:w,children:"Adicionar Gateway"})]})]})]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsxs(f,{children:[e.jsxs(v,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(N,{className:"text-sm font-medium",children:"Gateways Configurados"}),e.jsx(R,{className:"h-4 w-4 text-blue-600"})]}),e.jsxs(j,{children:[e.jsx("div",{className:"text-2xl font-bold",children:E.total}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Total de meios de pagamento"})]})]}),e.jsxs(f,{children:[e.jsxs(v,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(N,{className:"text-sm font-medium",children:"Gateways Ativos"}),e.jsx(T,{className:"h-4 w-4 text-green-600"})]}),e.jsxs(j,{children:[e.jsx("div",{className:"text-2xl font-bold",children:E.active}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Recebendo pagamentos"})]})]}),e.jsxs(f,{children:[e.jsxs(v,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(N,{className:"text-sm font-medium",children:"TransaÃ§Ãµes"}),e.jsx(D,{className:"h-4 w-4 text-purple-600"})]}),e.jsxs(j,{children:[e.jsx("div",{className:"text-2xl font-bold",children:E.totalTransactions}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Total processadas"})]})]})]}),e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:a.length===0?e.jsx(f,{className:"col-span-full",children:e.jsxs(j,{className:"flex flex-col items-center justify-center py-12",children:[e.jsx(R,{className:"h-12 w-12 text-gray-400 mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-white mb-2",children:"Nenhum gateway configurado"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mb-4",children:"Adicione seu primeiro gateway de pagamento"}),e.jsxs(y,{className:"bg-gradient-to-r from-blue-500 to-purple-500",onClick:()=>d(!0),children:[e.jsx(P,{className:"h-4 w-4 mr-2"}),"Adicionar Gateway"]})]})}):a.map(r=>{const o=_(r.provider);return e.jsxs(f,{className:"relative overflow-hidden",children:[e.jsx("div",{className:`absolute top-0 right-0 w-32 h-32 transform translate-x-16 -translate-y-16 rounded-full ${r.isActive?"bg-green-500/10":"bg-gray-500/10"}`}),e.jsx(v,{children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"text-3xl",children:o.icon}),e.jsxs("div",{children:[e.jsx(N,{className:"text-lg",children:r.name}),e.jsx(q,{children:o.label})]})]}),e.jsx($,{variant:r.isActive?"default":"outline",children:r.isActive?"Ativo":"Inativo"})]})}),e.jsxs(j,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Public Key"}),e.jsx("code",{className:"text-xs bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded block overflow-hidden text-ellipsis",children:r.publicKey})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-gray-500",children:"TransaÃ§Ãµes"}),e.jsx("span",{className:"font-medium",children:r.transactionsCount||0})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(y,{variant:"outline",className:"flex-1",size:"sm",onClick:()=>{},children:[e.jsx(D,{className:"h-4 w-4 mr-1"}),"Configurar"]}),e.jsx(y,{variant:r.isActive?"destructive":"default",size:"sm",onClick:()=>G(r.id,!r.isActive),children:r.isActive?e.jsx(X,{className:"h-4 w-4"}):e.jsx(T,{className:"h-4 w-4"})})]})]})]},r.id)})})]})})}export{Re as default};

import{s as i,r as f,b as R,u as z,j as e,B as A,a6 as B,d as y,e as j,f as b,h as g,S as P,I as D,o as U}from"./index-CurQCjv1.js";import{T as F,a as L,b as N,c as u,d as O,e as x}from"./table-NgKfF-Ho.js";import{a as H}from"./shopifySync-DMtENPGw.js";import{S as E}from"./skeleton-KytUVP5t.js";import{S as I}from"./shopping-cart-BrO4pQeG.js";import{C as V}from"./clock-CbYKYQdP.js";import{M as T}from"./mail-B1a8VkQI.js";const w={async getAll(r){const{data:a,error:t}=await i.from("AbandonedCart").select("*").eq("userId",r).order("createdAt",{ascending:!1});if(t)throw t;const{data:d,error:l}=await i.from("ShopifyAbandonedCart").select("*").eq("userId",r).order("abandonedAt",{ascending:!1});if(l)throw l;const c=(d||[]).map(s=>({id:s.id,userId:s.userId,cartId:s.shopifyCartId||s.id,customerEmail:s.email,customerName:s.customerName,items:s.lineItems||{},subtotal:s.totalPrice||0,total:s.totalPrice||0,recoveryEmailSent:!1,recoveryEmailSentAt:void 0,recovered:!1,recoveredAt:void 0,recoveryOrderId:void 0,metadata:{source:"shopify",shopifyCartToken:s.cartToken,abandonedCheckoutUrl:s.abandonedCheckoutUrl},createdAt:s.abandonedAt||s.createdAt}));return[...a||[],...c].filter((s,o,p)=>o===p.findIndex(C=>C.cartId===s.cartId)).sort((s,o)=>new Date(o.createdAt).getTime()-new Date(s.createdAt).getTime())},async getById(r){const{data:a,error:t}=await i.from("AbandonedCart").select("*").eq("id",r).single();if(t)throw t;return a},async create(r){const{data:a,error:t}=await i.from("AbandonedCart").insert(r).select().single();if(t)throw t;return a},async markEmailSent(r){const{data:a,error:t}=await i.from("AbandonedCart").update({recoveryEmailSent:!0,recoveryEmailSentAt:new Date().toISOString()}).eq("id",r).select().single();if(t)throw t;return a},async markRecovered(r,a){const{data:t,error:d}=await i.from("AbandonedCart").update({recovered:!0,recoveredAt:new Date().toISOString(),recoveryOrderId:a}).eq("id",r).select().single();if(d)throw d;return t},async getUnrecovered(r){return(await w.getAll(r)).filter(t=>!t.recovered)},async getNeedingEmail(r){return(await w.getAll(r)).filter(t=>!t.recoveryEmailSent&&!t.recovered)},async getShopifyAbandoned(r){const{data:a,error:t}=await i.from("ShopifyAbandonedCart").select("*").eq("userId",r).order("abandonedAt",{ascending:!1});if(t)throw t;return a},async syncFromShopify(r){try{const{data:a,error:t}=await i.from("ShopifyAbandonedCart").select("*").eq("id",r).single();if(t)throw t;const{data:d}=await i.from("AbandonedCart").select("id").eq("cartId",a.shopifyCartId||r).single();if(d)return d;const l={userId:a.userId,cartId:a.shopifyCartId||r,customerEmail:a.email,customerName:a.customerName,items:a.lineItems||{},subtotal:a.totalPrice||0,total:a.totalPrice||0,recoveryEmailSent:!1,recovered:!1,metadata:{source:"shopify",shopifyCartToken:a.cartToken,abandonedCheckoutUrl:a.abandonedCheckoutUrl}},{data:c,error:m}=await i.from("AbandonedCart").insert(l).select().single();if(m)throw m;return c}catch(a){throw console.error("Error syncing Shopify cart:",a),a}},async delete(r){const{error:a}=await i.from("AbandonedCart").delete().eq("id",r);if(a)throw a}},X=()=>{const[r,a]=f.useState([]),[t,d]=f.useState(!0),[l,c]=f.useState(!1),[m,v]=f.useState(""),{toast:s}=R(),o=z(n=>n.user);f.useEffect(()=>{p()},[]);const p=async()=>{try{if(!(o!=null&&o.id))return;const n=await w.getAll(o.id);a(n)}catch(n){s({title:"Erro ao carregar",description:n.message,variant:"destructive"})}finally{d(!1)}},C=async()=>{if(!(o!=null&&o.id)){s({title:"Erro",description:"Faça login para sincronizar",variant:"destructive"});return}try{c(!0),s({title:"Sincronizando...",description:"Buscando carrinhos abandonados da Shopify"});const n=await H.syncAbandonedCarts(o.id);n.success?(s({title:"Sincronização concluída!",description:n.message}),await p()):s({title:"Erro na sincronização",description:n.message,variant:"destructive"})}catch{s({title:"Erro ao sincronizar",description:"Configure a integração Shopify em Integrações",variant:"destructive"})}finally{c(!1)}},k=async n=>{try{s({title:"Email de recuperação enviado!"})}catch(h){s({title:"Erro",description:h.message,variant:"destructive"})}},S=r.filter(n=>{var h;return(h=n.customerEmail)==null?void 0:h.toLowerCase().includes(m.toLowerCase())}),q=r.reduce((n,h)=>n+h.total,0);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Carrinhos Abandonados"}),e.jsx("p",{className:"text-muted-foreground",children:"Recupere vendas de carrinhos abandonados"})]}),e.jsxs(A,{onClick:C,disabled:l,children:[e.jsx(B,{className:`mr-2 h-4 w-4 ${l?"animate-spin":""}`}),l?"Sincronizando...":"Sincronizar Shopify"]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsxs(y,{children:[e.jsxs(j,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(b,{className:"text-sm font-medium",children:"Total Abandonados"}),e.jsx(I,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(g,{children:e.jsx("div",{className:"text-2xl font-bold",children:r.length})})]}),e.jsxs(y,{children:[e.jsxs(j,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(b,{className:"text-sm font-medium",children:"Valor Total"}),e.jsx(V,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(g,{children:e.jsxs("div",{className:"text-2xl font-bold",children:["R$ ",q.toFixed(2)]})})]}),e.jsxs(y,{children:[e.jsxs(j,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(b,{className:"text-sm font-medium",children:"Taxa Recuperação"}),e.jsx(T,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(g,{children:e.jsx("div",{className:"text-2xl font-bold",children:"-"})})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(P,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(D,{placeholder:"Buscar por email...",value:m,onChange:n=>v(n.target.value),className:"pl-9"})]}),e.jsxs(y,{children:[e.jsx(j,{children:e.jsx(b,{children:"Lista de Carrinhos"})}),e.jsx(g,{children:t?e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{className:"h-12 w-full"}),e.jsx(E,{className:"h-12 w-full"})]}):S.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(I,{className:"h-12 w-12 text-muted-foreground mb-4 mx-auto"}),e.jsx("h3",{className:"text-lg font-semibold",children:"Nenhum carrinho abandonado"})]}):e.jsxs(F,{children:[e.jsx(L,{children:e.jsxs(N,{children:[e.jsx(u,{children:"Email"}),e.jsx(u,{children:"Produtos"}),e.jsx(u,{children:"Valor"}),e.jsx(u,{children:"Abandonado há"}),e.jsx(u,{children:"Ações"})]})}),e.jsx(O,{children:S.map(n=>e.jsxs(N,{children:[e.jsx(x,{children:n.customerEmail}),e.jsxs(x,{children:[n.itemCount," items"]}),e.jsxs(x,{children:["R$ ",n.total.toFixed(2)]}),e.jsx(x,{children:e.jsxs(U,{variant:"outline",children:[n.abandonedDays,"d"]})}),e.jsx(x,{children:e.jsxs(A,{size:"sm",onClick:()=>k(n.id),children:[e.jsx(T,{className:"h-4 w-4 mr-2"}),"Recuperar"]})})]},n.id))})]})})]})]})};export{X as default};

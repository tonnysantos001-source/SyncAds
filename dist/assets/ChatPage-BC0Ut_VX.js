import{j as e}from"./vendor-ui-DkUuACDy.js";import{f as a,r as t}from"./vendor-react-X41Bjl18.js";import{g as s,f as n,s as r,i as o}from"./index-hPMilkXu.js";import{I as i,a as c,b as d}from"./IconSend-H1bouXv2.js";import"./vendor-supabase-BQxDPPjR.js";import"./vendor-utils-Dl0_yMKq.js";import"./vendor-animation-DQ3cvw6m.js";import"./vendor-query-Bf3pI66S.js";import"./vendor-icons-DTdRnryx.js";function l({status:a="thinking"}){return e.jsxs("div",{className:"flex items-center gap-2 p-4 bg-gray-800 rounded-lg max-w-[70%]",children:[e.jsxs("div",{className:"flex gap-1",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-bounce [animation-delay:-0.3s]"}),e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-bounce [animation-delay:-0.15s]"}),e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-bounce"})]}),e.jsx("span",{className:"text-sm text-gray-400",children:{thinking:"Pensando...",searching:"Pesquisando...",navigating:"Navegando...",processing:"Processando..."}[a]})]})}function u(){const u=a(),{toast:m}=s(),g=n(e=>e.user),x=n(e=>e.isAuthenticated),[p,f]=t.useState([]),[h,v]=t.useState(null),[b,y]=t.useState(""),[E,N]=t.useState(!1),[j,w]=t.useState(!1),[A,S]=t.useState(null),[T,C]=t.useState(!0),[I,O]=t.useState({connected:!1,deviceId:null,lastCheck:0}),[D,k]=t.useState([]),P=t.useRef(null),R=t.useRef(null);t.useEffect(()=>{x&&g||u("/login-v2",{replace:!0})},[x,g,u]),t.useEffect(()=>{if(!g)return;(async()=>{N(!0);try{const{data:e,error:a}=await r.from("ChatConversation").select("id, title, createdAt").eq("userId",g.id).order("createdAt",{ascending:!1});if(a)throw a;if(!e||0===e.length){const e={id:crypto.randomUUID(),userId:g.id,title:`Conversa ${(new Date).toLocaleDateString()}`,createdAt:(new Date).toISOString()},{error:a}=await r.from("ChatConversation").insert(e);return void(a||(f([{id:e.id,title:e.title,messages:[]}]),v(e.id)))}const t=await Promise.all(e.map(async e=>{const{data:a}=await r.from("ChatMessage").select("id, role, content, createdAt").eq("conversationId",e.id).order("createdAt",{ascending:!0});return{id:e.id,title:e.title,messages:(a||[]).map(e=>({id:e.id,role:e.role.toLowerCase(),content:e.content,createdAt:e.createdAt}))}}));f(t),!h&&t.length>0&&v(t[0].id)}catch(e){m({title:"Erro",description:"NÃ£o foi possÃ­vel carregar as conversas",variant:"destructive"})}finally{N(!1)}})()},[g]),t.useEffect(()=>{if(!g)return;let e=0;const a=async()=>{try{const{data:a,error:t}=await r.from("extension_devices").select("id, device_id, status, last_seen").eq("user_id",g.id).eq("status","online").order("last_seen",{ascending:!1}).limit(1).maybeSingle();if(t)return e++,void(e>=3&&O({connected:!1,deviceId:null,lastCheck:Date.now()}));const s=Date.now(),n=a?new Date(a.last_seen).getTime():0;O({connected:!!a&&s-n<3e4,deviceId:a?.device_id||null,lastCheck:s}),t||(e=0)}catch(a){e++}};a();const t=setInterval(a,5e3);return()=>clearInterval(t)},[g]),t.useEffect(()=>{P.current?.scrollIntoView({behavior:"smooth"})},[p,h]),t.useEffect(()=>(D.length>0?(_(),R.current||(R.current=setInterval(()=>{_()},3e3))):R.current&&(clearInterval(R.current),R.current=null),()=>{R.current&&(clearInterval(R.current),R.current=null)}),[D.length,h,g]);const _=async()=>{if(0!==D.length)try{const e=D.map(e=>e.id),{data:a,error:t}=await r.from("ExtensionCommand").select("*").in("id",e).in("status",["COMPLETED","FAILED"]);if(t)return;if(a&&a.length>0)for(const n of a){const e=D.find(e=>e.id===n.id);e&&(await L(n,e.messageId),k(e=>e.filter(e=>e.id!==n.id)))}const s=Date.now()-12e4;k(e=>e.filter(e=>e.timestamp>s))}catch(e){}},L=async(e,a)=>{if(g&&h)try{const{data:{session:a}}=await r.auth.getSession();if(!a)return;let t="";if("COMPLETED"===e.status&&e.result){const a=e.result.result||e.result;switch(e.command){case"LIST_TABS":const s=a.tabs||[];t=`RESULTADO: Encontrei ${s.length} abas abertas:\n\n${s.map((e,a)=>`${a+1}. ${e.title}\n   URL: ${e.url}`).join("\n\n")}\n\nPor favor, apresente esta lista de forma organizada e amigÃ¡vel para o usuÃ¡rio.`;break;case"GET_PAGE_INFO":t=`RESULTADO: InformaÃ§Ãµes da pÃ¡gina:\n- TÃ­tulo: ${a.title}\n- URL: ${a.url}\n- DomÃ­nio: ${a.domain}\n\nResumo do conteÃºdo:\n${a.bodyText?.substring(0,500)||"Sem conteÃºdo"}\n\nPor favor, apresente essas informaÃ§Ãµes de forma clara para o usuÃ¡rio.`;break;case"NAVIGATE":t=`RESULTADO: Nova aba aberta com sucesso em: ${a.navigated}\n\nConfirme ao usuÃ¡rio que a aÃ§Ã£o foi concluÃ­da.`;break;case"CLICK_ELEMENT":t=`RESULTADO: Clique executado com sucesso no elemento: ${a.clicked}\n\nConfirme ao usuÃ¡rio que a aÃ§Ã£o foi concluÃ­da.`;break;case"TYPE_TEXT":t=`RESULTADO: Texto digitado com sucesso: "${a.value}"\n\nConfirme ao usuÃ¡rio que a aÃ§Ã£o foi concluÃ­da.`;break;case"READ_TEXT":t=`RESULTADO: Texto lido do elemento:\n\n${a.text}\n\nPor favor, apresente este conteÃºdo de forma clara para o usuÃ¡rio.`;break;default:t=`RESULTADO da aÃ§Ã£o ${e.command}:\n\n${JSON.stringify(a,null,2)}\n\nPor favor, apresente este resultado de forma clara para o usuÃ¡rio.`}}else"FAILED"===e.status&&(t=`ERRO: A aÃ§Ã£o ${e.command} falhou com o seguinte erro: ${e.error}\n\nPor favor, explique o problema ao usuÃ¡rio de forma amigÃ¡vel e sugira uma soluÃ§Ã£o.`);const s=await fetch("https://your-project.supabase.co/functions/v1/chat-enhanced",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a.access_token}`},body:JSON.stringify({message:t,conversationId:h,extensionConnected:I.connected})});if(!s.ok)throw new Error(`Erro HTTP: ${s.status}`);const n=await s.json(),o={id:crypto.randomUUID(),role:"assistant",content:n.response,createdAt:(new Date).toISOString()};f(e=>e.map(e=>e.id===h?{...e,messages:[...e.messages,o]}:e))}catch(t){}},$=async()=>{if(!b.trim()||!h||!g||j)return;const e=b.trim(),a=`temp-user-${Date.now()}`,t=`temp-ai-${Date.now()}`;y(""),w(!0);const s=e.toLowerCase();s.includes("pesquis")||s.includes("busca")||s.includes("procur")?S("searching"):s.includes("abr")||s.includes("naveg")||s.includes("acess")?S("navigating"):S("thinking");try{f(t=>t.map(t=>t.id===h?{...t,messages:[...t.messages,{id:a,role:"user",content:e,createdAt:(new Date).toISOString()}]}:t));const{data:{session:s}}=await r.auth.getSession();if(!s)throw new Error("Sem sessÃ£o");const n=await fetch("https://your-project.supabase.co/functions/v1/chat-enhanced",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s.access_token}`},body:JSON.stringify({message:e,conversationId:h,extensionConnected:I.connected,systemPrompt:JSON.stringify({role:"system",content:I.connected?'ðŸš€ EXTENSÃƒO DO NAVEGADOR ATIVA - MODO DE AUTOMAÃ‡ÃƒO WEB\n\n**REGRAS CRÃTICAS:**\n\n1. **NUNCA mostre blocos JSON ao usuÃ¡rio**\n - âŒ ERRADO: "Vou abrir para vocÃª ```json {...} ```"\n - âœ… CORRETO: Responda naturalmente: "Abrindo Facebook Ads em nova aba..."\n - O JSON serÃ¡ detectado e executado automaticamente nos bastidores\n\n2. **Comandos disponÃ­veis (use internamente, nÃ£o mostre):**\n - NAVIGATE: {"type": "NAVIGATE", "data": {"url": "https://..."}}\n - LIST_TABS: {"type": "LIST_TABS", "data": {}}\n - CLICK_ELEMENT: {"type": "CLICK_ELEMENT", "data": {"selector": "button"}}\n - TYPE_TEXT: {"type": "TYPE_TEXT", "data": {"selector": "input", "text": "..."}}\n - READ_TEXT: {"type": "READ_TEXT", "data": {"selector": ".class"}}\n - GET_PAGE_INFO: {"type": "GET_PAGE_INFO", "data": {}}\n - EXECUTE_JS: {"type": "EXECUTE_JS", "data": {"code": "..."}}\n\n3. **Fluxo correto:**\n - UsuÃ¡rio: "abra o facebook"\n - VocÃª: "Abrindo Facebook em nova aba... ```json\\n{"type": "NAVIGATE", "data": {"url": "https://facebook.com"}}\\n```"\n - Sistema detecta o JSON, executa silenciosamente e remove da tela\n - UsuÃ¡rio vÃª apenas: "Abrindo Facebook em nova aba..."\n\n4. **IMPORTANTE:**\n - Todas as navegaÃ§Ãµes SEMPRE abrem em NOVA ABA\n - NUNCA sai da pÃ¡gina do SaaS/chat\n - Seja natural e conversacional com o usuÃ¡rio\n - O JSON Ã© apenas para o sistema, nÃ£o para o usuÃ¡rio ver':"ExtensÃ£o do navegador OFFLINE. NÃ£o hÃ¡ acesso ao navegador. Responda normalmente."})})});if(!n.ok)throw new Error(`Erro HTTP: ${n.status}`);const o=await n.json();if(o.error)throw new Error(o.error);let i=o.response||"";i=i.replace(/```json\s*[\s\S]*?\s*```/g,""),i=i.replace(/\{[\s\S]*?"type"[\s\S]*?\}/g,""),i=i.replace(/\n{3,}/g,"\n\n").trim(),i||(i="Executando aÃ§Ã£o..."),f(s=>s.map(s=>s.id===h?{...s,messages:[...s.messages.filter(e=>!e.id.startsWith("temp-")),{id:o.userMessageId||a,role:"user",content:e,createdAt:(new Date).toISOString()},{id:o.aiMessageId||t,role:"assistant",content:i,createdAt:(new Date).toISOString()}]}:s))}catch(n){f(e=>e.map(e=>e.id===h?{...e,messages:e.messages.filter(e=>!e.id.startsWith("temp-"))}:e)),m({title:"Erro ao enviar mensagem",description:n.message||"Tente novamente",variant:"destructive"})}finally{w(!1),S(null)}},U=p.find(e=>e.id===h);return e.jsxs("div",{className:"flex h-full max-h-full overflow-hidden bg-gray-950 text-white",children:[e.jsx("div",{className:(T?"w-80":"w-0")+" transition-all duration-300 border-r border-gray-800 flex flex-col",children:T&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"p-4 border-b border-gray-800",children:e.jsxs("button",{onClick:async()=>{if(g)try{const e=(new Date).toISOString(),a={id:crypto.randomUUID(),userId:g.id,title:`Conversa ${(new Date).toLocaleDateString()}`,createdAt:e,updatedAt:e},{data:t,error:s}=await r.from("ChatConversation").insert(a).select().single();if(s)throw s;const n={id:a.id,title:a.title,messages:[]};f([n,...p]),v(a.id),m({title:"Nova conversa criada!"})}catch(e){m({title:"Erro",description:e?.message||"NÃ£o foi possÃ­vel criar nova conversa",variant:"destructive"})}else m({title:"Erro",description:"UsuÃ¡rio nÃ£o autenticado",variant:"destructive"})},className:"w-full flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg transition-colors",children:[e.jsx(i,{className:"w-5 h-5"}),"Nova Conversa"]})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-2",children:E?e.jsx("div",{className:"text-center text-gray-500 py-4",children:"Carregando..."}):p.map(a=>e.jsxs("div",{onClick:()=>v(a.id),className:"p-3 mb-2 rounded-lg cursor-pointer transition-colors "+(h===a.id?"bg-gray-800 border border-blue-600":"bg-gray-900 hover:bg-gray-800"),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm truncate",children:a.title}),e.jsx("button",{onClick:e=>{e.stopPropagation(),(async e=>{try{const{error:a}=await r.from("ChatConversation").delete().eq("id",e);if(a)throw a;f(a=>a.filter(a=>a.id!==e)),h===e&&v(p[0]?.id||null),m({title:"Conversa deletada"})}catch(a){m({title:"Erro ao deletar",variant:"destructive"})}})(a.id)},className:"text-gray-500 hover:text-red-500",children:e.jsx(o,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[a.messages.length," mensagens"]})]},a.id))})]})}),e.jsxs("div",{className:"flex-1 flex flex-col min-h-0",children:[e.jsxs("div",{className:"h-16 border-b border-gray-800 flex items-center px-4 justify-between",children:[e.jsx("button",{onClick:()=>C(!T),className:"p-2 hover:bg-gray-800 rounded-lg",children:e.jsx(c,{className:"w-6 h-6"})}),e.jsx("h1",{className:"text-lg font-semibold",children:U?.title||"Chat"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-medium "+(I.connected?"bg-green-600/20 text-green-400 border border-green-600/30":"bg-gray-800 text-gray-400 border border-gray-700"),children:[e.jsx("div",{className:"w-2 h-2 rounded-full "+(I.connected?"bg-green-400":"bg-gray-500")}),e.jsx("span",{children:I.connected?"ExtensÃ£o Ativa":"ExtensÃ£o Offline"})]})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:U?0===U.messages.length?e.jsx("div",{className:"flex items-center justify-center h-full text-gray-500",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xl mb-2",children:"Nova conversa"}),e.jsx("p",{className:"text-sm",children:"Envie uma mensagem para comeÃ§ar"}),I.connected&&e.jsxs("div",{className:"mt-8 p-4 bg-green-600/10 border border-green-600/30 rounded-lg max-w-md mx-auto",children:[e.jsx("p",{className:"text-green-400 text-sm mb-2 font-medium",children:"âœ¨ ExtensÃ£o conectada!"}),e.jsx("p",{className:"text-gray-400 text-xs",children:'Agora posso controlar seu navegador. Experimente: "Abra o Facebook Ads"'})]})]})}):e.jsxs(e.Fragment,{children:[U.messages.map(a=>e.jsx("div",{className:"flex "+("user"===a.role?"justify-end":"justify-start"),children:e.jsx("div",{className:"max-w-[70%] rounded-lg p-4 "+("user"===a.role?"bg-blue-600":"bg-gray-800"),children:e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:a.content})})},a.id)),A&&e.jsx(l,{status:A}),e.jsx("div",{ref:P})]}):e.jsx("div",{className:"flex items-center justify-center h-full text-gray-500",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xl mb-2",children:"Nenhuma conversa selecionada"}),e.jsx("p",{className:"text-sm",children:"Crie uma nova conversa para comeÃ§ar"}),!I.connected&&e.jsxs("div",{className:"mt-8 p-4 bg-yellow-600/10 border border-yellow-600/30 rounded-lg max-w-md mx-auto",children:[e.jsx("p",{className:"text-yellow-400 text-sm mb-2 font-medium",children:"âš ï¸ ExtensÃ£o do navegador offline"}),e.jsx("p",{className:"text-gray-400 text-xs",children:"Para usar automaÃ§Ã£o de navegador, instale e ative a extensÃ£o SyncAds AI"})]})]})})}),e.jsx("div",{className:"border-t border-gray-800 p-4",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:b,onChange:e=>y(e.target.value),onKeyPress:e=>"Enter"===e.key&&!e.shiftKey&&$(),onPaste:e=>{e.stopPropagation();const a=e.clipboardData.getData("text");a&&y(b+a)},placeholder:"Digite sua mensagem...",disabled:j||!h,className:"flex-1 bg-gray-900 border border-gray-800 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-600 disabled:opacity-50"}),e.jsx("button",{onClick:$,disabled:!b.trim()||j||!h,className:"bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-white px-6 py-3 rounded-lg transition-colors flex items-center gap-2",children:j?e.jsx("span",{children:"Enviando..."}):e.jsxs(e.Fragment,{children:[e.jsx(d,{className:"w-5 h-5"}),"Enviar"]})})]})})]})]})}export{u as default};

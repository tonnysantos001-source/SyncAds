import{j as e}from"./vendor-ui-DAyDU-p2.js";import{k as t,e as r,r as a}from"./vendor-react-BDwqAlkB.js";import{s as o}from"./index-DpZKd0kH.js";import{I as n}from"./types-BvyIDsDA.js";import{L as s,C as i,O as c}from"./vendor-icons-D7__3E7E.js";import"./vendor-supabase-rKXMzPQL.js";import"./vendor-utils-Dl0_yMKq.js";import"./vendor-animation-x8f1c1kX.js";import"./vendor-query-D3VdSFIC.js";const d=new class{REDIRECT_URI=`${window.location.origin}/integrations/callback`;async listIntegrations(e){const{data:t,error:r}=await o.from("Integration").select("*").eq("userId",e);if(r)throw r;return t||[]}async getIntegrationStatus(e,t){const{data:r,error:a}=await o.from("Integration").select("*").eq("userId",e).eq("platform",t.toUpperCase()).single();if(a&&"PGRST116"!==a.code)throw a;return r}async generateOAuthUrl(e,t){const r=n[e];if(!r||"oauth"!==r.authType)throw new Error("IntegraÃ§Ã£o nÃ£o suporta OAuth");if(!r.clientId||"your-google-client-id"===r.clientId||"your-meta-client-id"===r.clientId||"your-linkedin-client-id"===r.clientId||"your-twitter-client-id"===r.clientId||"your-tiktok-client-id"===r.clientId)throw new Error(`âŒ Client ID nÃ£o configurado para ${r.name}\n\nðŸ“ Para conectar esta integraÃ§Ã£o, vocÃª precisa:\n1. Criar uma aplicaÃ§Ã£o OAuth no ${r.name}\n2. Adicionar o Client ID no arquivo .env\n3. Reiniciar o servidor de desenvolvimento\n\nðŸ“– Consulte OAUTH_SETUP.md para instruÃ§Ãµes detalhadas.`);const a=btoa(JSON.stringify({userId:t,slug:e,timestamp:Date.now(),random:Math.random().toString(36).substring(7)})),s=new Date(Date.now()+6e5).toISOString(),{error:i}=await o.from("OAuthState").insert({id:crypto.randomUUID(),state:a,userId:t,integrationSlug:e,expiresAt:s,createdAt:(new Date).toISOString()});if(i)throw new Error(`Erro ao armazenar state OAuth: ${i.message}`);const c=new URLSearchParams({client_id:r.clientId,redirect_uri:this.REDIRECT_URI,response_type:"code",scope:r.scopes?.join(" ")||"",state:a,access_type:"offline",prompt:"consent"});return{authUrl:`${r.authUrl}?${c.toString()}`,state:a}}async handleOAuthCallback(e,t){const{data:r,error:a}=await o.from("OAuthState").select("*").eq("state",t).single();if(a||!r)throw new Error("State invÃ¡lido ou expirado");const{userId:s,integrationSlug:i}=JSON.parse(atob(t)),c=n[i];if(!c)throw new Error("IntegraÃ§Ã£o nÃ£o encontrada");const d=await fetch(c.tokenUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({client_id:c.clientId,client_secret:"8b80da29081d73fd7d1037f3cae72d55",code:e,redirect_uri:this.REDIRECT_URI,grant_type:"authorization_code"})});if(!d.ok)throw new Error("Falha ao obter tokens");const l=await d.json();l.expires_in&&new Date(Date.now()+1e3*l.expires_in).toISOString();const{data:m}=await o.from("Integration").select("id").eq("userId",s).eq("platform",i.toUpperCase()).single();if(m)await o.from("Integration").update({credentials:{access_token:l.access_token,refresh_token:l.refresh_token},isConnected:!0,lastSyncAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()}).eq("id",m.id);else{const{error:e}=await o.from("Integration").insert({id:crypto.randomUUID(),userId:s,platform:i.toUpperCase(),credentials:{access_token:l.access_token,refresh_token:l.refresh_token},isConnected:!0,lastSyncAt:(new Date).toISOString(),createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()});if(e)throw e}return await o.from("OAuthState").delete().eq("state",t),{success:!0,slug:i}}async connectDirect(e,t,r){throw new Error("AutenticaÃ§Ã£o direta requer implementaÃ§Ã£o no backend")}async disconnect(e,t){const{error:r}=await o.from("Integration").delete().eq("userId",e).eq("platform",t.toUpperCase());if(r)throw r}async refreshToken(e){}};function l(){const[l]=t(),m=r(),[u,h]=a.useState("loading"),[g,p]=a.useState("Processing your connection...");return a.useEffect(()=>{(async()=>{try{const t=l.get("shop"),r=l.get("code"),a=l.get("hmac");if(t&&r&&a){h("loading"),p("Conectando com Shopify...");try{const e=await o.auth.getSession(),n=await fetch(`https://your-project.supabase.co/functions/v1/shopify-oauth?action=callback&shop=${t}&code=${r}&hmac=${a}`,{headers:{Authorization:`Bearer ${e.data.session?.access_token}`}}),s=await n.json();if(s.success)return h("success"),p("Shopify conectada! Sincronizando dados..."),void setTimeout(()=>m("/integrations"),2e3);throw new Error(s.error||"Erro ao conectar Shopify")}catch(e){return h("error"),p(`Erro ao conectar Shopify: ${e.message}`),void setTimeout(()=>m("/integrations"),3e3)}}const s=l.get("state"),i=l.get("error");if(i)throw new Error(i);if(!r||!s)throw new Error("Missing code or state parameter");const c=await d.handleOAuthCallback(r,s),u=n[c.slug];h("success"),p(`${u.name} connected successfully!`);const g=JSON.parse(atob(s));localStorage.setItem(`oauth_success_${g.platform}_${g.userId}`,"true"),setTimeout(()=>{window.opener?window.close():m("/chat")},2e3)}catch(t){h("error"),p(t.message||"Failed to connect integration"),setTimeout(()=>{window.opener?window.close():m("/chat")},3e3)}})()},[l,m]),e.jsx("div",{className:"flex items-center justify-center min-h-screen bg-gray-50 dark:bg-gray-900",children:e.jsxs("div",{className:"text-center p-8 bg-white dark:bg-gray-800 rounded-lg shadow-lg max-w-md",children:["loading"===u&&e.jsxs(e.Fragment,{children:[e.jsx(s,{className:"h-16 w-16 animate-spin text-blue-600 mx-auto mb-4"}),e.jsx("h1",{className:"text-2xl font-bold mb-2",children:"Processing..."}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:g})]}),"success"===u&&e.jsxs(e.Fragment,{children:[e.jsx(i,{className:"h-16 w-16 text-green-600 mx-auto mb-4"}),e.jsx("h1",{className:"text-2xl font-bold mb-2 text-green-600",children:"Success!"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:g}),e.jsx("p",{className:"text-sm text-gray-500 mt-2",children:"Closing this window..."})]}),"error"===u&&e.jsxs(e.Fragment,{children:[e.jsx(c,{className:"h-16 w-16 text-red-600 mx-auto mb-4"}),e.jsx("h1",{className:"text-2xl font-bold mb-2 text-red-600",children:"Error"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:g}),e.jsx("p",{className:"text-sm text-gray-500 mt-2",children:"Redirecting..."})]})]})})}export{l as IntegrationCallbackPage};

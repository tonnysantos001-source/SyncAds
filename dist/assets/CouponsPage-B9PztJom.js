import{c as J,s as D,r as y,f as K,u as Q,j as e,B as S,aa as W,I as C,g as T,h as b,i as L,l as P,M as Y,o as _}from"./index-BOyCtk5k.js";import{T as ee,a as te,b as M,c as w,d as se,e as N}from"./table-CDAOLxXk.js";import{D as ae,a as re,b as ie,c as ne,d as oe,f as le}from"./dialog-CtqJTAqX.js";import{L as A}from"./label-CMike-tD.js";import{S as ce,a as de,b as ue,c as me,d as R}from"./select-D543OkJ4.js";import{m as F}from"./marketingApi-xGOnHaXh.js";import{a as he}from"./shopifySync-DhpS1VDJ.js";import{S as z}from"./skeleton-DxzNBJmk.js";import{P as V}from"./plus-DLcEcORE.js";import{T as pe}from"./tag-DSnvSisU.js";import{D as q}from"./dollar-sign-CFIpZffW.js";import{P as xe}from"./percent-DlWi9N1T.js";import{S as ge}from"./square-pen-C1_p0sg9.js";import{T as fe}from"./trash-2-CbOWc6LA.js";import"./index-vX3PxqRg.js";import"./index-BhpwvMXG.js";/**
 * @license lucide-react v0.417.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const U=J("Ticket",[["path",{d:"M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z",key:"qn84l0"}],["path",{d:"M13 5v2",key:"dyzc3o"}],["path",{d:"M13 17v2",key:"1ont0d"}],["path",{d:"M13 11v2",key:"1wjjxi"}]]),je={async listFromShopify(n,r){try{let s=D.from("ShopifyDiscountCode").select(`
          *,
          priceRule:ShopifyPriceRule!ShopifyDiscountCode_priceRuleId_fkey(*)
        `).eq("userId",n).order("updatedAt",{ascending:!1});r!=null&&r.search&&(s=s.ilike("code",`%${r.search}%`));const{data:u,error:a}=await s;if(a)throw a;let m=(u||[]).map(o=>{const i=o.priceRule,l=new Date,h=i.startsAt?new Date(i.startsAt):null,g=i.endsAt?new Date(i.endsAt):null;let p="active",x=!0;return h&&l<h?(p="scheduled",x=!1):g&&l>g?(p="expired",x=!1):i.usageLimit&&o.usageCount>=i.usageLimit&&(p="exhausted",x=!1),{id:String(o.id),code:o.code,title:i.title,type:i.targetType==="shipping_line"?"free_shipping":i.valueType==="percentage"?"percentage":"fixed_amount",value:parseFloat(i.value),usageCount:o.usageCount||0,usageLimit:i.usageLimit||void 0,startsAt:i.startsAt||void 0,endsAt:i.endsAt||void 0,status:p,isValid:x,metadata:{shopifyId:o.id,priceRuleId:i.id,shopifyData:o.shopifyData,priceRuleData:i.shopifyData,targetType:i.targetType,targetSelection:i.targetSelection,allocationMethod:i.allocationMethod,oncePerCustomer:i.oncePerCustomer},createdAt:o.createdAt,updatedAt:o.updatedAt}});return r!=null&&r.status&&(m=m.filter(o=>o.status===r.status)),m}catch(s){throw console.error("Error listing Shopify discounts:",s),s}},async getByCode(n,r){try{const{data:s,error:u}=await D.from("ShopifyDiscountCode").select(`
          *,
          priceRule:ShopifyPriceRule!ShopifyDiscountCode_priceRuleId_fkey(*)
        `).eq("userId",n).ilike("code",r).single();if(u)return console.error("Error getting discount by code:",u),null;if(!s)return null;const a=s.priceRule,m=new Date,o=a.startsAt?new Date(a.startsAt):null,i=a.endsAt?new Date(a.endsAt):null;let l="active",h=!0;return o&&m<o?(l="scheduled",h=!1):i&&m>i?(l="expired",h=!1):a.usageLimit&&s.usageCount>=a.usageLimit&&(l="exhausted",h=!1),{id:String(s.id),code:s.code,title:a.title,type:a.targetType==="shipping_line"?"free_shipping":a.valueType==="percentage"?"percentage":"fixed_amount",value:parseFloat(a.value),usageCount:s.usageCount||0,usageLimit:a.usageLimit||void 0,startsAt:a.startsAt||void 0,endsAt:a.endsAt||void 0,status:l,isValid:h,metadata:{shopifyId:s.id,priceRuleId:a.id,shopifyData:s.shopifyData,priceRuleData:a.shopifyData,targetType:a.targetType,targetSelection:a.targetSelection,allocationMethod:a.allocationMethod,oncePerCustomer:a.oncePerCustomer},createdAt:s.createdAt,updatedAt:s.updatedAt}}catch(s){return console.error("Error getting discount by code:",s),null}},async validateCode(n,r){try{const s=await this.getByCode(n,r);if(!s)return{valid:!1,reason:"Código não encontrado"};if(!s.isValid){if(s.status==="scheduled")return{valid:!1,reason:"Código ainda não está ativo"};if(s.status==="expired")return{valid:!1,reason:"Código expirado"};if(s.status==="exhausted")return{valid:!1,reason:"Código atingiu limite de uso"}}return{valid:!0,discount:s}}catch(s){return console.error("Error validating discount code:",s),{valid:!1,reason:"Erro ao validar código"}}},calculateDiscount(n,r,s=0){if(!n.isValid)return 0;const u=n.metadata||{};if(n.type==="free_shipping")return s;const a=u.targetType==="shipping_line"?s:r;if(n.type==="percentage"){const m=a*n.value/100;return Math.min(m,a)}else return Math.min(n.value,a)},async getStats(n){try{const{data:r,error:s}=await D.from("ShopifyDiscountCode").select(`
          usageCount,
          priceRule:ShopifyPriceRule!ShopifyDiscountCode_priceRuleId_fkey(usageLimit, startsAt, endsAt)
        `).eq("userId",n);if(s)throw s;const u=new Date;let a=0,m=0,o=0,i=0,l=0;return(r||[]).forEach(h=>{const g=h.priceRule,p=g.startsAt?new Date(g.startsAt):null,x=g.endsAt?new Date(g.endsAt):null;l+=h.usageCount||0,p&&u<p?m++:x&&u>x?o++:g.usageLimit&&h.usageCount>=g.usageLimit?i++:a++}),{total:(r==null?void 0:r.length)||0,active:a,scheduled:m,expired:o,exhausted:i,totalUsage:l}}catch(r){return console.error("Error getting discount stats:",r),{total:0,active:0,scheduled:0,expired:0,exhausted:0,totalUsage:0}}},async count(n){try{const{count:r,error:s}=await D.from("ShopifyDiscountCode").select("*",{count:"exact",head:!0}).eq("userId",n);if(s)throw s;return r||0}catch(r){return console.error("Error counting Shopify discounts:",r),0}},async incrementUsage(n,r){try{const s=await this.getByCode(n,r);if(!s||!s.isValid)return!1;const{error:u}=await D.from("ShopifyDiscountCode").update({usageCount:(s.usageCount||0)+1,updatedAt:new Date().toISOString()}).eq("id",s.id);if(u)throw u;return!0}catch(s){return console.error("Error incrementing discount usage:",s),!1}}},ke=()=>{const[n,r]=y.useState([]),[s,u]=y.useState([]),[a,m]=y.useState(!0),[o,i]=y.useState(!1),[l,h]=y.useState(""),[g,p]=y.useState(!1),[x,k]=y.useState(null),{toast:f}=K(),c=Q(t=>t.user),[d,j]=y.useState({code:"",name:"",type:"PERCENTAGE",value:0,minPurchaseAmount:0,maxDiscountAmount:0,usageLimit:0,perCustomerLimit:1,startsAt:"",expiresAt:"",isActive:!0});y.useEffect(()=>{c!=null&&c.id&&E()},[c==null?void 0:c.id]),y.useEffect(()=>{B()},[l,n]);const E=async()=>{if(!(c!=null&&c.id)){m(!1);return}try{m(!0);const t=await je.listFromShopify(c.id);r(t),u(t)}catch(t){console.error("Erro ao carregar cupons:",t),f({title:"Erro ao carregar cupons",description:t.message,variant:"destructive"})}finally{m(!1)}},O=async()=>{if(!(c!=null&&c.id)){f({title:"Erro",description:"Faça login para sincronizar",variant:"destructive"});return}try{i(!0),f({title:"Sincronizando...",description:"Buscando descontos da Shopify"});const t=await he.syncDiscounts(c.id);t.success?(f({title:"Sincronização concluída!",description:t.message}),await E()):f({title:"Erro na sincronização",description:t.message,variant:"destructive"})}catch{f({title:"Erro ao sincronizar",description:"Configure a integração Shopify em Integrações",variant:"destructive"})}finally{i(!1)}},B=()=>{if(!l){u(n);return}const t=n.filter(v=>v.code.toLowerCase().includes(l.toLowerCase())||v.name.toLowerCase().includes(l.toLowerCase()));u(t)},G=async t=>{t.preventDefault();try{if(!(c!=null&&c.organizationId))return;x?(await F.coupons.update(x.id,d),f({title:"Cupom atualizado!",description:"As alterações foram salvas."})):(await F.coupons.create({...d,organizationId:c.organizationId,usageCount:0}),f({title:"Cupom criado!",description:"O cupom está pronto para uso."})),p(!1),I(),E()}catch(v){f({title:"Erro",description:v.message,variant:"destructive"})}},H=async t=>{if(confirm("Tem certeza que deseja deletar este cupom?"))try{await F.coupons.delete(t),f({title:"Cupom deletado"}),E()}catch(v){f({title:"Erro ao deletar",description:v.message,variant:"destructive"})}},$=t=>{k(t),j({code:t.code,name:t.name,type:t.type,value:t.value,minPurchaseAmount:t.minPurchaseAmount||0,maxDiscountAmount:t.maxDiscountAmount||0,usageLimit:t.usageLimit||0,perCustomerLimit:t.perCustomerLimit||1,startsAt:t.startsAt||"",expiresAt:t.expiresAt||"",isActive:t.isActive}),p(!0)},I=()=>{k(null),j({code:"",name:"",type:"PERCENTAGE",value:0,minPurchaseAmount:0,maxDiscountAmount:0,usageLimit:0,perCustomerLimit:1,startsAt:"",expiresAt:"",isActive:!0})},X=n.reduce((t,v)=>t+v.usageCount,0),Z=n.filter(t=>t.isActive).length;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Cupons de Desconto"}),e.jsx("p",{className:"text-muted-foreground",children:"Crie e gerencie cupons para sua loja"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(S,{onClick:O,disabled:o,variant:"outline",children:[e.jsx(W,{className:`mr-2 h-4 w-4 ${o?"animate-spin":""}`}),o?"Sincronizando...":"Sincronizar Shopify"]}),e.jsxs(ae,{open:g,onOpenChange:p,children:[e.jsx(re,{asChild:!0,children:e.jsxs(S,{onClick:I,children:[e.jsx(V,{className:"mr-2 h-4 w-4"}),"Criar Cupom"]})}),e.jsxs(ie,{className:"max-w-2xl",children:[e.jsx(ne,{children:e.jsx(oe,{children:x?"Editar Cupom":"Novo Cupom"})}),e.jsxs("form",{onSubmit:G,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(A,{children:"Código *"}),e.jsx(C,{value:d.code,onChange:t=>j({...d,code:t.target.value.toUpperCase()}),placeholder:"PROMO10",required:!0})]}),e.jsxs("div",{children:[e.jsx(A,{children:"Nome *"}),e.jsx(C,{value:d.name,onChange:t=>j({...d,name:t.target.value}),placeholder:"Desconto 10%",required:!0})]}),e.jsxs("div",{children:[e.jsx(A,{children:"Tipo *"}),e.jsxs(ce,{value:d.type,onValueChange:t=>j({...d,type:t}),children:[e.jsx(de,{children:e.jsx(ue,{})}),e.jsxs(me,{children:[e.jsx(R,{value:"PERCENTAGE",children:"Porcentagem"}),e.jsx(R,{value:"FIXED_AMOUNT",children:"Valor Fixo"}),e.jsx(R,{value:"FREE_SHIPPING",children:"Frete Grátis"})]})]})]}),e.jsxs("div",{children:[e.jsx(A,{children:"Valor *"}),e.jsx(C,{type:"number",step:"0.01",value:d.value,onChange:t=>j({...d,value:parseFloat(t.target.value)}),required:!0})]}),e.jsxs("div",{children:[e.jsx(A,{children:"Compra Mínima"}),e.jsx(C,{type:"number",step:"0.01",value:d.minPurchaseAmount,onChange:t=>j({...d,minPurchaseAmount:parseFloat(t.target.value)})})]}),e.jsxs("div",{children:[e.jsx(A,{children:"Limite de Usos"}),e.jsx(C,{type:"number",value:d.usageLimit,onChange:t=>j({...d,usageLimit:parseInt(t.target.value)})})]}),e.jsxs("div",{children:[e.jsx(A,{children:"Data Início"}),e.jsx(C,{type:"datetime-local",value:d.startsAt,onChange:t=>j({...d,startsAt:t.target.value})})]}),e.jsxs("div",{children:[e.jsx(A,{children:"Data Expiração"}),e.jsx(C,{type:"datetime-local",value:d.expiresAt,onChange:t=>j({...d,expiresAt:t.target.value})})]})]}),e.jsxs(le,{children:[e.jsx(S,{type:"button",variant:"outline",onClick:()=>p(!1),children:"Cancelar"}),e.jsxs(S,{type:"submit",children:[x?"Atualizar":"Criar"," Cupom"]})]})]})]})]})]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsxs(T,{children:[e.jsxs(b,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(L,{className:"text-sm font-medium",children:"Total de Cupons"}),e.jsx(U,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(P,{children:e.jsx("div",{className:"text-2xl font-bold",children:n.length})})]}),e.jsxs(T,{children:[e.jsxs(b,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(L,{className:"text-sm font-medium",children:"Cupons Ativos"}),e.jsx(pe,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(P,{children:e.jsx("div",{className:"text-2xl font-bold",children:Z})})]}),e.jsxs(T,{children:[e.jsxs(b,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(L,{className:"text-sm font-medium",children:"Total de Usos"}),e.jsx(q,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(P,{children:e.jsx("div",{className:"text-2xl font-bold",children:X})})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(Y,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(C,{placeholder:"Buscar cupons...",value:l,onChange:t=>h(t.target.value),className:"pl-9"})]}),e.jsxs(T,{children:[e.jsx(b,{children:e.jsx(L,{children:"Lista de Cupons"})}),e.jsx(P,{children:a?e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{className:"h-12 w-full"}),e.jsx(z,{className:"h-12 w-full"})]}):s.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-center",children:[e.jsx(U,{className:"h-12 w-12 text-muted-foreground mb-4"}),e.jsx("h3",{className:"text-lg font-semibold",children:"Nenhum cupom encontrado"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:l?"Tente ajustar sua busca":"Comece criando seu primeiro cupom"}),!l&&e.jsxs(S,{onClick:I,children:[e.jsx(V,{className:"mr-2 h-4 w-4"}),"Criar Primeiro Cupom"]})]}):e.jsxs(ee,{children:[e.jsx(te,{children:e.jsxs(M,{children:[e.jsx(w,{children:"Código"}),e.jsx(w,{children:"Nome"}),e.jsx(w,{children:"Tipo"}),e.jsx(w,{children:"Valor"}),e.jsx(w,{children:"Usos"}),e.jsx(w,{children:"Status"}),e.jsx(w,{className:"text-right",children:"Ações"})]})}),e.jsx(se,{children:s.map(t=>e.jsxs(M,{children:[e.jsx(N,{children:e.jsx("code",{className:"font-mono font-bold",children:t.code})}),e.jsx(N,{children:t.name}),e.jsx(N,{children:e.jsxs(_,{variant:"outline",children:[t.type==="PERCENTAGE"&&e.jsx(xe,{className:"h-3 w-3 mr-1"}),t.type==="FIXED_AMOUNT"&&e.jsx(q,{className:"h-3 w-3 mr-1"}),t.type==="PERCENTAGE"?"Porcentagem":t.type==="FIXED_AMOUNT"?"Valor Fixo":"Frete Grátis"]})}),e.jsx(N,{children:t.type==="PERCENTAGE"?`${t.value}%`:t.type==="FIXED_AMOUNT"?`R$ ${t.value.toFixed(2)}`:"-"}),e.jsxs(N,{children:[t.usageCount,t.usageLimit&&` / ${t.usageLimit}`]}),e.jsx(N,{children:e.jsx(_,{variant:t.isActive?"default":"secondary",children:t.isActive?"Ativo":"Inativo"})}),e.jsx(N,{className:"text-right",children:e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(S,{variant:"ghost",size:"icon",onClick:()=>$(t),children:e.jsx(ge,{className:"h-4 w-4"})}),e.jsx(S,{variant:"ghost",size:"icon",onClick:()=>H(t.id),children:e.jsx(fe,{className:"h-4 w-4"})})]})})]},t.id))})]})})]})]})};export{ke as default};

import{s as e}from"./index-B1scEABt.js";const t={async getAll(t){const{data:r,error:o}=await e.from("Coupon").select("*").eq("userId",t).order("createdAt",{ascending:!1});if(o)throw o;return r},async getById(t){const{data:r,error:o}=await e.from("Coupon").select("*").eq("id",t).single();if(o)throw o;return r},async getByCode(t,r){const{data:o,error:a}=await e.from("Coupon").select("*").eq("code",t.toUpperCase()).eq("userId",r).single();if(a){if("PGRST116"===a.code)return null;throw a}return o},async validate(r,o,a){const s=await t.getByCode(r,o);if(!s)return{valid:!1,error:"Coupon not found"};if(!s.isActive)return{valid:!1,error:"Coupon is inactive"};const n=new Date;if(s.startsAt&&new Date(s.startsAt)>n)return{valid:!1,error:"Coupon not yet active"};if(s.expiresAt&&new Date(s.expiresAt)<n)return{valid:!1,error:"Coupon has expired"};if(s.usageLimit&&s.usageCount>=s.usageLimit)return{valid:!1,error:"Coupon usage limit reached"};if(a&&s.perCustomerLimit){const{data:t}=await e.from("CouponUsage").select("id").eq("couponId",s.id).eq("customerId",a);if(t&&t.length>=s.perCustomerLimit)return{valid:!1,error:"Customer usage limit reached"}}return{valid:!0,coupon:s}},async create(t){const{data:r,error:o}=await e.from("Coupon").insert({...t,code:t.code.toUpperCase()}).select().single();if(o)throw o;return r},async update(t,r){const{data:o,error:a}=await e.from("Coupon").update({...r,updatedAt:(new Date).toISOString()}).eq("id",t).select().single();if(a)throw a;return o},setActive:async(e,r)=>t.update(e,{isActive:r}),async incrementUsage(r){const{data:o,error:a}=await e.rpc("increment_coupon_usage",{coupon_id:r});if(a){const e=await t.getById(r);return t.update(r,{usageCount:e.usageCount+1})}return o},async delete(t){const{error:r}=await e.from("Coupon").delete().eq("id",t);if(r)throw r},async getActive(t){const r=(new Date).toISOString(),{data:o,error:a}=await e.from("Coupon").select("*").eq("userId",t).eq("isActive",!0).or(`startsAt.is.null,startsAt.lte.${r}`).or(`expiresAt.is.null,expiresAt.gte.${r}`).order("createdAt",{ascending:!1});if(a)throw a;return o}},r={coupons:t,couponUsage:{async record(t){const{data:r,error:o}=await e.from("CouponUsage").insert(t).select().single();if(o)throw o;return r},async getByCoupon(t){const{data:r,error:o}=await e.from("CouponUsage").select("*").eq("couponId",t).order("createdAt",{ascending:!1});if(o)throw o;return r},async getByCustomer(t){const{data:r,error:o}=await e.from("CouponUsage").select("*, coupon:Coupon(*)").eq("customerId",t).order("createdAt",{ascending:!1});if(o)throw o;return r}},discounts:{async getAll(t){const{data:r,error:o}=await e.from("Discount").select("*").eq("userId",t).order("priority",{ascending:!1});if(o)throw o;return r},async getActive(t){const r=(new Date).toISOString(),{data:o,error:a}=await e.from("Discount").select("*").eq("userId",t).eq("isActive",!0).or(`startsAt.is.null,startsAt.lte.${r}`).or(`expiresAt.is.null,expiresAt.gte.${r}`).order("priority",{ascending:!1});if(a)throw a;return o},async create(t){const{data:r,error:o}=await e.from("Discount").insert(t).select().single();if(o)throw o;return r},async update(t,r){const{data:o,error:a}=await e.from("Discount").update({...r,updatedAt:(new Date).toISOString()}).eq("id",t).select().single();if(a)throw a;return o},async delete(t){const{error:r}=await e.from("Discount").delete().eq("id",t);if(r)throw r}},orderBumps:{async getAll(t){const{data:r,error:o}=await e.from("OrderBump").select("*, product:Product(*)").eq("userId",t).order("createdAt",{ascending:!1});if(o)throw o;return r},async getActive(t,r){let o=e.from("OrderBump").select("*, product:Product(*)").eq("userId",t).eq("isActive",!0);r&&(o=o.eq("position",r));const{data:a,error:s}=await o.order("createdAt",{ascending:!1});if(s)throw s;return a},async create(t){const{data:r,error:o}=await e.from("OrderBump").insert(t).select().single();if(o)throw o;return r},async update(t,r){const{data:o,error:a}=await e.from("OrderBump").update({...r,updatedAt:(new Date).toISOString()}).eq("id",t).select().single();if(a)throw a;return o},async delete(t){const{error:r}=await e.from("OrderBump").delete().eq("id",t);if(r)throw r}},upsells:{async getAll(t){const{data:r,error:o}=await e.from("Upsell").select("\n        *,\n        fromProduct:Product!Upsell_fromProductId_fkey(*),\n        toProduct:Product!Upsell_toProductId_fkey(*)\n      ").eq("userId",t).order("createdAt",{ascending:!1});if(o)throw o;return r},async getByProduct(t,r){let o=e.from("Upsell").select("*, toProduct:Product!Upsell_toProductId_fkey(*)").eq("fromProductId",t).eq("isActive",!0);r&&(o=o.eq("timing",r));const{data:a,error:s}=await o.order("createdAt",{ascending:!1});if(s)throw s;return a},async create(t){const{data:r,error:o}=await e.from("Upsell").insert(t).select().single();if(o)throw o;return r},async update(t,r){const{data:o,error:a}=await e.from("Upsell").update({...r,updatedAt:(new Date).toISOString()}).eq("id",t).select().single();if(a)throw a;return o},async delete(t){const{error:r}=await e.from("Upsell").delete().eq("id",t);if(r)throw r}},crossSells:{async getAll(t){const{data:r,error:o}=await e.from("CrossSell").select("*, product:Product(*)").eq("userId",t).order("createdAt",{ascending:!1});if(o)throw o;return r},async getByProduct(t,r){let o=e.from("CrossSell").select("*").eq("productId",t).eq("isActive",!0);r&&(o=o.eq("position",r));const{data:a,error:s}=await o.order("createdAt",{ascending:!1});if(s)throw s;return a},async create(t){const{data:r,error:o}=await e.from("CrossSell").insert(t).select().single();if(o)throw o;return r},async update(t,r){const{data:o,error:a}=await e.from("CrossSell").update({...r,updatedAt:(new Date).toISOString()}).eq("id",t).select().single();if(a)throw a;return o},async delete(t){const{error:r}=await e.from("CrossSell").delete().eq("id",t);if(r)throw r}}};export{r as m};

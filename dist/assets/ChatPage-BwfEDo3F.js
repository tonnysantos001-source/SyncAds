import{j as e}from"./vendor-ui-DkUuACDy.js";import{r as a,f as t}from"./vendor-react-X41Bjl18.js";import{c as s,I as r,a as i,b as l,d as n,e as o,i as c,f as d}from"./chatService-DUNZqa0V.js";import{f as m,i as x,g as u,s as h,j as g,h as p,k as f,l as v}from"./index-gXeLoGk7.js";import{A as b,m as y}from"./vendor-animation-DQ3cvw6m.js";import{I as w}from"./IconSparkles-C8t3UK2U.js";import"./vendor-charts-KTfs4PKb.js";import"./vendor-utils-Dl0_yMKq.js";import"./vendor-supabase-BQxDPPjR.js";import"./vendor-query-Bf3pI66S.js";import"./vendor-icons-DTdRnryx.js";const j=2e3;function N(){const[N,C]=a.useState(""),[A,k]=a.useState(!0),[I,S]=a.useState(!0),[E,D]=a.useState(!1),[T,H]=a.useState(!0),[q,_]=a.useState({connected:!1,deviceId:null,lastCheck:0}),R=m(e=>e.user),L=m(e=>e.isAuthenticated),O=t(),$=x(e=>e.conversations),z=x(e=>e.activeConversationId),M=x(e=>e.setActiveConversationId),F=x(e=>e.isAssistantTyping),K=x(e=>e.setAssistantTyping),V=x(e=>e.addMessage),B=a.useRef(null),{toast:P}=u(),G=$.find(e=>e.id===z);a.useEffect(()=>{L&&R||O("/login-v2",{replace:!0})},[L,R,O]);a.useEffect(()=>{B.current?.scrollIntoView({behavior:"smooth"})},[G?.messages,F]),a.useEffect(()=>{if(!R)return;let e=0;const a=async()=>{try{const{data:a,error:t}=await h.from("extension_devices").select("id, device_id, status, last_seen").eq("user_id",R.id).eq("status","online").order("last_seen",{ascending:!1}).limit(1).maybeSingle();if(t)return e++,void(e>=3&&_({connected:!1,deviceId:null,lastCheck:Date.now()}));const s=Date.now(),r=a?new Date(a.last_seen).getTime():0;_({connected:!!a&&s-r<3e4,deviceId:a?.device_id||null,lastCheck:s}),t||(e=0)}catch(a){e++}};a();const t=setInterval(a,5e3);return()=>clearInterval(t)},[R]),a.useEffect(()=>{R&&(async()=>{try{H(!0);const e=await s.isAIConfigured();D(e),e||P({title:"‚ö†Ô∏è IA n√£o configurada",description:"Configure uma IA em Configura√ß√µes para usar o chat.",variant:"destructive"})}catch(e){D(!1)}finally{H(!1)}})()},[R,P]),a.useEffect(()=>{(async()=>{if(R)try{S(!0),await x.getState().loadConversations(R.id);const{data:e,error:a}=await h.from("ChatConversation").select("id").eq("userId",R.id).limit(1);if(a)throw a;e&&0!==e.length||await x.getState().createNewConversation(R.id,`Conversa ${(new Date).toLocaleDateString()}`)}catch(e){P({title:"Erro ao carregar chat",description:"Tente recarregar a p√°gina.",variant:"destructive"})}finally{S(!1)}})()},[R,P]);const J=a.useCallback(async()=>{if(""===N.trim()||!z||N.length>j)return;if(!E)return void P({title:"‚ö†Ô∏è IA n√£o configurada",description:"Configure uma IA em Configura√ß√µes antes de enviar mensagens.",variant:"destructive"});const e=N.trim();C(""),K(!0);const a={id:`temp-user-${Date.now()}`,role:"user",content:e,timestamp:(new Date).toISOString()};V(R.id,z,a);try{const a=await s.sendMessage(e,z),t={id:`msg-${Date.now()}`,role:"assistant",content:a,timestamp:(new Date).toISOString()};V(R.id,z,t)}catch(t){P({title:"Erro ao enviar mensagem",description:t.message||"Tente novamente",variant:"destructive"})}finally{K(!1)}},[N,z,V,K,P,E,R]),Q=a.useCallback(async()=>{if(R)try{await x.getState().createNewConversation(R.id,`Conversa ${(new Date).toLocaleDateString()}`),P({title:"‚ú® Nova conversa criada"})}catch(e){P({title:"Erro ao criar conversa",variant:"destructive"})}},[R,P]),U=a.useCallback(async e=>{if(confirm("Tem certeza que deseja deletar esta conversa?"))try{const{error:a}=await h.from("ChatConversation").delete().eq("id",e);if(a)throw a;await x.getState().loadConversations(R.id),P({title:"üóëÔ∏è Conversa deletada"})}catch(a){P({title:"Erro ao deletar",variant:"destructive"})}},[R,P]);return e.jsxs("div",{className:"flex h-full w-full max-h-full overflow-hidden bg-gradient-to-br from-gray-900 via-gray-850 to-gray-900",children:[e.jsx(b,{children:A&&e.jsxs(y.div,{initial:{x:-320,opacity:0},animate:{x:0,opacity:1},exit:{x:-320,opacity:0},transition:{type:"spring",damping:25,stiffness:200},className:"w-80 bg-gradient-to-b from-[#12121A] to-[#1A1A2E] border-r border-gray-700/50 flex flex-col shadow-2xl",children:[e.jsxs("div",{className:"p-4 border-b border-gray-700/50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h2",{className:"text-lg font-bold text-white flex items-center gap-2",children:[e.jsx(w,{className:"w-5 h-5 text-blue-400"}),"Conversas"]}),e.jsx(y.button,{whileHover:{scale:1.1,rotate:90},whileTap:{scale:.9},onClick:()=>k(!1),className:"p-2 rounded-lg hover:bg-gray-800/50 text-gray-400 hover:text-white transition-all",children:e.jsx(g,{className:"w-5 h-5"})})]}),e.jsxs(y.button,{whileHover:{scale:1.02,boxShadow:"0 0 25px rgba(59, 130, 246, 0.5)"},whileTap:{scale:.98},onClick:Q,className:"w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white rounded-xl px-4 py-3 flex items-center justify-center gap-2 font-medium transition-all shadow-lg shadow-blue-500/30",children:[e.jsx(r,{className:"w-5 h-5"}),"Nova Conversa"]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-2 space-y-2",children:$.map(a=>e.jsx(y.div,{whileHover:{scale:1.02,x:4},onClick:()=>M(a.id),className:p("p-3 rounded-xl cursor-pointer transition-all group relative",z===a.id?"bg-gradient-to-r from-blue-600/20 to-purple-600/20 border border-blue-500/50 shadow-lg shadow-blue-500/20":"bg-gray-800/30 hover:bg-gray-800/50 border border-transparent"),children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-white font-medium text-sm truncate",children:a.title}),e.jsx("p",{className:"text-xs text-gray-500 truncate",children:a.messages&&a.messages.length>0?a.messages[a.messages.length-1].content.substring(0,35)+"...":"Nova conversa"})]}),e.jsx(y.button,{whileHover:{scale:1.1},whileTap:{scale:.9},onClick:e=>{e.stopPropagation(),U(a.id)},className:"opacity-0 group-hover:opacity-100 p-2 rounded-lg hover:bg-red-500/20 text-red-400 transition-all",children:e.jsx(i,{className:"w-4 h-4"})})]})},a.id))})]})}),e.jsxs("div",{className:"flex-1 flex flex-col min-w-0 min-h-0 overflow-hidden",children:[e.jsxs("div",{className:"bg-gradient-to-r from-[#12121A] to-[#1A1A2E] border-b border-gray-700/50 px-6 py-4 flex items-center justify-between flex-shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[!A&&e.jsx(y.button,{whileHover:{scale:1.1},whileTap:{scale:.9},onClick:()=>k(!0),className:"p-2 rounded-lg hover:bg-gray-800/50 text-gray-400 hover:text-white transition-all",children:e.jsx(l,{className:"w-6 h-6"})}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-xl font-bold text-white flex items-center gap-2",children:[e.jsx(w,{className:"w-6 h-6 text-blue-400"}),"Chat IA - Marketing"]}),e.jsx("p",{className:"text-sm text-gray-400",children:"Assistente especializado em marketing digital"})]})]}),e.jsxs("div",{className:p("flex items-center gap-2 px-3 py-2 rounded-full text-xs font-medium transition-all",q.connected?"bg-green-600/20 text-green-400 border border-green-600/30":"bg-gray-800/50 text-gray-400 border border-gray-700/30"),children:[q.connected?e.jsx(f,{className:"w-4 h-4"}):e.jsx(v,{className:"w-4 h-4"}),e.jsx("span",{children:q.connected?"Extens√£o Ativa":"Extens√£o Offline"})]})]}),e.jsx("div",{className:"flex-1 min-h-0 overflow-y-auto px-6 py-4 space-y-4 bg-[#0A0A0F]",children:I?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx(y.div,{animate:{rotate:360},transition:{duration:1,repeat:1/0,ease:"linear"},className:"w-16 h-16 border-4 border-blue-500/30 border-t-blue-500 rounded-full mx-auto mb-4"}),e.jsx("p",{className:"text-gray-400 text-lg font-medium",children:"Carregando conversas..."})]})}):E||T?G&&G.messages?e.jsxs(e.Fragment,{children:[G.messages.map(a=>e.jsx(y.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:p("flex","user"===a.role?"justify-end":"justify-start"),children:e.jsxs("div",{className:p("max-w-[80%] rounded-2xl p-4 backdrop-blur-sm","user"===a.role?"bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg shadow-blue-500/20 border border-blue-400/30":"bg-gray-800/50 text-gray-200 border border-gray-700/30"),children:[e.jsxs("div",{className:"flex items-start gap-3",children:["assistant"===a.role&&e.jsx(y.div,{initial:{scale:0,rotate:-180},animate:{scale:1,rotate:0},transition:{type:"spring",stiffness:200},whileHover:{rotate:10,scale:1.1},className:"flex-shrink-0",children:e.jsx(n,{className:"w-6 h-6 text-blue-400"})}),"user"===a.role&&e.jsx(y.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:200},whileHover:{scale:1.1},className:"flex-shrink-0",children:e.jsx(o,{className:"w-6 h-6 text-white"})}),e.jsx("div",{className:"flex-1 whitespace-pre-wrap break-words",children:a.content})]}),e.jsx("div",{className:p("text-xs mt-2 ml-9","user"===a.role?"text-white/60":"text-gray-500"),children:a.timestamp?new Date(a.timestamp).toLocaleTimeString("pt-BR"):""})]})},a.id)),F&&e.jsx(y.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"flex justify-start",children:e.jsx("div",{className:"max-w-[80%] bg-gray-800/50 rounded-2xl p-4 border border-gray-700/30",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(n,{className:"w-6 h-6 text-blue-400 animate-pulse"}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(y.div,{animate:{y:[0,-8,0]},transition:{duration:.6,repeat:1/0,delay:0},className:"w-2 h-2 bg-blue-400 rounded-full"}),e.jsx(y.div,{animate:{y:[0,-8,0]},transition:{duration:.6,repeat:1/0,delay:.2},className:"w-2 h-2 bg-blue-400 rounded-full"}),e.jsx(y.div,{animate:{y:[0,-8,0]},transition:{duration:.6,repeat:1/0,delay:.4},className:"w-2 h-2 bg-blue-400 rounded-full"})]})]})})}),e.jsx("div",{ref:B})]}):e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx(w,{className:"w-16 h-16 text-blue-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-400 text-xl mb-2",children:"Ol√°! üëã Como posso ajudar?"}),e.jsx("p",{className:"text-gray-600 text-sm",children:"Estou aqui para ajudar com marketing digital e estrat√©gias"})]})}):e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center max-w-md",children:[e.jsx(v,{className:"w-16 h-16 text-yellow-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-400 text-xl mb-2",children:"‚ö†Ô∏è IA n√£o configurada"}),e.jsx("p",{className:"text-gray-600 text-sm mb-4",children:"Nenhuma IA est√° configurada no sistema. Voc√™ precisa configurar uma IA antes de usar o chat."}),e.jsx(y.button,{whileHover:{scale:1.05},whileTap:{scale:.95},onClick:()=>O("/settings"),className:"bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white rounded-xl px-6 py-3 font-medium transition-all shadow-lg shadow-blue-500/30",children:"Ir para Configura√ß√µes"})]})})}),e.jsx("div",{className:"border-t border-gray-700/50 p-4 bg-gradient-to-r from-[#12121A] to-[#1A1A2E] flex-shrink-0",children:e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsxs("div",{className:"relative",children:[e.jsx(c,{value:N,onChange:e=>C(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),J())},placeholder:"Digite sua mensagem... (Shift+Enter para nova linha)",maxLength:j,disabled:F,className:"w-full bg-gray-800/50 border border-gray-700/50 rounded-2xl px-6 py-4 pr-24 text-white placeholder-gray-500 resize-none focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 transition-all disabled:opacity-50 disabled:cursor-not-allowed",minRows:1,maxRows:6}),e.jsxs("div",{className:"absolute right-2 bottom-2 flex items-center gap-2",children:[e.jsxs("span",{className:p("text-xs font-medium px-2 py-1 rounded",N.length>1800?"text-red-400 bg-red-500/20":"text-gray-500 bg-gray-800/50"),children:[N.length,"/",j]}),e.jsx(y.button,{whileHover:{scale:1.05},whileTap:{scale:.95},onClick:J,disabled:""===N.trim()||N.length>j||F||!E,className:"bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white rounded-xl p-3 transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-blue-500/30",children:e.jsx(d,{className:"w-5 h-5"})})]})]}),!E&&!T&&e.jsxs(y.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"mt-3 text-xs text-red-400/80 flex items-center gap-2 bg-red-500/10 px-3 py-2 rounded-lg border border-red-500/20",children:[e.jsx(v,{className:"w-4 h-4"}),e.jsx("span",{children:"IA n√£o configurada - Configure em Configura√ß√µes para usar o chat"})]}),!q.connected&&E&&e.jsxs(y.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"mt-3 text-xs text-yellow-400/80 flex items-center gap-2 bg-yellow-500/10 px-3 py-2 rounded-lg border border-yellow-500/20",children:[e.jsx(v,{className:"w-4 h-4"}),e.jsx("span",{children:"Extens√£o offline - Recursos de automa√ß√£o indispon√≠veis"})]})]})})]})]})}export{N as default};

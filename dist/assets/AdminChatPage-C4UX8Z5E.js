import{c as P,j as e,n as Z,f as ee,r as l,B as g,X as se,M as te,g as R,l as J,v as D,s as c}from"./index-BxKmm3Bg.js";import{T as ae}from"./textarea-at3Iufro.js";import{S as re}from"./SuperAdminLayout-CmHq8BCg.js";import{G as $}from"./globe-RrZdpBcZ.js";import{S as k}from"./sparkles-CFGQ7EmP.js";import{D as oe}from"./download-CZeJ-kOJ.js";import{M as ne}from"./message-square-SbEvpEZV.js";import{T as _}from"./trash-2-DcJCJsID.js";import{S as L}from"./Logo-BwETPW9O.js";import{S as ie}from"./send-Cxwpdvmu.js";import"./dollar-sign-BKEjKRhb.js";/**
 * @license lucide-react v0.417.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ce=P("CirclePlus",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]);/**
 * @license lucide-react v0.417.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const le=P("CodeXml",[["path",{d:"m18 16 4-4-4-4",key:"1inbqp"}],["path",{d:"m6 8-4 4 4 4",key:"15zrgr"}],["path",{d:"m14.5 4-5 16",key:"e7oirm"}]]);function de({isThinking:n,currentTool:i,reasoning:m,sources:u}){if(!n)return null;const j=()=>{switch(i){case"web_search":return e.jsx($,{className:"h-4 w-4"});case"web_scraping":return e.jsx(oe,{className:"h-4 w-4"});case"python_exec":return e.jsx(le,{className:"h-4 w-4"});default:return e.jsx(k,{className:"h-4 w-4"})}},h=()=>{switch(i){case"web_search":return"Pesquisando na web";case"web_scraping":return"Raspando dados";case"python_exec":return"Executando c√≥digo Python";default:return"Pensando..."}};return e.jsx("div",{className:"mb-4 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg border border-blue-200",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsxs("div",{className:"relative flex-shrink-0",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 shadow-lg animate-pulse",children:e.jsxs("div",{className:"w-full h-full flex items-center justify-center",children:[e.jsx("div",{className:"text-3xl",children:"ü¶î"})," "]})}),e.jsx("div",{className:"absolute -top-1 -right-1 w-4 h-4 bg-green-500 rounded-full border-2 border-white animate-ping"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"flex items-center gap-2 mb-2",children:e.jsxs(Z,{variant:"secondary",className:"gap-2",children:[j(),h()]})}),m&&e.jsx("div",{className:"mb-3 p-3 bg-white/60 rounded-lg border border-blue-100",children:e.jsx("p",{className:"text-sm text-gray-700",children:m})}),u&&u.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs font-medium text-gray-600 mb-1",children:"Fontes consultadas:"}),u.map((y,d)=>e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-600",children:[e.jsx($,{className:"h-3 w-3"}),e.jsx("span",{className:"truncate",children:y})]},d))]})]})]})})}function me(n){const i=n.toLowerCase();return i.includes("conecte facebook")||i.includes("conecte o facebook")||i.includes("facebook ads")?"facebook":i.includes("conecte google")||i.includes("google ads")?"google":i.includes("conecte linkedin")?"linkedin":i.includes("conecte tiktok")?"tiktok":null}function ye(){const{toast:n}=ee(),[i,m]=l.useState([]),[u,j]=l.useState(""),[h,y]=l.useState(!1),[d,C]=l.useState(null),[X,Q]=l.useState([]),[E,T]=l.useState(!0),z=l.useRef(null),[B,f]=l.useState(null),[F,w]=l.useState(""),[G,b]=l.useState([]),S=async()=>{try{const{data:{user:s}}=await c.auth.getUser();if(!s)return;const{data:t,error:a}=await c.from("ChatConversation").select("id, title, createdAt, updatedAt").eq("userId",s.id).order("updatedAt",{ascending:!1}).limit(20);if(a)throw a;Q(t||[])}catch(s){console.error("Erro ao carregar conversas:",s)}},U=async s=>{try{const{data:t,error:a}=await c.from("ChatMessage").select("id, role, content, createdAt").eq("conversationId",s).order("createdAt",{ascending:!0});if(a)throw a;const r=(t||[]).map(o=>({id:o.id,role:o.role,content:o.content,timestamp:new Date(o.createdAt)}));m(r),C(s),console.log(`‚úÖ ${r.length} mensagens carregadas da conversa ${s}`)}catch(t){console.error("Erro ao carregar mensagens:",t),n({title:"Erro",description:"N√£o foi poss√≠vel carregar mensagens.",variant:"destructive"})}},V=async s=>{try{await c.from("ChatMessage").delete().eq("conversationId",s),await c.from("ChatConversation").delete().eq("id",s),d===s&&(m([]),C(null)),await S(),n({title:"‚úÖ Conversa deletada!",description:"Conversa removida com sucesso."})}catch(t){console.error("Erro ao deletar conversa:",t),n({title:"Erro",description:"N√£o foi poss√≠vel deletar conversa.",variant:"destructive"})}};l.useEffect(()=>{(async()=>{try{const{data:{user:t},error:a}=await c.auth.getUser();if(a||!t){console.error("Usu√°rio n√£o autenticado:",a),n({title:"Erro de autentica√ß√£o",description:"Voc√™ precisa fazer login novamente.",variant:"destructive"}),window.location.href="/login";return}await S();const{data:r,error:o}=await c.from("ChatConversation").select("id, title, createdAt, updatedAt").eq("userId",t.id).order("updatedAt",{ascending:!1}).limit(1).single();r?(console.log("‚úÖ Carregando conversa existente:",r.id),C(r.id),await U(r.id)):console.log('üìã Nenhuma conversa existente. Use "Nova Conversa" para come√ßar.')}catch(t){console.error("Erro ao inicializar conversa:",t)}})()},[]),l.useEffect(()=>{var s;(s=z.current)==null||s.scrollIntoView({behavior:"smooth"})},[i]);const Y=async(s,t)=>{try{const a=s.toLowerCase();let r=null,o="",I=[];if(a.includes("pesquis")||a.includes("busca")||a.includes("google")||a.includes("internet")){r="web_search";let p=s;if(a.includes("pesquis")){const N=s.match(/pesquis[ae]\s+(.+)/i);p=N?N[1]:s}o=`Pesquisando na web sobre: "${p}"`,f("web_search"),w(o),b(["Google Search","Exa AI","Tavily"])}else if(a.includes("baix")||a.includes("rasp")||a.includes("scrape")){r="web_scraping";const p=s.match(/https?:\/\/[^\s]+/i),N=p?p[0]:"URL n√£o especificada";o=`Raspando dados de: ${N}`,f("web_scraping"),w(o),b([N])}else a.includes("python")||a.includes("calcule")||a.includes("execute c√≥digo")?(r="python_exec",o="Executando c√≥digo Python para processar dados...",f("python_exec"),w(o)):(f(null),w("Processando sua solicita√ß√£o..."),b([]));const{data:{session:v}}=await c.auth.getSession();if(!v)throw new Error("N√£o autenticado");const O="https://ovskepqggmxlfckxqgbr.supabase.co/functions/v1/chat-enhanced",q=i.map(p=>({role:p.role.toLowerCase(),content:p.content}));console.log("üåê Calling chat-stream (Admin):",O),console.log("üìú History length:",q.length);const A=await fetch(O,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${v.access_token}`,apikey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92c2tlcHFnZ214bGZja3hxZ2JyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MjQ4NTUsImV4cCI6MjA3NjQwMDg1NX0.UdNgqpTN38An6FuoJPZlj_zLkmAqfJQXb6i1DdTQO_E"},body:JSON.stringify({message:s,conversationId:t,conversationHistory:q,systemPrompt:void 0})});if(!A.ok){const p=await A.json();throw new Error(p.error||"Erro ao processar mensagem")}const x=await A.json();return console.log("üì¶ Response data:",x),x.error?(console.error("‚ùå Erro na resposta:",x.error),`‚ö†Ô∏è ${x.response||x.error}`):!x.response||x.response==="Sem resposta da IA"?(console.error("‚ùå IA n√£o retornou resposta v√°lida"),"‚ö†Ô∏è IA n√£o configurada ou sem resposta. Configure uma IA em Configura√ß√µes > IA Global."):(f(null),w(""),b([]),x.response)}catch(a){return console.error("Admin chat error:",a),f(null),w(""),b([]),`‚ùå Erro: ${a.message}`}},H=async()=>{if(d)try{await c.from("ChatMessage").delete().eq("conversationId",d),m([]),n({title:"‚úÖ Mensagens limpas!",description:"Chat limpo com sucesso."})}catch(s){console.error("Erro ao limpar mensagens:",s),n({title:"Erro",description:"N√£o foi poss√≠vel limpar mensagens.",variant:"destructive"})}},K=async s=>{try{const{data:{user:t}}=await c.auth.getUser();if(!t)throw new Error("Usu√°rio n√£o autenticado");const a="https://ovskepqggmxlfckxqgbr.supabase.co/functions/v1/oauth-init",{data:{session:r}}=await c.auth.getSession();if(!r)throw new Error("N√£o autenticado");const o=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r.access_token}`,apikey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92c2tlcHFnZ214bGZja3hxZ2JyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MjQ4NTUsImV4cCI6MjA3NjQwMDg1NX0.UdNgqpTN38An6FuoJPZlj_zLkmAqfJQXb6i1DdTQO_E"},body:JSON.stringify({platform:s,redirectUrl:`${window.location.origin}/integrations/callback`})});if(!o.ok)throw new Error("Erro ao iniciar OAuth");const{authUrl:I}=await o.json();window.open(I,"_blank"),n({title:"üîó Autoriza√ß√£o Necess√°ria",description:`Abra a nova aba para autorizar ${s}`})}catch(t){console.error("Erro OAuth:",t),n({title:"Erro ao conectar",description:t.message,variant:"destructive"})}},W=async()=>{try{const{data:{user:s}}=await c.auth.getUser();if(!s)return;const{data:t}=await c.from("User").select("organizationId").eq("id",s.id).single();if(!(t!=null&&t.organizationId))throw new Error("Usu√°rio sem organiza√ß√£o");const a=crypto.randomUUID(),r=new Date().toISOString(),{error:o}=await c.from("ChatConversation").insert({id:a,userId:s.id,organizationId:t.organizationId,title:"üÜï Nova Conversa",createdAt:r,updatedAt:r});if(o)throw o;m([]),C(a),await S(),n({title:"‚úÖ Nova conversa criada!",description:"Comece um novo chat do zero."})}catch(s){console.error("Erro ao criar nova conversa:",s),n({title:"Erro",description:s.message||"N√£o foi poss√≠vel criar nova conversa.",variant:"destructive"})}},M=async()=>{if(!u.trim()||h||!d){console.log("Bot√£o desabilitado:",{inputTrim:!u.trim(),isLoading:h,conversationId:!!d});return}console.log("Enviando mensagem:",u.trim());const s=u.trim();j(""),y(!0);try{if(!d)throw new Error("Conversa n√£o inicializada");const t=d;console.log("Active conversation ID:",t);const a={id:`temp-${Date.now()}`,role:"USER",content:s,timestamp:new Date};m(v=>[...v,a]);const r=await Y(s,t),o=me(r),I={id:`temp-${Date.now()+1}`,role:"ASSISTANT",content:r,timestamp:new Date,metadata:o?{oauthAction:{platform:o,action:"connect"}}:void 0};m(v=>[...v,I])}catch(t){console.error("ERRO COMPLETO:",t);const a={id:`error-${Date.now()}`,role:"ASSISTANT",content:`‚ùå ERRO DETALHADO:

${t.message}

${t.stack||"Sem stack trace"}

${JSON.stringify(t,null,2)}`,timestamp:new Date};m(r=>[...r,a]),n({title:"Erro ao processar",description:t.message,variant:"destructive"})}finally{y(!1)}};return e.jsx(re,{children:e.jsxs("div",{className:"h-[calc(100vh-80px)] flex",children:[e.jsxs("div",{className:`${E?"w-72":"w-0"} transition-all duration-300 bg-gray-50 border-r border-gray-200 flex flex-col overflow-hidden`,children:[e.jsxs("div",{className:"p-4 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-sm font-semibold text-gray-700",children:"Conversas"}),e.jsx(g,{onClick:()=>T(!1),variant:"ghost",size:"sm",className:"h-7 w-7 p-0",children:e.jsx(se,{className:"h-4 w-4"})})]}),e.jsxs(g,{onClick:W,className:"w-full gap-2",size:"sm",children:[e.jsx(ce,{className:"h-4 w-4"}),"Nova Conversa"]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-2 space-y-1",children:X.map(s=>e.jsxs("div",{className:`group relative flex items-center gap-2 p-3 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors ${d===s.id?"bg-blue-50 border border-blue-200":"bg-white"}`,onClick:()=>U(s.id),children:[e.jsx(ne,{className:"h-4 w-4 text-gray-500 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:s.title}),e.jsx("p",{className:"text-xs text-gray-500",children:new Date(s.updatedAt).toLocaleDateString("pt-BR")})]}),e.jsx(g,{onClick:t=>{t.stopPropagation(),V(s.id)},variant:"ghost",size:"sm",className:"h-7 w-7 p-0 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx(_,{className:"h-3.5 w-3.5 text-red-500"})})]},s.id))})]}),e.jsxs("div",{className:"flex-1 flex flex-col",children:[e.jsx("div",{className:"border-b border-gray-200 bg-white/80 backdrop-blur-xl p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[!E&&e.jsx(g,{onClick:()=>T(!0),variant:"ghost",size:"sm",className:"h-9 w-9 p-0",children:e.jsx(te,{className:"h-5 w-5"})}),e.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-r from-blue-500 to-purple-500",children:e.jsx(L,{className:"h-6 w-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold text-gray-900",children:"Chat Administrativo"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Chat com IA"})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(g,{onClick:H,variant:"outline",size:"sm",className:"gap-2 hover:bg-red-50 hover:border-red-300",children:[e.jsx(_,{className:"h-4 w-4 text-red-500"}),"Limpar Chat"]}),e.jsxs(Z,{className:"bg-gradient-to-r from-green-500 to-emerald-500",children:[e.jsx(k,{className:"h-3 w-3 mr-1"}),"Online"]})]})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[i.map(s=>{var t;return e.jsx("div",{className:`flex ${s.role==="USER"?"justify-end":"justify-start"}`,children:e.jsx(R,{className:`max-w-[80%] ${s.role==="USER"?"bg-gradient-to-r from-blue-500 to-purple-500 text-white":s.role==="SYSTEM"?"bg-gradient-to-r from-amber-50 to-orange-50 border-amber-200":"bg-white"}`,children:e.jsxs(J,{className:"p-4",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[s.role==="ASSISTANT"&&e.jsx(L,{className:"h-5 w-5 text-blue-600 mt-1 flex-shrink-0"}),s.role==="SYSTEM"&&e.jsx(k,{className:"h-5 w-5 text-amber-600 mt-1 flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:`whitespace-pre-wrap break-words text-sm ${s.role==="USER"?"text-white":"text-gray-900"}`,children:s.content}),((t=s.metadata)==null?void 0:t.oauthAction)&&e.jsxs(g,{onClick:()=>K(s.metadata.oauthAction.platform),className:"mt-3 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600",size:"sm",children:["Conectar ",s.metadata.oauthAction.platform]})]})]}),e.jsx("div",{className:`text-xs mt-2 ${s.role==="USER"?"text-white/70":"text-gray-500"}`,children:s.timestamp.toLocaleTimeString("pt-BR")})]})})},s.id)}),h&&e.jsx(de,{isThinking:h,currentTool:B,reasoning:F,sources:G}),h&&e.jsx("div",{className:"flex justify-start",children:e.jsx(R,{className:"bg-white",children:e.jsx(J,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(D,{className:"h-4 w-4 animate-spin text-blue-600"}),e.jsx("span",{className:"text-sm text-gray-500",children:"Processando..."})]})})})}),e.jsx("div",{ref:z})]}),e.jsx("div",{className:"border-t border-gray-200 p-4 bg-white/80 backdrop-blur-xl",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(ae,{value:u,onChange:s=>j(s.target.value),onKeyDown:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),M())},placeholder:"Digite seu comando... (Ex: '/help', 'quantos usu√°rios temos?', '/stats')",className:"min-h-[60px] resize-none",disabled:h}),e.jsx(g,{onClick:M,disabled:!u.trim()||h||!d,className:"bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600",size:"lg",children:h?e.jsx(D,{className:"h-5 w-5 animate-spin"}):e.jsx(ie,{className:"h-5 w-5"})})]})})]})]})})}export{ye as default};

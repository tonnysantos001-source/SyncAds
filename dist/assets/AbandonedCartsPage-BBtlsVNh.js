import{s as n,r as y,f as I,u as T,j as e,g as b,h as p,i as C,S as A,l as g,Q as k,I as q,o as R,B}from"./index-C_eriggx.js";import{T as P,a as D,b as N,c as f,d as U,e as x}from"./table-gS-ENRdU.js";import{S}from"./skeleton-BDfB0X9Q.js";import{C as L}from"./clock-mZ1BVzJX.js";import{M as E}from"./mail-6Wz7lkwA.js";const v={async getAll(r){const{data:a,error:t}=await n.from("AbandonedCart").select("*").eq("userId",r).order("createdAt",{ascending:!1});if(t)throw t;const{data:d,error:i}=await n.from("ShopifyAbandonedCart").select("*").eq("userId",r).order("abandonedAt",{ascending:!1});if(i)throw i;const m=(d||[]).map(s=>({id:s.id,userId:s.userId,cartId:s.shopifyCartId||s.id,customerEmail:s.email,customerName:s.customerName,items:s.lineItems||{},subtotal:s.totalPrice||0,total:s.totalPrice||0,recoveryEmailSent:!1,recoveryEmailSentAt:void 0,recovered:!1,recoveredAt:void 0,recoveryOrderId:void 0,metadata:{source:"shopify",shopifyCartToken:s.cartToken,abandonedCheckoutUrl:s.abandonedCheckoutUrl},createdAt:s.abandonedAt||s.createdAt}));return[...a||[],...m].filter((s,u,j)=>u===j.findIndex(w=>w.cartId===s.cartId)).sort((s,u)=>new Date(u.createdAt).getTime()-new Date(s.createdAt).getTime())},async getById(r){const{data:a,error:t}=await n.from("AbandonedCart").select("*").eq("id",r).single();if(t)throw t;return a},async create(r){const{data:a,error:t}=await n.from("AbandonedCart").insert(r).select().single();if(t)throw t;return a},async markEmailSent(r){const{data:a,error:t}=await n.from("AbandonedCart").update({recoveryEmailSent:!0,recoveryEmailSentAt:new Date().toISOString()}).eq("id",r).select().single();if(t)throw t;return a},async markRecovered(r,a){const{data:t,error:d}=await n.from("AbandonedCart").update({recovered:!0,recoveredAt:new Date().toISOString(),recoveryOrderId:a}).eq("id",r).select().single();if(d)throw d;return t},async getUnrecovered(r){return(await v.getAll(r)).filter(t=>!t.recovered)},async getNeedingEmail(r){return(await v.getAll(r)).filter(t=>!t.recoveryEmailSent&&!t.recovered)},async getShopifyAbandoned(r){const{data:a,error:t}=await n.from("ShopifyAbandonedCart").select("*").eq("userId",r).order("abandonedAt",{ascending:!1});if(t)throw t;return a},async syncFromShopify(r){try{const{data:a,error:t}=await n.from("ShopifyAbandonedCart").select("*").eq("id",r).single();if(t)throw t;const{data:d}=await n.from("AbandonedCart").select("id").eq("cartId",a.shopifyCartId||r).single();if(d)return d;const i={userId:a.userId,cartId:a.shopifyCartId||r,customerEmail:a.email,customerName:a.customerName,items:a.lineItems||{},subtotal:a.totalPrice||0,total:a.totalPrice||0,recoveryEmailSent:!1,recovered:!1,metadata:{source:"shopify",shopifyCartToken:a.cartToken,abandonedCheckoutUrl:a.abandonedCheckoutUrl}},{data:m,error:l}=await n.from("AbandonedCart").insert(i).select().single();if(l)throw l;return m}catch(a){throw console.error("Error syncing Shopify cart:",a),a}},async delete(r){const{error:a}=await n.from("AbandonedCart").delete().eq("id",r);if(a)throw a}},$=()=>{const[r,a]=y.useState([]),[t,d]=y.useState(!0),[i,m]=y.useState(""),{toast:l}=I(),h=T(o=>o.user);y.useEffect(()=>{s()},[]);const s=async()=>{try{if(!(h!=null&&h.id))return;const o=await v.getAll(h.id);a(o)}catch(o){l({title:"Erro ao carregar",description:o.message,variant:"destructive"})}finally{d(!1)}},u=async o=>{try{l({title:"Email de recuperação enviado!"})}catch(c){l({title:"Erro",description:c.message,variant:"destructive"})}},j=r.filter(o=>{var c;return(c=o.customerEmail)==null?void 0:c.toLowerCase().includes(i.toLowerCase())}),w=r.reduce((o,c)=>o+c.total,0);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Carrinhos Abandonados"}),e.jsx("p",{className:"text-muted-foreground",children:"Recupere vendas de carrinhos abandonados"})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsxs(b,{children:[e.jsxs(p,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(C,{className:"text-sm font-medium",children:"Total Abandonados"}),e.jsx(A,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(g,{children:e.jsx("div",{className:"text-2xl font-bold",children:r.length})})]}),e.jsxs(b,{children:[e.jsxs(p,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(C,{className:"text-sm font-medium",children:"Valor Total"}),e.jsx(L,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(g,{children:e.jsxs("div",{className:"text-2xl font-bold",children:["R$ ",w.toFixed(2)]})})]}),e.jsxs(b,{children:[e.jsxs(p,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(C,{className:"text-sm font-medium",children:"Taxa Recuperação"}),e.jsx(E,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(g,{children:e.jsx("div",{className:"text-2xl font-bold",children:"-"})})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(k,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(q,{placeholder:"Buscar por email...",value:i,onChange:o=>m(o.target.value),className:"pl-9"})]}),e.jsxs(b,{children:[e.jsx(p,{children:e.jsx(C,{children:"Lista de Carrinhos"})}),e.jsx(g,{children:t?e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{className:"h-12 w-full"}),e.jsx(S,{className:"h-12 w-full"})]}):j.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(A,{className:"h-12 w-12 text-muted-foreground mb-4 mx-auto"}),e.jsx("h3",{className:"text-lg font-semibold",children:"Nenhum carrinho abandonado"})]}):e.jsxs(P,{children:[e.jsx(D,{children:e.jsxs(N,{children:[e.jsx(f,{children:"Email"}),e.jsx(f,{children:"Produtos"}),e.jsx(f,{children:"Valor"}),e.jsx(f,{children:"Abandonado há"}),e.jsx(f,{children:"Ações"})]})}),e.jsx(U,{children:j.map(o=>e.jsxs(N,{children:[e.jsx(x,{children:o.customerEmail}),e.jsxs(x,{children:[o.itemCount," items"]}),e.jsxs(x,{children:["R$ ",o.total.toFixed(2)]}),e.jsx(x,{children:e.jsxs(R,{variant:"outline",children:[o.abandonedDays,"d"]})}),e.jsx(x,{children:e.jsxs(B,{size:"sm",onClick:()=>u(o.id),children:[e.jsx(E,{className:"h-4 w-4 mr-2"}),"Recuperar"]})})]},o.id))})]})})]})]})};export{$ as default};

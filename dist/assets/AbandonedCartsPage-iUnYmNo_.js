import{s as i,r as g,d as B,a as P,j as e,O as m,B as E,a7 as z,C as f,e as b,f as j,h as v,T as D,I as U,W as O,o as L,k as F}from"./index-ZasCwQdT.js";import{T as H,a as M,b as V,c as p,d as W,e as y}from"./table-5D3ZM48d.js";import{a as $}from"./shopifySync-ow8pEnct.js";import{S as k}from"./skeleton-Cv158hmV.js";import{S as I}from"./shopping-cart-CcXf_dMa.js";import{D as G}from"./dollar-sign-CvZMjezq.js";import{T as J}from"./trending-up-7kn-UMLu.js";import{P as K}from"./package-B0KP3mS7.js";import{M as Q}from"./mail-DpYQ_7cR.js";const N={async getAll(r){const{data:a,error:o}=await i.from("AbandonedCart").select("*").eq("userId",r).order("createdAt",{ascending:!1});if(o)throw o;const{data:d,error:l}=await i.from("ShopifyAbandonedCart").select("*").eq("userId",r).order("abandonedAt",{ascending:!1});if(l)throw l;const x=(d||[]).map(s=>({id:s.id,userId:s.userId,cartId:s.shopifyCartId||s.id,customerEmail:s.email,customerName:s.customerName,items:s.lineItems||{},subtotal:s.totalPrice||0,total:s.totalPrice||0,recoveryEmailSent:!1,recoveryEmailSentAt:void 0,recovered:!1,recoveredAt:void 0,recoveryOrderId:void 0,metadata:{source:"shopify",shopifyCartToken:s.cartToken,abandonedCheckoutUrl:s.abandonedCheckoutUrl},createdAt:s.abandonedAt||s.createdAt}));return[...a||[],...x].filter((s,n,u)=>n===u.findIndex(w=>w.cartId===s.cartId)).sort((s,n)=>new Date(n.createdAt).getTime()-new Date(s.createdAt).getTime())},async getById(r){const{data:a,error:o}=await i.from("AbandonedCart").select("*").eq("id",r).single();if(o)throw o;return a},async create(r){const{data:a,error:o}=await i.from("AbandonedCart").insert(r).select().single();if(o)throw o;return a},async markEmailSent(r){const{data:a,error:o}=await i.from("AbandonedCart").update({recoveryEmailSent:!0,recoveryEmailSentAt:new Date().toISOString()}).eq("id",r).select().single();if(o)throw o;return a},async markRecovered(r,a){const{data:o,error:d}=await i.from("AbandonedCart").update({recovered:!0,recoveredAt:new Date().toISOString(),recoveryOrderId:a}).eq("id",r).select().single();if(d)throw d;return o},async getUnrecovered(r){return(await N.getAll(r)).filter(o=>!o.recovered)},async getNeedingEmail(r){return(await N.getAll(r)).filter(o=>!o.recoveryEmailSent&&!o.recovered)},async getShopifyAbandoned(r){const{data:a,error:o}=await i.from("ShopifyAbandonedCart").select("*").eq("userId",r).order("abandonedAt",{ascending:!1});if(o)throw o;return a},async syncFromShopify(r){try{const{data:a,error:o}=await i.from("ShopifyAbandonedCart").select("*").eq("id",r).single();if(o)throw o;const{data:d}=await i.from("AbandonedCart").select("id").eq("cartId",a.shopifyCartId||r).single();if(d)return d;const l={userId:a.userId,cartId:a.shopifyCartId||r,customerEmail:a.email,customerName:a.customerName,items:a.lineItems||{},subtotal:a.totalPrice||0,total:a.totalPrice||0,recoveryEmailSent:!1,recovered:!1,metadata:{source:"shopify",shopifyCartToken:a.cartToken,abandonedCheckoutUrl:a.abandonedCheckoutUrl}},{data:x,error:h}=await i.from("AbandonedCart").insert(l).select().single();if(h)throw h;return x}catch(a){throw console.error("Error syncing Shopify cart:",a),a}},async delete(r){const{error:a}=await i.from("AbandonedCart").delete().eq("id",r);if(a)throw a}},se=()=>{const[r,a]=g.useState([]),[o,d]=g.useState(!0),[l,x]=g.useState(!1),[h,C]=g.useState(""),{toast:s}=B(),n=P(t=>t.user);g.useEffect(()=>{u()},[]);const u=async()=>{try{if(!(n!=null&&n.id))return;const t=await N.getAll(n.id);a(t)}catch(t){s({title:"Erro ao carregar",description:t.message,variant:"destructive"})}finally{d(!1)}},w=async()=>{if(!(n!=null&&n.id)){s({title:"Erro",description:"Faça login para sincronizar",variant:"destructive"});return}try{x(!0),s({title:"Sincronizando...",description:"Buscando carrinhos abandonados da Shopify"});const t=await $.syncAbandonedCarts(n.id);t.success?(s({title:"Sincronização concluída!",description:t.message}),await u()):s({title:"Erro na sincronização",description:t.message,variant:"destructive"})}catch{s({title:"Erro ao sincronizar",description:"Configure a integração Shopify em Integrações",variant:"destructive"})}finally{x(!1)}},T=async t=>{try{s({title:"Email de recuperação enviado!"})}catch(c){s({title:"Erro",description:c.message,variant:"destructive"})}},S=r.filter(t=>{var c;return(c=t.customerEmail)==null?void 0:c.toLowerCase().includes(h.toLowerCase())}),q=r.reduce((t,c)=>t+c.total,0),R=r.length>0?12.5:0,A=t=>new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(t);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(m.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-4xl font-black bg-gradient-to-r from-orange-600 via-red-600 to-pink-600 bg-clip-text text-transparent",children:"Carrinhos Abandonados"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 font-medium",children:"Recupere vendas de carrinhos abandonados"})]}),e.jsxs(E,{onClick:w,disabled:l,className:"bg-gradient-to-r from-orange-500 to-pink-500 text-white border-0 hover:from-orange-600 hover:to-pink-600 transition-all duration-300 shadow-lg hover:shadow-xl disabled:opacity-50",children:[e.jsx(z,{className:`mr-2 h-4 w-4 ${l?"animate-spin":""}`}),l?"Sincronizando...":"Sincronizar Shopify"]})]}),e.jsxs("div",{className:"grid gap-6 md:grid-cols-3",children:[e.jsx(m.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.1},children:e.jsxs(f,{className:"relative overflow-hidden border-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl shadow-lg hover:shadow-xl transition-all duration-300",children:[e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 bg-orange-500 opacity-10 rounded-full blur-3xl"}),e.jsxs(b,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Total Abandonados"}),e.jsx("div",{className:"p-2 rounded-lg bg-orange-500 bg-opacity-10",children:e.jsx(I,{className:"h-4 w-4 text-orange-500"})})]}),e.jsxs(v,{children:[e.jsx("div",{className:"text-3xl font-bold bg-gradient-to-br from-orange-600 to-red-500 bg-clip-text text-transparent",children:r.length}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:"Carrinhos esperando recuperação"})]})]})}),e.jsx(m.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.2},children:e.jsxs(f,{className:"relative overflow-hidden border-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl shadow-lg hover:shadow-xl transition-all duration-300",children:[e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 bg-red-500 opacity-10 rounded-full blur-3xl"}),e.jsxs(b,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Valor Total"}),e.jsx("div",{className:"p-2 rounded-lg bg-red-500 bg-opacity-10",children:e.jsx(G,{className:"h-4 w-4 text-red-500"})})]}),e.jsxs(v,{children:[e.jsx("div",{className:"text-3xl font-bold bg-gradient-to-br from-red-600 to-pink-500 bg-clip-text text-transparent",children:A(q)}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:"Potencial de recuperação"})]})]})}),e.jsx(m.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.3},children:e.jsxs(f,{className:"relative overflow-hidden border-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl shadow-lg hover:shadow-xl transition-all duration-300",children:[e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 bg-pink-500 opacity-10 rounded-full blur-3xl"}),e.jsxs(b,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Taxa Recuperação"}),e.jsx("div",{className:"p-2 rounded-lg bg-pink-500 bg-opacity-10",children:e.jsx(J,{className:"h-4 w-4 text-pink-500"})})]}),e.jsxs(v,{children:[e.jsxs("div",{className:"text-3xl font-bold bg-gradient-to-br from-pink-600 to-purple-500 bg-clip-text text-transparent",children:[R.toFixed(1),"%"]}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:"Média de conversão"})]})]})})]}),e.jsxs(m.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.4},className:"relative",children:[e.jsx(D,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(U,{placeholder:"Buscar por email...",value:h,onChange:t=>C(t.target.value),className:"pl-9 border-gray-200 dark:border-gray-700 bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm dark:text-white dark:placeholder:text-gray-500"})]}),e.jsx(m.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.5},children:e.jsxs(f,{className:"border-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl shadow-lg",children:[e.jsx(b,{children:e.jsx(j,{className:"text-xl font-bold bg-gradient-to-r from-orange-600 to-pink-600 bg-clip-text text-transparent",children:"Lista de Carrinhos"})}),e.jsx(v,{children:o?e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{className:"h-12 w-full"}),e.jsx(k,{className:"h-12 w-full"}),e.jsx(k,{className:"h-12 w-full"})]}):S.length===0?e.jsxs(m.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{duration:.5},className:"text-center py-12",children:[e.jsx(I,{className:"h-16 w-16 text-muted-foreground mb-4 mx-auto opacity-50"}),e.jsx("h3",{className:"text-lg font-semibold mb-2 dark:text-white",children:"Nenhum carrinho abandonado"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:h?"Tente ajustar os filtros de busca":"Os carrinhos abandonados aparecerão aqui"})]}):e.jsx("div",{className:"rounded-lg overflow-hidden border border-gray-200 dark:border-gray-700",children:e.jsxs(H,{children:[e.jsx(M,{children:e.jsxs(V,{className:"bg-gradient-to-r from-orange-50 to-pink-50 dark:from-gray-800 dark:to-gray-800 hover:from-orange-100 hover:to-pink-100 dark:hover:from-gray-700 dark:hover:to-gray-700",children:[e.jsx(p,{className:"font-semibold dark:text-gray-300",children:"Email"}),e.jsx(p,{className:"font-semibold dark:text-gray-300",children:"Produtos"}),e.jsx(p,{className:"font-semibold dark:text-gray-300",children:"Valor"}),e.jsx(p,{className:"font-semibold dark:text-gray-300",children:"Abandonado há"}),e.jsx(p,{className:"font-semibold dark:text-gray-300",children:"Ações"})]})}),e.jsx(W,{children:S.map((t,c)=>e.jsxs(m.tr,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{duration:.3,delay:c*.05},className:"border-b border-gray-100 dark:border-gray-800 hover:bg-gradient-to-r hover:from-orange-50/50 hover:to-pink-50/50 dark:hover:from-gray-800/50 dark:hover:to-gray-800/50 transition-all duration-200",children:[e.jsx(y,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-br from-orange-100 to-pink-100 dark:from-orange-900/20 dark:to-pink-900/20",children:e.jsx(O,{className:"h-4 w-4 text-orange-600 dark:text-orange-400"})}),e.jsx("span",{className:"font-medium dark:text-white",children:t.customerEmail})]})}),e.jsx(y,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(K,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("span",{className:"dark:text-gray-300",children:[t.itemCount," ",t.itemCount===1?"item":"items"]})]})}),e.jsx(y,{children:e.jsx("span",{className:"font-bold bg-gradient-to-r from-orange-600 to-pink-600 bg-clip-text text-transparent",children:A(t.total)})}),e.jsx(y,{children:e.jsxs(L,{variant:"outline",className:"bg-gradient-to-r from-orange-100 to-pink-100 dark:from-orange-900/30 dark:to-pink-900/30 text-orange-700 dark:text-orange-300 border-orange-300 dark:border-orange-700",children:[e.jsx(F,{className:"h-3 w-3 mr-1"}),t.abandonedDays,"d"]})}),e.jsx(y,{children:e.jsxs(E,{size:"sm",onClick:()=>T(t.id),className:"bg-gradient-to-r from-orange-500 to-pink-500 text-white border-0 hover:from-orange-600 hover:to-pink-600 transition-all duration-300 shadow-md hover:shadow-lg",children:[e.jsx(Q,{className:"h-4 w-4 mr-2"}),"Recuperar"]})})]},t.id))})]})})})]})})]})};export{se as default};

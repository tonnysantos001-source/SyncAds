import{j as e}from"./vendor-ui-DkUuACDy.js";import{r as t}from"./vendor-react-X41Bjl18.js";import{s as r,g as a,f as s,C as o,a as d,b as i,c as l,I as c,B as n,d as x,e as m}from"./index-y8dUli4Z.js";import{T as h,a as g,b as y,c as u,d as p,e as v}from"./table-A68Pj_tE.js";import{S as f,a as b,b as w,c as j,d as N}from"./select-Ip4b7DwE.js";import{A as k,b as I}from"./alert-BFp0Vq7y.js";import{S as A}from"./skeleton-B8wCfXq2.js";import{m as E}from"./vendor-animation-DQ3cvw6m.js";import{f as R,w as P,K as S,D,av as C,S as q,R as M,C as V}from"./vendor-icons-DTdRnryx.js";import{f as O}from"./vendor-utils-Dl0_yMKq.js";import{p as X}from"./pt-BR-BbSwNUOy.js";import"./vendor-supabase-BQxDPPjR.js";import"./vendor-query-Bf3pI66S.js";const T={async list(e,t){try{let a=r.from("RecoveredCart").select("*").eq("userId",e).order("createdAt",{ascending:!1});void 0!==t?.recovered&&(a=a.eq("recovered",t.recovered)),t?.method&&(a=a.eq("recoveryMethod",t.method)),t?.dateFrom&&(a=a.gte("createdAt",t.dateFrom)),t?.dateTo&&(a=a.lte("createdAt",t.dateTo));const{data:s,error:o}=await a;if(o)throw o;return s}catch(a){throw a}},async getById(e){try{const{data:t,error:a}=await r.from("RecoveredCart").select("*").eq("id",e).single();if(a)throw a;return t}catch(t){throw t}},async create(e){try{const t={userId:e.userId,cartId:e.cartId,customerId:e.customerId,customerEmail:e.customerEmail,customerPhone:e.customerPhone,cartValue:e.cartValue,recoveryMethod:e.recoveryMethod||"EMAIL",discountOffered:e.discountValue||0,discountType:e.discountType,discountValue:e.discountValue,recoveryAttempts:0,recovered:!1},{data:a,error:s}=await r.from("RecoveredCart").insert(t).select().single();if(s)throw s;return a}catch(t){throw t}},async sendPixRecovery(e,t){try{const{data:a,error:s}=await r.from("RecoveredCart").update({pixQrCode:t.qrCode,pixCopyPaste:t.copyPaste,pixExpiresAt:t.expiresAt,pixPaymentId:t.paymentId,recoveryMethod:"PIX",recoveryAttempts:r.sql`"recoveryAttempts" + 1`,lastRecoveryAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()}).eq("id",e).select().single();if(s)throw s;return a}catch(a){throw a}},async sendEmailRecovery(e,t){try{const{data:a,error:s}=await r.from("RecoveredCart").update({recoveryEmailSent:!0,recoveryMethod:"EMAIL",recoveryAttempts:r.sql`"recoveryAttempts" + 1`,lastRecoveryAt:(new Date).toISOString(),metadata:t,updatedAt:(new Date).toISOString()}).eq("id",e).select().single();if(s)throw s;return a}catch(a){throw a}},async sendSmsRecovery(e,t){try{const{data:a,error:s}=await r.from("RecoveredCart").update({recoverySmsSent:!0,recoveryMethod:"SMS",recoveryAttempts:r.sql`"recoveryAttempts" + 1`,lastRecoveryAt:(new Date).toISOString(),metadata:{message:t},updatedAt:(new Date).toISOString()}).eq("id",e).select().single();if(s)throw s;return a}catch(a){throw a}},async sendWhatsAppRecovery(e,t){try{const{data:a,error:s}=await r.from("RecoveredCart").update({recoveryWhatsappSent:!0,recoveryMethod:"WHATSAPP",recoveryAttempts:r.sql`"recoveryAttempts" + 1`,lastRecoveryAt:(new Date).toISOString(),metadata:{message:t},updatedAt:(new Date).toISOString()}).eq("id",e).select().single();if(s)throw s;return a}catch(a){throw a}},async markAsRecovered(e,t){try{const{data:a,error:s}=await r.from("RecoveredCart").update({recovered:!0,recoveredAt:(new Date).toISOString(),orderId:t,updatedAt:(new Date).toISOString()}).eq("id",e).select().single();if(s)throw s;return a}catch(a){throw a}},async getStats(e,t){try{let a=r.from("RecoveredCart").select("*").eq("userId",e);t&&(a=a.gte("createdAt",t.from).lte("createdAt",t.to));const{data:s,error:o}=await a;if(o)throw o;const d=s,i=d.length,l=d.filter(e=>e.recovered).length,c=d.reduce((e,t)=>e+t.cartValue,0),n=d.filter(e=>e.recovered).reduce((e,t)=>e+t.cartValue,0),x=i>0?l/i*100:0,m={};return["PIX","EMAIL","SMS","WHATSAPP","PUSH_NOTIFICATION"].forEach(e=>{const t=d.filter(t=>t.recoveryMethod===e);if(t.length>0){const r=t.filter(e=>e.recovered).length;m[e]={attempts:t.length,successes:r,rate:r/t.length*100,value:t.filter(e=>e.recovered).reduce((e,t)=>e+t.cartValue,0)}}}),{totalAttempts:i,successfulRecoveries:l,totalCartValue:c,recoveredValue:n,recoveryRate:x,byMethod:m}}catch(a){throw a}},async getPending(e,t=50){try{const{data:a,error:s}=await r.from("RecoveredCart").select("*").eq("userId",e).eq("recovered",!1).order("createdAt",{ascending:!1}).limit(t);if(s)throw s;return a}catch(a){throw a}},async getPixRecovered(e){try{const{data:t,error:a}=await r.from("RecoveredCart").select("*").eq("userId",e).eq("recoveryMethod","PIX").eq("recovered",!0).order("recoveredAt",{ascending:!1});if(a)throw a;return t}catch(t){throw t}},async delete(e){try{const{error:t}=await r.from("RecoveredCart").delete().eq("id",e);if(t)throw t;return!0}catch(t){throw t}},async update(e,t){try{const{data:a,error:s}=await r.from("RecoveredCart").update({...t,updatedAt:(new Date).toISOString()}).eq("id",e).select().single();if(s)throw s;return a}catch(a){throw a}}},H=()=>{const[r,H]=t.useState([]),[L,G]=t.useState([]),[F,B]=t.useState(!0),[W,z]=t.useState(""),[K,Q]=t.useState("all"),{toast:U}=a(),_=s(e=>e.user);t.useEffect(()=>{J()},[_?.id]),t.useEffect(()=>{Y()},[W,K,r]);const J=async()=>{try{if(!_?.id)return;B(!0);const e=await T.getPixRecovered(_.id);H(e)}catch(e){U({title:"Erro ao carregar dados",description:e.message,variant:"destructive"})}finally{B(!1)}},Y=()=>{let e=r;W&&(e=e.filter(e=>e.customerEmail.toLowerCase().includes(W.toLowerCase())||e.orderId&&e.orderId.toLowerCase().includes(W.toLowerCase()))),"all"!==K&&("RECOVERED"===K?e=e.filter(e=>e.recovered):"PENDING"===K?e=e.filter(e=>!e.recovered&&(!e.pixExpiresAt||new Date(e.pixExpiresAt)>new Date)):"EXPIRED"===K&&(e=e.filter(e=>!e.recovered&&e.pixExpiresAt&&new Date(e.pixExpiresAt)<new Date))),G(e)},Z=e=>new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(e),$=e=>e.recovered?"RECOVERED":e.pixExpiresAt&&new Date(e.pixExpiresAt)<new Date?"EXPIRED":"PENDING",ee=r.filter(e=>"PENDING"===$(e)).reduce((e,t)=>e+t.cartValue,0),te=r.filter(e=>e.recovered).reduce((e,t)=>e+t.cartValue,0),re=r.filter(e=>"EXPIRED"===$(e)).reduce((e,t)=>e+t.cartValue,0),ae=r.length>0?(r.filter(e=>e.recovered).length/r.length*100).toFixed(1):"0";return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(E.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},children:[e.jsx("h1",{className:"text-4xl font-black bg-gradient-to-r from-green-600 via-teal-600 to-blue-600 bg-clip-text text-transparent",children:"PIX Recuperados"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 font-medium",children:"Gerencie transações PIX e recupere vendas perdidas"})]}),e.jsxs("div",{className:"grid gap-6 md:grid-cols-4",children:[e.jsx(E.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.1},children:e.jsxs(o,{className:"relative overflow-hidden border-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl shadow-lg hover:shadow-xl transition-all duration-300",children:[e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 bg-yellow-500 opacity-10 rounded-full blur-3xl"}),e.jsxs(d,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(i,{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Aguardando Pagamento"}),e.jsx("div",{className:"p-2 rounded-lg bg-yellow-500 bg-opacity-10",children:e.jsx(R,{className:"h-4 w-4 text-yellow-500"})})]}),e.jsxs(l,{children:[e.jsx("div",{className:"text-3xl font-bold bg-gradient-to-br from-yellow-600 to-orange-500 bg-clip-text text-transparent",children:Z(ee)}),e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:[r.filter(e=>"PENDING"===$(e)).length," ","aguardando"]})]})]})}),e.jsx(E.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.2},children:e.jsxs(o,{className:"relative overflow-hidden border-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl shadow-lg hover:shadow-xl transition-all duration-300",children:[e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 bg-green-500 opacity-10 rounded-full blur-3xl"}),e.jsxs(d,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(i,{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"PIX Recuperados"}),e.jsx("div",{className:"p-2 rounded-lg bg-green-500 bg-opacity-10",children:e.jsx(P,{className:"h-4 w-4 text-green-500"})})]}),e.jsxs(l,{children:[e.jsx("div",{className:"text-3xl font-bold bg-gradient-to-br from-green-600 to-teal-500 bg-clip-text text-transparent",children:Z(te)}),e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:[r.filter(e=>e.recovered).length," recuperados"]})]})]})}),e.jsx(E.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.3},children:e.jsxs(o,{className:"relative overflow-hidden border-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl shadow-lg hover:shadow-xl transition-all duration-300",children:[e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 bg-red-500 opacity-10 rounded-full blur-3xl"}),e.jsxs(d,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(i,{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Expirados"}),e.jsx("div",{className:"p-2 rounded-lg bg-red-500 bg-opacity-10",children:e.jsx(S,{className:"h-4 w-4 text-red-500"})})]}),e.jsxs(l,{children:[e.jsx("div",{className:"text-3xl font-bold bg-gradient-to-br from-red-600 to-pink-500 bg-clip-text text-transparent",children:Z(re)}),e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:[r.filter(e=>"EXPIRED"===$(e)).length," ","expirados"]})]})]})}),e.jsx(E.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.4},children:e.jsxs(o,{className:"relative overflow-hidden border-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl shadow-lg hover:shadow-xl transition-all duration-300",children:[e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 bg-blue-500 opacity-10 rounded-full blur-3xl"}),e.jsxs(d,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(i,{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Taxa de Recuperação"}),e.jsx("div",{className:"p-2 rounded-lg bg-blue-500 bg-opacity-10",children:e.jsx(D,{className:"h-4 w-4 text-blue-500"})})]}),e.jsxs(l,{children:[e.jsxs("div",{className:"text-3xl font-bold bg-gradient-to-br from-blue-600 to-cyan-500 bg-clip-text text-transparent",children:[ae,"%"]}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:"Taxa de conversão de PIX"})]})]})})]}),ee>0&&e.jsx(E.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{duration:.5,delay:.5},children:e.jsxs(k,{className:"border-0 bg-gradient-to-r from-yellow-50 to-orange-50 dark:from-yellow-900/20 dark:to-orange-900/20 backdrop-blur-sm",children:[e.jsx(C,{className:"h-4 w-4 text-yellow-600 dark:text-yellow-400"}),e.jsxs(I,{className:"dark:text-gray-300",children:["Você tem"," ",e.jsx("strong",{className:"text-yellow-700 dark:text-yellow-300",children:Z(ee)})," ","em PIX aguardando pagamento. Considere enviar lembretes para os clientes."]})]})}),e.jsxs(E.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.6},className:"flex flex-col sm:flex-row items-center gap-4",children:[e.jsxs("div",{className:"relative flex-1 w-full",children:[e.jsx(q,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(c,{placeholder:"Buscar por pedido, cliente ou email...",value:W,onChange:e=>z(e.target.value),className:"pl-9 border-gray-200 dark:border-gray-700 bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm dark:text-white dark:placeholder:text-gray-500"})]}),e.jsxs(f,{value:K,onValueChange:Q,children:[e.jsx(b,{className:"w-full sm:w-[200px] border-gray-200 dark:border-gray-700 bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm dark:text-white",children:e.jsx(w,{placeholder:"Status"})}),e.jsxs(j,{children:[e.jsx(N,{value:"all",children:"Todos"}),e.jsx(N,{value:"PENDING",children:"Aguardando"}),e.jsx(N,{value:"RECOVERED",children:"Recuperado"}),e.jsx(N,{value:"EXPIRED",children:"Expirado"})]})]}),e.jsxs(n,{onClick:J,className:"w-full sm:w-auto bg-gradient-to-r from-green-500 to-teal-500 text-white border-0 hover:from-green-600 hover:to-teal-600 transition-all duration-300 shadow-lg hover:shadow-xl",children:[e.jsx(M,{className:"h-4 w-4 mr-2"}),"Atualizar"]})]}),e.jsx(E.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.7},children:e.jsxs(o,{className:"border-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl shadow-lg",children:[e.jsxs(d,{children:[e.jsx(i,{className:"text-xl font-bold bg-gradient-to-r from-green-600 to-teal-600 bg-clip-text text-transparent",children:"Recuperação de Carrinhos via PIX"}),e.jsxs(x,{className:"dark:text-gray-400",children:[L.length," carrinho(s) encontrado(s)"]})]}),e.jsx(l,{children:F?e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{className:"h-12 w-full"}),e.jsx(A,{className:"h-12 w-full"}),e.jsx(A,{className:"h-12 w-full"})]}):0===L.length?e.jsxs(E.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{duration:.5},className:"flex flex-col items-center justify-center py-12 text-center",children:[e.jsx(D,{className:"h-16 w-16 text-muted-foreground mb-4 opacity-50"}),e.jsx("h3",{className:"text-lg font-semibold mb-2 dark:text-white",children:"Nenhum PIX encontrado"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:W||"all"!==K?"Tente ajustar os filtros":"Aguardando primeira transação PIX"})]}):e.jsx("div",{className:"rounded-lg overflow-hidden border border-gray-200 dark:border-gray-700",children:e.jsxs(h,{children:[e.jsx(g,{children:e.jsxs(y,{className:"bg-gradient-to-r from-green-50 to-teal-50 dark:from-gray-800 dark:to-gray-800 hover:from-green-100 hover:to-teal-100 dark:hover:from-gray-700 dark:hover:to-gray-700",children:[e.jsx(u,{className:"font-semibold dark:text-gray-300",children:"Carrinho"}),e.jsx(u,{className:"font-semibold dark:text-gray-300",children:"Cliente"}),e.jsx(u,{className:"font-semibold dark:text-gray-300",children:"Valor"}),e.jsx(u,{className:"font-semibold dark:text-gray-300",children:"Tentativas"}),e.jsx(u,{className:"font-semibold dark:text-gray-300",children:"Status"}),e.jsx(u,{className:"font-semibold dark:text-gray-300",children:"Expira em"}),e.jsx(u,{className:"font-semibold dark:text-gray-300",children:"Data"}),e.jsx(u,{className:"text-right font-semibold dark:text-gray-300",children:"Ações"})]})}),e.jsx(p,{children:L.map((t,r)=>{const a=$(t),s=(e=>({PENDING:{label:"Aguardando Pagamento",variant:"secondary",icon:R},RECOVERED:{label:"Recuperado",variant:"default",icon:V},EXPIRED:{label:"Expirado",variant:"destructive",icon:C},FAILED:{label:"Falhou",variant:"destructive",icon:C}}[e]||{label:"Aguardando Pagamento",variant:"secondary",icon:R}))(a),o=s.icon;return e.jsxs(E.tr,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{duration:.3,delay:.05*r},className:"border-b border-gray-100 dark:border-gray-800 hover:bg-gradient-to-r hover:from-green-50/50 hover:to-teal-50/50 dark:hover:from-gray-800/50 dark:hover:to-gray-800/50 transition-all duration-200",children:[e.jsx(v,{children:e.jsxs("div",{className:"font-mono text-sm font-semibold bg-gradient-to-r from-green-600 to-teal-600 bg-clip-text text-transparent",children:["#",t.cartId.substring(0,8)]})}),e.jsx(v,{children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium dark:text-white",children:t.customerEmail}),t.customerPhone&&e.jsx("div",{className:"text-sm text-muted-foreground",children:t.customerPhone})]})}),e.jsxs(v,{children:[e.jsx("div",{className:"font-bold bg-gradient-to-r from-green-600 to-teal-600 bg-clip-text text-transparent",children:Z(t.cartValue)}),t.discountOffered>0&&e.jsxs("div",{className:"text-sm text-green-600 dark:text-green-400",children:["Desconto:"," ",Z(t.discountOffered)]}),t.recoveredAt&&e.jsxs("div",{className:"text-sm text-green-600 dark:text-green-400",children:["Recuperado em"," ",O(new Date(t.recoveredAt),"dd/MM/yyyy HH:mm",{locale:X})]})]}),e.jsxs(v,{children:[e.jsxs("div",{className:"text-sm dark:text-gray-300",children:[t.recoveryAttempts," tentativa(s)"]}),t.lastRecoveryAt&&e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Última:"," ",O(new Date(t.lastRecoveryAt),"dd/MM HH:mm",{locale:X})]})]}),e.jsx(v,{children:e.jsxs(m,{variant:s.variant,className:"gap-1",children:[e.jsx(o,{className:"h-3 w-3"}),s.label]})}),e.jsx(v,{children:t.pixExpiresAt?e.jsx("div",{className:"text-sm",children:O(new Date(t.pixExpiresAt),"dd/MM/yyyy HH:mm",{locale:X})}):e.jsx("span",{className:"text-sm text-muted-foreground",children:"-"})}),e.jsx(v,{children:O(new Date(t.createdAt),"dd/MM/yyyy",{locale:X})}),e.jsx(v,{className:"text-right",children:e.jsxs("div",{className:"flex justify-end gap-2",children:["PENDING"===a&&t.pixCopyPaste&&e.jsx(n,{variant:"outline",size:"sm",className:"bg-gradient-to-r from-green-500 to-teal-500 text-white border-0 hover:from-green-600 hover:to-teal-600 transition-all duration-300 shadow-md hover:shadow-lg",onClick:()=>{navigator.clipboard.writeText(t.pixCopyPaste),U({title:"Chave PIX copiada!"})},children:"Copiar PIX"}),t.orderId&&e.jsx(n,{variant:"ghost",size:"sm",className:"hover:bg-gradient-to-r hover:from-green-50 hover:to-teal-50 dark:hover:from-gray-800 dark:hover:to-gray-800",children:"Ver pedido"})]})})]},t.id)})})]})})})]})})]})};export{H as default};

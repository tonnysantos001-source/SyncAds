import{c as H,b as K,r as c,j as t,B as g,a8 as W,o as ee,d as J,h as R,k as $,s as i}from"./index-6tYPEaS8.js";import{T as te}from"./textarea-CQssXcKR.js";import{S as se}from"./SuperAdminLayout-CALuDMpU.js";import{A as re}from"./AiThinkingIndicator-C4Cv9slo.js";import{X as ae}from"./x-B0FuSGSi.js";import{M as oe}from"./message-square-qIvHiD01.js";import{T as q}from"./trash-2-D8N13aj8.js";import{S as D}from"./shield-BFInjhE4.js";import{S as L}from"./sparkles-C-QjfGiG.js";import{S as ne}from"./send-DCEo-0k_.js";import"./Logo-BGrZLdEn.js";import"./users-DCLsB4-I.js";import"./dollar-sign-AH6YJ0yd.js";import"./chart-column-B0TWu0Ne.js";import"./credit-card-CTZ5hIsq.js";import"./bot-B5_aUI4d.js";import"./globe-CjBGpZ_4.js";import"./download-CgV_aFvJ.js";/**
 * @license lucide-react v0.417.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ie=H("CirclePlus",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]);function ce(n){const l=n.toLowerCase();return l.includes("conecte facebook")||l.includes("conecte o facebook")||l.includes("facebook ads")?"facebook":l.includes("conecte google")||l.includes("google ads")?"google":l.includes("conecte linkedin")?"linkedin":l.includes("conecte tiktok")?"tiktok":null}function Ie(){const{toast:n}=K(),[l,p]=c.useState([]),[x,A]=c.useState(""),[u,I]=c.useState(!1),[m,j]=c.useState(null),[P,Z]=c.useState([]),[k,E]=c.useState(!0),T=c.useRef(null),[_,f]=c.useState(null),[Q,v]=c.useState(""),[X,b]=c.useState([]),C=async()=>{try{const{data:{user:e}}=await i.auth.getUser();if(!e)return;const{data:s,error:r}=await i.from("ChatConversation").select("id, title, createdAt, updatedAt").eq("userId",e.id).order("updatedAt",{ascending:!1}).limit(20);if(r)throw r;Z(s||[])}catch(e){console.error("Erro ao carregar conversas:",e)}},O=async e=>{try{const{data:s,error:r}=await i.from("ChatMessage").select("id, role, content, createdAt").eq("conversationId",e).order("createdAt",{ascending:!0});if(r)throw r;const a=(s||[]).map(o=>({id:o.id,role:o.role,content:o.content,timestamp:new Date(o.createdAt)}));p(a),j(e),console.log(`‚úÖ ${a.length} mensagens carregadas da conversa ${e}`)}catch(s){console.error("Erro ao carregar mensagens:",s),n({title:"Erro",description:"N√£o foi poss√≠vel carregar mensagens.",variant:"destructive"})}},B=async e=>{try{await i.from("ChatMessage").delete().eq("conversationId",e),await i.from("ChatConversation").delete().eq("id",e),m===e&&(p([]),j(null)),await C(),n({title:"‚úÖ Conversa deletada!",description:"Conversa removida com sucesso."})}catch(s){console.error("Erro ao deletar conversa:",s),n({title:"Erro",description:"N√£o foi poss√≠vel deletar conversa.",variant:"destructive"})}};c.useEffect(()=>{(async()=>{try{const{data:{user:s},error:r}=await i.auth.getUser();if(r||!s){console.error("Usu√°rio n√£o autenticado:",r),n({title:"Erro de autentica√ß√£o",description:"Voc√™ precisa fazer login novamente.",variant:"destructive"}),window.location.href="/login";return}await C();const{data:a,error:o}=await i.from("ChatConversation").select("id, title, createdAt, updatedAt").eq("userId",s.id).order("updatedAt",{ascending:!1}).limit(1).single();a?(console.log("‚úÖ Carregando conversa existente:",a.id),j(a.id),await O(a.id)):console.log('üìã Nenhuma conversa existente. Use "Nova Conversa" para come√ßar.')}catch(s){console.error("Erro ao inicializar conversa:",s)}})()},[]),c.useEffect(()=>{var e;(e=T.current)==null||e.scrollIntoView({behavior:"smooth"})},[l]);const F=async(e,s)=>{try{const r=e.toLowerCase();let a=null,o="",y=[];if(r.includes("pesquis")||r.includes("busca")||r.includes("google")||r.includes("internet")){a="web_search";let d=e;if(r.includes("pesquis")){const N=e.match(/pesquis[ae]\s+(.+)/i);d=N?N[1]:e}o=`Pesquisando na web sobre: "${d}"`,f("web_search"),v(o),b(["Google Search","Exa AI","Tavily"])}else if(r.includes("baix")||r.includes("rasp")||r.includes("scrape")){a="web_scraping";const d=e.match(/https?:\/\/[^\s]+/i),N=d?d[0]:"URL n√£o especificada";o=`Raspando dados de: ${N}`,f("web_scraping"),v(o),b([N])}else r.includes("python")||r.includes("calcule")||r.includes("execute c√≥digo")?(a="python_exec",o="Executando c√≥digo Python para processar dados...",f("python_exec"),v(o)):(f(null),v("Processando sua solicita√ß√£o..."),b([]));const{data:{session:w}}=await i.auth.getSession();if(!w)throw new Error("N√£o autenticado");const M="https://ovskepqggmxlfckxqgbr.supabase.co/functions/v1/chat-enhanced",z=l.map(d=>({role:d.role.toLowerCase(),content:d.content}));console.log("üåê Calling chat-stream (Admin):",M),console.log("üìú History length:",z.length);const S=await fetch(M,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${w.access_token}`,apikey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92c2tlcHFnZ214bGZja3hxZ2JyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MjQ4NTUsImV4cCI6MjA3NjQwMDg1NX0.UdNgqpTN38An6FuoJPZlj_zLkmAqfJQXb6i1DdTQO_E"},body:JSON.stringify({message:e,conversationId:s,conversationHistory:z,systemPrompt:void 0})});if(!S.ok){const d=await S.json();throw new Error(d.error||"Erro ao processar mensagem")}const h=await S.json();return console.log("üì¶ Response data:",h),h.error?(console.error("‚ùå Erro na resposta:",h.error),`‚ö†Ô∏è ${h.response||h.error}`):!h.response||h.response==="Sem resposta da IA"?(console.error("‚ùå IA n√£o retornou resposta v√°lida"),"‚ö†Ô∏è IA n√£o configurada ou sem resposta. Configure uma IA em Configura√ß√µes > IA Global."):(f(null),v(""),b([]),h.response)}catch(r){return console.error("Admin chat error:",r),f(null),v(""),b([]),`‚ùå Erro: ${r.message}`}},G=async()=>{if(m)try{await i.from("ChatMessage").delete().eq("conversationId",m),p([]),n({title:"‚úÖ Mensagens limpas!",description:"Chat limpo com sucesso."})}catch(e){console.error("Erro ao limpar mensagens:",e),n({title:"Erro",description:"N√£o foi poss√≠vel limpar mensagens.",variant:"destructive"})}},V=async e=>{try{const{data:{user:s}}=await i.auth.getUser();if(!s)throw new Error("Usu√°rio n√£o autenticado");const r="https://ovskepqggmxlfckxqgbr.supabase.co/functions/v1/oauth-init",{data:{session:a}}=await i.auth.getSession();if(!a)throw new Error("N√£o autenticado");const o=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a.access_token}`,apikey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92c2tlcHFnZ214bGZja3hxZ2JyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MjQ4NTUsImV4cCI6MjA3NjQwMDg1NX0.UdNgqpTN38An6FuoJPZlj_zLkmAqfJQXb6i1DdTQO_E"},body:JSON.stringify({platform:e,redirectUrl:`${window.location.origin}/integrations/callback`})});if(!o.ok)throw new Error("Erro ao iniciar OAuth");const{authUrl:y}=await o.json();window.open(y,"_blank"),n({title:"üîó Autoriza√ß√£o Necess√°ria",description:`Abra a nova aba para autorizar ${e}`})}catch(s){console.error("Erro OAuth:",s),n({title:"Erro ao conectar",description:s.message,variant:"destructive"})}},Y=async()=>{try{const{data:{user:e}}=await i.auth.getUser();if(!e)return;const s=crypto.randomUUID(),r=new Date().toISOString(),{error:a}=await i.from("ChatConversation").insert({id:s,userId:e.id,title:"üÜï Nova Conversa",createdAt:r,updatedAt:r});if(a)throw a;p([]),j(s),await C(),n({title:"‚úÖ Nova conversa criada!",description:"Comece um novo chat do zero."})}catch(e){console.error("Erro ao criar nova conversa:",e),n({title:"Erro",description:e.message||"N√£o foi poss√≠vel criar nova conversa.",variant:"destructive"})}},U=async()=>{if(!x.trim()||u||!m){console.log("Bot√£o desabilitado:",{inputTrim:!x.trim(),isLoading:u,conversationId:!!m});return}console.log("Enviando mensagem:",x.trim());const e=x.trim();A(""),I(!0);try{if(!m)throw new Error("Conversa n√£o inicializada");const s=m;console.log("Active conversation ID:",s);const r={id:`temp-${Date.now()}`,role:"USER",content:e,timestamp:new Date};p(w=>[...w,r]);const a=ce(e),o=await F(e,s),y={id:`temp-${Date.now()+1}`,role:"ASSISTANT",content:o,timestamp:new Date,metadata:a?{oauthAction:{platform:a,action:"connect"}}:void 0};p(w=>[...w,y])}catch(s){console.error("ERRO COMPLETO:",s);const r={id:`error-${Date.now()}`,role:"ASSISTANT",content:`‚ùå ERRO DETALHADO:

${s.message}

${s.stack||"Sem stack trace"}

${JSON.stringify(s,null,2)}`,timestamp:new Date};p(a=>[...a,r]),n({title:"Erro ao processar",description:s.message,variant:"destructive"})}finally{I(!1)}};return t.jsx(se,{children:t.jsxs("div",{className:"h-[calc(100vh-80px)] flex",children:[t.jsxs("div",{className:`${k?"w-72":"w-0"} transition-all duration-300 bg-gray-50 border-r border-gray-200 flex flex-col overflow-hidden`,children:[t.jsxs("div",{className:"p-4 border-b border-gray-200",children:[t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[t.jsx("h2",{className:"text-sm font-semibold text-gray-700",children:"Conversas"}),t.jsx(g,{onClick:()=>E(!1),variant:"ghost",size:"sm",className:"h-7 w-7 p-0",children:t.jsx(ae,{className:"h-4 w-4"})})]}),t.jsxs(g,{onClick:Y,className:"w-full gap-2",size:"sm",children:[t.jsx(ie,{className:"h-4 w-4"}),"Nova Conversa"]})]}),t.jsx("div",{className:"flex-1 overflow-y-auto p-2 space-y-1",children:P.map(e=>t.jsxs("div",{className:`group relative flex items-center gap-2 p-3 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors ${m===e.id?"bg-blue-50 border border-blue-200":"bg-white"}`,onClick:()=>O(e.id),children:[t.jsx(oe,{className:"h-4 w-4 text-gray-500 flex-shrink-0"}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:e.title}),t.jsx("p",{className:"text-xs text-gray-500",children:new Date(e.updatedAt).toLocaleDateString("pt-BR")})]}),t.jsx(g,{onClick:s=>{s.stopPropagation(),B(e.id)},variant:"ghost",size:"sm",className:"h-7 w-7 p-0 opacity-0 group-hover:opacity-100 transition-opacity",children:t.jsx(q,{className:"h-3.5 w-3.5 text-red-500"})})]},e.id))})]}),t.jsxs("div",{className:"flex-1 flex flex-col",children:[t.jsx("div",{className:"border-b border-gray-200 bg-white/80 backdrop-blur-xl p-4",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[!k&&t.jsx(g,{onClick:()=>E(!0),variant:"ghost",size:"sm",className:"h-9 w-9 p-0",children:t.jsx(W,{className:"h-5 w-5"})}),t.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-r from-blue-500 to-purple-500",children:t.jsx(D,{className:"h-6 w-6 text-white"})}),t.jsxs("div",{children:[t.jsx("h1",{className:"text-xl font-bold text-gray-900",children:"Chat Administrativo"}),t.jsx("p",{className:"text-sm text-gray-500",children:"Chat com IA"})]})]}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs(g,{onClick:G,variant:"outline",size:"sm",className:"gap-2 hover:bg-red-50 hover:border-red-300",children:[t.jsx(q,{className:"h-4 w-4 text-red-500"}),"Limpar Chat"]}),t.jsxs(ee,{className:"bg-gradient-to-r from-green-500 to-emerald-500",children:[t.jsx(L,{className:"h-3 w-3 mr-1"}),"Online"]})]})]})}),t.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[l.map(e=>{var s;return t.jsx("div",{className:`flex ${e.role==="USER"?"justify-end":"justify-start"}`,children:t.jsx(J,{className:`max-w-[80%] ${e.role==="USER"?"bg-gradient-to-r from-blue-500 to-purple-500 text-white":e.role==="SYSTEM"?"bg-gradient-to-r from-amber-50 to-orange-50 border-amber-200":"bg-white"}`,children:t.jsxs(R,{className:"p-4",children:[t.jsxs("div",{className:"flex items-start gap-2",children:[e.role==="ASSISTANT"&&t.jsx(D,{className:"h-5 w-5 text-blue-600 mt-1 flex-shrink-0"}),e.role==="SYSTEM"&&t.jsx(L,{className:"h-5 w-5 text-amber-600 mt-1 flex-shrink-0"}),t.jsxs("div",{className:"flex-1",children:[t.jsx("div",{className:`whitespace-pre-wrap break-words text-sm ${e.role==="USER"?"text-white":"text-gray-900"}`,children:e.content}),((s=e.metadata)==null?void 0:s.oauthAction)&&t.jsxs(g,{onClick:()=>V(e.metadata.oauthAction.platform),className:"mt-3 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600",size:"sm",children:["Conectar ",e.metadata.oauthAction.platform]})]})]}),t.jsx("div",{className:`text-xs mt-2 ${e.role==="USER"?"text-white/70":"text-gray-500"}`,children:e.timestamp.toLocaleTimeString("pt-BR")})]})})},e.id)}),u&&t.jsx(re,{isThinking:u,currentTool:_,reasoning:Q,sources:X}),u&&t.jsx("div",{className:"flex justify-start",children:t.jsx(J,{className:"bg-white",children:t.jsx(R,{className:"p-4",children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx($,{className:"h-4 w-4 animate-spin text-blue-600"}),t.jsx("span",{className:"text-sm text-gray-500",children:"Processando..."})]})})})}),t.jsx("div",{ref:T})]}),t.jsx("div",{className:"border-t border-gray-200 p-4 bg-white/80 backdrop-blur-xl",children:t.jsxs("div",{className:"flex gap-2",children:[t.jsx(te,{value:x,onChange:e=>A(e.target.value),onKeyDown:e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),U())},placeholder:"Digite seu comando... (Ex: '/help', 'quantos usu√°rios temos?', '/stats')",className:"min-h-[60px] resize-none",disabled:u}),t.jsx(g,{onClick:U,disabled:!x.trim()||u||!m,className:"bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600",size:"lg",children:u?t.jsx($,{className:"h-5 w-5 animate-spin"}):t.jsx(ne,{className:"h-5 w-5"})})]})})]})]})})}export{Ie as default};

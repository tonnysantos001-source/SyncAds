import{j as e}from"./vendor-ui-DkUuACDy.js";import{f as t,r as s}from"./vendor-react-X41Bjl18.js";import{g as a,f as r,i as n,s as o}from"./index-BUZDbfd2.js";import{I as i,a as c,b as d}from"./IconSend-k0S1PxJo.js";import"./vendor-supabase-BQxDPPjR.js";import"./vendor-utils-Dl0_yMKq.js";import"./vendor-animation-DQ3cvw6m.js";import"./vendor-query-Bf3pI66S.js";import"./vendor-icons-DTdRnryx.js";function l({status:t="thinking"}){return e.jsxs("div",{className:"flex items-center gap-2 p-4 bg-gray-800 rounded-lg max-w-[70%]",children:[e.jsxs("div",{className:"flex gap-1",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-bounce [animation-delay:-0.3s]"}),e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-bounce [animation-delay:-0.15s]"}),e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-bounce"})]}),e.jsx("span",{className:"text-sm text-gray-400",children:{thinking:"Pensando...",searching:"Pesquisando...",navigating:"Navegando...",processing:"Processando..."}[t]})]})}function m(){const m=t(),{toast:u}=a(),g=r(e=>e.user),x=r(e=>e.isAuthenticated),[h,v]=s.useState([]),[p,f]=s.useState(null),[b,j]=s.useState(""),[y,w]=s.useState(!1),[N,S]=s.useState(!1),[C,E]=s.useState(null),[A,I]=s.useState(!0),[D,k]=s.useState({connected:!1,deviceId:null,lastCheck:0}),O=s.useRef(null);s.useEffect(()=>{x&&g||m("/login-v2",{replace:!0})},[x,g,m]),s.useEffect(()=>{if(!g)return;(async()=>{w(!0);try{const{data:e,error:t}=await o.from("ChatConversation").select("id, title, createdAt").eq("userId",g.id).order("createdAt",{ascending:!1});if(t)throw t;if(!e||0===e.length){const e={id:crypto.randomUUID(),userId:g.id,title:`Conversa ${(new Date).toLocaleDateString()}`,createdAt:(new Date).toISOString()},{error:t}=await o.from("ChatConversation").insert(e);return void(t||(v([{id:e.id,title:e.title,messages:[]}]),f(e.id)))}const s=await Promise.all(e.map(async e=>{const{data:t}=await o.from("ChatMessage").select("id, role, content, createdAt").eq("conversationId",e.id).order("createdAt",{ascending:!0});return{id:e.id,title:e.title,messages:(t||[]).map(e=>({id:e.id,role:e.role.toLowerCase(),content:e.content,createdAt:e.createdAt}))}}));v(s),!p&&s.length>0&&f(s[0].id)}catch(e){u({title:"Erro",description:"Não foi possível carregar as conversas",variant:"destructive"})}finally{w(!1)}})()},[g]),s.useEffect(()=>{if(!g)return;let e=0;const t=async()=>{try{const{data:t,error:s}=await o.from("extension_devices").select("id, device_id, status, last_seen").eq("user_id",g.id).eq("status","online").order("last_seen",{ascending:!1}).limit(1).maybeSingle();if(s)return e++,void(e>=3&&k({connected:!1,deviceId:null,lastCheck:Date.now()}));const a=Date.now(),r=t?new Date(t.last_seen).getTime():0;k({connected:!!t&&a-r<3e4,deviceId:t?.device_id||null,lastCheck:a}),s||(e=0)}catch(t){e++}};t();const s=setInterval(t,5e3);return()=>clearInterval(s)},[g]),s.useEffect(()=>{O.current?.scrollIntoView({behavior:"smooth"})},[h,p]);const P=async()=>{if(!b.trim()||!p||!g||N)return;const e=b.trim(),t=`temp-user-${Date.now()}`,s=`temp-ai-${Date.now()}`;j(""),S(!0);const a=e.toLowerCase();a.includes("pesquis")||a.includes("busca")||a.includes("procur")?E("searching"):a.includes("abr")||a.includes("naveg")||a.includes("acess")?E("navigating"):E("thinking");try{v(s=>s.map(s=>s.id===p?{...s,messages:[...s.messages,{id:t,role:"user",content:e,createdAt:(new Date).toISOString()}]}:s));const{data:{session:a}}=await o.auth.getSession();if(!a)throw new Error("Sem sessão");const r=await fetch("https://your-project.supabase.co/functions/v1/chat-enhanced",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a.access_token}`},body:JSON.stringify({message:e,conversationId:p,extensionConnected:D.connected,systemPrompt:D.connected?"Você é o assistente de IA do SyncAds com ACESSO REAL ao navegador através da extensão conectada. Você pode REALMENTE executar comandos no navegador.":"Você é o assistente de IA do SyncAds. A extensão está OFFLINE - você NÃO tem acesso ao navegador no momento."})});if(!r.ok)throw new Error(`Erro HTTP: ${r.status}`);const n=await r.json();if(n.error)throw new Error(n.error);v(a=>a.map(a=>a.id===p?{...a,messages:[...a.messages.filter(e=>!e.id.startsWith("temp-")),{id:n.userMessageId||t,role:"user",content:e,createdAt:(new Date).toISOString()},{id:n.aiMessageId||s,role:"assistant",content:n.response||"Desculpe, não consegui gerar uma resposta.",createdAt:(new Date).toISOString()}]}:a))}catch(r){v(e=>e.map(e=>e.id===p?{...e,messages:e.messages.filter(e=>!e.id.startsWith("temp-"))}:e)),u({title:"Erro ao enviar mensagem",description:r.message||"Tente novamente",variant:"destructive"})}finally{S(!1),E(null)}},q=h.find(e=>e.id===p);return e.jsxs("div",{className:"flex h-screen bg-gray-950 text-white",children:[e.jsx("div",{className:(A?"w-80":"w-0")+" transition-all duration-300 border-r border-gray-800 flex flex-col",children:A&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"p-4 border-b border-gray-800",children:e.jsxs("button",{onClick:async()=>{if(g)try{const e={id:crypto.randomUUID(),userId:g.id,title:`Conversa ${(new Date).toLocaleDateString()}`,createdAt:(new Date).toISOString()},{data:t,error:s}=await o.from("ChatConversation").insert(e).select().single();if(s)throw s;const a={id:e.id,title:e.title,messages:[]};v([a,...h]),f(e.id),u({title:"Nova conversa criada!"})}catch(e){u({title:"Erro",description:e?.message||"Não foi possível criar nova conversa",variant:"destructive"})}else u({title:"Erro",description:"Usuário não autenticado",variant:"destructive"})},className:"w-full flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg transition-colors",children:[e.jsx(i,{className:"w-5 h-5"}),"Nova Conversa"]})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-2",children:y?e.jsx("div",{className:"text-center text-gray-500 py-4",children:"Carregando..."}):h.map(t=>e.jsxs("div",{onClick:()=>f(t.id),className:"p-3 mb-2 rounded-lg cursor-pointer transition-colors "+(p===t.id?"bg-gray-800 border border-blue-600":"bg-gray-900 hover:bg-gray-800"),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm truncate",children:t.title}),e.jsx("button",{onClick:e=>{e.stopPropagation(),(async e=>{try{const{error:t}=await o.from("ChatConversation").delete().eq("id",e);if(t)throw t;v(t=>t.filter(t=>t.id!==e)),p===e&&f(h[0]?.id||null),u({title:"Conversa deletada"})}catch(t){u({title:"Erro ao deletar",variant:"destructive"})}})(t.id)},className:"text-gray-500 hover:text-red-500",children:e.jsx(n,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[t.messages.length," mensagens"]})]},t.id))})]})}),e.jsxs("div",{className:"flex-1 flex flex-col",children:[e.jsxs("div",{className:"h-16 border-b border-gray-800 flex items-center px-4 justify-between",children:[e.jsx("button",{onClick:()=>I(!A),className:"p-2 hover:bg-gray-800 rounded-lg",children:e.jsx(c,{className:"w-6 h-6"})}),e.jsx("h1",{className:"text-lg font-semibold",children:q?.title||"Chat"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-medium "+(D.connected?"bg-green-600/20 text-green-400 border border-green-600/30":"bg-gray-800 text-gray-400 border border-gray-700"),children:[e.jsx("div",{className:"w-2 h-2 rounded-full "+(D.connected?"bg-green-400":"bg-gray-500")}),e.jsx("span",{children:D.connected?"Extensão Ativa":"Extensão Offline"})]})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:q?0===q.messages.length?e.jsx("div",{className:"flex items-center justify-center h-full text-gray-500",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xl mb-2",children:"Nova conversa"}),e.jsx("p",{className:"text-sm",children:"Envie uma mensagem para começar"}),D.connected&&e.jsxs("div",{className:"mt-8 p-4 bg-green-600/10 border border-green-600/30 rounded-lg max-w-md mx-auto",children:[e.jsx("p",{className:"text-green-400 text-sm mb-2 font-medium",children:"✨ Extensão conectada!"}),e.jsx("p",{className:"text-gray-400 text-xs",children:'Agora posso controlar seu navegador. Experimente: "Abra o Facebook Ads"'})]})]})}):e.jsxs(e.Fragment,{children:[q.messages.map(t=>e.jsx("div",{className:"flex "+("user"===t.role?"justify-end":"justify-start"),children:e.jsx("div",{className:"max-w-[70%] rounded-lg p-4 "+("user"===t.role?"bg-blue-600":"bg-gray-800"),children:e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:t.content})})},t.id)),C&&e.jsx(l,{status:C}),e.jsx("div",{ref:O})]}):e.jsx("div",{className:"flex items-center justify-center h-full text-gray-500",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xl mb-2",children:"Nenhuma conversa selecionada"}),e.jsx("p",{className:"text-sm",children:"Crie uma nova conversa para começar"}),!D.connected&&e.jsxs("div",{className:"mt-8 p-4 bg-yellow-600/10 border border-yellow-600/30 rounded-lg max-w-md mx-auto",children:[e.jsx("p",{className:"text-yellow-400 text-sm mb-2 font-medium",children:"⚠️ Extensão do navegador offline"}),e.jsx("p",{className:"text-gray-400 text-xs",children:"Para usar automação de navegador, instale e ative a extensão SyncAds AI"})]})]})})}),e.jsx("div",{className:"border-t border-gray-800 p-4",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:b,onChange:e=>j(e.target.value),onKeyPress:e=>"Enter"===e.key&&!e.shiftKey&&P(),placeholder:"Digite sua mensagem...",disabled:N||!p,className:"flex-1 bg-gray-900 border border-gray-800 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-600 disabled:opacity-50"}),e.jsx("button",{onClick:P,disabled:!b.trim()||N||!p,className:"bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-white px-6 py-3 rounded-lg transition-colors flex items-center gap-2",children:N?e.jsx("span",{children:"Enviando..."}):e.jsxs(e.Fragment,{children:[e.jsx(d,{className:"w-5 h-5"}),"Enviar"]})})]})})]})]})}export{m as default};

import{j as e}from"./vendor-ui-DkUuACDy.js";import{r as a,f as t}from"./vendor-react-X41Bjl18.js";import{c as s,I as r,a as i,b as l,d as n,e as o,i as c,f as d}from"./chatService-D5LXDeoW.js";import{f as m,i as x,g as h,s as u,j as g,h as p,k as f,l as v}from"./index-nz1ln7LP.js";import{A as b,m as y}from"./vendor-animation-DQ3cvw6m.js";import{I as w}from"./IconSparkles-BbNOolJA.js";import"./vendor-charts-DhkUgiCU.js";import"./vendor-utils-Dl0_yMKq.js";import"./vendor-supabase-BQxDPPjR.js";import"./vendor-query-Bf3pI66S.js";import"./vendor-icons-DTdRnryx.js";const j=2e3;function N(){const[N,C]=a.useState(""),[k,S]=a.useState(!0),[A,E]=a.useState(!0),[D,I]=a.useState({connected:!1,deviceId:null,lastCheck:0}),T=m(e=>e.user),H=m(e=>e.isAuthenticated),q=t(),_=x(e=>e.conversations),R=x(e=>e.activeConversationId),L=x(e=>e.setActiveConversationId),O=x(e=>e.isAssistantTyping),$=x(e=>e.setAssistantTyping),z=x(e=>e.addMessage),M=a.useRef(null),{toast:F}=h(),K=_.find(e=>e.id===R);a.useEffect(()=>{H&&T||q("/login-v2",{replace:!0})},[H,T,q]);a.useEffect(()=>{M.current?.scrollIntoView({behavior:"smooth"})},[K?.messages,O]),a.useEffect(()=>{if(!T)return;let e=0;const a=async()=>{try{const{data:a,error:t}=await u.from("extension_devices").select("id, device_id, status, last_seen").eq("user_id",T.id).eq("status","online").order("last_seen",{ascending:!1}).limit(1).maybeSingle();if(t)return e++,void(e>=3&&I({connected:!1,deviceId:null,lastCheck:Date.now()}));const s=Date.now(),r=a?new Date(a.last_seen).getTime():0;I({connected:!!a&&s-r<3e4,deviceId:a?.device_id||null,lastCheck:s}),t||(e=0)}catch(a){e++}};a();const t=setInterval(a,5e3);return()=>clearInterval(t)},[T]),a.useEffect(()=>{(async()=>{if(T)try{E(!0),await x.getState().loadConversations(T.id);const{data:e,error:a}=await u.from("ChatConversation").select("id").eq("userId",T.id).limit(1);if(a)throw a;e&&0!==e.length||await x.getState().createNewConversation(T.id,`Conversa ${(new Date).toLocaleDateString()}`)}catch(e){F({title:"Erro ao carregar chat",description:"Tente recarregar a p√°gina.",variant:"destructive"})}finally{E(!1)}})()},[T,F]);const B=a.useCallback(async()=>{if(""===N.trim()||!R||N.length>j)return;const e=N.trim();C(""),$(!0);const a={id:`temp-user-${Date.now()}`,role:"user",content:e,timestamp:(new Date).toISOString()};z(R,a);try{const a=await s.sendMessage(R,e);if(a.reply){const e={id:`msg-${Date.now()}`,role:"assistant",content:a.reply,timestamp:(new Date).toISOString()};z(R,e)}}catch(t){F({title:"Erro ao enviar mensagem",description:t.message||"Tente novamente",variant:"destructive"})}finally{$(!1)}},[N,R,z,$,F]),P=a.useCallback(async()=>{if(T)try{await x.getState().createNewConversation(T.id,`Conversa ${(new Date).toLocaleDateString()}`),F({title:"‚ú® Nova conversa criada"})}catch(e){F({title:"Erro ao criar conversa",variant:"destructive"})}},[T,F]),V=a.useCallback(async e=>{if(confirm("Tem certeza que deseja deletar esta conversa?"))try{const{error:a}=await u.from("ChatConversation").delete().eq("id",e);if(a)throw a;await x.getState().loadConversations(T.id),F({title:"üóëÔ∏è Conversa deletada"})}catch(a){F({title:"Erro ao deletar",variant:"destructive"})}},[T,F]);return e.jsxs("div",{className:"flex h-full w-full overflow-hidden bg-gradient-to-br from-gray-900 via-gray-850 to-gray-900",children:[e.jsx(b,{children:k&&e.jsxs(y.div,{initial:{x:-320,opacity:0},animate:{x:0,opacity:1},exit:{x:-320,opacity:0},transition:{type:"spring",damping:25,stiffness:200},className:"w-80 bg-gradient-to-b from-[#12121A] to-[#1A1A2E] border-r border-gray-700/50 flex flex-col shadow-2xl",children:[e.jsxs("div",{className:"p-4 border-b border-gray-700/50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h2",{className:"text-lg font-bold text-white flex items-center gap-2",children:[e.jsx(w,{className:"w-5 h-5 text-blue-400"}),"Conversas"]}),e.jsx(y.button,{whileHover:{scale:1.1,rotate:90},whileTap:{scale:.9},onClick:()=>S(!1),className:"p-2 rounded-lg hover:bg-gray-800/50 text-gray-400 hover:text-white transition-all",children:e.jsx(g,{className:"w-5 h-5"})})]}),e.jsxs(y.button,{whileHover:{scale:1.02,boxShadow:"0 0 25px rgba(59, 130, 246, 0.5)"},whileTap:{scale:.98},onClick:P,className:"w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white rounded-xl px-4 py-3 flex items-center justify-center gap-2 font-medium transition-all shadow-lg shadow-blue-500/30",children:[e.jsx(r,{className:"w-5 h-5"}),"Nova Conversa"]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-2 space-y-2",children:_.map(a=>e.jsx(y.div,{whileHover:{scale:1.02,x:4},onClick:()=>L(a.id),className:p("p-3 rounded-xl cursor-pointer transition-all group relative",R===a.id?"bg-gradient-to-r from-blue-600/20 to-purple-600/20 border border-blue-500/50 shadow-lg shadow-blue-500/20":"bg-gray-800/30 hover:bg-gray-800/50 border border-transparent"),children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-white font-medium text-sm truncate",children:a.title}),e.jsx("p",{className:"text-xs text-gray-500 truncate",children:a.messages&&a.messages.length>0?a.messages[a.messages.length-1].content.substring(0,35)+"...":"Nova conversa"})]}),e.jsx(y.button,{whileHover:{scale:1.1},whileTap:{scale:.9},onClick:e=>{e.stopPropagation(),V(a.id)},className:"opacity-0 group-hover:opacity-100 p-2 rounded-lg hover:bg-red-500/20 text-red-400 transition-all",children:e.jsx(i,{className:"w-4 h-4"})})]})},a.id))})]})}),e.jsxs("div",{className:"flex-1 flex flex-col min-w-0",children:[e.jsxs("div",{className:"bg-gradient-to-r from-[#12121A] to-[#1A1A2E] border-b border-gray-700/50 px-6 py-4 flex items-center justify-between flex-shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[!k&&e.jsx(y.button,{whileHover:{scale:1.1},whileTap:{scale:.9},onClick:()=>S(!0),className:"p-2 rounded-lg hover:bg-gray-800/50 text-gray-400 hover:text-white transition-all",children:e.jsx(l,{className:"w-6 h-6"})}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-xl font-bold text-white flex items-center gap-2",children:[e.jsx(w,{className:"w-6 h-6 text-blue-400"}),"Chat IA - Marketing"]}),e.jsx("p",{className:"text-sm text-gray-400",children:"Assistente especializado em marketing digital"})]})]}),e.jsxs("div",{className:p("flex items-center gap-2 px-3 py-2 rounded-full text-xs font-medium transition-all",D.connected?"bg-green-600/20 text-green-400 border border-green-600/30":"bg-gray-800/50 text-gray-400 border border-gray-700/30"),children:[D.connected?e.jsx(f,{className:"w-4 h-4"}):e.jsx(v,{className:"w-4 h-4"}),e.jsx("span",{children:D.connected?"Extens√£o Ativa":"Extens√£o Offline"})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto px-6 py-4 space-y-4 bg-[#0A0A0F]",children:A?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx(y.div,{animate:{rotate:360},transition:{duration:1,repeat:1/0,ease:"linear"},className:"w-16 h-16 border-4 border-blue-500/30 border-t-blue-500 rounded-full mx-auto mb-4"}),e.jsx("p",{className:"text-gray-400 text-lg font-medium",children:"Carregando conversas..."})]})}):K&&K.messages?e.jsxs(e.Fragment,{children:[K.messages.map(a=>e.jsx(y.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:p("flex","user"===a.role?"justify-end":"justify-start"),children:e.jsxs("div",{className:p("max-w-[80%] rounded-2xl p-4 backdrop-blur-sm","user"===a.role?"bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg shadow-blue-500/20 border border-blue-400/30":"bg-gray-800/50 text-gray-200 border border-gray-700/30"),children:[e.jsxs("div",{className:"flex items-start gap-3",children:["assistant"===a.role&&e.jsx(y.div,{initial:{scale:0,rotate:-180},animate:{scale:1,rotate:0},transition:{type:"spring",stiffness:200},whileHover:{rotate:10,scale:1.1},className:"flex-shrink-0",children:e.jsx(n,{className:"w-6 h-6 text-blue-400"})}),"user"===a.role&&e.jsx(y.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:200},whileHover:{scale:1.1},className:"flex-shrink-0",children:e.jsx(o,{className:"w-6 h-6 text-white"})}),e.jsx("div",{className:"flex-1 whitespace-pre-wrap break-words",children:a.content})]}),e.jsx("div",{className:p("text-xs mt-2 ml-9","user"===a.role?"text-white/60":"text-gray-500"),children:a.timestamp?new Date(a.timestamp).toLocaleTimeString("pt-BR"):""})]})},a.id)),O&&e.jsx(y.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"flex justify-start",children:e.jsx("div",{className:"max-w-[80%] bg-gray-800/50 rounded-2xl p-4 border border-gray-700/30",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(n,{className:"w-6 h-6 text-blue-400 animate-pulse"}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(y.div,{animate:{y:[0,-8,0]},transition:{duration:.6,repeat:1/0,delay:0},className:"w-2 h-2 bg-blue-400 rounded-full"}),e.jsx(y.div,{animate:{y:[0,-8,0]},transition:{duration:.6,repeat:1/0,delay:.2},className:"w-2 h-2 bg-blue-400 rounded-full"}),e.jsx(y.div,{animate:{y:[0,-8,0]},transition:{duration:.6,repeat:1/0,delay:.4},className:"w-2 h-2 bg-blue-400 rounded-full"})]})]})})}),e.jsx("div",{ref:M})]}):e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx(w,{className:"w-16 h-16 text-blue-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-400 text-xl mb-2",children:"Ol√°! üëã Como posso ajudar?"}),e.jsx("p",{className:"text-gray-600 text-sm",children:"Estou aqui para ajudar com marketing digital e estrat√©gias"})]})})}),e.jsx("div",{className:"border-t border-gray-700/50 p-4 bg-gradient-to-r from-[#12121A] to-[#1A1A2E] flex-shrink-0",children:e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsxs("div",{className:"relative",children:[e.jsx(c,{value:N,onChange:e=>C(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),B())},placeholder:"Digite sua mensagem... (Shift+Enter para nova linha)",maxLength:j,disabled:O,className:"w-full bg-gray-800/50 border border-gray-700/50 rounded-2xl px-6 py-4 pr-24 text-white placeholder-gray-500 resize-none focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 transition-all disabled:opacity-50 disabled:cursor-not-allowed",minRows:1,maxRows:6}),e.jsxs("div",{className:"absolute right-2 bottom-2 flex items-center gap-2",children:[e.jsxs("span",{className:p("text-xs font-medium px-2 py-1 rounded",N.length>1800?"text-red-400 bg-red-500/20":"text-gray-500 bg-gray-800/50"),children:[N.length,"/",j]}),e.jsx(y.button,{whileHover:{scale:1.05},whileTap:{scale:.95},onClick:B,disabled:""===N.trim()||N.length>j||O,className:"bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white rounded-xl p-3 transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-blue-500/30",children:e.jsx(d,{className:"w-5 h-5"})})]})]}),!D.connected&&e.jsxs(y.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"mt-3 text-xs text-yellow-400/80 flex items-center gap-2 bg-yellow-500/10 px-3 py-2 rounded-lg border border-yellow-500/20",children:[e.jsx(v,{className:"w-4 h-4"}),e.jsx("span",{children:"Extens√£o offline - Recursos de automa√ß√£o indispon√≠veis"})]})]})})]})]})}export{N as default};

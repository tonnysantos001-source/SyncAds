import{s as l,r as b,b as W,u as z,j as e,M as m,d as N,e as E,f as I,h as A,S as U,I as Q,B as M,a6 as _,g as J,o as K,a5 as Y}from"./index-Dl-TXdSt.js";import{T as Z,a as $,b as ee,c as y,d as re,e as p}from"./table-6JrUrzVD.js";import{S as te,a as ae,b as oe,c as se,d as S}from"./select-WWepSia_.js";import{A as de,a as le}from"./alert-DGkmaTAW.js";import{S as q}from"./skeleton-DQACbCSe.js";import{C as V}from"./clock-C46-NJ3T.js";import{T as ie}from"./trending-up-Hj0M6Eka.js";import{T as ne}from"./trending-down-DRwE0iV6.js";import{D as H}from"./dollar-sign-BbDR5lTb.js";import{C as X}from"./circle-alert-gopj48Nm.js";import{f as C,p as P}from"./pt-BR-BQ5kKd2v.js";import"./index-DARO_Czt.js";import"./constructFrom-rJN6zrQ_.js";const ce={async list(o,a){try{let t=l.from("RecoveredCart").select("*").eq("userId",o).order("createdAt",{ascending:!1});(a==null?void 0:a.recovered)!==void 0&&(t=t.eq("recovered",a.recovered)),a!=null&&a.method&&(t=t.eq("recoveryMethod",a.method)),a!=null&&a.dateFrom&&(t=t.gte("createdAt",a.dateFrom)),a!=null&&a.dateTo&&(t=t.lte("createdAt",a.dateTo));const{data:s,error:v}=await t;if(v)throw v;return s}catch(t){throw console.error("Error listing recovered carts:",t),t}},async getById(o){try{const{data:a,error:t}=await l.from("RecoveredCart").select("*").eq("id",o).single();if(t)throw t;return a}catch(a){throw console.error("Error getting recovered cart:",a),a}},async create(o){try{const a={userId:o.userId,cartId:o.cartId,customerId:o.customerId,customerEmail:o.customerEmail,customerPhone:o.customerPhone,cartValue:o.cartValue,recoveryMethod:o.recoveryMethod||"EMAIL",discountOffered:o.discountValue||0,discountType:o.discountType,discountValue:o.discountValue,recoveryAttempts:0,recovered:!1},{data:t,error:s}=await l.from("RecoveredCart").insert(a).select().single();if(s)throw s;return t}catch(a){throw console.error("Error creating recovery:",a),a}},async sendPixRecovery(o,a){try{const{data:t,error:s}=await l.from("RecoveredCart").update({pixQrCode:a.qrCode,pixCopyPaste:a.copyPaste,pixExpiresAt:a.expiresAt,pixPaymentId:a.paymentId,recoveryMethod:"PIX",recoveryAttempts:l.sql`"recoveryAttempts" + 1`,lastRecoveryAt:new Date().toISOString(),updatedAt:new Date().toISOString()}).eq("id",o).select().single();if(s)throw s;return t}catch(t){throw console.error("Error sending PIX recovery:",t),t}},async sendEmailRecovery(o,a){try{const{data:t,error:s}=await l.from("RecoveredCart").update({recoveryEmailSent:!0,recoveryMethod:"EMAIL",recoveryAttempts:l.sql`"recoveryAttempts" + 1`,lastRecoveryAt:new Date().toISOString(),metadata:a,updatedAt:new Date().toISOString()}).eq("id",o).select().single();if(s)throw s;return t}catch(t){throw console.error("Error sending email recovery:",t),t}},async sendSmsRecovery(o,a){try{const{data:t,error:s}=await l.from("RecoveredCart").update({recoverySmsSent:!0,recoveryMethod:"SMS",recoveryAttempts:l.sql`"recoveryAttempts" + 1`,lastRecoveryAt:new Date().toISOString(),metadata:{message:a},updatedAt:new Date().toISOString()}).eq("id",o).select().single();if(s)throw s;return t}catch(t){throw console.error("Error sending SMS recovery:",t),t}},async sendWhatsAppRecovery(o,a){try{const{data:t,error:s}=await l.from("RecoveredCart").update({recoveryWhatsappSent:!0,recoveryMethod:"WHATSAPP",recoveryAttempts:l.sql`"recoveryAttempts" + 1`,lastRecoveryAt:new Date().toISOString(),metadata:{message:a},updatedAt:new Date().toISOString()}).eq("id",o).select().single();if(s)throw s;return t}catch(t){throw console.error("Error sending WhatsApp recovery:",t),t}},async markAsRecovered(o,a){try{const{data:t,error:s}=await l.from("RecoveredCart").update({recovered:!0,recoveredAt:new Date().toISOString(),orderId:a,updatedAt:new Date().toISOString()}).eq("id",o).select().single();if(s)throw s;return t}catch(t){throw console.error("Error marking as recovered:",t),t}},async getStats(o,a){try{let t=l.from("RecoveredCart").select("*").eq("userId",o);a&&(t=t.gte("createdAt",a.from).lte("createdAt",a.to));const{data:s,error:v}=await t;if(v)throw v;const u=s,c=u.length,k=u.filter(n=>n.recovered).length,h=u.reduce((n,i)=>n+i.cartValue,0),D=u.filter(n=>n.recovered).reduce((n,i)=>n+i.cartValue,0),R=c>0?k/c*100:0,g=["PIX","EMAIL","SMS","WHATSAPP","PUSH_NOTIFICATION"],w={};return g.forEach(n=>{const i=u.filter(x=>x.recoveryMethod===n);if(i.length>0){const x=i.filter(f=>f.recovered).length;w[n]={attempts:i.length,successes:x,rate:x/i.length*100,value:i.filter(f=>f.recovered).reduce((f,j)=>f+j.cartValue,0)}}}),{totalAttempts:c,successfulRecoveries:k,totalCartValue:h,recoveredValue:D,recoveryRate:R,byMethod:w}}catch(t){throw console.error("Error getting recovery stats:",t),t}},async getPending(o,a=50){try{const{data:t,error:s}=await l.from("RecoveredCart").select("*").eq("userId",o).eq("recovered",!1).order("createdAt",{ascending:!1}).limit(a);if(s)throw s;return t}catch(t){throw console.error("Error getting pending recoveries:",t),t}},async getPixRecovered(o){try{const{data:a,error:t}=await l.from("RecoveredCart").select("*").eq("userId",o).eq("recoveryMethod","PIX").eq("recovered",!0).order("recoveredAt",{ascending:!1});if(t)throw t;return a}catch(a){throw console.error("Error getting PIX recovered carts:",a),a}},async delete(o){try{const{error:a}=await l.from("RecoveredCart").delete().eq("id",o);if(a)throw a;return!0}catch(a){throw console.error("Error deleting recovery:",a),a}},async update(o,a){try{const{data:t,error:s}=await l.from("RecoveredCart").update({...a,updatedAt:new Date().toISOString()}).eq("id",o).select().single();if(s)throw s;return t}catch(t){throw console.error("Error updating recovery:",t),t}}},Ee=()=>{const[o,a]=b.useState([]),[t,s]=b.useState([]),[v,u]=b.useState(!0),[c,k]=b.useState(""),[h,D]=b.useState("all"),{toast:R}=W(),g=z(r=>r.user);b.useEffect(()=>{w()},[g==null?void 0:g.id]),b.useEffect(()=>{n()},[c,h,o]);const w=async()=>{try{if(!(g!=null&&g.id))return;u(!0);const r=await ce.getPixRecovered(g.id);a(r)}catch(r){console.error("Erro ao carregar PIX recuperados:",r),R({title:"Erro ao carregar dados",description:r.message,variant:"destructive"})}finally{u(!1)}},n=()=>{let r=o;c&&(r=r.filter(d=>d.customerEmail.toLowerCase().includes(c.toLowerCase())||d.orderId&&d.orderId.toLowerCase().includes(c.toLowerCase()))),h!=="all"&&(h==="RECOVERED"?r=r.filter(d=>d.recovered):h==="PENDING"?r=r.filter(d=>!d.recovered&&(!d.pixExpiresAt||new Date(d.pixExpiresAt)>new Date)):h==="EXPIRED"&&(r=r.filter(d=>!d.recovered&&d.pixExpiresAt&&new Date(d.pixExpiresAt)<new Date))),s(r)},i=r=>new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(r),x=r=>r.recovered?"RECOVERED":r.pixExpiresAt&&new Date(r.pixExpiresAt)<new Date?"EXPIRED":"PENDING",f=r=>({PENDING:{label:"Aguardando Pagamento",variant:"secondary",icon:V},RECOVERED:{label:"Recuperado",variant:"default",icon:Y},EXPIRED:{label:"Expirado",variant:"destructive",icon:X},FAILED:{label:"Falhou",variant:"destructive",icon:X}})[r]||{label:"Aguardando Pagamento",variant:"secondary",icon:V},j=o.filter(r=>x(r)==="PENDING").reduce((r,d)=>r+d.cartValue,0),B=o.filter(r=>r.recovered).reduce((r,d)=>r+d.cartValue,0),F=o.filter(r=>x(r)==="EXPIRED").reduce((r,d)=>r+d.cartValue,0),L=o.length>0?(o.filter(r=>r.recovered).length/o.length*100).toFixed(1):"0";return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(m.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},children:[e.jsx("h1",{className:"text-4xl font-black bg-gradient-to-r from-green-600 via-teal-600 to-blue-600 bg-clip-text text-transparent",children:"PIX Recuperados"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 font-medium",children:"Gerencie transações PIX e recupere vendas perdidas"})]}),e.jsxs("div",{className:"grid gap-6 md:grid-cols-4",children:[e.jsx(m.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.1},children:e.jsxs(N,{className:"relative overflow-hidden border-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl shadow-lg hover:shadow-xl transition-all duration-300",children:[e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 bg-yellow-500 opacity-10 rounded-full blur-3xl"}),e.jsxs(E,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Aguardando Pagamento"}),e.jsx("div",{className:"p-2 rounded-lg bg-yellow-500 bg-opacity-10",children:e.jsx(V,{className:"h-4 w-4 text-yellow-500"})})]}),e.jsxs(A,{children:[e.jsx("div",{className:"text-3xl font-bold bg-gradient-to-br from-yellow-600 to-orange-500 bg-clip-text text-transparent",children:i(j)}),e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:[o.filter(r=>x(r)==="PENDING").length," ","aguardando"]})]})]})}),e.jsx(m.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.2},children:e.jsxs(N,{className:"relative overflow-hidden border-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl shadow-lg hover:shadow-xl transition-all duration-300",children:[e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 bg-green-500 opacity-10 rounded-full blur-3xl"}),e.jsxs(E,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"PIX Recuperados"}),e.jsx("div",{className:"p-2 rounded-lg bg-green-500 bg-opacity-10",children:e.jsx(ie,{className:"h-4 w-4 text-green-500"})})]}),e.jsxs(A,{children:[e.jsx("div",{className:"text-3xl font-bold bg-gradient-to-br from-green-600 to-teal-500 bg-clip-text text-transparent",children:i(B)}),e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:[o.filter(r=>r.recovered).length," recuperados"]})]})]})}),e.jsx(m.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.3},children:e.jsxs(N,{className:"relative overflow-hidden border-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl shadow-lg hover:shadow-xl transition-all duration-300",children:[e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 bg-red-500 opacity-10 rounded-full blur-3xl"}),e.jsxs(E,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Expirados"}),e.jsx("div",{className:"p-2 rounded-lg bg-red-500 bg-opacity-10",children:e.jsx(ne,{className:"h-4 w-4 text-red-500"})})]}),e.jsxs(A,{children:[e.jsx("div",{className:"text-3xl font-bold bg-gradient-to-br from-red-600 to-pink-500 bg-clip-text text-transparent",children:i(F)}),e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:[o.filter(r=>x(r)==="EXPIRED").length," ","expirados"]})]})]})}),e.jsx(m.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.4},children:e.jsxs(N,{className:"relative overflow-hidden border-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl shadow-lg hover:shadow-xl transition-all duration-300",children:[e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 bg-blue-500 opacity-10 rounded-full blur-3xl"}),e.jsxs(E,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Taxa de Recuperação"}),e.jsx("div",{className:"p-2 rounded-lg bg-blue-500 bg-opacity-10",children:e.jsx(H,{className:"h-4 w-4 text-blue-500"})})]}),e.jsxs(A,{children:[e.jsxs("div",{className:"text-3xl font-bold bg-gradient-to-br from-blue-600 to-cyan-500 bg-clip-text text-transparent",children:[L,"%"]}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:"Taxa de conversão de PIX"})]})]})})]}),j>0&&e.jsx(m.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{duration:.5,delay:.5},children:e.jsxs(de,{className:"border-0 bg-gradient-to-r from-yellow-50 to-orange-50 dark:from-yellow-900/20 dark:to-orange-900/20 backdrop-blur-sm",children:[e.jsx(X,{className:"h-4 w-4 text-yellow-600 dark:text-yellow-400"}),e.jsxs(le,{className:"dark:text-gray-300",children:["Você tem"," ",e.jsx("strong",{className:"text-yellow-700 dark:text-yellow-300",children:i(j)})," ","em PIX aguardando pagamento. Considere enviar lembretes para os clientes."]})]})}),e.jsxs(m.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.6},className:"flex flex-col sm:flex-row items-center gap-4",children:[e.jsxs("div",{className:"relative flex-1 w-full",children:[e.jsx(U,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(Q,{placeholder:"Buscar por pedido, cliente ou email...",value:c,onChange:r=>k(r.target.value),className:"pl-9 border-gray-200 dark:border-gray-700 bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm dark:text-white dark:placeholder:text-gray-500"})]}),e.jsxs(te,{value:h,onValueChange:D,children:[e.jsx(ae,{className:"w-full sm:w-[200px] border-gray-200 dark:border-gray-700 bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm dark:text-white",children:e.jsx(oe,{placeholder:"Status"})}),e.jsxs(se,{children:[e.jsx(S,{value:"all",children:"Todos"}),e.jsx(S,{value:"PENDING",children:"Aguardando"}),e.jsx(S,{value:"RECOVERED",children:"Recuperado"}),e.jsx(S,{value:"EXPIRED",children:"Expirado"})]})]}),e.jsxs(M,{onClick:w,className:"w-full sm:w-auto bg-gradient-to-r from-green-500 to-teal-500 text-white border-0 hover:from-green-600 hover:to-teal-600 transition-all duration-300 shadow-lg hover:shadow-xl",children:[e.jsx(_,{className:"h-4 w-4 mr-2"}),"Atualizar"]})]}),e.jsx(m.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.7},children:e.jsxs(N,{className:"border-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl shadow-lg",children:[e.jsxs(E,{children:[e.jsx(I,{className:"text-xl font-bold bg-gradient-to-r from-green-600 to-teal-600 bg-clip-text text-transparent",children:"Recuperação de Carrinhos via PIX"}),e.jsxs(J,{className:"dark:text-gray-400",children:[t.length," carrinho(s) encontrado(s)"]})]}),e.jsx(A,{children:v?e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{className:"h-12 w-full"}),e.jsx(q,{className:"h-12 w-full"}),e.jsx(q,{className:"h-12 w-full"})]}):t.length===0?e.jsxs(m.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{duration:.5},className:"flex flex-col items-center justify-center py-12 text-center",children:[e.jsx(H,{className:"h-16 w-16 text-muted-foreground mb-4 opacity-50"}),e.jsx("h3",{className:"text-lg font-semibold mb-2 dark:text-white",children:"Nenhum PIX encontrado"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:c||h!=="all"?"Tente ajustar os filtros":"Aguardando primeira transação PIX"})]}):e.jsx("div",{className:"rounded-lg overflow-hidden border border-gray-200 dark:border-gray-700",children:e.jsxs(Z,{children:[e.jsx($,{children:e.jsxs(ee,{className:"bg-gradient-to-r from-green-50 to-teal-50 dark:from-gray-800 dark:to-gray-800 hover:from-green-100 hover:to-teal-100 dark:hover:from-gray-700 dark:hover:to-gray-700",children:[e.jsx(y,{className:"font-semibold dark:text-gray-300",children:"Carrinho"}),e.jsx(y,{className:"font-semibold dark:text-gray-300",children:"Cliente"}),e.jsx(y,{className:"font-semibold dark:text-gray-300",children:"Valor"}),e.jsx(y,{className:"font-semibold dark:text-gray-300",children:"Tentativas"}),e.jsx(y,{className:"font-semibold dark:text-gray-300",children:"Status"}),e.jsx(y,{className:"font-semibold dark:text-gray-300",children:"Expira em"}),e.jsx(y,{className:"font-semibold dark:text-gray-300",children:"Data"}),e.jsx(y,{className:"text-right font-semibold dark:text-gray-300",children:"Ações"})]})}),e.jsx(re,{children:t.map((r,d)=>{const O=x(r),T=f(O),G=T.icon;return e.jsxs(m.tr,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{duration:.3,delay:d*.05},className:"border-b border-gray-100 dark:border-gray-800 hover:bg-gradient-to-r hover:from-green-50/50 hover:to-teal-50/50 dark:hover:from-gray-800/50 dark:hover:to-gray-800/50 transition-all duration-200",children:[e.jsx(p,{children:e.jsxs("div",{className:"font-mono text-sm font-semibold bg-gradient-to-r from-green-600 to-teal-600 bg-clip-text text-transparent",children:["#",r.cartId.substring(0,8)]})}),e.jsx(p,{children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium dark:text-white",children:r.customerEmail}),r.customerPhone&&e.jsx("div",{className:"text-sm text-muted-foreground",children:r.customerPhone})]})}),e.jsxs(p,{children:[e.jsx("div",{className:"font-bold bg-gradient-to-r from-green-600 to-teal-600 bg-clip-text text-transparent",children:i(r.cartValue)}),r.discountOffered>0&&e.jsxs("div",{className:"text-sm text-green-600 dark:text-green-400",children:["Desconto:"," ",i(r.discountOffered)]}),r.recoveredAt&&e.jsxs("div",{className:"text-sm text-green-600 dark:text-green-400",children:["Recuperado em"," ",C(new Date(r.recoveredAt),"dd/MM/yyyy HH:mm",{locale:P})]})]}),e.jsxs(p,{children:[e.jsxs("div",{className:"text-sm dark:text-gray-300",children:[r.recoveryAttempts," tentativa(s)"]}),r.lastRecoveryAt&&e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Última:"," ",C(new Date(r.lastRecoveryAt),"dd/MM HH:mm",{locale:P})]})]}),e.jsx(p,{children:e.jsxs(K,{variant:T.variant,className:"gap-1",children:[e.jsx(G,{className:"h-3 w-3"}),T.label]})}),e.jsx(p,{children:r.pixExpiresAt?e.jsx("div",{className:"text-sm",children:C(new Date(r.pixExpiresAt),"dd/MM/yyyy HH:mm",{locale:P})}):e.jsx("span",{className:"text-sm text-muted-foreground",children:"-"})}),e.jsx(p,{children:C(new Date(r.createdAt),"dd/MM/yyyy",{locale:P})}),e.jsx(p,{className:"text-right",children:e.jsxs("div",{className:"flex justify-end gap-2",children:[O==="PENDING"&&r.pixCopyPaste&&e.jsx(M,{variant:"outline",size:"sm",className:"bg-gradient-to-r from-green-500 to-teal-500 text-white border-0 hover:from-green-600 hover:to-teal-600 transition-all duration-300 shadow-md hover:shadow-lg",onClick:()=>{navigator.clipboard.writeText(r.pixCopyPaste),R({title:"Chave PIX copiada!"})},children:"Copiar PIX"}),r.orderId&&e.jsx(M,{variant:"ghost",size:"sm",className:"hover:bg-gradient-to-r hover:from-green-50 hover:to-teal-50 dark:hover:from-gray-800 dark:hover:to-gray-800",children:"Ver pedido"})]})})]},r.id)})})]})})})]})})]})};export{Ee as default};

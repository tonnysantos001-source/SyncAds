import{s as n,r as j,b as G,u as W,j as e,d as E,e as N,f as I,h as A,S as z,I as U,B as M,a6 as Q,g as _,o as J,a5 as K}from"./index-BSEhnWC3.js";import{T as Y,a as Z,b as O,c as p,d as $,e as v}from"./table-BiBP2ckd.js";import{S as ee,a as re,b as te,c as se,d as C}from"./select-D7iY7GiD.js";import{A as ae,a as oe}from"./alert-C3w83a_M.js";import{S as q}from"./skeleton-Bt1TjtPE.js";import{C as V}from"./clock-CZXdSN-6.js";import{T as ce}from"./trending-up-u0ktDIMD.js";import{T as ne}from"./trending-down-SSwD28OX.js";import{D as H}from"./dollar-sign-DjyNRZ3q.js";import{C as X}from"./circle-alert-B8fUlpeM.js";import{f as P,p as D}from"./pt-BR-BQ5kKd2v.js";import"./index-BrVKaw35.js";import"./constructFrom-rJN6zrQ_.js";const de={async list(a,s){try{let t=n.from("RecoveredCart").select("*").eq("userId",a).order("createdAt",{ascending:!1});(s==null?void 0:s.recovered)!==void 0&&(t=t.eq("recovered",s.recovered)),s!=null&&s.method&&(t=t.eq("recoveryMethod",s.method)),s!=null&&s.dateFrom&&(t=t.gte("createdAt",s.dateFrom)),s!=null&&s.dateTo&&(t=t.lte("createdAt",s.dateTo));const{data:o,error:f}=await t;if(f)throw f;return o}catch(t){throw console.error("Error listing recovered carts:",t),t}},async getById(a){try{const{data:s,error:t}=await n.from("RecoveredCart").select("*").eq("id",a).single();if(t)throw t;return s}catch(s){throw console.error("Error getting recovered cart:",s),s}},async create(a){try{const s={userId:a.userId,cartId:a.cartId,customerId:a.customerId,customerEmail:a.customerEmail,customerPhone:a.customerPhone,cartValue:a.cartValue,recoveryMethod:a.recoveryMethod||"EMAIL",discountOffered:a.discountValue||0,discountType:a.discountType,discountValue:a.discountValue,recoveryAttempts:0,recovered:!1},{data:t,error:o}=await n.from("RecoveredCart").insert(s).select().single();if(o)throw o;return t}catch(s){throw console.error("Error creating recovery:",s),s}},async sendPixRecovery(a,s){try{const{data:t,error:o}=await n.from("RecoveredCart").update({pixQrCode:s.qrCode,pixCopyPaste:s.copyPaste,pixExpiresAt:s.expiresAt,pixPaymentId:s.paymentId,recoveryMethod:"PIX",recoveryAttempts:n.sql`"recoveryAttempts" + 1`,lastRecoveryAt:new Date().toISOString(),updatedAt:new Date().toISOString()}).eq("id",a).select().single();if(o)throw o;return t}catch(t){throw console.error("Error sending PIX recovery:",t),t}},async sendEmailRecovery(a,s){try{const{data:t,error:o}=await n.from("RecoveredCart").update({recoveryEmailSent:!0,recoveryMethod:"EMAIL",recoveryAttempts:n.sql`"recoveryAttempts" + 1`,lastRecoveryAt:new Date().toISOString(),metadata:s,updatedAt:new Date().toISOString()}).eq("id",a).select().single();if(o)throw o;return t}catch(t){throw console.error("Error sending email recovery:",t),t}},async sendSmsRecovery(a,s){try{const{data:t,error:o}=await n.from("RecoveredCart").update({recoverySmsSent:!0,recoveryMethod:"SMS",recoveryAttempts:n.sql`"recoveryAttempts" + 1`,lastRecoveryAt:new Date().toISOString(),metadata:{message:s},updatedAt:new Date().toISOString()}).eq("id",a).select().single();if(o)throw o;return t}catch(t){throw console.error("Error sending SMS recovery:",t),t}},async sendWhatsAppRecovery(a,s){try{const{data:t,error:o}=await n.from("RecoveredCart").update({recoveryWhatsappSent:!0,recoveryMethod:"WHATSAPP",recoveryAttempts:n.sql`"recoveryAttempts" + 1`,lastRecoveryAt:new Date().toISOString(),metadata:{message:s},updatedAt:new Date().toISOString()}).eq("id",a).select().single();if(o)throw o;return t}catch(t){throw console.error("Error sending WhatsApp recovery:",t),t}},async markAsRecovered(a,s){try{const{data:t,error:o}=await n.from("RecoveredCart").update({recovered:!0,recoveredAt:new Date().toISOString(),orderId:s,updatedAt:new Date().toISOString()}).eq("id",a).select().single();if(o)throw o;return t}catch(t){throw console.error("Error marking as recovered:",t),t}},async getStats(a,s){try{let t=n.from("RecoveredCart").select("*").eq("userId",a);s&&(t=t.gte("createdAt",s.from).lte("createdAt",s.to));const{data:o,error:f}=await t;if(f)throw f;const h=o,l=h.length,R=h.filter(i=>i.recovered).length,m=h.reduce((i,d)=>i+d.cartValue,0),b=h.filter(i=>i.recovered).reduce((i,d)=>i+d.cartValue,0),S=l>0?R/l*100:0,u=["PIX","EMAIL","SMS","WHATSAPP","PUSH_NOTIFICATION"],y={};return u.forEach(i=>{const d=h.filter(x=>x.recoveryMethod===i);if(d.length>0){const x=d.filter(g=>g.recovered).length;y[i]={attempts:d.length,successes:x,rate:x/d.length*100,value:d.filter(g=>g.recovered).reduce((g,w)=>g+w.cartValue,0)}}}),{totalAttempts:l,successfulRecoveries:R,totalCartValue:m,recoveredValue:b,recoveryRate:S,byMethod:y}}catch(t){throw console.error("Error getting recovery stats:",t),t}},async getPending(a,s=50){try{const{data:t,error:o}=await n.from("RecoveredCart").select("*").eq("userId",a).eq("recovered",!1).order("createdAt",{ascending:!1}).limit(s);if(o)throw o;return t}catch(t){throw console.error("Error getting pending recoveries:",t),t}},async getPixRecovered(a){try{const{data:s,error:t}=await n.from("RecoveredCart").select("*").eq("userId",a).eq("recoveryMethod","PIX").eq("recovered",!0).order("recoveredAt",{ascending:!1});if(t)throw t;return s}catch(s){throw console.error("Error getting PIX recovered carts:",s),s}},async delete(a){try{const{error:s}=await n.from("RecoveredCart").delete().eq("id",a);if(s)throw s;return!0}catch(s){throw console.error("Error deleting recovery:",s),s}},async update(a,s){try{const{data:t,error:o}=await n.from("RecoveredCart").update({...s,updatedAt:new Date().toISOString()}).eq("id",a).select().single();if(o)throw o;return t}catch(t){throw console.error("Error updating recovery:",t),t}}},Ee=()=>{const[a,s]=j.useState([]),[t,o]=j.useState([]),[f,h]=j.useState(!0),[l,R]=j.useState(""),[m,b]=j.useState("all"),{toast:S}=G(),u=W(r=>r.user);j.useEffect(()=>{y()},[u==null?void 0:u.id]),j.useEffect(()=>{i()},[l,m,a]);const y=async()=>{try{if(!(u!=null&&u.id))return;h(!0);const r=await de.getPixRecovered(u.id);s(r)}catch(r){console.error("Erro ao carregar PIX recuperados:",r),S({title:"Erro ao carregar dados",description:r.message,variant:"destructive"})}finally{h(!1)}},i=()=>{let r=a;l&&(r=r.filter(c=>c.customerEmail.toLowerCase().includes(l.toLowerCase())||c.orderId&&c.orderId.toLowerCase().includes(l.toLowerCase()))),m!=="all"&&(m==="RECOVERED"?r=r.filter(c=>c.recovered):m==="PENDING"?r=r.filter(c=>!c.recovered&&(!c.pixExpiresAt||new Date(c.pixExpiresAt)>new Date)):m==="EXPIRED"&&(r=r.filter(c=>!c.recovered&&c.pixExpiresAt&&new Date(c.pixExpiresAt)<new Date))),o(r)},d=r=>new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(r),x=r=>r.recovered?"RECOVERED":r.pixExpiresAt&&new Date(r.pixExpiresAt)<new Date?"EXPIRED":"PENDING",g=r=>({PENDING:{label:"Aguardando Pagamento",variant:"secondary",icon:V},RECOVERED:{label:"Recuperado",variant:"default",icon:K},EXPIRED:{label:"Expirado",variant:"destructive",icon:X},FAILED:{label:"Falhou",variant:"destructive",icon:X}})[r]||{label:"Aguardando Pagamento",variant:"secondary",icon:V},w=a.filter(r=>x(r)==="PENDING").reduce((r,c)=>r+c.cartValue,0),B=a.filter(r=>r.recovered).reduce((r,c)=>r+c.cartValue,0),F=a.filter(r=>x(r)==="EXPIRED").reduce((r,c)=>r+c.cartValue,0),L=a.length>0?(a.filter(r=>r.recovered).length/a.length*100).toFixed(1):"0";return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"PIX Recuperados"}),e.jsx("p",{className:"text-muted-foreground",children:"Gerencie transações PIX e recupere vendas perdidas"})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-4",children:[e.jsxs(E,{children:[e.jsxs(N,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Aguardando Pagamento"}),e.jsx(V,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(A,{children:[e.jsx("div",{className:"text-2xl font-bold",children:d(w)}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[a.filter(r=>x(r)==="PENDING").length," ","aguardando"]})]})]}),e.jsxs(E,{children:[e.jsxs(N,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"PIX Recuperados"}),e.jsx(ce,{className:"h-4 w-4 text-green-600"})]}),e.jsxs(A,{children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:d(B)}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[a.filter(r=>r.recovered).length," recuperados"]})]})]}),e.jsxs(E,{children:[e.jsxs(N,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Expirados"}),e.jsx(ne,{className:"h-4 w-4 text-red-600"})]}),e.jsxs(A,{children:[e.jsx("div",{className:"text-2xl font-bold text-red-600",children:d(F)}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[a.filter(r=>x(r)==="EXPIRED").length," ","expirados"]})]})]}),e.jsxs(E,{children:[e.jsxs(N,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Taxa de Recuperação"}),e.jsx(H,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(A,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[L,"%"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Taxa de conversão de PIX"})]})]})]}),w>0&&e.jsxs(ae,{children:[e.jsx(X,{className:"h-4 w-4"}),e.jsxs(oe,{children:["Você tem ",e.jsx("strong",{children:d(w)})," em PIX aguardando pagamento. Considere enviar lembretes para os clientes."]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(z,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(U,{placeholder:"Buscar por pedido, cliente ou email...",value:l,onChange:r=>R(r.target.value),className:"pl-9"})]}),e.jsxs(ee,{value:m,onValueChange:b,children:[e.jsx(re,{className:"w-[200px]",children:e.jsx(te,{placeholder:"Status"})}),e.jsxs(se,{children:[e.jsx(C,{value:"all",children:"Todos"}),e.jsx(C,{value:"PENDING",children:"Aguardando"}),e.jsx(C,{value:"RECOVERED",children:"Recuperado"}),e.jsx(C,{value:"EXPIRED",children:"Expirado"})]})]}),e.jsxs(M,{onClick:y,variant:"outline",children:[e.jsx(Q,{className:"h-4 w-4 mr-2"}),"Atualizar"]})]}),e.jsxs(E,{children:[e.jsxs(N,{children:[e.jsx(I,{children:"Recuperação de Carrinhos via PIX"}),e.jsxs(_,{children:[t.length," carrinho(s) encontrado(s)"]})]}),e.jsx(A,{children:f?e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{className:"h-12 w-full"}),e.jsx(q,{className:"h-12 w-full"}),e.jsx(q,{className:"h-12 w-full"})]}):t.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-center",children:[e.jsx(H,{className:"h-12 w-12 text-muted-foreground mb-4"}),e.jsx("h3",{className:"text-lg font-semibold",children:"Nenhum PIX encontrado"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:l||m!=="all"?"Tente ajustar os filtros":"Aguardando primeira transação PIX"})]}):e.jsxs(Y,{children:[e.jsx(Z,{children:e.jsxs(O,{children:[e.jsx(p,{children:"Carrinho"}),e.jsx(p,{children:"Cliente"}),e.jsx(p,{children:"Valor"}),e.jsx(p,{children:"Tentativas"}),e.jsx(p,{children:"Status"}),e.jsx(p,{children:"Expira em"}),e.jsx(p,{children:"Data"}),e.jsx(p,{className:"text-right",children:"Ações"})]})}),e.jsx($,{children:t.map(r=>{const c=x(r),T=g(c),k=T.icon;return e.jsxs(O,{children:[e.jsx(v,{children:e.jsxs("div",{className:"font-mono text-sm",children:["#",r.cartId.substring(0,8)]})}),e.jsx(v,{children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:r.customerEmail}),r.customerPhone&&e.jsx("div",{className:"text-sm text-muted-foreground",children:r.customerPhone})]})}),e.jsxs(v,{children:[e.jsx("div",{className:"font-medium",children:d(r.cartValue)}),r.discountOffered>0&&e.jsxs("div",{className:"text-sm text-green-600",children:["Desconto: ",d(r.discountOffered)]}),r.recoveredAt&&e.jsxs("div",{className:"text-sm text-green-600",children:["Recuperado em"," ",P(new Date(r.recoveredAt),"dd/MM/yyyy HH:mm",{locale:D})]})]}),e.jsxs(v,{children:[e.jsxs("div",{className:"text-sm",children:[r.recoveryAttempts," tentativa(s)"]}),r.lastRecoveryAt&&e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Última:"," ",P(new Date(r.lastRecoveryAt),"dd/MM HH:mm",{locale:D})]})]}),e.jsx(v,{children:e.jsxs(J,{variant:T.variant,className:"gap-1",children:[e.jsx(k,{className:"h-3 w-3"}),T.label]})}),e.jsx(v,{children:r.pixExpiresAt?e.jsx("div",{className:"text-sm",children:P(new Date(r.pixExpiresAt),"dd/MM/yyyy HH:mm",{locale:D})}):e.jsx("span",{className:"text-sm text-muted-foreground",children:"-"})}),e.jsx(v,{children:P(new Date(r.createdAt),"dd/MM/yyyy",{locale:D})}),e.jsx(v,{className:"text-right",children:e.jsxs("div",{className:"flex justify-end gap-2",children:[c==="PENDING"&&r.pixCopyPaste&&e.jsx(M,{variant:"outline",size:"sm",onClick:()=>{navigator.clipboard.writeText(r.pixCopyPaste),S({title:"Chave PIX copiada!"})},children:"Copiar PIX"}),r.orderId&&e.jsx(M,{variant:"ghost",size:"sm",children:"Ver pedido"})]})})]},r.id)})})]})})]})]})};export{Ee as default};

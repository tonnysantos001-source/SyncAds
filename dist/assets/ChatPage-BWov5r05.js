import{j as e}from"./vendor-ui-DkUuACDy.js";import{f as t,r as a}from"./vendor-react-X41Bjl18.js";import{g as s,f as r,i as o,s as n}from"./index-CheLaPa6.js";import{I as i,a as d,b as c}from"./IconSend-C9FDPUWV.js";import"./vendor-supabase-BQxDPPjR.js";import"./vendor-utils-Dl0_yMKq.js";import"./vendor-animation-DQ3cvw6m.js";import"./vendor-query-Bf3pI66S.js";import"./vendor-icons-DTdRnryx.js";function l(){const l=t(),{toast:m}=s(),x=r(e=>e.user),u=r(e=>e.isAuthenticated),[g,v]=a.useState([]),[h,p]=a.useState(null),[f,y]=a.useState(""),[b,j]=a.useState(!1),[N,w]=a.useState(!1),[A,I]=a.useState(!0),[S,E]=a.useState({connected:!1,deviceId:null,lastCheck:0}),C=a.useRef(null);a.useEffect(()=>{u&&x||l("/login-v2",{replace:!0})},[u,x,l]),a.useEffect(()=>{if(!x)return;(async()=>{j(!0);try{const{data:e,error:t}=await n.from("ChatConversation").select("id, title, createdAt").eq("userId",x.id).order("createdAt",{ascending:!1});if(t)throw t;if(!e||0===e.length){const e={id:crypto.randomUUID(),userId:x.id,title:`Conversa ${(new Date).toLocaleDateString()}`,createdAt:(new Date).toISOString()},{error:t}=await n.from("ChatConversation").insert(e);return void(t||(v([{id:e.id,title:e.title,messages:[]}]),p(e.id)))}const a=await Promise.all(e.map(async e=>{const{data:t}=await n.from("ChatMessage").select("id, role, content, createdAt").eq("conversationId",e.id).order("createdAt",{ascending:!0});return{id:e.id,title:e.title,messages:(t||[]).map(e=>({id:e.id,role:e.role.toLowerCase(),content:e.content,createdAt:e.createdAt}))}}));v(a),!h&&a.length>0&&p(a[0].id)}catch(e){m({title:"Erro",description:"Não foi possível carregar as conversas",variant:"destructive"})}finally{j(!1)}})()},[x]),a.useEffect(()=>{if(!x)return;const e=async()=>{try{const{data:e,error:t}=await n.from("ExtensionDevice").select("id, deviceId, isOnline, lastSeen").eq("userId",x.id).eq("isOnline",!0).order("lastSeen",{ascending:!1}).limit(1).maybeSingle();if(t)return;const a=!!e&&new Date(e.lastSeen).getTime()>Date.now()-6e4;E({connected:a,deviceId:e?.deviceId||null,lastCheck:Date.now()})}catch(e){}};e();const t=setInterval(e,1e4);return()=>clearInterval(t)},[x]),a.useEffect(()=>{C.current?.scrollIntoView({behavior:"smooth"})},[g,h]);const D=async()=>{if(!f.trim()||!h||!x||N)return;const e=f.trim();y(""),w(!0);try{const t={id:crypto.randomUUID(),conversationId:h,userId:x.id,role:"USER",content:e,createdAt:(new Date).toISOString()},{error:a}=await n.from("ChatMessage").insert(t);if(a)throw a;v(e=>e.map(e=>e.id===h?{...e,messages:[...e.messages,{id:t.id,role:"user",content:t.content,createdAt:t.createdAt}]}:e));const{data:{session:s}}=await n.auth.getSession();if(!s)throw new Error("Sem sessão");const r=await fetch("https://your-project.supabase.co/functions/v1/chat-enhanced",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s.access_token}`},body:JSON.stringify({message:e,conversationId:h,extensionConnected:S.connected,systemPrompt:S.connected?"Você é o assistente de IA do SyncAds. IMPORTANTE: A extensão do navegador está CONECTADA e ATIVA. Você TEM ACESSO ao navegador do usuário e pode executar comandos como NAVEGAR, CLICAR, PREENCHER, etc. Quando o usuário pedir para fazer algo no navegador (como abrir Facebook Ads, criar campanha, etc), você DEVE informar que vai fazer isso e então executar o comando. Nunca diga que não pode acessar o navegador - você PODE através da extensão que está ativa.":"Você é o assistente de IA do SyncAds. IMPORTANTE: A extensão do navegador está OFFLINE no momento. Você NÃO tem acesso ao navegador do usuário. Se o usuário pedir para fazer algo no navegador, instrua-o a instalar e ativar a extensão SyncAds AI primeiro. Você pode ajudar com: análise de dados, código Python, estratégias de marketing, configurações, e responder perguntas."})});if(!r.ok)throw new Error(`Erro HTTP: ${r.status}`);const o=await r.json();if(o.error)throw new Error(o.error);const i={id:crypto.randomUUID(),conversationId:h,userId:x.id,role:"ASSISTANT",content:o.response||"Desculpe, não consegui gerar uma resposta.",createdAt:(new Date).toISOString()},{error:d}=await n.from("ChatMessage").insert(i);if(d)throw d;v(e=>e.map(e=>e.id===h?{...e,messages:[...e.messages,{id:i.id,role:"assistant",content:i.content,createdAt:i.createdAt}]}:e))}catch(t){m({title:"Erro ao enviar mensagem",description:t.message||"Tente novamente",variant:"destructive"})}finally{w(!1)}},O=g.find(e=>e.id===h);return e.jsxs("div",{className:"flex h-screen bg-gray-950 text-white",children:[e.jsx("div",{className:(A?"w-80":"w-0")+" transition-all duration-300 border-r border-gray-800 flex flex-col",children:A&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"p-4 border-b border-gray-800",children:e.jsxs("button",{onClick:async()=>{if(x)try{const e={id:crypto.randomUUID(),userId:x.id,title:`Conversa ${(new Date).toLocaleDateString()}`,createdAt:(new Date).toISOString()},{error:t}=await n.from("ChatConversation").insert(e);if(t)throw t;const a={id:e.id,title:e.title,messages:[]};v([a,...g]),p(e.id),m({title:"Nova conversa criada!"})}catch(e){m({title:"Erro",description:"Não foi possível criar nova conversa",variant:"destructive"})}},className:"w-full flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg transition-colors",children:[e.jsx(i,{className:"w-5 h-5"}),"Nova Conversa"]})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-2",children:b?e.jsx("div",{className:"text-center text-gray-500 py-4",children:"Carregando..."}):g.map(t=>e.jsxs("div",{onClick:()=>p(t.id),className:"p-3 mb-2 rounded-lg cursor-pointer transition-colors "+(h===t.id?"bg-gray-800 border border-blue-600":"bg-gray-900 hover:bg-gray-800"),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm truncate",children:t.title}),e.jsx("button",{onClick:e=>{e.stopPropagation(),(async e=>{try{const{error:t}=await n.from("ChatConversation").delete().eq("id",e);if(t)throw t;v(t=>t.filter(t=>t.id!==e)),h===e&&p(g[0]?.id||null),m({title:"Conversa deletada"})}catch(t){m({title:"Erro ao deletar",variant:"destructive"})}})(t.id)},className:"text-gray-500 hover:text-red-500",children:e.jsx(o,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[t.messages.length," mensagens"]})]},t.id))})]})}),e.jsxs("div",{className:"flex-1 flex flex-col",children:[e.jsxs("div",{className:"h-16 border-b border-gray-800 flex items-center px-4 justify-between",children:[e.jsx("button",{onClick:()=>I(!A),className:"p-2 hover:bg-gray-800 rounded-lg",children:e.jsx(d,{className:"w-6 h-6"})}),e.jsx("h1",{className:"text-lg font-semibold",children:O?.title||"Chat"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-medium "+(S.connected?"bg-green-600/20 text-green-400 border border-green-600/30":"bg-gray-800 text-gray-400 border border-gray-700"),children:[e.jsx("div",{className:"w-2 h-2 rounded-full "+(S.connected?"bg-green-400":"bg-gray-500")}),e.jsx("span",{children:S.connected?"Extensão Ativa":"Extensão Offline"})]})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:O?0===O.messages.length?e.jsx("div",{className:"flex items-center justify-center h-full text-gray-500",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xl mb-2",children:"Nova conversa"}),e.jsx("p",{className:"text-sm",children:"Envie uma mensagem para começar"}),S.connected&&e.jsxs("div",{className:"mt-8 p-4 bg-green-600/10 border border-green-600/30 rounded-lg max-w-md mx-auto",children:[e.jsx("p",{className:"text-green-400 text-sm mb-2 font-medium",children:"✨ Extensão conectada!"}),e.jsx("p",{className:"text-gray-400 text-xs",children:'Agora posso controlar seu navegador. Experimente: "Abra o Facebook Ads"'})]})]})}):e.jsxs(e.Fragment,{children:[O.messages.map(t=>e.jsx("div",{className:"flex "+("user"===t.role?"justify-end":"justify-start"),children:e.jsx("div",{className:"max-w-[70%] rounded-lg p-4 "+("user"===t.role?"bg-blue-600":"bg-gray-800"),children:e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:t.content})})},t.id)),e.jsx("div",{ref:C})]}):e.jsx("div",{className:"flex items-center justify-center h-full text-gray-500",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xl mb-2",children:"Nenhuma conversa selecionada"}),e.jsx("p",{className:"text-sm",children:"Crie uma nova conversa para começar"}),!S.connected&&e.jsxs("div",{className:"mt-8 p-4 bg-yellow-600/10 border border-yellow-600/30 rounded-lg max-w-md mx-auto",children:[e.jsx("p",{className:"text-yellow-400 text-sm mb-2 font-medium",children:"⚠️ Extensão do navegador offline"}),e.jsx("p",{className:"text-gray-400 text-xs",children:"Para usar automação de navegador, instale e ative a extensão SyncAds AI"})]})]})})}),e.jsx("div",{className:"border-t border-gray-800 p-4",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:f,onChange:e=>y(e.target.value),onKeyPress:e=>"Enter"===e.key&&!e.shiftKey&&D(),placeholder:"Digite sua mensagem...",disabled:N||!h,className:"flex-1 bg-gray-900 border border-gray-800 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-600 disabled:opacity-50"}),e.jsx("button",{onClick:D,disabled:!f.trim()||N||!h,className:"bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-white px-6 py-3 rounded-lg transition-colors flex items-center gap-2",children:N?e.jsx("span",{children:"Enviando..."}):e.jsxs(e.Fragment,{children:[e.jsx(c,{className:"w-5 h-5"}),"Enviar"]})})]})})]})]})}export{l as default};

import{f as X,r as m,s as P,j as e,g as N,h as b,i as C,l as v,a3 as Y,B as A,C as Z,S as $,I as ee,n as D}from"./index-DO-uVCB2.js";import{T as M,a as V,b as h,c as l,d as H,e as t}from"./table-BxcjaEu_.js";import{S as se}from"./SuperAdminLayout-DvHURFhV.js";import{S as ae,a as te,b as re,c as le,d as x}from"./select-C4ftlfIS.js";import{D as ne}from"./dollar-sign-Dh9A7saq.js";import{T as ce}from"./trending-up-CX7ReSBS.js";import{F as U}from"./file-text-DfQp9Dio.js";import{D as ie}from"./download-C4cYXIOi.js";import{f as de,p as oe}from"./pt-BR-COO1Bk_c.js";import"./Logo-Ci7oVn8I.js";import"./message-square-BcVwCN08.js";import"./index-BoQoy_0E.js";function we(){const{toast:_}=X(),[T,I]=m.useState(!0),[u,z]=m.useState(""),[p,G]=m.useState("all"),[g,R]=m.useState("subscriptions"),[q,J]=m.useState([]),[K,O]=m.useState([]),[f,Q]=m.useState({totalRevenue:0,monthlyRevenue:0,activeSubscriptions:0,totalInvoices:0,paidInvoices:0,pendingInvoices:0});m.useEffect(()=>{W()},[]);const W=async()=>{try{I(!0);const{data:s,error:n}=await P.from("Subscription").select(`
          *,
          user:userId (id, name, email),
          plan:planId (id, name, price, maxAiMessages)
        `).order("createdAt",{ascending:!1});if(n)throw n;const{data:a,error:c}=await P.from("Invoice").select(`
          *,
          user:userId (name, email)
        `).order("createdAt",{ascending:!1});if(c)throw c;J(s||[]),O(a||[]);const i=(s||[]).filter(r=>r.status==="active").length,d=(s||[]).filter(r=>r.status==="active").reduce((r,k)=>{var E;return r+(((E=k.plan)==null?void 0:E.price)||0)},0),o=(a||[]).filter(r=>r.status==="paid").length,j=(a||[]).filter(r=>r.status==="open"||r.status==="draft").length,S=(a||[]).filter(r=>r.status==="paid").reduce((r,k)=>r+k.amount,0);Q({totalRevenue:S,monthlyRevenue:d,activeSubscriptions:i,totalInvoices:(a==null?void 0:a.length)||0,paidInvoices:o,pendingInvoices:j})}catch(s){console.error("Error loading billing data:",s),_({title:"Erro ao carregar dados",description:"Não foi possível carregar os dados de faturamento.",variant:"destructive"})}finally{I(!1)}},y=s=>new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(s),w=s=>s?de(new Date(s),"dd/MM/yyyy",{locale:oe}):"-",L=s=>{const a={active:{label:"Ativa",className:"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200"},trialing:{label:"Trial",className:"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200"},past_due:{label:"Atrasada",className:"bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200"},canceled:{label:"Cancelada",className:"bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200"},paid:{label:"Paga",className:"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200"},open:{label:"Aberta",className:"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200"},draft:{label:"Rascunho",className:"bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200"},void:{label:"Cancelada",className:"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200"}}[s]||{label:s,className:"bg-gray-100 text-gray-800"};return e.jsx(D,{className:a.className,children:a.label})},B=q.filter(s=>{var c,i,d,o,j,S;const n=((i=(c=s.user)==null?void 0:c.name)==null?void 0:i.toLowerCase().includes(u.toLowerCase()))||((o=(d=s.user)==null?void 0:d.email)==null?void 0:o.toLowerCase().includes(u.toLowerCase()))||((S=(j=s.plan)==null?void 0:j.name)==null?void 0:S.toLowerCase().includes(u.toLowerCase())),a=p==="all"||s.status===p;return n&&a}),F=K.filter(s=>{var c,i,d,o,j;const n=((i=(c=s.user)==null?void 0:c.name)==null?void 0:i.toLowerCase().includes(u.toLowerCase()))||((o=(d=s.user)==null?void 0:d.email)==null?void 0:o.toLowerCase().includes(u.toLowerCase()))||((j=s.invoiceNumber)==null?void 0:j.toLowerCase().includes(u.toLowerCase())),a=p==="all"||s.status===p;return n&&a});return e.jsx(se,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white",children:"Faturamento"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mt-1",children:"Gerencie assinaturas e faturas dos clientes"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[e.jsxs(N,{children:[e.jsxs(b,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(C,{className:"text-sm font-medium",children:"Receita Total"}),e.jsx(ne,{className:"h-4 w-4 text-green-600"})]}),e.jsxs(v,{children:[e.jsx("div",{className:"text-2xl font-bold",children:y(f.totalRevenue)}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[f.paidInvoices," faturas pagas"]})]})]}),e.jsxs(N,{children:[e.jsxs(b,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(C,{className:"text-sm font-medium",children:"MRR"}),e.jsx(ce,{className:"h-4 w-4 text-blue-600"})]}),e.jsxs(v,{children:[e.jsx("div",{className:"text-2xl font-bold",children:y(f.monthlyRevenue)}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Receita mensal recorrente"})]})]}),e.jsxs(N,{children:[e.jsxs(b,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(C,{className:"text-sm font-medium",children:"Assinaturas Ativas"}),e.jsx(Y,{className:"h-4 w-4 text-purple-600"})]}),e.jsxs(v,{children:[e.jsx("div",{className:"text-2xl font-bold",children:f.activeSubscriptions}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Clientes com planos ativos"})]})]}),e.jsxs(N,{children:[e.jsxs(b,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(C,{className:"text-sm font-medium",children:"Faturas Pendentes"}),e.jsx(U,{className:"h-4 w-4 text-orange-600"})]}),e.jsxs(v,{children:[e.jsx("div",{className:"text-2xl font-bold",children:f.pendingInvoices}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Aguardando pagamento"})]})]})]}),e.jsxs(N,{children:[e.jsx(b,{children:e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(A,{variant:g==="subscriptions"?"default":"outline",onClick:()=>R("subscriptions"),className:g==="subscriptions"?"bg-pink-600 hover:bg-pink-700":"",children:[e.jsx(Z,{className:"h-4 w-4 mr-2"}),"Assinaturas"]}),e.jsxs(A,{variant:g==="invoices"?"default":"outline",onClick:()=>R("invoices"),className:g==="invoices"?"bg-pink-600 hover:bg-pink-700":"",children:[e.jsx(U,{className:"h-4 w-4 mr-2"}),"Faturas"]})]}),e.jsxs("div",{className:"flex gap-2 w-full sm:w-auto",children:[e.jsxs("div",{className:"relative flex-1 sm:w-64",children:[e.jsx($,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(ee,{placeholder:"Buscar...",value:u,onChange:s=>z(s.target.value),className:"pl-10"})]}),e.jsxs(ae,{value:p,onValueChange:G,children:[e.jsx(te,{className:"w-32",children:e.jsx(re,{placeholder:"Status"})}),e.jsxs(le,{children:[e.jsx(x,{value:"all",children:"Todos"}),g==="subscriptions"?e.jsxs(e.Fragment,{children:[e.jsx(x,{value:"active",children:"Ativa"}),e.jsx(x,{value:"trialing",children:"Trial"}),e.jsx(x,{value:"canceled",children:"Cancelada"}),e.jsx(x,{value:"past_due",children:"Atrasada"})]}):e.jsxs(e.Fragment,{children:[e.jsx(x,{value:"paid",children:"Paga"}),e.jsx(x,{value:"open",children:"Aberta"}),e.jsx(x,{value:"draft",children:"Rascunho"}),e.jsx(x,{value:"void",children:"Cancelada"})]})]})]})]})]})}),e.jsx(v,{children:g==="subscriptions"?e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(M,{children:[e.jsx(V,{children:e.jsxs(h,{children:[e.jsx(l,{children:"Cliente"}),e.jsx(l,{children:"Plano"}),e.jsx(l,{children:"Valor"}),e.jsx(l,{children:"Status"}),e.jsx(l,{children:"Uso IA"}),e.jsx(l,{children:"Renovação"}),e.jsx(l,{children:"Criado em"})]})}),e.jsx(H,{children:T?e.jsx(h,{children:e.jsx(t,{colSpan:7,className:"text-center py-8 text-gray-500",children:"Carregando..."})}):B.length===0?e.jsx(h,{children:e.jsx(t,{colSpan:7,className:"text-center py-8 text-gray-500",children:"Nenhuma assinatura encontrada"})}):B.map(s=>{var n,a,c,i,d,o;return e.jsxs(h,{children:[e.jsx(t,{children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-white",children:((n=s.user)==null?void 0:n.name)||"N/A"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:((a=s.user)==null?void 0:a.email)||"N/A"})]})}),e.jsx(t,{children:e.jsx(D,{variant:"outline",children:((c=s.plan)==null?void 0:c.name)||"N/A"})}),e.jsxs(t,{className:"font-semibold",children:[y(((i=s.plan)==null?void 0:i.price)||0),"/mês"]}),e.jsx(t,{children:L(s.status)}),e.jsx(t,{children:e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:s.usedAiMessages}),e.jsxs("span",{className:"text-gray-500",children:[" ","/ ",((d=s.plan)==null?void 0:d.maxAiMessages)===0?"∞":(o=s.plan)==null?void 0:o.maxAiMessages]})]})}),e.jsx(t,{className:"text-sm",children:w(s.currentPeriodEnd)}),e.jsx(t,{className:"text-sm text-gray-600 dark:text-gray-400",children:w(s.createdAt)})]},s.id)})})]})}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(M,{children:[e.jsx(V,{children:e.jsxs(h,{children:[e.jsx(l,{children:"Fatura"}),e.jsx(l,{children:"Cliente"}),e.jsx(l,{children:"Valor"}),e.jsx(l,{children:"Status"}),e.jsx(l,{children:"Pago em"}),e.jsx(l,{children:"Criado em"}),e.jsx(l,{className:"text-right",children:"Ações"})]})}),e.jsx(H,{children:T?e.jsx(h,{children:e.jsx(t,{colSpan:7,className:"text-center py-8 text-gray-500",children:"Carregando..."})}):F.length===0?e.jsx(h,{children:e.jsx(t,{colSpan:7,className:"text-center py-8 text-gray-500",children:"Nenhuma fatura encontrada"})}):F.map(s=>{var n,a;return e.jsxs(h,{children:[e.jsx(t,{className:"font-medium",children:s.invoiceNumber}),e.jsx(t,{children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-white",children:((n=s.user)==null?void 0:n.name)||"N/A"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:((a=s.user)==null?void 0:a.email)||"N/A"})]})}),e.jsx(t,{className:"font-semibold",children:y(s.amount)}),e.jsx(t,{children:L(s.status)}),e.jsx(t,{className:"text-sm",children:w(s.paidAt)}),e.jsx(t,{className:"text-sm text-gray-600 dark:text-gray-400",children:w(s.createdAt)}),e.jsx(t,{className:"text-right",children:e.jsx(A,{variant:"ghost",size:"icon",children:e.jsx(ie,{className:"h-4 w-4"})})})]},s.id)})})]})})})]})]})})}export{we as default};

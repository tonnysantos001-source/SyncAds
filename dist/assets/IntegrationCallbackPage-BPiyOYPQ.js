var S=Object.defineProperty;var E=(r,t,a)=>t in r?S(r,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):r[t]=a;var y=(r,t,a)=>E(r,typeof t!="symbol"?t+"":t,a);import{s as c,a4 as b,a as C,r as w,j as o,i as A,a5 as U}from"./index-C4s97nHi.js";import{C as O}from"./circle-x-2ZYyDiON.js";var u={};const I={google_ads:{slug:"google_ads",name:"Google Ads",authType:"oauth",icon:"ðŸ”",description:"Gerencie suas campanhas do Google Ads",scopes:["https://www.googleapis.com/auth/adwords"],clientId:u.VITE_GOOGLE_CLIENT_ID,authUrl:"https://accounts.google.com/o/oauth2/v2/auth",tokenUrl:"https://oauth2.googleapis.com/token"},meta_ads:{slug:"meta_ads",name:"Meta Ads",authType:"oauth",icon:"ðŸ“˜",description:"Conecte suas campanhas do Facebook e Instagram",scopes:["ads_management","ads_read","business_management"],clientId:u.VITE_META_CLIENT_ID,authUrl:"https://www.facebook.com/v18.0/dialog/oauth",tokenUrl:"https://graph.facebook.com/v18.0/oauth/access_token"},facebook_ads:{slug:"facebook_ads",name:"Facebook Ads",authType:"oauth",icon:"ðŸ‘¥",description:"Gerencie anÃºncios do Facebook",scopes:["ads_management","ads_read"],clientId:u.VITE_META_CLIENT_ID,authUrl:"https://www.facebook.com/v18.0/dialog/oauth",tokenUrl:"https://graph.facebook.com/v18.0/oauth/access_token"},linkedin_ads:{slug:"linkedin_ads",name:"LinkedIn Ads",authType:"oauth",icon:"ðŸ’¼",description:"Conecte suas campanhas do LinkedIn",scopes:["r_ads","rw_ads","r_organization_social"],clientId:u.VITE_LINKEDIN_CLIENT_ID,authUrl:"https://www.linkedin.com/oauth/v2/authorization",tokenUrl:"https://www.linkedin.com/oauth/v2/accessToken"},google_analytics:{slug:"google_analytics",name:"Google Analytics",authType:"oauth",icon:"ðŸ“Š",description:"Analise dados do Google Analytics",scopes:["https://www.googleapis.com/auth/analytics.readonly"],clientId:u.VITE_GOOGLE_CLIENT_ID,authUrl:"https://accounts.google.com/o/oauth2/v2/auth",tokenUrl:"https://oauth2.googleapis.com/token"},twitter_ads:{slug:"twitter_ads",name:"Twitter Ads",authType:"oauth",icon:"ðŸ¦",description:"Gerencie campanhas do Twitter/X",scopes:["tweet.read","users.read","offline.access"],clientId:u.VITE_TWITTER_CLIENT_ID,authUrl:"https://twitter.com/i/oauth2/authorize",tokenUrl:"https://api.twitter.com/2/oauth2/token"},tiktok_ads:{slug:"tiktok_ads",name:"TikTok Ads",authType:"oauth",icon:"ðŸŽµ",description:"Conecte suas campanhas do TikTok",scopes:["user.info.basic","video.list"],clientId:u.VITE_TIKTOK_CLIENT_ID,authUrl:"https://www.tiktok.com/auth/authorize/",tokenUrl:"https://open-api.tiktok.com/oauth/access_token/"}};class D{constructor(){y(this,"REDIRECT_URI",`${window.location.origin}/integrations/callback`)}async listIntegrations(t){const{data:a,error:e}=await c.from("Integration").select("*").eq("userId",t);if(e)throw e;return a||[]}async getIntegrationStatus(t,a){const{data:e,error:n}=await c.from("Integration").select("*").eq("userId",t).eq("platform",a.toUpperCase()).single();if(n&&n.code!=="PGRST116")throw n;return e}async generateOAuthUrl(t,a){var s;const e=I[t];if(!e||e.authType!=="oauth")throw new Error("IntegraÃ§Ã£o nÃ£o suporta OAuth");if(!e.clientId||e.clientId==="your-google-client-id"||e.clientId==="your-meta-client-id"||e.clientId==="your-linkedin-client-id"||e.clientId==="your-twitter-client-id"||e.clientId==="your-tiktok-client-id")throw new Error(`âŒ Client ID nÃ£o configurado para ${e.name}

ðŸ“ Para conectar esta integraÃ§Ã£o, vocÃª precisa:
1. Criar uma aplicaÃ§Ã£o OAuth no ${e.name}
2. Adicionar o Client ID no arquivo .env
3. Reiniciar o servidor de desenvolvimento

ðŸ“– Consulte OAUTH_SETUP.md para instruÃ§Ãµes detalhadas.`);const n=btoa(JSON.stringify({userId:a,slug:t,timestamp:Date.now(),random:Math.random().toString(36).substring(7)})),i=new Date(Date.now()+10*60*1e3).toISOString(),{error:l}=await c.from("OAuthState").insert({id:crypto.randomUUID(),state:n,userId:a,integrationSlug:t,expiresAt:i,createdAt:new Date().toISOString()});if(l)throw new Error(`Erro ao armazenar state OAuth: ${l.message}`);const h=new URLSearchParams({client_id:e.clientId,redirect_uri:this.REDIRECT_URI,response_type:"code",scope:((s=e.scopes)==null?void 0:s.join(" "))||"",state:n,access_type:"offline",prompt:"consent"});return{authUrl:`${e.authUrl}?${h.toString()}`,state:n}}async handleOAuthCallback(t,a){const{data:e,error:n}=await c.from("OAuthState").select("*").eq("state",a).single();if(n||!e)throw new Error("State invÃ¡lido ou expirado");const{userId:i,integrationSlug:l}=JSON.parse(atob(a)),h=I[l];if(!h)throw new Error("IntegraÃ§Ã£o nÃ£o encontrada");const d=await fetch(h.tokenUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({client_id:h.clientId,client_secret:"8b80da29081d73fd7d1037f3cae72d55",code:t,redirect_uri:this.REDIRECT_URI,grant_type:"authorization_code"})});if(!d.ok)throw new Error("Falha ao obter tokens");const s=await d.json();s.expires_in&&new Date(Date.now()+s.expires_in*1e3).toISOString();const{data:m}=await c.from("Integration").select("id").eq("userId",i).eq("platform",l.toUpperCase()).single();if(m)await c.from("Integration").update({credentials:{access_token:s.access_token,refresh_token:s.refresh_token},isConnected:!0,lastSyncAt:new Date().toISOString(),updatedAt:new Date().toISOString()}).eq("id",m.id);else{const{error:g}=await c.from("Integration").insert({id:crypto.randomUUID(),userId:i,platform:l.toUpperCase(),credentials:{access_token:s.access_token,refresh_token:s.refresh_token},isConnected:!0,lastSyncAt:new Date().toISOString(),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()});if(g)throw g}return await c.from("OAuthState").delete().eq("state",a),{success:!0,slug:l}}async connectDirect(t,a,e){throw new Error("AutenticaÃ§Ã£o direta requer implementaÃ§Ã£o no backend")}async disconnect(t,a){const{error:e}=await c.from("Integration").delete().eq("userId",t).eq("platform",a.toUpperCase());if(e)throw e}async refreshToken(t){console.log("Refresh token nÃ£o implementado ainda")}}const N=new D;function $(){const[r]=b(),t=C(),[a,e]=w.useState("loading"),[n,i]=w.useState("Processing your connection...");return w.useEffect(()=>{(async()=>{var h;try{const d=r.get("shop"),s=r.get("code"),m=r.get("hmac");if(d&&s&&m){e("loading"),i("Conectando com Shopify...");try{const p=await c.auth.getSession(),k=await(await fetch(`https://ovskepqggmxlfckxqgbr.supabase.co/functions/v1/shopify-oauth?action=callback&shop=${d}&code=${s}&hmac=${m}`,{headers:{Authorization:`Bearer ${(h=p.data.session)==null?void 0:h.access_token}`}})).json();if(k.success){e("success"),i("Shopify conectada! Sincronizando dados..."),setTimeout(()=>t("/integrations"),2e3);return}else throw new Error(k.error||"Erro ao conectar Shopify")}catch(p){e("error"),i(`Erro ao conectar Shopify: ${p.message}`),setTimeout(()=>t("/integrations"),3e3);return}}const g=r.get("state"),f=r.get("error");if(f)throw new Error(f);if(!s||!g)throw new Error("Missing code or state parameter");const x=await N.handleOAuthCallback(s,g),T=I[x.slug];e("success"),i(`${T.name} connected successfully!`);const _=JSON.parse(atob(g));localStorage.setItem(`oauth_success_${_.platform}_${_.userId}`,"true"),setTimeout(()=>{window.opener?window.close():t("/chat")},2e3)}catch(d){console.error("OAuth callback error:",d),e("error"),i(d.message||"Failed to connect integration"),setTimeout(()=>{window.opener?window.close():t("/chat")},3e3)}})()},[r,t]),o.jsx("div",{className:"flex items-center justify-center min-h-screen bg-gray-50 dark:bg-gray-900",children:o.jsxs("div",{className:"text-center p-8 bg-white dark:bg-gray-800 rounded-lg shadow-lg max-w-md",children:[a==="loading"&&o.jsxs(o.Fragment,{children:[o.jsx(A,{className:"h-16 w-16 animate-spin text-blue-600 mx-auto mb-4"}),o.jsx("h1",{className:"text-2xl font-bold mb-2",children:"Processing..."}),o.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:n})]}),a==="success"&&o.jsxs(o.Fragment,{children:[o.jsx(U,{className:"h-16 w-16 text-green-600 mx-auto mb-4"}),o.jsx("h1",{className:"text-2xl font-bold mb-2 text-green-600",children:"Success!"}),o.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:n}),o.jsx("p",{className:"text-sm text-gray-500 mt-2",children:"Closing this window..."})]}),a==="error"&&o.jsxs(o.Fragment,{children:[o.jsx(O,{className:"h-16 w-16 text-red-600 mx-auto mb-4"}),o.jsx("h1",{className:"text-2xl font-bold mb-2 text-red-600",children:"Error"}),o.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:n}),o.jsx("p",{className:"text-sm text-gray-500 mt-2",children:"Redirecting..."})]})]})})}export{$ as IntegrationCallbackPage};

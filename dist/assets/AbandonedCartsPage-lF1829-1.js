import{j as e}from"./vendor-ui-DkUuACDy.js";import{r as a}from"./vendor-react-X41Bjl18.js";import{s as r,g as t,f as s,B as o,C as i,a as n,b as d,c as l,I as c,e as m}from"./index-hPMilkXu.js";import{T as x,a as h,b as g,c as p,d as y,e as u}from"./table-BnfIhzCY.js";import{a as b}from"./shopifySync-j0T8XoZT.js";import{S as f}from"./skeleton-C93RJMX5.js";import{m as j}from"./vendor-animation-DQ3cvw6m.js";import{R as v,u as w,D as k,w as N,S as A,U as C,J as S,f as I,r as E}from"./vendor-icons-DTdRnryx.js";import"./vendor-supabase-BQxDPPjR.js";import"./vendor-utils-Dl0_yMKq.js";import"./vendor-query-Bf3pI66S.js";const q={async getAll(e){const{data:a,error:t}=await r.from("AbandonedCart").select("*").eq("userId",e).order("createdAt",{ascending:!1});if(t)throw t;const{data:s,error:o}=await r.from("ShopifyAbandonedCart").select("*").eq("userId",e).order("abandonedAt",{ascending:!1});if(o)throw o;return[...a||[],...(s||[]).map(e=>({id:e.id,userId:e.userId,cartId:e.shopifyCartId||e.id,customerEmail:e.email,customerName:e.customerName,items:e.lineItems||{},subtotal:e.totalPrice||0,total:e.totalPrice||0,recoveryEmailSent:!1,recoveryEmailSentAt:void 0,recovered:!1,recoveredAt:void 0,recoveryOrderId:void 0,metadata:{source:"shopify",shopifyCartToken:e.cartToken,abandonedCheckoutUrl:e.abandonedCheckoutUrl},createdAt:e.abandonedAt||e.createdAt}))].filter((e,a,r)=>a===r.findIndex(a=>a.cartId===e.cartId)).sort((e,a)=>new Date(a.createdAt).getTime()-new Date(e.createdAt).getTime())},async getById(e){const{data:a,error:t}=await r.from("AbandonedCart").select("*").eq("id",e).single();if(t)throw t;return a},async create(e){const{data:a,error:t}=await r.from("AbandonedCart").insert(e).select().single();if(t)throw t;return a},async markEmailSent(e){const{data:a,error:t}=await r.from("AbandonedCart").update({recoveryEmailSent:!0,recoveryEmailSentAt:(new Date).toISOString()}).eq("id",e).select().single();if(t)throw t;return a},async markRecovered(e,a){const{data:t,error:s}=await r.from("AbandonedCart").update({recovered:!0,recoveredAt:(new Date).toISOString(),recoveryOrderId:a}).eq("id",e).select().single();if(s)throw s;return t},getUnrecovered:async e=>(await q.getAll(e)).filter(e=>!e.recovered),getNeedingEmail:async e=>(await q.getAll(e)).filter(e=>!e.recoveryEmailSent&&!e.recovered),async getShopifyAbandoned(e){const{data:a,error:t}=await r.from("ShopifyAbandonedCart").select("*").eq("userId",e).order("abandonedAt",{ascending:!1});if(t)throw t;return a},async syncFromShopify(e){try{const{data:a,error:t}=await r.from("ShopifyAbandonedCart").select("*").eq("id",e).single();if(t)throw t;const{data:s}=await r.from("AbandonedCart").select("id").eq("cartId",a.shopifyCartId||e).single();if(s)return s;const o={userId:a.userId,cartId:a.shopifyCartId||e,customerEmail:a.email,customerName:a.customerName,items:a.lineItems||{},subtotal:a.totalPrice||0,total:a.totalPrice||0,recoveryEmailSent:!1,recovered:!1,metadata:{source:"shopify",shopifyCartToken:a.cartToken,abandonedCheckoutUrl:a.abandonedCheckoutUrl}},{data:i,error:n}=await r.from("AbandonedCart").insert(o).select().single();if(n)throw n;return i}catch(a){throw a}},async delete(e){const{error:a}=await r.from("AbandonedCart").delete().eq("id",e);if(a)throw a}},T=()=>{const[r,T]=a.useState([]),[z,R]=a.useState(!0),[B,D]=a.useState(!1),[P,U]=a.useState(""),{toast:O}=t(),F=s(e=>e.user);a.useEffect(()=>{L()},[]);const L=async()=>{try{if(!F?.id)return;const e=await q.getAll(F.id);T(e)}catch(e){O({title:"Erro ao carregar",description:e.message,variant:"destructive"})}finally{R(!1)}},V=r.filter(e=>e.customerEmail?.toLowerCase().includes(P.toLowerCase())),J=r.reduce((e,a)=>e+a.total,0),M=r.length>0?12.5:0,G=e=>new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(e);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(j.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-4xl font-black bg-gradient-to-r from-orange-600 via-red-600 to-pink-600 bg-clip-text text-transparent",children:"Carrinhos Abandonados"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 font-medium",children:"Recupere vendas de carrinhos abandonados"})]}),e.jsxs(o,{onClick:async()=>{if(F?.id)try{D(!0),O({title:"Sincronizando...",description:"Buscando carrinhos abandonados da Shopify"});const e=await b.syncAbandonedCarts(F.id);e.success?(O({title:"Sincronização concluída!",description:e.message}),await L()):O({title:"Erro na sincronização",description:e.message,variant:"destructive"})}catch(e){O({title:"Erro ao sincronizar",description:"Configure a integração Shopify em Integrações",variant:"destructive"})}finally{D(!1)}else O({title:"Erro",description:"Faça login para sincronizar",variant:"destructive"})},disabled:B,className:"bg-gradient-to-r from-orange-500 to-pink-500 text-white border-0 hover:from-orange-600 hover:to-pink-600 transition-all duration-300 shadow-lg hover:shadow-xl disabled:opacity-50",children:[e.jsx(v,{className:"mr-2 h-4 w-4 "+(B?"animate-spin":"")}),B?"Sincronizando...":"Sincronizar Shopify"]})]}),e.jsxs("div",{className:"grid gap-6 md:grid-cols-3",children:[e.jsx(j.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.1},children:e.jsxs(i,{className:"relative overflow-hidden border-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl shadow-lg hover:shadow-xl transition-all duration-300",children:[e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 bg-orange-500 opacity-10 rounded-full blur-3xl"}),e.jsxs(n,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(d,{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Total Abandonados"}),e.jsx("div",{className:"p-2 rounded-lg bg-orange-500 bg-opacity-10",children:e.jsx(w,{className:"h-4 w-4 text-orange-500"})})]}),e.jsxs(l,{children:[e.jsx("div",{className:"text-3xl font-bold bg-gradient-to-br from-orange-600 to-red-500 bg-clip-text text-transparent",children:r.length}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:"Carrinhos esperando recuperação"})]})]})}),e.jsx(j.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.2},children:e.jsxs(i,{className:"relative overflow-hidden border-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl shadow-lg hover:shadow-xl transition-all duration-300",children:[e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 bg-red-500 opacity-10 rounded-full blur-3xl"}),e.jsxs(n,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(d,{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Valor Total"}),e.jsx("div",{className:"p-2 rounded-lg bg-red-500 bg-opacity-10",children:e.jsx(k,{className:"h-4 w-4 text-red-500"})})]}),e.jsxs(l,{children:[e.jsx("div",{className:"text-3xl font-bold bg-gradient-to-br from-red-600 to-pink-500 bg-clip-text text-transparent",children:G(J)}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:"Potencial de recuperação"})]})]})}),e.jsx(j.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.3},children:e.jsxs(i,{className:"relative overflow-hidden border-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl shadow-lg hover:shadow-xl transition-all duration-300",children:[e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 bg-pink-500 opacity-10 rounded-full blur-3xl"}),e.jsxs(n,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(d,{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Taxa Recuperação"}),e.jsx("div",{className:"p-2 rounded-lg bg-pink-500 bg-opacity-10",children:e.jsx(N,{className:"h-4 w-4 text-pink-500"})})]}),e.jsxs(l,{children:[e.jsxs("div",{className:"text-3xl font-bold bg-gradient-to-br from-pink-600 to-purple-500 bg-clip-text text-transparent",children:[M.toFixed(1),"%"]}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:"Média de conversão"})]})]})})]}),e.jsxs(j.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.4},className:"relative",children:[e.jsx(A,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(c,{placeholder:"Buscar por email...",value:P,onChange:e=>U(e.target.value),className:"pl-9 border-gray-200 dark:border-gray-700 bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm dark:text-white dark:placeholder:text-gray-500"})]}),e.jsx(j.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.5},children:e.jsxs(i,{className:"border-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl shadow-lg",children:[e.jsx(n,{children:e.jsx(d,{className:"text-xl font-bold bg-gradient-to-r from-orange-600 to-pink-600 bg-clip-text text-transparent",children:"Lista de Carrinhos"})}),e.jsx(l,{children:z?e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{className:"h-12 w-full"}),e.jsx(f,{className:"h-12 w-full"}),e.jsx(f,{className:"h-12 w-full"})]}):0===V.length?e.jsxs(j.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{duration:.5},className:"text-center py-12",children:[e.jsx(w,{className:"h-16 w-16 text-muted-foreground mb-4 mx-auto opacity-50"}),e.jsx("h3",{className:"text-lg font-semibold mb-2 dark:text-white",children:"Nenhum carrinho abandonado"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:P?"Tente ajustar os filtros de busca":"Os carrinhos abandonados aparecerão aqui"})]}):e.jsx("div",{className:"rounded-lg overflow-hidden border border-gray-200 dark:border-gray-700",children:e.jsxs(x,{children:[e.jsx(h,{children:e.jsxs(g,{className:"bg-gradient-to-r from-orange-50 to-pink-50 dark:from-gray-800 dark:to-gray-800 hover:from-orange-100 hover:to-pink-100 dark:hover:from-gray-700 dark:hover:to-gray-700",children:[e.jsx(p,{className:"font-semibold dark:text-gray-300",children:"Email"}),e.jsx(p,{className:"font-semibold dark:text-gray-300",children:"Produtos"}),e.jsx(p,{className:"font-semibold dark:text-gray-300",children:"Valor"}),e.jsx(p,{className:"font-semibold dark:text-gray-300",children:"Abandonado há"}),e.jsx(p,{className:"font-semibold dark:text-gray-300",children:"Ações"})]})}),e.jsx(y,{children:V.map((a,r)=>e.jsxs(j.tr,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{duration:.3,delay:.05*r},className:"border-b border-gray-100 dark:border-gray-800 hover:bg-gradient-to-r hover:from-orange-50/50 hover:to-pink-50/50 dark:hover:from-gray-800/50 dark:hover:to-gray-800/50 transition-all duration-200",children:[e.jsx(u,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-br from-orange-100 to-pink-100 dark:from-orange-900/20 dark:to-pink-900/20",children:e.jsx(C,{className:"h-4 w-4 text-orange-600 dark:text-orange-400"})}),e.jsx("span",{className:"font-medium dark:text-white",children:a.customerEmail})]})}),e.jsx(u,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(S,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("span",{className:"dark:text-gray-300",children:[a.itemCount," ",1===a.itemCount?"item":"items"]})]})}),e.jsx(u,{children:e.jsx("span",{className:"font-bold bg-gradient-to-r from-orange-600 to-pink-600 bg-clip-text text-transparent",children:G(a.total)})}),e.jsx(u,{children:e.jsxs(m,{variant:"outline",className:"bg-gradient-to-r from-orange-100 to-pink-100 dark:from-orange-900/30 dark:to-pink-900/30 text-orange-700 dark:text-orange-300 border-orange-300 dark:border-orange-700",children:[e.jsx(I,{className:"h-3 w-3 mr-1"}),a.abandonedDays,"d"]})}),e.jsx(u,{children:e.jsxs(o,{size:"sm",onClick:()=>(async()=>{try{O({title:"Email de recuperação enviado!"})}catch(e){O({title:"Erro",description:e.message,variant:"destructive"})}})(a.id),className:"bg-gradient-to-r from-orange-500 to-pink-500 text-white border-0 hover:from-orange-600 hover:to-pink-600 transition-all duration-300 shadow-md hover:shadow-lg",children:[e.jsx(E,{className:"h-4 w-4 mr-2"}),"Recuperar"]})})]},a.id))})]})})})]})})]})};export{T as default};

var L=Object.defineProperty;var F=(a,s,t)=>s in a?L(a,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[s]=t;var h=(a,s,t)=>F(a,typeof s!="symbol"?s+"":s,t);import{s as y,a9 as z,aa as B,ab as V,b as W,u as U,r as p,j as e,B as f,I as S,d as j,e as w,f as N,h as v,C as R,T,g as H,n as $}from"./index-CEWpG3gN.js";import{L as C}from"./label-BmhJRpwM.js";import{D as X,a as Y,b as J,c as Z,d as Q,e as ee,f as se}from"./dialog-qpsp7Er7.js";import{S as ae,a as te,b as re,c as ie,d as ne}from"./select-Do9o6DhZ.js";import{S as P}from"./SuperAdminLayout-DCr3iLkR.js";import{P as D}from"./plus-DaRpa2_h.js";import{C as K}from"./credit-card-Ds-QGStY.js";import{X as ce}from"./x-DeJVuiXe.js";import"./index-2j8551ML.js";import"./Logo-ibNcyk8L.js";import"./shield-CsHWaSPb.js";import"./message-square-BK7RjsX5.js";import"./users-CTNEVY--.js";import"./dollar-sign-HgGaSGqy.js";import"./chart-column-C0qPVnRp.js";import"./bot-DXlJCsKD.js";const oe={async list(a){try{let s=y.from("Gateway").select("*").eq("isActive",!0).order("isPopular",{ascending:!1}).order("name",{ascending:!0});a!=null&&a.type&&(s=s.eq("type",a.type)),(a==null?void 0:a.isPopular)!==void 0&&(s=s.eq("isPopular",a.isPopular)),(a==null?void 0:a.supportsPix)!==void 0&&(s=s.eq("supportsPix",a.supportsPix)),(a==null?void 0:a.supportsCreditCard)!==void 0&&(s=s.eq("supportsCreditCard",a.supportsCreditCard));const{data:t,error:n}=await s;if(n)throw n;return t}catch(s){throw console.error("Error listing gateways:",s),s}},async getById(a){try{const{data:s,error:t}=await y.from("Gateway").select("*").eq("id",a).single();if(t)throw t;return s}catch(s){throw console.error("Error getting gateway:",s),s}},async getBySlug(a){try{const{data:s,error:t}=await y.from("Gateway").select("*").eq("slug",a).single();if(t)throw t;return s}catch(s){throw console.error("Error getting gateway by slug:",s),s}},async listPopular(){try{const{data:a,error:s}=await y.from("Gateway").select("*").eq("isActive",!0).eq("isPopular",!0).order("name",{ascending:!0});if(s)throw s;return a}catch(a){throw console.error("Error listing popular gateways:",a),a}}};class le extends Error{constructor(t){super(t.message);h(this,"type");h(this,"userMessage");h(this,"details");h(this,"code");h(this,"statusCode");h(this,"retryable");this.name="CustomError",this.type=t.type,this.userMessage=t.userMessage,this.details=t.details,this.code=t.code,this.statusCode=t.statusCode||500,this.retryable=t.retryable||!1}}function O(a){var s,t,n;return a!=null&&a.code?de(a):a!=null&&a.response?ue(a):(s=a==null?void 0:a.message)!=null&&s.includes("fetch")||(t=a==null?void 0:a.message)!=null&&t.includes("network")?{type:"NETWORK_ERROR",message:a.message,userMessage:"Erro de conexÃ£o. Verifique sua internet.",retryable:!0}:(n=a==null?void 0:a.message)!=null&&n.includes("timeout")?{type:"TIMEOUT",message:a.message,userMessage:"A operaÃ§Ã£o demorou muito. Tente novamente.",retryable:!0}:a instanceof le?{type:a.type,message:a.message,userMessage:a.userMessage,details:a.details,code:a.code,statusCode:a.statusCode,retryable:a.retryable}:{type:"UNKNOWN_ERROR",message:(a==null?void 0:a.message)||"Erro desconhecido",userMessage:"Algo deu errado. Tente novamente.",details:a,retryable:!1}}function de(a){const s=a.code,t=a.message||"";return s==="PGRST301"||t.includes("JWT")?{type:"SESSION_EXPIRED",message:t,userMessage:"Sua sessÃ£o expirou. FaÃ§a login novamente.",code:s,statusCode:401,retryable:!1}:s==="PGRST116"||t.includes("not found")?{type:"NOT_FOUND",message:t,userMessage:"Registro nÃ£o encontrado.",code:s,statusCode:404,retryable:!1}:s==="23505"||t.includes("duplicate")||t.includes("already exists")?{type:"DUPLICATE_ENTRY",message:t,userMessage:"Este registro jÃ¡ existe.",code:s,statusCode:409,retryable:!1}:t.includes("permission denied")||t.includes("RLS")?{type:"FORBIDDEN",message:t,userMessage:"VocÃª nÃ£o tem permissÃ£o para esta aÃ§Ã£o.",code:s,statusCode:403,retryable:!1}:{type:"DATABASE_ERROR",message:t,userMessage:"Erro ao acessar o banco de dados.",code:s,statusCode:500,retryable:!0}}function ue(a){var m,d;const s=(m=a.response)==null?void 0:m.status,t=(d=a.response)==null?void 0:d.data,n=(t==null?void 0:t.message)||(t==null?void 0:t.error)||a.message;switch(s){case 400:return{type:"VALIDATION_ERROR",message:n,userMessage:"Dados invÃ¡lidos. Verifique os campos.",statusCode:400,details:t,retryable:!1};case 401:return{type:"UNAUTHORIZED",message:n,userMessage:"VocÃª precisa fazer login.",statusCode:401,retryable:!1};case 403:return{type:"FORBIDDEN",message:n,userMessage:"VocÃª nÃ£o tem permissÃ£o para esta aÃ§Ã£o.",statusCode:403,retryable:!1};case 404:return{type:"NOT_FOUND",message:n,userMessage:"Recurso nÃ£o encontrado.",statusCode:404,retryable:!1};case 409:return{type:"DUPLICATE_ENTRY",message:n,userMessage:"Este registro jÃ¡ existe.",statusCode:409,retryable:!1};case 429:return{type:"RATE_LIMIT_EXCEEDED",message:n,userMessage:"Muitas requisiÃ§Ãµes. Aguarde um momento.",statusCode:429,retryable:!0};case 500:case 502:case 503:case 504:return{type:"API_ERROR",message:n,userMessage:"Erro no servidor. Tente novamente em alguns instantes.",statusCode:s,retryable:!0};default:return{type:"API_ERROR",message:n,userMessage:"Erro na comunicaÃ§Ã£o com o servidor.",statusCode:s,details:t,retryable:!0}}}class me{constructor(){h(this,"logs",[]);h(this,"maxLogs",100)}log(s,t){const n={timestamp:new Date().toISOString(),type:s.type,message:s.message,userMessage:s.userMessage,details:s.details,code:s.code,statusCode:s.statusCode,userId:t==null?void 0:t.userId,organizationId:t==null?void 0:t.organizationId,url:window.location.href,userAgent:navigator.userAgent};this.logs.unshift(n),this.logs.length>this.maxLogs&&(this.logs=this.logs.slice(0,this.maxLogs)),this.sendToSentry(n)}getLogs(s=20){return this.logs.slice(0,s)}clear(){this.logs=[]}sendToSentry(s){z("error_details",{type:s.type,code:s.code,statusCode:s.statusCode,url:s.url}),B(s.userMessage,"error",{type:s.type,code:s.code,statusCode:s.statusCode});const t=new Error(s.message);t.name=s.type,V(t,{type:s.type,code:s.code,statusCode:s.statusCode,userMessage:s.userMessage,details:s.details,userId:s.userId,organizationId:s.organizationId,url:s.url})}}const pe=new me;function ge(a,s){const t=O(a);return pe.log(t,s),t}async function he(a,s={}){const{maxRetries:t=3,delayMs:n=1e3,backoff:m=!0}=s;let d;for(let g=0;g<=t;g++)try{return await a()}catch(x){if(d=x,!O(x).retryable)throw x;if(g===t)break;const c=m?n*Math.pow(2,g):n;await new Promise(u=>setTimeout(u,c)),console.log(`ðŸ”„ Retry attempt ${g+1}/${t}`)}throw d}function xe(){const{toast:a}=W(),{user:s,organization:t}=U(),n=p.useCallback((i,c)=>{const u=ge(i,{userId:s==null?void 0:s.id,organizationId:t==null?void 0:t.id});return a({title:"Erro",description:c||u.userMessage,variant:"destructive"}),u},[a,s,t]),m=p.useCallback(i=>{a({title:"Sucesso",description:i})},[a]),d=p.useCallback(i=>{a({title:"AtenÃ§Ã£o",description:i,variant:"default"})},[a]),g=p.useCallback(i=>{a({title:"InformaÃ§Ã£o",description:i})},[a]),x=p.useCallback(async(i,c)=>{try{const E=await(c!=null&&c.retry?()=>he(i,c.retry):i)();return c!=null&&c.successMessage&&m(c.successMessage),E}catch(u){return n(u,c==null?void 0:c.errorMessage),null}},[n,m]);return{showError:n,showSuccess:m,showWarning:d,showInfo:g,executeWithErrorHandling:x}}const G=[{value:"stripe",label:"Stripe",icon:"ðŸ’³"},{value:"mercadopago",label:"Mercado Pago",icon:"ðŸ‡§ðŸ‡·"},{value:"pagseguro",label:"PagSeguro",icon:"ðŸ”’"},{value:"paypal",label:"PayPal",icon:"ðŸ…¿ï¸"},{value:"asaas",label:"Asaas",icon:"ðŸ’°"}];function Ge(){const{showError:a,executeWithErrorHandling:s}=xe(),[t,n]=p.useState([]),[m,d]=p.useState(!1),[g,x]=p.useState(!0),[i,c]=p.useState({name:"",provider:"",publicKey:"",secretKey:""});p.useEffect(()=>{u()},[]);const u=async()=>{x(!0);const r=await s(async()=>{const l=await oe.list();return await Promise.all(l.map(async o=>{var M,I;try{const{count:q}=await y.from("Transaction").select("*",{count:"exact",head:!0}).eq("gatewayId",o.id);return{id:o.id,name:o.name,provider:o.type,publicKey:((M=o.apiKey)==null?void 0:M.slice(0,20))+"***"||"N/A",isActive:o.isActive,createdAt:o.createdAt,transactionsCount:q||0}}catch{return{id:o.id,name:o.name,provider:o.type,publicKey:((I=o.apiKey)==null?void 0:I.slice(0,20))+"***"||"N/A",isActive:o.isActive,createdAt:o.createdAt,transactionsCount:0}}}))},{errorMessage:"NÃ£o foi possÃ­vel carregar os gateways"});r&&n(r),x(!1)},E=async()=>{if(!i.name||!i.provider||!i.publicKey||!i.secretKey){a(new Error("Campos obrigatÃ³rios"),"Preencha todos os campos");return}await s(async()=>{const{data:l,error:b}=await y.from("Gateway").insert({name:i.name,type:i.provider,apiKey:i.publicKey,secretKey:i.secretKey,isActive:!0,createdAt:new Date().toISOString()}).select().single();if(b)throw b;return l},{successMessage:`${i.name} foi configurado com sucesso.`,errorMessage:"NÃ£o foi possÃ­vel adicionar o gateway"})&&(d(!1),c({name:"",provider:"",publicKey:"",secretKey:""}),u())},k=async(r,l)=>{await s(async()=>{const{error:o}=await y.from("Gateway").update({isActive:l,updatedAt:new Date().toISOString()}).eq("id",r);if(o)throw o;return!0},{successMessage:l?"Gateway ativado":"Gateway desativado",errorMessage:"NÃ£o foi possÃ­vel atualizar o status"})&&u()},_=r=>G.find(l=>l.value===r)||{label:r,icon:"ðŸ’³"},A={total:t.length,active:t.filter(r=>r.isActive).length,totalTransactions:t.reduce((r,l)=>r+(l.transactionsCount||0),0)};return g?e.jsx(P,{children:e.jsx("div",{className:"flex items-center justify-center min-h-[50vh]",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})})}):e.jsx(P,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white",children:"Gateways de Pagamento"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"Gerencie os meios de recebimento dos clientes"})]}),e.jsxs(X,{open:m,onOpenChange:d,children:[e.jsx(Y,{asChild:!0,children:e.jsxs(f,{className:"bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600",children:[e.jsx(D,{className:"h-4 w-4 mr-2"}),"Adicionar Gateway"]})}),e.jsxs(J,{className:"sm:max-w-[500px]",children:[e.jsxs(Z,{children:[e.jsx(Q,{children:"Adicionar Gateway de Pagamento"}),e.jsx(ee,{children:"Configure um novo meio de recebimento"})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(C,{htmlFor:"name",children:"Nome do Gateway"}),e.jsx(S,{id:"name",placeholder:"Ex: Stripe Principal",value:i.name,onChange:r=>c({...i,name:r.target.value})})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(C,{htmlFor:"provider",children:"Provider"}),e.jsxs(ae,{value:i.provider,onValueChange:r=>c({...i,provider:r}),children:[e.jsx(te,{children:e.jsx(re,{placeholder:"Selecione um provider"})}),e.jsx(ie,{children:G.map(r=>e.jsx(ne,{value:r.value,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:r.icon}),e.jsx("span",{children:r.label})]})},r.value))})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(C,{htmlFor:"publicKey",children:"Public Key"}),e.jsx(S,{id:"publicKey",placeholder:"pk_test_...",value:i.publicKey,onChange:r=>c({...i,publicKey:r.target.value})})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(C,{htmlFor:"secretKey",children:"Secret Key"}),e.jsx(S,{id:"secretKey",type:"password",placeholder:"sk_test_...",value:i.secretKey,onChange:r=>c({...i,secretKey:r.target.value})}),e.jsx("p",{className:"text-xs text-gray-500",children:"Esta chave serÃ¡ armazenada de forma segura e criptografada"})]})]}),e.jsxs(se,{children:[e.jsx(f,{variant:"outline",onClick:()=>d(!1),children:"Cancelar"}),e.jsx(f,{className:"bg-gradient-to-r from-blue-500 to-purple-500",onClick:E,children:"Adicionar Gateway"})]})]})]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsxs(j,{children:[e.jsxs(w,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(N,{className:"text-sm font-medium",children:"Gateways Configurados"}),e.jsx(K,{className:"h-4 w-4 text-blue-600"})]}),e.jsxs(v,{children:[e.jsx("div",{className:"text-2xl font-bold",children:A.total}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Total de meios de pagamento"})]})]}),e.jsxs(j,{children:[e.jsxs(w,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(N,{className:"text-sm font-medium",children:"Gateways Ativos"}),e.jsx(R,{className:"h-4 w-4 text-green-600"})]}),e.jsxs(v,{children:[e.jsx("div",{className:"text-2xl font-bold",children:A.active}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Recebendo pagamentos"})]})]}),e.jsxs(j,{children:[e.jsxs(w,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(N,{className:"text-sm font-medium",children:"TransaÃ§Ãµes"}),e.jsx(T,{className:"h-4 w-4 text-purple-600"})]}),e.jsxs(v,{children:[e.jsx("div",{className:"text-2xl font-bold",children:A.totalTransactions}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Total processadas"})]})]})]}),e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:t.length===0?e.jsx(j,{className:"col-span-full",children:e.jsxs(v,{className:"flex flex-col items-center justify-center py-12",children:[e.jsx(K,{className:"h-12 w-12 text-gray-400 mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-white mb-2",children:"Nenhum gateway configurado"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mb-4",children:"Adicione seu primeiro gateway de pagamento"}),e.jsxs(f,{className:"bg-gradient-to-r from-blue-500 to-purple-500",onClick:()=>d(!0),children:[e.jsx(D,{className:"h-4 w-4 mr-2"}),"Adicionar Gateway"]})]})}):t.map(r=>{const l=_(r.provider);return e.jsxs(j,{className:"relative overflow-hidden",children:[e.jsx("div",{className:`absolute top-0 right-0 w-32 h-32 transform translate-x-16 -translate-y-16 rounded-full ${r.isActive?"bg-green-500/10":"bg-gray-500/10"}`}),e.jsx(w,{children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"text-3xl",children:l.icon}),e.jsxs("div",{children:[e.jsx(N,{className:"text-lg",children:r.name}),e.jsx(H,{children:l.label})]})]}),e.jsx($,{variant:r.isActive?"default":"outline",children:r.isActive?"Ativo":"Inativo"})]})}),e.jsxs(v,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Public Key"}),e.jsx("code",{className:"text-xs bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded block overflow-hidden text-ellipsis",children:r.publicKey})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-gray-500",children:"TransaÃ§Ãµes"}),e.jsx("span",{className:"font-medium",children:r.transactionsCount||0})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(f,{variant:"outline",className:"flex-1",size:"sm",onClick:()=>{},children:[e.jsx(T,{className:"h-4 w-4 mr-1"}),"Configurar"]}),e.jsx(f,{variant:r.isActive?"destructive":"default",size:"sm",onClick:()=>k(r.id,!r.isActive),children:r.isActive?e.jsx(ce,{className:"h-4 w-4"}):e.jsx(R,{className:"h-4 w-4"})})]})]})]},r.id)})})]})})}export{Ge as default};

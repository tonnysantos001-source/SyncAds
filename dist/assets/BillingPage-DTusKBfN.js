import{d as X,r as m,s as F,j as e,O as Y,e as N,f as b,g as S,aa as Z,i as v,ak as $,a9 as ee,au as M,B as A,ac as se,at as ae,I as te,o as P}from"./index-DB1lyyic.js";import{T as D,a as V,b as h,c as l,d as U,e as t}from"./table-D7NWkaoR.js";import{S as re}from"./SuperAdminLayout-BTy8AnuX.js";import{S as le,a as ne,b as ce,c as ie,d as x}from"./select-B3kWVwj5.js";import{f as de,p as oe}from"./pt-BR-BQ5kKd2v.js";import"./index-_7OXcJ15.js";import"./constructFrom-rJN6zrQ_.js";function fe(){const{toast:G}=X(),[T,I]=m.useState(!0),[u,_]=m.useState(""),[p,z]=m.useState("all"),[j,R]=m.useState("subscriptions"),[O,q]=m.useState([]),[J,K]=m.useState([]),[f,Q]=m.useState({totalRevenue:0,monthlyRevenue:0,activeSubscriptions:0,totalInvoices:0,paidInvoices:0,pendingInvoices:0});m.useEffect(()=>{W()},[]);const W=async()=>{try{I(!0);const{data:s,error:n}=await F.from("Subscription").select(`
          *,
          user:userId (id, name, email),
          plan:planId (id, name, price, maxAiMessages)
        `).order("createdAt",{ascending:!1});if(n)throw n;const{data:a,error:c}=await F.from("Invoice").select(`
          *,
          user:userId (name, email)
        `).order("createdAt",{ascending:!1});if(c)throw c;q(s||[]),K(a||[]);const i=(s||[]).filter(r=>r.status==="active").length,d=(s||[]).filter(r=>r.status==="active").reduce((r,k)=>{var E;return r+(((E=k.plan)==null?void 0:E.price)||0)},0),o=(a||[]).filter(r=>r.status==="paid").length,g=(a||[]).filter(r=>r.status==="open"||r.status==="draft").length,C=(a||[]).filter(r=>r.status==="paid").reduce((r,k)=>r+k.amount,0);Q({totalRevenue:C,monthlyRevenue:d,activeSubscriptions:i,totalInvoices:(a==null?void 0:a.length)||0,paidInvoices:o,pendingInvoices:g})}catch(s){console.error("Error loading billing data:",s),G({title:"Erro ao carregar dados",description:"Não foi possível carregar os dados de faturamento.",variant:"destructive"})}finally{I(!1)}},y=s=>new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(s),w=s=>s?de(new Date(s),"dd/MM/yyyy",{locale:oe}):"-",L=s=>{const a={active:{label:"Ativa",className:"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200"},trialing:{label:"Trial",className:"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200"},past_due:{label:"Atrasada",className:"bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200"},canceled:{label:"Cancelada",className:"bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200"},paid:{label:"Paga",className:"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200"},open:{label:"Aberta",className:"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200"},draft:{label:"Rascunho",className:"bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200"},void:{label:"Cancelada",className:"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200"}}[s]||{label:s,className:"bg-gray-100 text-gray-800"};return e.jsx(P,{className:a.className,children:a.label})},B=O.filter(s=>{var c,i,d,o,g,C;const n=((i=(c=s.user)==null?void 0:c.name)==null?void 0:i.toLowerCase().includes(u.toLowerCase()))||((o=(d=s.user)==null?void 0:d.email)==null?void 0:o.toLowerCase().includes(u.toLowerCase()))||((C=(g=s.plan)==null?void 0:g.name)==null?void 0:C.toLowerCase().includes(u.toLowerCase())),a=p==="all"||s.status===p;return n&&a}),H=J.filter(s=>{var c,i,d,o,g;const n=((i=(c=s.user)==null?void 0:c.name)==null?void 0:i.toLowerCase().includes(u.toLowerCase()))||((o=(d=s.user)==null?void 0:d.email)==null?void 0:o.toLowerCase().includes(u.toLowerCase()))||((g=s.invoiceNumber)==null?void 0:g.toLowerCase().includes(u.toLowerCase())),a=p==="all"||s.status===p;return n&&a});return e.jsx(re,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs(Y.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},children:[e.jsx("h1",{className:"text-3xl font-bold bg-gradient-to-r from-green-400 to-emerald-400 bg-clip-text text-transparent",children:"Faturamento"}),e.jsx("p",{className:"text-gray-400 mt-1",children:"Gerencie assinaturas e faturas dos clientes"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[e.jsxs(N,{children:[e.jsxs(b,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(S,{className:"text-sm font-medium",children:"Receita Total"}),e.jsx(Z,{className:"h-4 w-4 text-green-600"})]}),e.jsxs(v,{children:[e.jsx("div",{className:"text-2xl font-bold",children:y(f.totalRevenue)}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[f.paidInvoices," faturas pagas"]})]})]}),e.jsxs(N,{children:[e.jsxs(b,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(S,{className:"text-sm font-medium",children:"MRR"}),e.jsx($,{className:"h-4 w-4 text-blue-600"})]}),e.jsxs(v,{children:[e.jsx("div",{className:"text-2xl font-bold",children:y(f.monthlyRevenue)}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Receita mensal recorrente"})]})]}),e.jsxs(N,{children:[e.jsxs(b,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(S,{className:"text-sm font-medium",children:"Assinaturas Ativas"}),e.jsx(ee,{className:"h-4 w-4 text-purple-600"})]}),e.jsxs(v,{children:[e.jsx("div",{className:"text-2xl font-bold",children:f.activeSubscriptions}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Clientes com planos ativos"})]})]}),e.jsxs(N,{children:[e.jsxs(b,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(S,{className:"text-sm font-medium",children:"Faturas Pendentes"}),e.jsx(M,{className:"h-4 w-4 text-orange-600"})]}),e.jsxs(v,{children:[e.jsx("div",{className:"text-2xl font-bold",children:f.pendingInvoices}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Aguardando pagamento"})]})]})]}),e.jsxs(N,{children:[e.jsx(b,{children:e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(A,{variant:j==="subscriptions"?"default":"outline",onClick:()=>R("subscriptions"),className:j==="subscriptions"?"bg-pink-600 hover:bg-pink-700":"",children:[e.jsx(se,{className:"h-4 w-4 mr-2"}),"Assinaturas"]}),e.jsxs(A,{variant:j==="invoices"?"default":"outline",onClick:()=>R("invoices"),className:j==="invoices"?"bg-pink-600 hover:bg-pink-700":"",children:[e.jsx(M,{className:"h-4 w-4 mr-2"}),"Faturas"]})]}),e.jsxs("div",{className:"flex gap-2 w-full sm:w-auto",children:[e.jsx("div",{className:"relative flex-1 sm:w-64",children:e.jsxs("div",{className:"relative",children:[e.jsx(ae,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400"}),e.jsx(te,{placeholder:"Buscar...",value:u,onChange:s=>_(s.target.value),className:"pl-10 bg-gray-800 border-gray-700 text-white placeholder:text-gray-500"})]})}),e.jsxs(le,{value:p,onValueChange:z,children:[e.jsx(ne,{className:"w-32",children:e.jsx(ce,{placeholder:"Status"})}),e.jsxs(ie,{children:[e.jsx(x,{value:"all",children:"Todos"}),j==="subscriptions"?e.jsxs(e.Fragment,{children:[e.jsx(x,{value:"active",children:"Ativa"}),e.jsx(x,{value:"trialing",children:"Trial"}),e.jsx(x,{value:"canceled",children:"Cancelada"}),e.jsx(x,{value:"past_due",children:"Atrasada"})]}):e.jsxs(e.Fragment,{children:[e.jsx(x,{value:"paid",children:"Paga"}),e.jsx(x,{value:"open",children:"Aberta"}),e.jsx(x,{value:"draft",children:"Rascunho"}),e.jsx(x,{value:"void",children:"Cancelada"})]})]})]})]})]})}),e.jsx(v,{children:j==="subscriptions"?e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(D,{children:[e.jsx(V,{children:e.jsxs(h,{children:[e.jsx(l,{children:"Cliente"}),e.jsx(l,{children:"Plano"}),e.jsx(l,{children:"Valor"}),e.jsx(l,{children:"Status"}),e.jsx(l,{children:"Uso IA"}),e.jsx(l,{children:"Renovação"}),e.jsx(l,{children:"Criado em"})]})}),e.jsx(U,{children:T?e.jsx(h,{children:e.jsx(t,{colSpan:7,className:"text-center py-8 text-gray-500",children:"Carregando..."})}):B.length===0?e.jsx(h,{children:e.jsx(t,{colSpan:7,className:"text-center py-8 text-gray-500",children:"Nenhuma assinatura encontrada"})}):B.map(s=>{var n,a,c,i,d,o;return e.jsxs(h,{children:[e.jsx(t,{children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-white",children:((n=s.user)==null?void 0:n.name)||"N/A"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:((a=s.user)==null?void 0:a.email)||"N/A"})]})}),e.jsx(t,{children:e.jsx(P,{variant:"outline",children:((c=s.plan)==null?void 0:c.name)||"N/A"})}),e.jsxs(t,{className:"font-semibold",children:[y(((i=s.plan)==null?void 0:i.price)||0),"/mês"]}),e.jsx(t,{children:L(s.status)}),e.jsx(t,{children:e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:s.usedAiMessages}),e.jsxs("span",{className:"text-gray-500",children:[" ","/"," ",((d=s.plan)==null?void 0:d.maxAiMessages)===0?"∞":(o=s.plan)==null?void 0:o.maxAiMessages]})]})}),e.jsx(t,{className:"text-sm",children:w(s.currentPeriodEnd)}),e.jsx(t,{className:"text-sm text-gray-600 dark:text-gray-400",children:w(s.createdAt)})]},s.id)})})]})}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(D,{children:[e.jsx(V,{children:e.jsxs(h,{children:[e.jsx(l,{children:"Fatura"}),e.jsx(l,{children:"Cliente"}),e.jsx(l,{children:"Valor"}),e.jsx(l,{children:"Status"}),e.jsx(l,{children:"Pago em"}),e.jsx(l,{children:"Criado em"}),e.jsx(l,{className:"text-right",children:"Ações"})]})}),e.jsx(U,{children:T?e.jsx(h,{children:e.jsx(t,{colSpan:7,className:"text-center py-8 text-gray-500",children:"Carregando..."})}):H.length===0?e.jsx(h,{children:e.jsx(t,{colSpan:7,className:"text-center py-8 text-gray-500",children:"Nenhuma fatura encontrada"})}):H.map(s=>{var n,a;return e.jsxs(h,{children:[e.jsx(t,{className:"font-medium",children:s.invoiceNumber}),e.jsx(t,{children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-white",children:((n=s.user)==null?void 0:n.name)||"N/A"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:((a=s.user)==null?void 0:a.email)||"N/A"})]})}),e.jsx(t,{className:"font-semibold",children:y(s.amount)}),e.jsx(t,{children:L(s.status)}),e.jsx(t,{className:"text-sm",children:w(s.paidAt)}),e.jsx(t,{className:"text-sm text-gray-600 dark:text-gray-400",children:w(s.createdAt)}),e.jsx(t,{className:"text-right",children:e.jsx(A,{variant:"ghost",size:"icon",children:e.jsx(Download,{className:"h-4 w-4"})})})]},s.id)})})]})})})]})]})})}export{fe as default};

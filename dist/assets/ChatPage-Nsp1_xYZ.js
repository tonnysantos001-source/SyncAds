import{j as e}from"./vendor-ui-DkUuACDy.js";import{f as t,r as s}from"./vendor-react-X41Bjl18.js";import{g as r,f as a,i,s as n}from"./index-Dn321sY6.js";import{I as o,a as c,b as l}from"./IconSend-B14rwnjE.js";import"./vendor-supabase-BQxDPPjR.js";import"./vendor-utils-Dl0_yMKq.js";import"./vendor-animation-DQ3cvw6m.js";import"./vendor-query-Bf3pI66S.js";import"./vendor-icons-DTdRnryx.js";function d(){const d=t(),{toast:m}=r(),h=a(e=>e.user),u=a(e=>e.isAuthenticated),[x,g]=s.useState([]),[f,v]=s.useState(null),[p,j]=s.useState(""),[y,b]=s.useState(!1),[w,N]=s.useState(!1),[C,S]=s.useState(!0),I=s.useRef(null);s.useEffect(()=>{u&&h||d("/login-v2",{replace:!0})},[u,h,d]),s.useEffect(()=>{if(!h)return;(async()=>{b(!0);try{const{data:e,error:t}=await n.from("ChatConversation").select("id, title, createdAt").eq("userId",h.id).order("createdAt",{ascending:!1});if(t)throw t;if(!e||0===e.length)return void(await A());const s=await Promise.all(e.map(async e=>{const{data:t}=await n.from("ChatMessage").select("id, role, content, createdAt").eq("conversationId",e.id).order("createdAt",{ascending:!0});return{id:e.id,title:e.title,messages:(t||[]).map(e=>({id:e.id,role:e.role.toLowerCase(),content:e.content,createdAt:e.createdAt}))}}));g(s),!f&&s.length>0&&v(s[0].id)}catch(e){m({title:"Erro",description:"Não foi possível carregar as conversas",variant:"destructive"})}finally{b(!1)}})()},[h]),s.useEffect(()=>{I.current?.scrollIntoView({behavior:"smooth"})},[x,f]);const A=async()=>{if(h)try{const e={id:crypto.randomUUID(),userId:h.id,title:`Conversa ${(new Date).toLocaleDateString()}`,createdAt:(new Date).toISOString()},{error:t}=await n.from("ChatConversation").insert(e);if(t)throw t;const s={id:e.id,title:e.title,messages:[]};g([s,...x]),v(e.id),m({title:"Nova conversa criada!"})}catch(e){m({title:"Erro",description:"Não foi possível criar nova conversa",variant:"destructive"})}},E=async()=>{if(!p.trim()||!f||!h||w)return;const e=p.trim();j(""),N(!0);try{const t={id:crypto.randomUUID(),conversationId:f,userId:h.id,role:"USER",content:e,createdAt:(new Date).toISOString()},{error:s}=await n.from("ChatMessage").insert(t);if(s)throw s;g(e=>e.map(e=>e.id===f?{...e,messages:[...e.messages,{id:t.id,role:"user",content:t.content,createdAt:t.createdAt}]}:e));const{data:{session:r}}=await n.auth.getSession();if(!r)throw new Error("Sem sessão");const a=await fetch("https://your-project.supabase.co/functions/v1/chat-enhanced",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r.access_token}`},body:JSON.stringify({message:e,conversationId:f})});if(!a.ok)throw new Error(`Erro HTTP: ${a.status}`);const i=await a.json();if(i.error)throw new Error(i.error);const o={id:crypto.randomUUID(),conversationId:f,userId:h.id,role:"ASSISTANT",content:i.response||"Desculpe, não consegui gerar uma resposta.",createdAt:(new Date).toISOString()},{error:c}=await n.from("ChatMessage").insert(o);if(c)throw c;g(e=>e.map(e=>e.id===f?{...e,messages:[...e.messages,{id:o.id,role:"assistant",content:o.content,createdAt:o.createdAt}]}:e))}catch(t){m({title:"Erro ao enviar mensagem",description:t.message||"Tente novamente",variant:"destructive"})}finally{N(!1)}},D=x.find(e=>e.id===f);return e.jsxs("div",{className:"flex h-screen bg-gray-950 text-white",children:[e.jsx("div",{className:(C?"w-80":"w-0")+" transition-all duration-300 border-r border-gray-800 flex flex-col",children:C&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"p-4 border-b border-gray-800",children:e.jsxs("button",{onClick:A,className:"w-full flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg transition-colors",children:[e.jsx(o,{className:"w-5 h-5"}),"Nova Conversa"]})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-2",children:y?e.jsx("div",{className:"text-center text-gray-500 py-4",children:"Carregando..."}):x.map(t=>e.jsxs("div",{onClick:()=>v(t.id),className:"p-3 mb-2 rounded-lg cursor-pointer transition-colors "+(f===t.id?"bg-gray-800 border border-blue-600":"bg-gray-900 hover:bg-gray-800"),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm truncate",children:t.title}),e.jsx("button",{onClick:e=>{e.stopPropagation(),(async e=>{try{const{error:t}=await n.from("ChatConversation").delete().eq("id",e);if(t)throw t;g(t=>t.filter(t=>t.id!==e)),f===e&&v(x[0]?.id||null),m({title:"Conversa deletada"})}catch(t){m({title:"Erro ao deletar",variant:"destructive"})}})(t.id)},className:"text-gray-500 hover:text-red-500",children:e.jsx(i,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[t.messages.length," mensagens"]})]},t.id))})]})}),e.jsxs("div",{className:"flex-1 flex flex-col",children:[e.jsxs("div",{className:"h-16 border-b border-gray-800 flex items-center px-4 justify-between",children:[e.jsx("button",{onClick:()=>S(!C),className:"p-2 hover:bg-gray-800 rounded-lg",children:e.jsx(c,{className:"w-6 h-6"})}),e.jsx("h1",{className:"text-lg font-semibold",children:D?.title||"Chat"}),e.jsx("div",{className:"w-10"})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:D?0===D.messages.length?e.jsx("div",{className:"flex items-center justify-center h-full text-gray-500",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xl mb-2",children:"Nova conversa"}),e.jsx("p",{className:"text-sm",children:"Envie uma mensagem para começar"})]})}):e.jsxs(e.Fragment,{children:[D.messages.map(t=>e.jsx("div",{className:"flex "+("user"===t.role?"justify-end":"justify-start"),children:e.jsx("div",{className:"max-w-[70%] rounded-lg p-4 "+("user"===t.role?"bg-blue-600":"bg-gray-800"),children:e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:t.content})})},t.id)),e.jsx("div",{ref:I})]}):e.jsx("div",{className:"flex items-center justify-center h-full text-gray-500",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xl mb-2",children:"Nenhuma conversa selecionada"}),e.jsx("p",{className:"text-sm",children:"Crie uma nova conversa para começar"})]})})}),e.jsx("div",{className:"border-t border-gray-800 p-4",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:p,onChange:e=>j(e.target.value),onKeyPress:e=>"Enter"===e.key&&!e.shiftKey&&E(),placeholder:"Digite sua mensagem...",disabled:w||!f,className:"flex-1 bg-gray-900 border border-gray-800 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-600 disabled:opacity-50"}),e.jsx("button",{onClick:E,disabled:!p.trim()||w||!f,className:"bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-white px-6 py-3 rounded-lg transition-colors flex items-center gap-2",children:w?e.jsx("span",{children:"Enviando..."}):e.jsxs(e.Fragment,{children:[e.jsx(l,{className:"w-5 h-5"}),"Enviar"]})})]})})]})]})}export{d as default};

import{j as e}from"./vendor-ui-D3JNL6pE.js";import{r as t}from"./vendor-react-X41Bjl18.js";import{s as a,g as s,f as i,B as r,I as o,C as n,a as l,b as c,c as d,e as u}from"./index-DY7iJmhQ.js";import{S as m}from"./switch-DaQXnPQ5.js";import{T as p,a as h,b as g,c as x,d as y,e as v}from"./table-5Gcl5TCK.js";import{D as j,e as f,a as b,b as C,c as N,f as A}from"./dialog-D2m9FeVF.js";import{L as w}from"./label-CQ2CWsqm.js";import{S,a as k,b as D,c as L,d as E}from"./select-MMy43jsm.js";import{m as R}from"./marketingApi-DBEeWKxE.js";import{a as I}from"./shopifySync-DXP8Lw7v.js";import{S as T}from"./skeleton-BEXizwxg.js";import{m as z}from"./vendor-animation-DtB50Lbk.js";import{R as P,P as F,b0 as _,y as M,Q as U,aU as $,S as q,D as B,W as G,$ as V}from"./vendor-icons-ky0_7qlE.js";import{f as O}from"./vendor-utils-Dl0_yMKq.js";import{p as X}from"./pt-BR-BbSwNUOy.js";import"./vendor-supabase-HUq0BeMy.js";import"./vendor-query-DqG_mm-v.js";const H={async listFromShopify(e,t){try{let s=a.from("ShopifyDiscountCode").select("\n          *,\n          priceRule:ShopifyPriceRule!ShopifyDiscountCode_priceRuleId_fkey(*)\n        ").eq("userId",e).order("updatedAt",{ascending:!1});t?.search&&(s=s.ilike("code",`%${t.search}%`));const{data:i,error:r}=await s;if(r)throw r;let o=(i||[]).map(e=>{const t=e.priceRule,a=new Date,s=t.startsAt?new Date(t.startsAt):null,i=t.endsAt?new Date(t.endsAt):null;let r="active",o=!0;return s&&a<s?(r="scheduled",o=!1):i&&a>i?(r="expired",o=!1):t.usageLimit&&e.usageCount>=t.usageLimit&&(r="exhausted",o=!1),{id:String(e.id),code:e.code,title:t.title,type:"shipping_line"===t.targetType?"free_shipping":"percentage"===t.valueType?"percentage":"fixed_amount",value:parseFloat(t.value),usageCount:e.usageCount||0,usageLimit:t.usageLimit||void 0,startsAt:t.startsAt||void 0,endsAt:t.endsAt||void 0,status:r,isValid:o,metadata:{shopifyId:e.id,priceRuleId:t.id,shopifyData:e.shopifyData,priceRuleData:t.shopifyData,targetType:t.targetType,targetSelection:t.targetSelection,allocationMethod:t.allocationMethod,oncePerCustomer:t.oncePerCustomer},createdAt:e.createdAt,updatedAt:e.updatedAt}});return t?.status&&(o=o.filter(e=>e.status===t.status)),o}catch(s){throw s}},async getByCode(e,t){try{const{data:s,error:i}=await a.from("ShopifyDiscountCode").select("\n          *,\n          priceRule:ShopifyPriceRule!ShopifyDiscountCode_priceRuleId_fkey(*)\n        ").eq("userId",e).ilike("code",t).single();if(i)return null;if(!s)return null;const r=s.priceRule,o=new Date,n=r.startsAt?new Date(r.startsAt):null,l=r.endsAt?new Date(r.endsAt):null;let c="active",d=!0;return n&&o<n?(c="scheduled",d=!1):l&&o>l?(c="expired",d=!1):r.usageLimit&&s.usageCount>=r.usageLimit&&(c="exhausted",d=!1),{id:String(s.id),code:s.code,title:r.title,type:"shipping_line"===r.targetType?"free_shipping":"percentage"===r.valueType?"percentage":"fixed_amount",value:parseFloat(r.value),usageCount:s.usageCount||0,usageLimit:r.usageLimit||void 0,startsAt:r.startsAt||void 0,endsAt:r.endsAt||void 0,status:c,isValid:d,metadata:{shopifyId:s.id,priceRuleId:r.id,shopifyData:s.shopifyData,priceRuleData:r.shopifyData,targetType:r.targetType,targetSelection:r.targetSelection,allocationMethod:r.allocationMethod,oncePerCustomer:r.oncePerCustomer},createdAt:s.createdAt,updatedAt:s.updatedAt}}catch(s){return null}},async validateCode(e,t){try{const a=await this.getByCode(e,t);if(!a)return{valid:!1,reason:"Código não encontrado"};if(!a.isValid){if("scheduled"===a.status)return{valid:!1,reason:"Código ainda não está ativo"};if("expired"===a.status)return{valid:!1,reason:"Código expirado"};if("exhausted"===a.status)return{valid:!1,reason:"Código atingiu limite de uso"}}return{valid:!0,discount:a}}catch(a){return{valid:!1,reason:"Erro ao validar código"}}},calculateDiscount(e,t,a=0){if(!e.isValid)return 0;const s=e.metadata||{};if("free_shipping"===e.type)return a;const i="shipping_line"===s.targetType?a:t;if("percentage"===e.type){const t=i*e.value/100;return Math.min(t,i)}return Math.min(e.value,i)},async getStats(e){try{const{data:t,error:s}=await a.from("ShopifyDiscountCode").select("\n          usageCount,\n          priceRule:ShopifyPriceRule!ShopifyDiscountCode_priceRuleId_fkey(usageLimit, startsAt, endsAt)\n        ").eq("userId",e);if(s)throw s;const i=new Date;let r=0,o=0,n=0,l=0,c=0;return(t||[]).forEach(e=>{const t=e.priceRule,a=t.startsAt?new Date(t.startsAt):null,s=t.endsAt?new Date(t.endsAt):null;c+=e.usageCount||0,a&&i<a?o++:s&&i>s?n++:t.usageLimit&&e.usageCount>=t.usageLimit?l++:r++}),{total:t?.length||0,active:r,scheduled:o,expired:n,exhausted:l,totalUsage:c}}catch(t){return{total:0,active:0,scheduled:0,expired:0,exhausted:0,totalUsage:0}}},async count(e){try{const{count:t,error:s}=await a.from("ShopifyDiscountCode").select("*",{count:"exact",head:!0}).eq("userId",e);if(s)throw s;return t||0}catch(t){return 0}},async incrementUsage(e,t){try{const s=await this.getByCode(e,t);if(!s||!s.isValid)return!1;const{error:i}=await a.from("ShopifyDiscountCode").update({usageCount:(s.usageCount||0)+1,updatedAt:(new Date).toISOString()}).eq("id",s.id);if(i)throw i;return!0}catch(s){return!1}}},Q=({title:t,value:a,icon:s,color:i,delay:r=0,subtitle:o})=>e.jsx(z.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:r},children:e.jsxs(n,{className:"relative overflow-hidden border-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl shadow-lg hover:shadow-xl transition-all duration-300",children:[e.jsx("div",{className:`absolute top-0 right-0 w-32 h-32 ${i} opacity-10 rounded-full blur-3xl`}),e.jsxs(l,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(c,{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:t}),e.jsx("div",{className:`p-2 rounded-lg ${i} bg-opacity-10`,children:e.jsx(s,{className:`h-5 w-5 ${i.replace("bg-","text-")}`})})]}),e.jsxs(d,{children:[e.jsx("div",{className:"text-3xl font-bold bg-gradient-to-br from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent",children:a}),o&&e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:o})]})]})}),W=()=>{const[a,W]=t.useState([]),[J,K]=t.useState([]),[Y,Z]=t.useState(!0),[ee,te]=t.useState(!1),[ae,se]=t.useState(""),[ie,re]=t.useState(!1),[oe,ne]=t.useState(null),{toast:le}=s(),ce=i(e=>e.user),[de,ue]=t.useState({code:"",name:"",type:"PERCENTAGE",value:0,minPurchaseAmount:0,maxDiscountAmount:0,usageLimit:0,perCustomerLimit:1,startsAt:"",expiresAt:"",isActive:!0});t.useEffect(()=>{ce?.id&&me()},[ce?.id]),t.useEffect(()=>{he()},[ae,a]);const me=async()=>{if(ce?.id)try{Z(!0);const e=await H.listFromShopify(ce.id);W(e),K(e)}catch(e){le({title:"Erro ao carregar cupons",description:e.message,variant:"destructive"})}finally{Z(!1)}else Z(!1)},pe=async()=>{if(ce?.id)try{te(!0),le({title:"Sincronizando...",description:"Buscando descontos da Shopify"});const e=await I.syncDiscounts(ce.id);e.success?(le({title:"Sincronização concluída!",description:e.message}),await me()):le({title:"Erro na sincronização",description:e.message,variant:"destructive"})}catch(e){le({title:"Erro ao sincronizar",description:"Configure a integração Shopify em Integrações",variant:"destructive"})}finally{te(!1)}else le({title:"Erro",description:"Faça login para sincronizar",variant:"destructive"})},he=()=>{if(!ae)return void K(a);const e=a.filter(e=>e.code?.toLowerCase().includes(ae.toLowerCase())||e.name?.toLowerCase().includes(ae.toLowerCase()));K(e)},ge=()=>{ne(null),ue({code:"",name:"",type:"PERCENTAGE",value:0,minPurchaseAmount:0,maxDiscountAmount:0,usageLimit:0,perCustomerLimit:1,startsAt:"",expiresAt:"",isActive:!0})},xe=e=>{return"PERCENTAGE"===e.type?`${e.value}%`:"FIXED_AMOUNT"===e.type?(t=e.value,new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(t)):"Frete Grátis";var t},ye=a.reduce((e,t)=>e+(t.usageCount||0),0),ve=a.filter(e=>e.isActive).length;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(z.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-5xl font-black bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 dark:from-blue-400 dark:via-purple-400 dark:to-pink-400 bg-clip-text text-transparent mb-2",children:"Cupons de Desconto"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-300 font-medium text-lg",children:"Gerencie cupons sincronizados com Shopify"})]}),e.jsxs(z.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},transition:{duration:.5,delay:.2},className:"flex gap-3",children:[e.jsxs(r,{onClick:pe,disabled:ee,variant:"outline",size:"lg",className:"border-2 hover:border-purple-500",children:[e.jsx(P,{className:"mr-2 h-5 w-5 "+(ee?"animate-spin":"")}),ee?"Sincronizando...":"Sincronizar Shopify"]}),e.jsxs(j,{open:ie,onOpenChange:re,children:[e.jsx(f,{asChild:!0,children:e.jsxs(r,{onClick:ge,size:"lg",className:"bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700",children:[e.jsx(F,{className:"mr-2 h-5 w-5"}),"Criar Cupom"]})}),e.jsxs(b,{className:"max-w-2xl bg-white/95 dark:bg-gray-900/95 backdrop-blur-xl",children:[e.jsx(C,{children:e.jsx(N,{className:"text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent",children:oe?"Editar Cupom":"Novo Cupom"})}),e.jsxs("form",{onSubmit:async e=>{e.preventDefault();try{if(!ce?.organizationId)return;oe?(await R.coupons.update(oe.id,de),le({title:"Cupom atualizado!",description:"As alterações foram salvas."})):(await R.coupons.create({...de,organizationId:ce.organizationId,usageCount:0}),le({title:"Cupom criado!",description:"O cupom está pronto para uso."})),re(!1),ge(),me()}catch(t){le({title:"Erro",description:t.message,variant:"destructive"})}},className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(w,{children:"Código *"}),e.jsx(o,{value:de.code,onChange:e=>ue({...de,code:e.target.value.toUpperCase()}),placeholder:"DESCONTO20",className:"mt-1.5",required:!0})]}),e.jsxs("div",{children:[e.jsx(w,{children:"Nome *"}),e.jsx(o,{value:de.name,onChange:e=>ue({...de,name:e.target.value}),placeholder:"Nome do cupom",className:"mt-1.5",required:!0})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(w,{children:"Tipo de Desconto"}),e.jsxs(S,{value:de.type,onValueChange:e=>ue({...de,type:e}),children:[e.jsx(k,{className:"mt-1.5",children:e.jsx(D,{})}),e.jsxs(L,{children:[e.jsx(E,{value:"PERCENTAGE",children:"Percentual (%)"}),e.jsx(E,{value:"FIXED_AMOUNT",children:"Valor Fixo (R$)"}),e.jsx(E,{value:"FREE_SHIPPING",children:"Frete Grátis"})]})]})]}),e.jsxs("div",{children:[e.jsx(w,{children:"Valor"}),e.jsx(o,{type:"number",step:"0.01",value:de.value,onChange:e=>ue({...de,value:parseFloat(e.target.value)}),placeholder:"0.00",className:"mt-1.5",required:!0})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(w,{children:"Compra Mínima (R$)"}),e.jsx(o,{type:"number",step:"0.01",value:de.minPurchaseAmount,onChange:e=>ue({...de,minPurchaseAmount:parseFloat(e.target.value)}),className:"mt-1.5"})]}),e.jsxs("div",{children:[e.jsx(w,{children:"Desconto Máximo (R$)"}),e.jsx(o,{type:"number",step:"0.01",value:de.maxDiscountAmount,onChange:e=>ue({...de,maxDiscountAmount:parseFloat(e.target.value)}),className:"mt-1.5"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(w,{children:"Limite Total de Uso"}),e.jsx(o,{type:"number",value:de.usageLimit,onChange:e=>ue({...de,usageLimit:parseInt(e.target.value)}),placeholder:"0 = ilimitado",className:"mt-1.5"})]}),e.jsxs("div",{children:[e.jsx(w,{children:"Limite por Cliente"}),e.jsx(o,{type:"number",value:de.perCustomerLimit,onChange:e=>ue({...de,perCustomerLimit:parseInt(e.target.value)}),className:"mt-1.5"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(w,{children:"Data de Início"}),e.jsx(o,{type:"datetime-local",value:de.startsAt,onChange:e=>ue({...de,startsAt:e.target.value}),className:"mt-1.5"})]}),e.jsxs("div",{children:[e.jsx(w,{children:"Data de Expiração"}),e.jsx(o,{type:"datetime-local",value:de.expiresAt,onChange:e=>ue({...de,expiresAt:e.target.value}),className:"mt-1.5"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(m,{checked:de.isActive,onCheckedChange:e=>ue({...de,isActive:e})}),e.jsx(w,{children:"Cupom Ativo"})]}),e.jsxs(A,{className:"mt-6",children:[e.jsx(r,{type:"button",variant:"outline",onClick:()=>re(!1),children:"Cancelar"}),e.jsxs(r,{type:"submit",className:"bg-gradient-to-r from-blue-600 to-purple-600",children:[oe?"Atualizar":"Criar"," Cupom"]})]})]})]})]})]})]}),e.jsxs("div",{className:"grid gap-6 md:grid-cols-2 lg:grid-cols-4",children:[e.jsx(Q,{title:"Total de Cupons",value:a.length,icon:_,color:"bg-blue-500",delay:.1}),e.jsx(Q,{title:"Cupons Ativos",value:ve,icon:M,color:"bg-green-500",delay:.2,subtitle:`${(ve/a.length*100||0).toFixed(0)}% do total`}),e.jsx(Q,{title:"Usos Totais",value:ye,icon:U,color:"bg-purple-500",delay:.3}),e.jsx(Q,{title:"Média de Uso",value:(ye/a.length||0).toFixed(1),icon:$,color:"bg-pink-500",delay:.4,subtitle:"por cupom"})]}),e.jsxs(z.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.5},className:"relative",children:[e.jsx(q,{className:"absolute left-4 top-1/2 h-5 w-5 -translate-y-1/2 text-gray-400"}),e.jsx(o,{placeholder:"Buscar por código ou nome...",value:ae,onChange:e=>se(e.target.value),className:"pl-12 h-12 border-0 bg-white/80 dark:bg-gray-800/80 backdrop-blur-xl shadow-lg"})]}),e.jsx(z.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.6},children:e.jsxs(n,{className:"border-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl shadow-lg",children:[e.jsx(l,{children:e.jsx(c,{className:"text-2xl font-bold bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent",children:"Lista de Cupons"})}),e.jsx(d,{children:Y?e.jsx("div",{className:"space-y-3",children:[1,2,3,4,5].map(t=>e.jsx(T,{className:"h-16 w-full"},t))}):0===J.length?e.jsxs(z.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"flex flex-col items-center justify-center py-16",children:[e.jsxs("div",{className:"relative mb-6",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 opacity-20 blur-3xl rounded-full"}),e.jsx(_,{className:"relative h-20 w-20 text-gray-400"})]}),e.jsx("h3",{className:"text-2xl font-bold mb-2",children:"Nenhum cupom encontrado"}),e.jsx("p",{className:"text-gray-500 mb-6",children:ae?"Tente ajustar os filtros":"Sincronize com Shopify ou crie um cupom"}),!ae&&e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(r,{onClick:pe,disabled:ee,variant:"outline",size:"lg",children:[e.jsx(P,{className:"mr-2 h-5 w-5 "+(ee?"animate-spin":"")}),"Sincronizar Shopify"]}),e.jsxs(r,{onClick:()=>re(!0),size:"lg",className:"bg-gradient-to-r from-blue-600 to-purple-600",children:[e.jsx(F,{className:"mr-2 h-5 w-5"}),"Criar Cupom"]})]})]}):e.jsxs(p,{children:[e.jsx(h,{children:e.jsxs(g,{children:[e.jsx(x,{children:"Código"}),e.jsx(x,{children:"Nome"}),e.jsx(x,{children:"Desconto"}),e.jsx(x,{children:"Usos"}),e.jsx(x,{children:"Validade"}),e.jsx(x,{children:"Status"}),e.jsx(x,{className:"text-right",children:"Ações"})]})}),e.jsx(y,{children:J.map((t,a)=>e.jsxs(z.tr,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:.05*a},className:"hover:bg-gray-50 dark:hover:bg-gray-800/50",children:[e.jsx(v,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center",children:e.jsx(_,{className:"h-5 w-5 text-white"})}),e.jsx("span",{className:"font-mono font-semibold",children:t.code})]})}),e.jsx(v,{className:"font-medium",children:t.name}),e.jsx(v,{children:e.jsxs("div",{className:"flex items-center gap-2",children:["PERCENTAGE"===t.type?e.jsx($,{className:"h-4 w-4 text-green-500"}):e.jsx(B,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{className:"font-semibold",children:xe(t)})]})}),e.jsxs(v,{children:[t.usageCount||0,t.usageLimit?` / ${t.usageLimit}`:""]}),e.jsx(v,{className:"text-sm",children:t.expiresAt?O(new Date(t.expiresAt),"dd/MM/yyyy",{locale:X}):"Sem expiração"}),e.jsx(v,{children:e.jsx(u,{className:t.isActive?"bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400":"bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-400",children:t.isActive?"Ativo":"Inativo"})}),e.jsx(v,{className:"text-right",children:e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(r,{variant:"ghost",size:"icon",onClick:()=>(e=>{ne(e),ue({code:e.code,name:e.name,type:e.type,value:e.value,minPurchaseAmount:e.minPurchaseAmount||0,maxDiscountAmount:e.maxDiscountAmount||0,usageLimit:e.usageLimit||0,perCustomerLimit:e.perCustomerLimit||1,startsAt:e.startsAt||"",expiresAt:e.expiresAt||"",isActive:e.isActive}),re(!0)})(t),className:"hover:bg-blue-100 dark:hover:bg-blue-900/30",children:e.jsx(G,{className:"h-4 w-4"})}),e.jsx(r,{variant:"ghost",size:"icon",onClick:()=>(async e=>{if(confirm("Tem certeza que deseja deletar este cupom?"))try{await R.coupons.delete(e),le({title:"Cupom deletado"}),me()}catch(t){le({title:"Erro ao deletar",description:t.message,variant:"destructive"})}})(t.id),className:"hover:bg-red-100 dark:hover:bg-red-900/30",children:e.jsx(V,{className:"h-4 w-4"})})]})})]},t.id))})]})})]})})]})};export{W as default};

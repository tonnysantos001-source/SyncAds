import{j as e}from"./vendor-ui-DAyDU-p2.js";import{r as a}from"./vendor-react-BDwqAlkB.js";import{s,f as r,g as t,C as i,a as n,b as o,d as c,c as d,B as l,e as u,I as m}from"./index-DYmsTddt.js";import{L as p}from"./label--5S_JX-R.js";import{D as x,a as h,b as g,c as f,d as j,f as v}from"./dialog-BOa4kFRV.js";import{T as y,a as N,b,c as w,d as A,e as P}from"./table-GelaaZPD.js";import{T as I,a as S,b as C,c as D}from"./tabs-DnTVZ9VS.js";import{L as E,h as k,Z as M,n as q,aS as U,l as F,A as O,a3 as V,g as $,p as T,Y as B,al as R,a2 as L,t as z,aA as _}from"./vendor-icons-CcQ2w9M2.js";import{m as Y}from"./vendor-animation-x8f1c1kX.js";import"./vendor-supabase-rKXMzPQL.js";import"./vendor-utils-Dl0_yMKq.js";import"./vendor-query-D3VdSFIC.js";const G={free:0,starter:49.9,pro:149.9,enterprise:499.9};async function H(e){try{const{data:{user:a}}=await s.auth.getUser();if(!a)return{success:!1,error:"Usuário não autenticado"};const r=await async function(){const{data:e,error:a}=await s.from("GatewayConfig").select("*").is("userId",null).eq("isDefault",!0).eq("isActive",!0).single();if(a||!e)throw new Error("Gateway administrativo não configurado");return e}(),t=await fetch(`${s.supabaseUrl}/functions/v1/process-payment`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${(await s.auth.getSession()).data.session?.access_token}`},body:JSON.stringify({orderId:`verification-${Date.now()}`,userId:a.id,amount:1,paymentMethod:"credit_card",card:{number:e.cardNumber,holderName:e.cardholderName,expirationMonth:e.expiryMonth,expirationYear:e.expiryYear,cvv:e.cvv},customer:{name:e.cardholderName,document:e.cpf,email:a.email},metadata:{type:"card_verification",description:"Verificação de cartão - Será estornado automaticamente"}})}),i=await t.json();if(!i.success)return{success:!1,error:i.message||"Falha na verificação do cartão"};const n=function(e){const a=e.replace(/\s/g,"");return/^4/.test(a)?"Visa":/^5[1-5]/.test(a)?"Mastercard":/^3[47]/.test(a)?"Amex":/^6(?:011|5)/.test(a)?"Discover":/^35/.test(a)?"JCB":/^(?:2131|1800|36)/.test(a)?"Diners":/^606282/.test(a)?"Hipercard":/^(?:6062|6016|6504|6509|6505)/.test(a)?"Elo":"Desconhecida"}(e.cardNumber),o=e.cardNumber.slice(-4),{data:c,error:d}=await s.from("PaymentMethod").insert({userId:a.id,type:"credit_card",cardBrand:n,lastFourDigits:o,expiryMonth:e.expiryMonth,expiryYear:e.expiryYear,cardholderName:e.cardholderName,isDefault:!1,isVerified:!0,gatewayToken:i.transactionId,gatewayCustomerId:i.gatewayTransactionId}).select().single();return d?{success:!1,error:"Erro ao salvar método de pagamento"}:(await s.from("PaymentSplitLog").insert({transactionId:i.transactionId,orderId:`verification-${Date.now()}`,userId:a.id,ruleId:null,decision:"admin",gatewayId:r.id,gatewayName:r.name,amount:1,adminRevenue:1,clientRevenue:0,ruleType:"admin_billing",ruleName:"Verificação de Cartão SyncAds",reason:"Cobrança de verificação de método de pagamento",metadata:{type:"card_verification",willBeRefunded:!0}}),{success:!0,paymentMethod:c})}catch(a){return{success:!1,error:a instanceof Error?a.message:"Erro desconhecido"}}}function J(e){const a=e.replace(/\s/g,"");return a.match(/.{1,4}/g)?.join(" ")||a}function W(e){const a=e.replace(/\D/g,"");return a.length>=2?`${a.slice(0,2)}/${a.slice(2,4)}`:a}const Z=[{id:"free",name:"Free",price:0,description:"Perfeito para começar",icon:k,color:"from-gray-500 to-gray-600",features:["5 mensagens IA por dia","2 imagens IA por dia","1 página de checkout","100 produtos","Taxa de transação: 2.5%","Suporte por email"],limits:{dailyAiMessages:5,dailyAiImages:2,checkoutPages:1,products:100}},{id:"starter",name:"Starter",price:G.starter,description:"Para pequenos negócios",icon:M,color:"from-blue-500 to-blue-600",badge:"7 dias grátis",features:["50 mensagens IA por dia","20 imagens IA por dia","5 páginas de checkout","1.000 produtos","Taxa de transação: 1.5%","Suporte prioritário","Analytics básico"],limits:{dailyAiMessages:50,dailyAiImages:20,checkoutPages:5,products:1e3}},{id:"pro",name:"Pro",price:G.pro,description:"Para negócios em crescimento",icon:q,color:"from-purple-500 to-purple-600",badge:"7 dias grátis",popular:!0,features:["200 mensagens IA por dia","100 imagens IA por dia","20 páginas de checkout","10.000 produtos","Taxa de transação: 1%","Suporte prioritário 24/7","Analytics avançado","Domínio customizado","API de integração"],limits:{dailyAiMessages:200,dailyAiImages:100,checkoutPages:20,products:1e4}},{id:"enterprise",name:"Enterprise",price:G.enterprise,description:"Para grandes operações",icon:U,color:"from-orange-500 to-orange-600",badge:"7 dias grátis",features:["Mensagens IA ilimitadas","Imagens IA ilimitadas","Páginas de checkout ilimitadas","Produtos ilimitados","Taxa de transação: 0.5%","Suporte dedicado 24/7","Analytics avançado + BI","White label completo","API completa","Gerente de conta"],limits:{dailyAiMessages:-1,dailyAiImages:-1,checkoutPages:-1,products:-1}}],K=()=>{const M=r(e=>e.user),{toast:q}=t(),[U,K]=a.useState(!0),[Q,X]=a.useState(null),[ee,ae]=a.useState([]),[se,re]=a.useState([]),[te,ie]=a.useState(!1),[ne,oe]=a.useState(!1),[ce,de]=a.useState(null),[le,ue]=a.useState(!1),[me,pe]=a.useState({cardNumber:"",cardholderName:"",expiryDate:"",cvv:"",cpf:""});a.useEffect(()=>{xe()},[M?.id]);const xe=async()=>{try{K(!0),await Promise.all([he(),ge(),fe()])}catch(e){q({title:"Erro ao carregar dados",description:"Não foi possível carregar as informações de faturamento.",variant:"destructive"})}finally{K(!1)}},he=async()=>{const e=await async function(){const{data:{user:e}}=await s.auth.getUser();if(!e)return null;const{data:a,error:r}=await s.from("Subscription").select("*").eq("userId",e.id).in("status",["trialing","active","past_due"]).order("createdAt",{ascending:!1}).limit(1).single();return r?null:a}();X(e)},ge=async()=>{const e=await async function(){const{data:{user:e}}=await s.auth.getUser();if(!e)return[];const{data:a,error:r}=await s.from("PaymentMethod").select("*").eq("userId",e.id).order("isDefault",{ascending:!1}).order("createdAt",{ascending:!1});return r?[]:a||[]}();ae(e)},fe=async()=>{const e=await async function(){const{data:{user:e}}=await s.auth.getUser();if(!e)return[];const{data:a,error:r}=await s.from("Invoice").select("*").eq("userId",e.id).order("createdAt",{ascending:!1});return r?[]:a||[]}();re(e)},je=async e=>{try{const a=await async function(e){try{const{data:{user:a}}=await s.auth.getUser();if(!a)return{success:!1,error:"Usuário não autenticado"};const{data:r}=await s.from("Subscription").select("*").eq("userId",a.id).eq("paymentMethodId",e).in("status",["trialing","active"]).single();if(r)return{success:!1,error:"Não é possível remover o método de pagamento de uma assinatura ativa"};const{error:t}=await s.from("PaymentMethod").delete().eq("id",e).eq("userId",a.id);return t?{success:!1,error:"Erro ao remover método de pagamento"}:{success:!0}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Erro desconhecido"}}}(e);if(!a.success)return void q({title:"Erro ao remover cartão",description:a.error,variant:"destructive"});q({title:"Cartão removido",description:"O método de pagamento foi removido com sucesso."}),await ge()}catch(a){}},ve=async e=>{try{const a=await async function(e){try{const{data:{user:a}}=await s.auth.getUser();if(!a)return{success:!1,error:"Usuário não autenticado"};await s.from("PaymentMethod").update({isDefault:!1}).eq("userId",a.id);const{error:r}=await s.from("PaymentMethod").update({isDefault:!0}).eq("id",e).eq("userId",a.id);return r?{success:!1,error:"Erro ao definir método de pagamento padrão"}:{success:!0}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Erro desconhecido"}}}(e);if(!a.success)return void q({title:"Erro",description:a.error,variant:"destructive"});q({title:"Cartão definido como padrão",description:"Este cartão será usado nas próximas cobranças."}),await ge()}catch(a){}},ye=()=>Q?.plan||"free",Ne=e=>new Date(e).toLocaleDateString("pt-BR"),be=e=>new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(e),we=a=>{const s={trialing:{label:"Em Trial",variant:"default"},active:{label:"Ativo",variant:"default"},past_due:{label:"Pagamento Pendente",variant:"destructive"},canceled:{label:"Cancelado",variant:"secondary"},paused:{label:"Pausado",variant:"secondary"},pending:{label:"Pendente",variant:"outline"},paid:{label:"Pago",variant:"default"},failed:{label:"Falhou",variant:"destructive"}}[a]||{label:a,variant:"outline"};return e.jsx(u,{variant:s.variant,children:s.label})};return U?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsx(E,{className:"h-8 w-8 animate-spin text-primary"})}):e.jsxs("div",{className:"container mx-auto px-4 py-8 max-w-7xl",children:[e.jsxs(Y.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"mb-8",children:[e.jsx("h1",{className:"text-4xl font-bold mb-2",children:"Faturamento"}),e.jsx("p",{className:"text-muted-foreground",children:"Gerencie sua assinatura, métodos de pagamento e faturas"})]}),e.jsxs(I,{defaultValue:"plans",className:"space-y-6",children:[e.jsxs(S,{children:[e.jsx(C,{value:"plans",children:"Planos"}),e.jsx(C,{value:"payment-methods",children:"Métodos de Pagamento"}),e.jsx(C,{value:"invoices",children:"Faturas"})]}),e.jsxs(D,{value:"plans",className:"space-y-6",children:[Q&&e.jsx(Y.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},children:e.jsxs(i,{children:[e.jsxs(n,{children:[e.jsx(o,{children:"Assinatura Atual"}),e.jsx(c,{children:"Detalhes da sua assinatura ativa"})]}),e.jsxs(d,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"font-semibold text-lg",children:["Plano ",Q.plan.toUpperCase()]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[be(Q.amount),"/mês"]})]}),we(Q.status)]}),"trialing"===Q.status&&Q.trialEnd&&e.jsx("div",{className:"bg-blue-50 dark:bg-blue-950 p-4 rounded-lg border border-blue-200 dark:border-blue-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(k,{className:"h-5 w-5 text-blue-600 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-blue-900 dark:text-blue-100",children:"Período de Trial"}),e.jsxs("p",{className:"text-sm text-blue-700 dark:text-blue-300",children:["Seu trial termina em"," ",Ne(Q.trialEnd),". Primeira cobrança nesta data."]})]})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"Período Atual"}),e.jsxs("p",{className:"font-medium",children:[Ne(Q.currentPeriodStart)," -"," ",Ne(Q.currentPeriodEnd)]})]}),Q.nextPaymentDate&&e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"Próximo Pagamento"}),e.jsx("p",{className:"font-medium",children:Ne(Q.nextPaymentDate)})]})]}),e.jsx("div",{className:"flex gap-2",children:Q.cancelAtPeriodEnd?e.jsx(l,{variant:"default",onClick:async()=>{if(Q)try{const e=await async function(e){try{const{data:{user:a}}=await s.auth.getUser();if(!a)return{success:!1,error:"Usuário não autenticado"};const{error:r}=await s.from("Subscription").update({cancelAtPeriodEnd:!1,updatedAt:(new Date).toISOString()}).eq("id",e).eq("userId",a.id);return r?{success:!1,error:"Erro ao reativar assinatura"}:{success:!0}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Erro desconhecido"}}}(Q.id);if(!e.success)return void q({title:"Erro ao reativar",description:e.error,variant:"destructive"});q({title:"Assinatura reativada",description:"Sua assinatura continuará ativa."}),await he()}catch(e){}},children:"Reativar Assinatura"}):e.jsx(l,{variant:"outline",onClick:async()=>{if(Q)try{const e=await async function(e,a=!1){try{const{data:{user:r}}=await s.auth.getUser();if(!r)return{success:!1,error:"Usuário não autenticado"};const t={cancelAtPeriodEnd:!a,updatedAt:(new Date).toISOString()};a&&(t.status="canceled");const{error:i}=await s.from("Subscription").update(t).eq("id",e).eq("userId",r.id);return i?{success:!1,error:"Erro ao cancelar assinatura"}:{success:!0}}catch(r){return{success:!1,error:r instanceof Error?r.message:"Erro desconhecido"}}}(Q.id);if(!e.success)return void q({title:"Erro ao cancelar",description:e.error,variant:"destructive"});q({title:"Assinatura cancelada",description:"Sua assinatura será cancelada no final do período."}),await he()}catch(e){}},children:"Cancelar Assinatura"})})]})]})}),e.jsx("div",{className:"grid md:grid-cols-2 lg:grid-cols-4 gap-6",children:Z.map((a,s)=>{const r=a.icon,t=ye()===a.id,u=Z.findIndex(e=>e.id===ye())<Z.findIndex(e=>e.id===a.id);return e.jsx(Y.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.1*s},children:e.jsxs(i,{className:`relative overflow-hidden ${a.popular?"border-primary shadow-lg":""} ${t?"ring-2 ring-primary":""}`,children:[a.popular&&e.jsx("div",{className:"absolute top-0 right-0 bg-primary text-primary-foreground px-3 py-1 text-xs font-semibold rounded-bl-lg",children:"POPULAR"}),a.badge&&!a.popular&&e.jsx("div",{className:"absolute top-0 right-0 bg-blue-500 text-white px-3 py-1 text-xs font-semibold rounded-bl-lg",children:a.badge}),e.jsxs(n,{children:[e.jsx("div",{className:`w-12 h-12 rounded-lg bg-gradient-to-br ${a.color} flex items-center justify-center mb-4`,children:e.jsx(r,{className:"h-6 w-6 text-white"})}),e.jsx(o,{children:a.name}),e.jsx(c,{children:a.description}),e.jsxs("div",{className:"mt-4",children:[e.jsx("span",{className:"text-4xl font-bold",children:0===a.price?"Grátis":be(a.price)}),a.price>0&&e.jsx("span",{className:"text-muted-foreground",children:"/mês"})]})]}),e.jsxs(d,{className:"space-y-4",children:[e.jsx("ul",{className:"space-y-2",children:a.features.map((a,s)=>e.jsxs("li",{className:"flex items-start gap-2 text-sm",children:[e.jsx(F,{className:"h-4 w-4 text-green-500 mt-0.5 flex-shrink-0"}),e.jsx("span",{children:a})]},s))}),t?e.jsxs(l,{className:"w-full",disabled:!0,children:[e.jsx(F,{className:"mr-2 h-4 w-4"}),"Plano Atual"]}):u&&"free"!==a.id?e.jsxs(l,{className:"w-full",onClick:()=>{de(a),oe(!0)},children:["Fazer Upgrade",e.jsx(O,{className:"ml-2 h-4 w-4"})]}):null]})]})},a.id)})})]}),e.jsxs(D,{value:"payment-methods",className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Métodos de Pagamento"}),e.jsx("p",{className:"text-muted-foreground",children:"Gerencie seus cartões de crédito"})]}),e.jsxs(l,{onClick:()=>ie(!0),children:[e.jsx(V,{className:"mr-2 h-4 w-4"}),"Adicionar Cartão"]})]}),0===ee.length?e.jsx(i,{children:e.jsxs(d,{className:"flex flex-col items-center justify-center py-12",children:[e.jsx($,{className:"h-12 w-12 text-muted-foreground mb-4"}),e.jsx("p",{className:"text-lg font-medium mb-2",children:"Nenhum método de pagamento"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Adicione um cartão para fazer upgrade de plano"}),e.jsxs(l,{onClick:()=>ie(!0),children:[e.jsx(V,{className:"mr-2 h-4 w-4"}),"Adicionar Cartão"]})]})}):e.jsx("div",{className:"grid md:grid-cols-2 gap-4",children:ee.map(a=>e.jsx(i,{children:e.jsxs(d,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"w-12 h-12 bg-gradient-to-br from-purple-500 to-blue-500 rounded-lg flex items-center justify-center",children:e.jsx($,{className:"h-6 w-6 text-white"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsxs("p",{className:"font-semibold",children:[a.cardBrand," •••• ",a.lastFourDigits]}),a.isDefault&&e.jsx(u,{variant:"default",children:"Padrão"}),a.isVerified&&e.jsx(T,{className:"h-4 w-4 text-green-500"})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:a.cardholderName}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Expira em ",a.expiryMonth,"/",a.expiryYear]})]})]}),e.jsx(l,{variant:"ghost",size:"sm",onClick:()=>je(a.id),children:e.jsx(B,{className:"h-4 w-4"})})]}),!a.isDefault&&e.jsx(l,{variant:"outline",size:"sm",className:"w-full mt-4",onClick:()=>ve(a.id),children:"Definir como Padrão"})]})},a.id))})]}),e.jsxs(D,{value:"invoices",className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Histórico de Faturas"}),e.jsx("p",{className:"text-muted-foreground",children:"Visualize e baixe suas faturas"})]}),0===se.length?e.jsx(i,{children:e.jsxs(d,{className:"flex flex-col items-center justify-center py-12",children:[e.jsx(R,{className:"h-12 w-12 text-muted-foreground mb-4"}),e.jsx("p",{className:"text-lg font-medium mb-2",children:"Nenhuma fatura ainda"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Suas faturas aparecerão aqui"})]})}):e.jsx(i,{children:e.jsxs(y,{children:[e.jsx(N,{children:e.jsxs(b,{children:[e.jsx(w,{children:"Data"}),e.jsx(w,{children:"Descrição"}),e.jsx(w,{children:"Valor"}),e.jsx(w,{children:"Status"}),e.jsx(w,{className:"text-right",children:"Ações"})]})}),e.jsx(A,{children:se.map(a=>e.jsxs(b,{children:[e.jsx(P,{children:Ne(a.createdAt)}),e.jsx(P,{children:a.description}),e.jsx(P,{children:be(a.amount)}),e.jsx(P,{children:we(a.status)}),e.jsx(P,{className:"text-right",children:"paid"===a.status&&e.jsxs(l,{variant:"ghost",size:"sm",children:[e.jsx(L,{className:"h-4 w-4 mr-2"}),"Baixar PDF"]})})]},a.id))})]})})]})]}),e.jsx(x,{open:te,onOpenChange:ie,children:e.jsxs(h,{children:[e.jsxs(g,{children:[e.jsx(f,{children:"Adicionar Cartão de Crédito"}),e.jsx(j,{children:"Será cobrado R$ 1,00 para verificação do cartão. Este valor será estornado automaticamente em até 24 horas."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"cardNumber",children:"Número do Cartão"}),e.jsx(m,{id:"cardNumber",placeholder:"1234 5678 9012 3456",maxLength:19,value:me.cardNumber,onChange:e=>pe({...me,cardNumber:J(e.target.value)})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"cardholderName",children:"Nome no Cartão"}),e.jsx(m,{id:"cardholderName",placeholder:"NOME COMO NO CARTÃO",value:me.cardholderName,onChange:e=>pe({...me,cardholderName:e.target.value.toUpperCase()})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"expiryDate",children:"Validade"}),e.jsx(m,{id:"expiryDate",placeholder:"MM/AA",maxLength:5,value:me.expiryDate,onChange:e=>pe({...me,expiryDate:W(e.target.value)})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"cvv",children:"CVV"}),e.jsx(m,{id:"cvv",placeholder:"123",type:"password",maxLength:4,value:me.cvv,onChange:e=>pe({...me,cvv:e.target.value.replace(/\D/g,"")})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"cpf",children:"CPF"}),e.jsx(m,{id:"cpf",placeholder:"000.000.000-00",maxLength:14,value:me.cpf,onChange:e=>pe({...me,cpf:e.target.value})})]}),e.jsx("div",{className:"bg-blue-50 dark:bg-blue-950 p-4 rounded-lg border border-blue-200 dark:border-blue-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(z,{className:"h-5 w-5 text-blue-600 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-blue-900 dark:text-blue-100 text-sm",children:"Pagamento Seguro"}),e.jsx("p",{className:"text-xs text-blue-700 dark:text-blue-300",children:"Seus dados são criptografados e protegidos"})]})]})})]}),e.jsxs(v,{children:[e.jsx(l,{variant:"outline",onClick:()=>ie(!1),disabled:le,children:"Cancelar"}),e.jsx(l,{onClick:async()=>{try{if(ue(!0),!function(e){const a=e.replace(/\s/g,"");if(!/^\d+$/.test(a))return!1;let s=0,r=!1;for(let t=a.length-1;t>=0;t--){let e=parseInt(a[t]);r&&(e*=2,e>9&&(e-=9)),s+=e,r=!r}return s%10==0}(me.cardNumber))return void q({title:"Cartão inválido",description:"Número de cartão inválido.",variant:"destructive"});if(e=me.cvv,!/^\d+$/.test(e)||3!==e.length)return void q({title:"CVV inválido",description:"CVV deve ter 3 ou 4 dígitos.",variant:"destructive"});const[a,s]=me.expiryDate.split("/");if(!a||!s||2!==a.length||2!==s.length)return void q({title:"Data inválida",description:"Use o formato MM/AA.",variant:"destructive"});const r=await H({cardNumber:me.cardNumber.replace(/\s/g,""),cardholderName:me.cardholderName,expiryMonth:a,expiryYear:`20${s}`,cvv:me.cvv,cpf:me.cpf.replace(/\D/g,"")});if(!r.success)return void q({title:"Erro ao adicionar cartão",description:r.error,variant:"destructive"});q({title:"Cartão adicionado com sucesso!",description:"Cobramos R$ 1,00 para verificação. Será estornado em até 24h."}),ie(!1),pe({cardNumber:"",cardholderName:"",expiryDate:"",cvv:"",cpf:""}),await ge()}catch(a){q({title:"Erro",description:"Ocorreu um erro ao adicionar o cartão.",variant:"destructive"})}finally{ue(!1)}var e},disabled:le,children:le?e.jsxs(e.Fragment,{children:[e.jsx(E,{className:"mr-2 h-4 w-4 animate-spin"}),"Processando..."]}):e.jsxs(e.Fragment,{children:[e.jsx($,{className:"mr-2 h-4 w-4"}),"Adicionar Cartão"]})})]})]})}),e.jsx(x,{open:ne,onOpenChange:oe,children:e.jsxs(h,{children:[e.jsxs(g,{children:[e.jsx(f,{children:"Confirmar Upgrade de Plano"}),e.jsxs(j,{children:["Você está prestes a fazer upgrade para o plano"," ",ce?.name]})]}),ce&&e.jsxs("div",{className:"space-y-4",children:[e.jsx(i,{children:e.jsxs(d,{className:"pt-6 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Plano"}),e.jsx("span",{className:"font-semibold",children:ce.name})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Valor"}),e.jsxs("span",{className:"font-semibold",children:[be(ce.price),"/mês"]})]}),ce.badge&&e.jsx("div",{className:"pt-3 border-t",children:e.jsxs("div",{className:"flex items-center gap-2 text-green-600 dark:text-green-400",children:[e.jsx(k,{className:"h-4 w-4"}),e.jsx("span",{className:"font-medium text-sm",children:ce.badge})]})})]})}),e.jsx("div",{className:"bg-yellow-50 dark:bg-yellow-950 p-4 rounded-lg border border-yellow-200 dark:border-yellow-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(_,{className:"h-5 w-5 text-yellow-600 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-yellow-900 dark:text-yellow-100 text-sm",children:"Período de Trial"}),e.jsxs("p",{className:"text-xs text-yellow-700 dark:text-yellow-300",children:["Você não será cobrado nos próximos 7 dias. Após o trial, a cobrança será de ",be(ce.price)," por mês."]})]})]})})]}),e.jsxs(v,{children:[e.jsx(l,{variant:"outline",onClick:()=>oe(!1),disabled:le,children:"Cancelar"}),e.jsx(l,{onClick:async()=>{if(ce&&"free"!==ce.id)try{if(ue(!0),0===ee.length)return q({title:"Adicione um cartão",description:"Você precisa adicionar um método de pagamento primeiro.",variant:"destructive"}),oe(!1),void ie(!0);const e=ee.find(e=>e.isDefault)||ee[0],a=await async function(e,a){try{const{data:{user:r}}=await s.auth.getUser();if(!r)return{success:!1,error:"Usuário não autenticado"};const{data:t}=await s.from("PaymentMethod").select("*").eq("id",a).eq("userId",r.id).single();if(!t||!t.isVerified)return{success:!1,error:"Método de pagamento inválido ou não verificado"};const{data:i}=await s.from("Subscription").select("*").eq("userId",r.id).in("status",["trialing","active"]);if(i&&i.length>0)for(const e of i)await s.from("Subscription").update({status:"canceled",cancelAtPeriodEnd:!0,updatedAt:(new Date).toISOString()}).eq("id",e.id);const n=new Date,o=new Date(n);o.setDate(o.getDate()+7);const c=new Date(o);c.setMonth(c.getMonth()+1);const{data:d,error:l}=await s.from("Subscription").insert({userId:r.id,plan:e,status:"trialing",currentPeriodStart:n.toISOString(),currentPeriodEnd:c.toISOString(),trialEnd:o.toISOString(),cancelAtPeriodEnd:!1,paymentMethodId:a,nextPaymentDate:o.toISOString(),amount:G[e]}).select().single();return l?{success:!1,error:"Erro ao criar assinatura"}:(await s.from("Invoice").insert({userId:r.id,subscriptionId:d.id,amount:G[e],status:"draft",description:`Assinatura ${e.toUpperCase()} - Primeiro pagamento`,dueDate:o.toISOString(),paymentMethodId:a,metadata:{plan:e,period:"monthly",isFirstPayment:!0}}),{success:!0,subscription:d})}catch(r){return{success:!1,error:r instanceof Error?r.message:"Erro desconhecido"}}}(ce.id,e.id);if(!a.success)return void q({title:"Erro ao criar assinatura",description:a.error,variant:"destructive"});q({title:"Assinatura criada com sucesso!",description:`Você tem 7 dias grátis para testar o plano ${ce.name}.`}),oe(!1),await xe()}catch(e){q({title:"Erro",description:"Ocorreu um erro ao criar a assinatura.",variant:"destructive"})}finally{ue(!1)}},disabled:le,children:le?e.jsxs(e.Fragment,{children:[e.jsx(E,{className:"mr-2 h-4 w-4 animate-spin"}),"Processando..."]}):e.jsxs(e.Fragment,{children:["Confirmar Upgrade",e.jsx(O,{className:"ml-2 h-4 w-4"})]})})]})]})})]})};export{K as default};

import{f as H,r as h,s as o,j as e,g as c,h as i,i as x,l as m,k as $,S as q,I as Z,n as G}from"./index-uxOQkJKF.js";import{T as K,a as O,b,c as d,d as z,e as l}from"./table-BoQIPlv_.js";import{S as w}from"./SuperAdminLayout-bAf6xCKN.js";import{M as T}from"./message-square-CCrRpq2k.js";import{Z as J}from"./zap-Co5gbvQQ.js";import{D as Q}from"./dollar-sign-D0_z6Oya.js";import{T as V}from"./trending-up-DNwED8zS.js";import"./Logo-C0_G3gQ5.js";function le(){const{toast:k}=H(),[n,C]=h.useState([]),[u,I]=h.useState(""),[S,M]=h.useState(!0);h.useEffect(()=>{E()},[]);const E=async()=>{try{const{data:s,error:a}=await o.from("User").select("id, name, email, plan, createdAt").order("createdAt",{ascending:!1});if(a)throw a;const v=(s||[]).map(t=>t.id),{data:y}=await o.from("ChatConversation").select("userId, id").in("userId",v),D=(y||[]).map(t=>t.id),{data:U}=await o.from("ChatMessage").select("conversationId").in("conversationId",D),j=new Map;(y||[]).forEach(t=>{const r=(U||[]).filter(F=>F.conversationId===t.id).length,B=j.get(t.userId)||0;j.set(t.userId,B+r)});const{data:P}=await o.from("AiUsage").select("userId, totalTokens, estimatedCost, createdAt").in("userId",v).order("createdAt",{ascending:!1}),p=new Map;(P||[]).forEach(t=>{p.has(t.userId)||p.set(t.userId,t)});const{data:f}=await o.from("GlobalAiConnection").select("provider").eq("isActive",!0).limit(1).maybeSingle(),L=(s||[]).map(t=>{const r=p.get(t.id);return{clientId:t.id,clientName:t.name||"Sem nome",clientSlug:t.email||"",plan:t.plan||"FREE",totalMessages:j.get(t.id)||0,totalTokens:(r==null?void 0:r.totalTokens)||0,estimatedCost:(r==null?void 0:r.estimatedCost)||0,aiProvider:(f==null?void 0:f.provider)||"N/A",lastUsed:(r==null?void 0:r.createdAt)||null}});C(L)}catch(s){console.error("Error loading usage data:",s),k({title:"Erro ao carregar uso de IA",description:s.message,variant:"destructive"})}finally{M(!1)}},N=n.filter(s=>s.clientName.toLowerCase().includes(u.toLowerCase())||s.clientSlug.toLowerCase().includes(u.toLowerCase())),g={totalMessages:n.reduce((s,a)=>s+a.totalMessages,0),totalTokens:n.reduce((s,a)=>s+a.totalTokens,0),totalCost:n.reduce((s,a)=>s+a.estimatedCost,0),avgMessagesPerClient:n.length>0?n.reduce((s,a)=>s+a.totalMessages,0)/n.length:0},A=s=>{const a={FREE:"bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-100",STARTER:"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200",PRO:"bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200",ENTERPRISE:"bg-emerald-100 text-emerald-800 dark:bg-emerald-900 dark:text-emerald-200"};return e.jsx("span",{className:`px-2 py-1 rounded text-xs font-medium ${a[s]||a.FREE}`,children:s})},R=s=>{const a={openai:"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200",anthropic:"bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200",google:"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200","N/A":"bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-100"};return e.jsx(G,{variant:"outline",className:a[s]||a["N/A"],children:s.toUpperCase()})};return S?e.jsx(w,{children:e.jsx("div",{className:"flex items-center justify-center min-h-[50vh]",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})})}):e.jsx(w,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white",children:"Uso de IA"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"Acompanhe o uso de inteligência artificial por cliente"})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-4",children:[e.jsxs(c,{children:[e.jsxs(i,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(x,{className:"text-sm font-medium",children:"Total de Mensagens"}),e.jsx(T,{className:"h-4 w-4 text-blue-600"})]}),e.jsxs(m,{children:[e.jsx("div",{className:"text-2xl font-bold",children:g.totalMessages.toLocaleString("pt-BR")}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Todas conversas com IA"})]})]}),e.jsxs(c,{children:[e.jsxs(i,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(x,{className:"text-sm font-medium",children:"Total de Tokens"}),e.jsx(J,{className:"h-4 w-4 text-amber-600"})]}),e.jsxs(m,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[(g.totalTokens/1e3).toFixed(1),"K"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Tokens processados"})]})]}),e.jsxs(c,{children:[e.jsxs(i,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(x,{className:"text-sm font-medium",children:"Custo Estimado"}),e.jsx(Q,{className:"h-4 w-4 text-green-600"})]}),e.jsxs(m,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:["R$ ",g.totalCost.toLocaleString("pt-BR",{minimumFractionDigits:2})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Custo com APIs"})]})]}),e.jsxs(c,{children:[e.jsxs(i,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(x,{className:"text-sm font-medium",children:"Média por Usuário"}),e.jsx(V,{className:"h-4 w-4 text-purple-600"})]}),e.jsxs(m,{children:[e.jsx("div",{className:"text-2xl font-bold",children:Math.round(g.avgMessagesPerClient)}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Mensagens / usuário"})]})]})]}),e.jsxs(c,{children:[e.jsx(i,{children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx(x,{children:"Uso de IA por Usuário"}),e.jsx($,{children:"Detalhes de mensagens, tokens e custos"})]})})}),e.jsxs(m,{children:[e.jsx("div",{className:"mb-4",children:e.jsxs("div",{className:"relative",children:[e.jsx(q,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(Z,{placeholder:"Buscar usuário...",value:u,onChange:s=>I(s.target.value),className:"pl-10"})]})}),e.jsx("div",{className:"border rounded-lg",children:e.jsxs(K,{children:[e.jsx(O,{children:e.jsxs(b,{children:[e.jsx(d,{children:"Usuário"}),e.jsx(d,{children:"Plano"}),e.jsx(d,{children:"Provider"}),e.jsx(d,{children:"Mensagens"}),e.jsx(d,{children:"Tokens"}),e.jsx(d,{children:"Custo"}),e.jsx(d,{children:"Último Uso"})]})}),e.jsx(z,{children:N.length===0?e.jsx(b,{children:e.jsx(l,{colSpan:7,className:"text-center py-8 text-gray-500",children:"Nenhum dado de uso encontrado"})}):N.map(s=>e.jsxs(b,{children:[e.jsx(l,{children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.clientName}),e.jsx("div",{className:"text-sm text-gray-500",children:s.clientSlug})]})}),e.jsx(l,{children:A(s.plan)}),e.jsx(l,{children:R(s.aiProvider)}),e.jsx(l,{children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(T,{className:"h-4 w-4 text-gray-400"}),e.jsx("span",{className:"font-medium",children:s.totalMessages})]})}),e.jsx(l,{children:e.jsx("span",{className:"text-sm",children:s.totalTokens.toLocaleString("pt-BR")})}),e.jsx(l,{children:e.jsxs("span",{className:"font-semibold text-green-600",children:["R$ ",s.estimatedCost.toLocaleString("pt-BR",{minimumFractionDigits:2})]})}),e.jsx(l,{children:s.lastUsed?e.jsx("span",{className:"text-sm text-gray-600",children:new Date(s.lastUsed).toLocaleDateString("pt-BR")}):e.jsx("span",{className:"text-sm text-gray-400",children:"Nunca"})})]},s.clientId))})]})})]})]})]})})}export{le as default};

import{c as I,f as A,r as i,j as e,B as j,n as $,g as N,l as b,al as y,s as l}from"./index-B-osEcsW.js";import{T as z}from"./textarea-KuGV1aJB.js";import{S as D}from"./SuperAdminLayout-D80Yqo5F.js";import{S as C}from"./Logo-D44nFj3s.js";import{S as E}from"./sparkles-BQHsdYtO.js";import{S as O}from"./send-DYUjut_o.js";import"./message-square-B2cJ57yk.js";import"./dollar-sign-C66kBVB9.js";/**
 * @license lucide-react v0.417.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const L=I("CirclePlus",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]);function K(){const{toast:x}=A(),[p,m]=i.useState([]),[h,u]=i.useState(""),[d,f]=i.useState(!1),[S,g]=i.useState(null),v=i.useRef(null);i.useEffect(()=>{(async()=>{try{const{data:{user:s},error:r}=await l.auth.getUser();if(r||!s){console.error("UsuÃ¡rio nÃ£o autenticado:",r),x({title:"Erro de autenticaÃ§Ã£o",description:"VocÃª precisa fazer login novamente.",variant:"destructive"}),window.location.href="/login";return}const{data:o}=await l.from("ChatConversation").select("*").eq("userId",s.id).order("createdAt",{ascending:!1}).limit(1),c=o==null?void 0:o[0];if(c){g(c.id);const{data:a}=await l.from("ChatMessage").select("id, role, content, createdAt, userId").eq("conversationId",c.id).order("createdAt",{ascending:!1}).limit(50);a&&a.length>0&&(m(a.reverse().map(n=>({id:n.id,role:n.role,content:n.content,timestamp:new Date(n.createdAt)}))),console.log(`âœ… ${a.length} mensagens carregadas do histÃ³rico`))}else{const{data:a}=await l.from("User").select("organizationId").eq("id",s.id).single();if(!(a!=null&&a.organizationId))throw new Error("UsuÃ¡rio sem organizaÃ§Ã£o");const{data:n}=await l.from("ChatConversation").insert({userId:s.id,organizationId:a.organizationId,title:"ðŸ›¡ï¸ Admin Chat"}).select().single();n&&g(n.id)}}catch(s){console.error("Erro ao inicializar conversa:",s)}})()},[]),i.useEffect(()=>{var t;(t=v.current)==null||t.scrollIntoView({behavior:"smooth"})},[p]);const k=async(t,s)=>{try{const{data:{session:r}}=await l.auth.getSession();if(!r)throw new Error("NÃ£o autenticado");const o=await fetch("https://ovskepqggmxlfckxqgbr.supabase.co/functions/v1/chat-stream",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r.access_token}`},body:JSON.stringify({message:t,conversationId:s})});if(!o.ok){const a=await o.json();throw new Error(a.error||"Erro ao processar mensagem")}return(await o.json()).response||"Sem resposta"}catch(r){return console.error("Admin chat error:",r),`âŒ Erro: ${r.message}`}},w=async()=>{if(!h.trim()||d)return;const t=h.trim();u(""),f(!0);try{let s=S||"admin-chat-default";const r={id:`temp-${Date.now()}`,role:"user",content:t,timestamp:new Date};m(a=>[...a,r]);const o=await k(t,s),c={id:`temp-${Date.now()+1}`,role:"assistant",content:o,timestamp:new Date};m(a=>[...a,c])}catch(s){console.error("ERRO COMPLETO:",s);const r={id:`error-${Date.now()}`,role:"assistant",content:`âŒ ERRO DETALHADO:

${s.message}

${s.stack||"Sem stack trace"}

${JSON.stringify(s,null,2)}`,timestamp:new Date};m(o=>[...o,r]),x({title:"Erro ao processar",description:s.message,variant:"destructive"})}finally{f(!1)}};return e.jsx(D,{children:e.jsxs("div",{className:"h-[calc(100vh-80px)] flex flex-col",children:[e.jsx("div",{className:"border-b border-gray-200 bg-white/80 backdrop-blur-xl p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-r from-blue-500 to-purple-500",children:e.jsx(C,{className:"h-6 w-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold text-gray-900",children:"Chat Administrativo"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Chat com IA"})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(j,{onClick:handleNewConversation,variant:"outline",size:"sm",className:"gap-2",children:[e.jsx(L,{className:"h-4 w-4"}),"Nova Conversa"]}),e.jsxs($,{className:"bg-gradient-to-r from-green-500 to-emerald-500",children:[e.jsx(E,{className:"h-3 w-3 mr-1"}),"Online"]})]})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[p.map(t=>e.jsx("div",{className:`flex ${t.role==="user"?"justify-end":"justify-start"}`,children:e.jsx(N,{className:`max-w-[80%] ${t.role==="user"?"bg-gradient-to-r from-blue-500 to-purple-500 text-white":t.role==="system"?"bg-gradient-to-r from-amber-50 to-orange-50 border-amber-200":"bg-white"}`,children:e.jsxs(b,{className:"p-4",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[t.role==="assistant"&&e.jsx(C,{className:"h-5 w-5 text-blue-600 mt-1 flex-shrink-0"}),t.role==="system"&&e.jsx(E,{className:"h-5 w-5 text-amber-600 mt-1 flex-shrink-0"}),e.jsx("div",{className:`flex-1 whitespace-pre-wrap break-words text-sm ${t.role==="user"?"text-white":"text-gray-900"}`,children:t.content})]}),e.jsx("div",{className:`text-xs mt-2 ${t.role==="user"?"text-white/70":"text-gray-500"}`,children:t.timestamp.toLocaleTimeString("pt-BR")})]})})},t.id)),d&&e.jsx("div",{className:"flex justify-start",children:e.jsx(N,{className:"bg-white",children:e.jsx(b,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(y,{className:"h-4 w-4 animate-spin text-blue-600"}),e.jsx("span",{className:"text-sm text-gray-500",children:"Processando..."})]})})})}),e.jsx("div",{ref:v})]}),e.jsx("div",{className:"border-t border-gray-200 p-4 bg-white/80 backdrop-blur-xl",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(z,{value:h,onChange:t=>u(t.target.value),onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),w())},placeholder:"Digite seu comando... (Ex: 'stats gerais', 'audite o sistema', 'clientes ativos')",className:"min-h-[60px] resize-none",disabled:d}),e.jsx(j,{onClick:w,disabled:!h.trim()||d,className:"bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600",size:"lg",children:d?e.jsx(y,{className:"h-5 w-5 animate-spin"}):e.jsx(O,{className:"h-5 w-5"})})]})})]})})}export{K as default};
